<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WILLOW V50 Command Center - Glenn Fitzgerald</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
    }
    
    /* Header */
    .header {
      background: white;
      padding: 24px 32px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-left h1 {
      font-size: 28px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }
    
    .header-left p {
      color: #64748b;
      font-size: 14px;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .user-info {
      text-align: right;
    }
    
    .user-name {
      font-weight: 600;
      color: #1e293b;
      font-size: 15px;
    }
    
    .user-role {
      font-size: 13px;
      color: #64748b;
    }
    
    .user-role.admin {
      color: #2563eb;
      font-weight: 600;
    }
    
    .logout-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .logout-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }
    
    /* Search Panel */
    .search-panel {
      background: white;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    
    .search-panel h2 {
      color: #1e293b;
      font-size: 22px;
      margin-bottom: 24px;
    }
    
    .search-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .search-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .search-field label {
      font-weight: 600;
      color: #334155;
      font-size: 14px;
    }
    
    .search-field input, .search-field select {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.2s;
    }
    
    .search-field input:focus, .search-field select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .search-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #f1f5f9;
      color: #334155;
    }
    
    .btn-secondary:hover {
      background: #e2e8f0;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
      transform: translateY(-2px);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    /* Search Results */
    .search-results {
      margin-top: 24px;
      display: none;
    }
    
    .search-results.show {
      display: block;
    }
    
    .result-card {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .result-card:hover {
      border-color: #667eea;
      background: white;
      transform: translateX(4px);
    }
    
    .result-card.selected {
      border-color: #667eea;
      background: #eff6ff;
    }
    
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }
    
    .result-name {
      font-weight: 600;
      font-size: 18px;
      color: #1e293b;
    }
    
    .result-score {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .score-critical {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .score-super-hot {
      background: #fed7aa;
      color: #9a3412;
    }
    
    .score-hot {
      background: #fef3c7;
      color: #92400e;
    }
    
    .score-warm {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .score-cold {
      background: #f1f5f9;
      color: #475569;
    }
    
    .result-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      font-size: 14px;
      color: #64748b;
    }
    
    .result-detail {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    /* Content Area */
    .content-area {
      background: white;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-height: 700px;
    }
    
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: #64748b;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e2e8f0;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .empty-state h3 {
      color: #1e293b;
      font-size: 24px;
      margin-bottom: 12px;
    }
    
    .empty-state p {
      font-size: 16px;
      line-height: 1.6;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid #e2e8f0;
      overflow-x: auto;
    }
    
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      color: #64748b;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .tab:hover {
      color: #2563eb;
    }
    
    .tab.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* CMA Generation Interface */
    .cma-generator {
      max-width: 1200px;
    }
    
    .cma-section {
      background: #f8fafc;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .cma-section h3 {
      color: #1e293b;
      font-size: 18px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }
    
    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-field label {
      font-weight: 600;
      color: #334155;
      font-size: 14px;
    }
    
    .form-field input, .form-field select, .form-field textarea {
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-field input:focus, .form-field select:focus, .form-field textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-field .help-text {
      font-size: 12px;
      color: #64748b;
    }
    
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .checkbox-item label {
      font-weight: normal;
      cursor: pointer;
    }
    
    /* Intelligence Display */
    .intelligence-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .intel-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 8px;
      padding: 20px;
      border-left: 4px solid #667eea;
    }
    
    .intel-card h4 {
      color: #334155;
      font-size: 14px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .intel-value {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
    }
    
    .intel-label {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }
    
    /* Admin Controls */
    .admin-controls {
      background: #fef3c7;
      border: 2px solid #fbbf24;
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 24px;
      display: none;
    }
    
    .admin-controls.show {
      display: block;
    }
    
    .admin-controls h3 {
      color: #92400e;
      font-size: 16px;
      margin-bottom: 12px;
    }
    
    .admin-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .admin-btn {
      padding: 10px 18px;
      background: white;
      border: 2px solid #fbbf24;
      border-radius: 6px;
      color: #92400e;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .admin-btn:hover {
      background: #fbbf24;
      color: white;
    }
    
    /* Error/Success Messages */
    .message {
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .message.show {
      display: block;
    }
    
    .message.error {
      background: #fee2e2;
      border: 2px solid #ef4444;
      color: #991b1b;
    }
    
    .message.success {
      background: #d1fae5;
      border: 2px solid #10b981;
      color: #065f46;
    }
    
    .message.warning {
      background: #fef3c7;
      border: 2px solid #fbbf24;
      color: #92400e;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 16px;
      }
      
      .search-grid {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1>üéØ WILLOW V50 Command Center</h1>
        <p>Intelligent Lead Management & CMA Generation</p>
      </div>
      <div class="header-right">
        <div class="user-info">
          <div class="user-name" id="userName">Loading...</div>
          <div class="user-role" id="userRole">Loading...</div>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    
    <!-- Admin Controls -->
    <div class="admin-controls" id="adminControls">
      <h3>‚ö° Admin Controls</h3>
      <div class="admin-actions">
        <button class="admin-btn" onclick="bulkOperations()">üì¶ Bulk Operations</button>
        <button class="admin-btn" onclick="systemSettings()">‚öôÔ∏è System Settings</button>
        <button class="admin-btn" onclick="userManagement()">üë• User Management</button>
        <button class="admin-btn" onclick="viewAuditLog()">üìã Audit Log</button>
      </div>
    </div>
    
    <!-- Search Panel -->
    <div class="search-panel">
      <h2>üîç Lead Search</h2>
      <div class="search-grid">
        <div class="search-field">
          <label for="leadId">FUB Lead ID</label>
          <input 
            type="text" 
            id="leadId" 
            placeholder="Enter Lead ID (e.g., 1429)"
            onkeypress="if(event.key==='Enter') searchLeads()"
          >
        </div>
        <div class="search-field">
          <label for="leadName">Name</label>
          <input 
            type="text" 
            id="leadName" 
            placeholder="Search by name"
            onkeypress="if(event.key==='Enter') searchLeads()"
          >
        </div>
        <div class="search-field">
          <label for="leadEmail">Email</label>
          <input 
            type="email" 
            id="leadEmail" 
            placeholder="Search by email"
            onkeypress="if(event.key==='Enter') searchLeads()"
          >
        </div>
        <div class="search-field">
          <label for="leadPhone">Phone</label>
          <input 
            type="tel" 
            id="leadPhone" 
            placeholder="Search by phone"
            onkeypress="if(event.key==='Enter') searchLeads()"
          >
        </div>
        <div class="search-field">
          <label for="priorityFilter">Priority Filter</label>
          <select id="priorityFilter">
            <option value="">All Priorities</option>
            <option value="CRITICAL">CRITICAL</option>
            <option value="SUPER_HOT">SUPER HOT</option>
            <option value="HOT">HOT</option>
            <option value="WARM">WARM</option>
            <option value="COLD">COLD</option>
          </select>
        </div>
        <div class="search-field">
          <label for="scoreFilter">Min Score</label>
          <input 
            type="number" 
            id="scoreFilter" 
            placeholder="Min behavioral score"
            min="0"
            max="100"
          >
        </div>
      </div>
      <div class="search-actions">
        <button class="btn btn-primary" onclick="searchLeads()">
          üîç Search Leads
        </button>
        <button class="btn btn-secondary" onclick="clearSearch()">
          Clear
        </button>
        <button class="btn btn-success" onclick="loadRecent()" style="margin-left: auto;">
          ‚ö° Load Recent
        </button>
      </div>
      
      <!-- Search Results -->
      <div class="search-results" id="searchResults"></div>
    </div>
    
    <!-- Messages -->
    <div class="message" id="messageBox"></div>
    
    <!-- Content Area -->
    <div class="content-area">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="intelligence" onclick="switchTab('intelligence')">
          üß† Intelligence
        </button>
        <button class="tab" data-tab="cma" onclick="switchTab('cma')">
          üìä CMA Generation
        </button>
        <button class="tab" data-tab="fub" onclick="switchTab('fub')">
          üíº FUB Sync
        </button>
        <button class="tab" data-tab="activity" onclick="switchTab('activity')">
          üìà Activity
        </button>
        <button class="tab" data-tab="actions" onclick="switchTab('actions')">
          ‚ö° Quick Actions
        </button>
      </div>
      
      <!-- Tab Content: Intelligence -->
      <div class="tab-content active" id="intelligence-tab">
        <div class="empty-state">
          <div class="empty-state-icon">üéØ</div>
          <h3>Ready to Load Intelligence</h3>
          <p>Search for a lead above to view complete behavioral intelligence,<br>ATTOM property data, and market analysis.</p>
        </div>
      </div>
      
      <!-- Tab Content: CMA Generation -->
      <div class="tab-content" id="cma-tab">
        <div class="cma-generator">
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <h3>CMA Generation Engine</h3>
            <p>Select a lead to access CMA generation tools.<br>Parameters will pre-fill from ATTOM property intelligence.</p>
          </div>
        </div>
      </div>
      
      <!-- Tab Content: FUB Sync -->
      <div class="tab-content" id="fub-tab">
        <div class="empty-state">
          <div class="empty-state-icon">üíº</div>
          <h3>FUB Custom Field Management</h3>
          <p>Update WILLOW custom fields, create tasks, add notes,<br>and sync CMA data to Follow Up Boss.</p>
        </div>
      </div>
      
      <!-- Tab Content: Activity -->
      <div class="tab-content" id="activity-tab">
        <div class="empty-state">
          <div class="empty-state-icon">üìà</div>
          <h3>Activity Timeline</h3>
          <p>View lead engagement history, email opens, property views,<br>and behavioral trigger patterns.</p>
        </div>
      </div>
      
      <!-- Tab Content: Actions -->
      <div class="tab-content" id="actions-tab">
        <div class="empty-state">
          <div class="empty-state-icon">‚ö°</div>
          <h3>Quick Actions</h3>
          <p>Partner assignment, email campaigns, task creation,<br>and bulk operations.</p>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // ==========================================
    // WILLOW V50 COMMAND CENTER - JAVASCRIPT
    // Glenn Fitzgerald's Digital Twin
    // 22 Years Real Estate Experience
    // ==========================================
    
    // Global State
    let currentUser = null;
    let currentLead = null;
    let authToken = null;
    let searchResults = [];
    
    // API Configuration
    const API_BASE = '/.netlify/functions';
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
    });
    
    // ==========================================
    // AUTHENTICATION
    // ==========================================
    
    function checkAuth() {
      authToken = localStorage.getItem('willow_token');
      const userStr = localStorage.getItem('willow_user');
      
      if (!authToken || !userStr) {
        window.location.href = '/login.html';
        return;
      }
      
      try {
        currentUser = JSON.parse(userStr);
        displayUserInfo();
        
        // Show admin controls if user is admin
        if (currentUser.role === 'admin') {
          document.getElementById('adminControls').classList.add('show');
        }
        
      } catch (error) {
        console.error('Error loading user info:', error);
        logout();
      }
    }
    
    function displayUserInfo() {
      document.getElementById('userName').textContent = currentUser.name;
      const roleElement = document.getElementById('userRole');
      roleElement.textContent = currentUser.role.toUpperCase();
      if (currentUser.role === 'admin') {
        roleElement.classList.add('admin');
      }
    }
    
    function logout() {
      localStorage.removeItem('willow_token');
      localStorage.removeItem('willow_user');
      window.location.href = '/login.html';
    }
    
    // ==========================================
    // LEAD SEARCH
    // ==========================================
    
    async function searchLeads() {
      const leadId = document.getElementById('leadId').value.trim();
      const leadName = document.getElementById('leadName').value.trim();
      const leadEmail = document.getElementById('leadEmail').value.trim();
      const leadPhone = document.getElementById('leadPhone').value.trim();
      const priority = document.getElementById('priorityFilter').value;
      const minScore = document.getElementById('scoreFilter').value;
      
      // Validate at least one search criterion
      if (!leadId && !leadName && !leadEmail && !leadPhone && !priority && !minScore) {
        showMessage('Please enter at least one search criterion', 'warning');
        return;
      }
      
      try {
        showLoading('Searching leads...');
        
        // If searching by ID, use direct lookup
        if (leadId) {
          await loadLeadById(leadId);
          return;
        }
        
        // Build query string
        let queryParams = [];
        if (leadName) queryParams.push(`name=${encodeURIComponent(leadName)}`);
        if (leadEmail) queryParams.push(`email=${encodeURIComponent(leadEmail)}`);
        if (leadPhone) queryParams.push(`phone=${encodeURIComponent(leadPhone)}`);
        if (priority) queryParams.push(`priority=${priority}`);
        if (minScore) queryParams.push(`minScore=${minScore}`);
        
        const response = await fetch(`${API_BASE}/lead-search?${queryParams.join('&')}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Accept': 'application/json'
          }
        });
        
        if (response.status === 401) {
          showMessage('Session expired. Please login again.', 'error');
          setTimeout(logout, 2000);
          return;
        }
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        searchResults = data.leads || [];
        
        displaySearchResults(searchResults);
        hideLoading();
        
      } catch (error) {
        console.error('Search error:', error);
        showMessage(`Search failed: ${error.message}`, 'error');
        hideLoading();
      }
    }
    
    function displaySearchResults(results) {
      const container = document.getElementById('searchResults');
      
      if (results.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 40px 20px;">
            <p>No leads found matching your search criteria.</p>
          </div>
        `;
        container.classList.add('show');
        return;
      }
      
      let html = `<h3 style="margin: 24px 0 16px 0; color: #1e293b;">Found ${results.length} lead${results.length > 1 ? 's' : ''}</h3>`;
      
      results.forEach(lead => {
        const score = lead.customFields?.customWILLOWBehavioralScore || 0;
        const priority = lead.customFields?.customWILLOWPriorityLevel || 'COLD';
        const scoreClass = getScoreClass(priority);
        
        html += `
          <div class="result-card" onclick="selectLead(${lead.id})">
            <div class="result-header">
              <div class="result-name">${escapeHtml(lead.name || 'No Name')}</div>
              <div class="result-score ${scoreClass}">
                ${priority} (${score})
              </div>
            </div>
            <div class="result-details">
              <div class="result-detail">üìß ${escapeHtml(lead.emails?.[0]?.value || 'No Email')}</div>
              <div class="result-detail">üì± ${escapeHtml(lead.phones?.[0]?.value || 'No Phone')}</div>
              <div class="result-detail">üè† ${escapeHtml(lead.customFields?.customFelloPropertyAddress || 'No Address')}</div>
              <div class="result-detail">üìÖ ${formatDate(lead.created)}</div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      container.classList.add('show');
    }
    
    function getScoreClass(priority) {
      const map = {
        'CRITICAL': 'score-critical',
        'SUPER_HOT': 'score-super-hot',
        'HOT': 'score-hot',
        'WARM': 'score-warm',
        'COLD': 'score-cold'
      };
      return map[priority] || 'score-cold';
    }
    
    async function selectLead(leadId) {
      // Remove previous selection
      document.querySelectorAll('.result-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // Add selection to clicked card
      event.currentTarget.classList.add('selected');
      
      // Load full intelligence
      await loadLeadById(leadId);
    }
    
    async function loadLeadById(leadId) {
      try {
        showLoading('Loading complete intelligence...');
        
        const response = await fetch(`${API_BASE}/willow-app?leadId=${leadId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Accept': 'text/html'
          }
        });
        
        if (response.status === 401) {
          showMessage('Session expired. Please login again.', 'error');
          setTimeout(logout, 2000);
          return;
        }
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const html = await response.text();
        
        // Store current lead
        currentLead = { id: leadId };
        
        // Display intelligence
        document.getElementById('intelligence-tab').innerHTML = html;
        
        // Load CMA interface
        await loadCMAInterface(leadId);
        
        // Load FUB sync interface
        await loadFUBInterface(leadId);
        
        // Switch to intelligence tab
        switchTab('intelligence');
        
        hideLoading();
        showMessage(`Loaded intelligence for lead ${leadId}`, 'success');
        
      } catch (error) {
        console.error('Load lead error:', error);
        showMessage(`Failed to load lead: ${error.message}`, 'error');
        hideLoading();
      }
    }
    
    async function loadRecent() {
      try {
        showLoading('Loading recent leads...');
        
        const response = await fetch(`${API_BASE}/lead-search?recent=20`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        searchResults = data.leads || [];
        
        displaySearchResults(searchResults);
        hideLoading();
        
      } catch (error) {
        console.error('Load recent error:', error);
        showMessage(`Failed to load recent leads: ${error.message}`, 'error');
        hideLoading();
      }
    }
    
    function clearSearch() {
      document.getElementById('leadId').value = '';
      document.getElementById('leadName').value = '';
      document.getElementById('leadEmail').value = '';
      document.getElementById('leadPhone').value = '';
      document.getElementById('priorityFilter').value = '';
      document.getElementById('scoreFilter').value = '';
      document.getElementById('searchResults').classList.remove('show');
      hideMessage();
    }
    
    // ==========================================
    // CMA GENERATION
    // ==========================================
    
    async function loadCMAInterface(leadId) {
      const cmaTab = document.getElementById('cma-tab');
      
      cmaTab.innerHTML = `
        <div class="cma-generator">
          <h2 style="margin-bottom: 24px; color: #1e293b;">üìä CMA Generation for Lead ${leadId}</h2>
          
          <!-- Property Information -->
          <div class="cma-section">
            <h3>üè† Property Information</h3>
            <div class="form-grid">
              <div class="form-field">
                <label>Street Address *</label>
                <input type="text" id="cma-address" placeholder="123 Main Street">
              </div>
              <div class="form-field">
                <label>City *</label>
                <input type="text" id="cma-city" placeholder="Poughkeepsie">
              </div>
              <div class="form-field">
                <label>State *</label>
                <input type="text" id="cma-state" value="NY" maxlength="2">
              </div>
              <div class="form-field">
                <label>ZIP Code *</label>
                <input type="text" id="cma-zip" placeholder="12601">
              </div>
            </div>
          </div>
          
          <!-- CMA Parameters (Glenn's 22-Year Expertise) -->
          <div class="cma-section">
            <h3>‚öôÔ∏è CMA Parameters (Pre-optimized for Hudson Valley)</h3>
            <div class="form-grid">
              <div class="form-field">
                <label>Search Radius (miles)</label>
                <input type="number" id="cma-radius" value="3" min="1" max="10" step="0.5">
                <span class="help-text">Glenn's default: 3 miles for Hudson Valley</span>
              </div>
              <div class="form-field">
                <label>Days Back (market data)</label>
                <input type="number" id="cma-daysback" value="180" min="90" max="365" step="30">
                <span class="help-text">Glenn's default: 180 days for current market</span>
              </div>
              <div class="form-field">
                <label>Number of Comparables</label>
                <input type="number" id="cma-comps" value="6" min="3" max="12">
                <span class="help-text">Glenn's default: 6 comps for optimal analysis</span>
              </div>
              <div class="form-field">
                <label>Price Variance (%)</label>
                <input type="number" id="cma-variance" value="15" min="5" max="30" step="5">
                <span class="help-text">Glenn's default: 15% for balanced range</span>
              </div>
            </div>
          </div>
          
          <!-- Advanced Options -->
          <div class="cma-section">
            <h3>üéØ Advanced Options</h3>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="cma-luxury">
                <label for="cma-luxury">Apply Luxury Property Protocol ($750K+)</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="cma-investment">
                <label for="cma-investment">Include Investment Analysis</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="cma-market">
                <label for="cma-market">Add Market Trend Analysis</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="cma-waterfront">
                <label for="cma-waterfront">Waterfront Property Adjustments</label>
              </div>
            </div>
          </div>
          
          <!-- CMA Actions -->
          <div class="search-actions">
            <button class="btn btn-primary" onclick="generateCMA()">
              üöÄ Generate CMA
            </button>
            <button class="btn btn-success" onclick="previewCMA()">
              üëÅÔ∏è Preview Parameters
            </button>
            <button class="btn btn-secondary" onclick="resetCMAForm()">
              Reset to Defaults
            </button>
          </div>
          
          <!-- CMA Result -->
          <div id="cma-result" style="margin-top: 24px;"></div>
        </div>
      `;
      
      // Pre-fill from ATTOM data if available (will implement extraction)
      // TODO: Extract address from intelligence display and pre-fill
    }
    
    async function generateCMA() {
      const address = document.getElementById('cma-address').value.trim();
      const city = document.getElementById('cma-city').value.trim();
      const state = document.getElementById('cma-state').value.trim();
      const zip = document.getElementById('cma-zip').value.trim();
      
      if (!address || !city || !state || !zip) {
        showMessage('Please fill in all required property fields', 'warning');
        return;
      }
      
      const params = {
        address: `${address}, ${city}, ${state} ${zip}`,
        radius: document.getElementById('cma-radius').value,
        daysBack: document.getElementById('cma-daysback').value,
        comparables: document.getElementById('cma-comps').value,
        priceVariance: document.getElementById('cma-variance').value,
        luxury: document.getElementById('cma-luxury').checked,
        investment: document.getElementById('cma-investment').checked,
        marketTrends: document.getElementById('cma-market').checked,
        waterfront: document.getElementById('cma-waterfront').checked,
        leadId: currentLead?.id
      };
      
      try {
        showLoading('Generating CMA with CloudCMA API...');
        
        const response = await fetch(`${API_BASE}/cloudcma-generate`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(params)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        // Display CMA result
        displayCMAResult(result);
        
        // Auto-sync to FUB
        if (currentLead?.id) {
          await syncCMAToFUB(currentLead.id, result);
        }
        
        hideLoading();
        showMessage('CMA generated successfully!', 'success');
        
      } catch (error) {
        console.error('CMA generation error:', error);
        showMessage(`CMA generation failed: ${error.message}`, 'error');
        hideLoading();
      }
    }
    
    function displayCMAResult(result) {
      const container = document.getElementById('cma-result');
      
      container.innerHTML = `
        <div class="cma-section" style="background: #eff6ff; border: 2px solid #2563eb;">
          <h3>‚úÖ CMA Generated Successfully</h3>
          <div class="intelligence-grid">
            <div class="intel-card">
              <h4>CMA ID</h4>
              <div class="intel-value">${result.cma_id || 'N/A'}</div>
            </div>
            <div class="intel-card">
              <h4>Status</h4>
              <div class="intel-value">${result.status || 'Processing'}</div>
            </div>
            <div class="intel-card">
              <h4>Estimated Value</h4>
              <div class="intel-value">$${(result.estimated_value || 0).toLocaleString()}</div>
            </div>
            <div class="intel-card">
              <h4>Comparables Found</h4>
              <div class="intel-value">${result.comps_count || 0}</div>
            </div>
          </div>
          <div class="search-actions" style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="window.open('${result.cma_url}', '_blank')">
              üìÑ View Full CMA
            </button>
            <button class="btn btn-success" onclick="emailCMA('${result.cma_url}')">
              üìß Email to Lead
            </button>
          </div>
        </div>
      `;
    }
    
    function previewCMA() {
      const address = document.getElementById('cma-address').value.trim();
      const params = {
        address: address,
        radius: document.getElementById('cma-radius').value,
        daysBack: document.getElementById('cma-daysback').value,
        comparables: document.getElementById('cma-comps').value,
        priceVariance: document.getElementById('cma-variance').value
      };
      
      alert(`CMA Parameters Preview:\n\nAddress: ${params.address}\nRadius: ${params.radius} miles\nDays Back: ${params.daysBack}\nComparables: ${params.comparables}\nPrice Variance: ${params.priceVariance}%`);
    }
    
    function resetCMAForm() {
      document.getElementById('cma-radius').value = '3';
      document.getElementById('cma-daysback').value = '180';
      document.getElementById('cma-comps').value = '6';
      document.getElementById('cma-variance').value = '15';
      document.getElementById('cma-luxury').checked = false;
      document.getElementById('cma-investment').checked = false;
      document.getElementById('cma-market').checked = false;
      document.getElementById('cma-waterfront').checked = false;
    }
    
    // ==========================================
    // FUB SYNC
    // ==========================================
    
    async function loadFUBInterface(leadId) {
      const fubTab = document.getElementById('fub-tab');
      
      fubTab.innerHTML = `
        <div style="max-width: 1200px;">
          <h2 style="margin-bottom: 24px; color: #1e293b;">üíº FUB Custom Field Management - Lead ${leadId}</h2>
          
          <!-- WILLOW Fields (Write-Enabled) -->
          <div class="cma-section">
            <h3>‚úèÔ∏è WILLOW Custom Fields (22 Write-Enabled)</h3>
            <p style="color: #64748b; margin-bottom: 16px;">Update behavioral intelligence and CMA data in Follow Up Boss</p>
            <div class="form-grid">
              <div class="form-field">
                <label>Behavioral Score (0-100)</label>
                <input type="number" id="fub-score" min="0" max="100" placeholder="Auto-calculated">
              </div>
              <div class="form-field">
                <label>Priority Level</label>
                <select id="fub-priority">
                  <option value="">Auto-calculated</option>
                  <option value="CRITICAL">CRITICAL</option>
                  <option value="SUPER_HOT">SUPER HOT</option>
                  <option value="HOT">HOT</option>
                  <option value="WARM">WARM</option>
                  <option value="COLD">COLD</option>
                </select>
              </div>
              <div class="form-field">
                <label>CMA Generated</label>
                <input type="text" id="fub-cma-generated" placeholder="YYYY-MM-DD">
              </div>
              <div class="form-field">
                <label>CMA Link</label>
                <input type="url" id="fub-cma-link" placeholder="https://...">
              </div>
              <div class="form-field">
                <label>Assigned Partner</label>
                <select id="fub-partner">
                  <option value="">Select Partner</option>
                  <option value="Glenn">Glenn Fitzgerald</option>
                  <option value="Justin">Justin</option>
                  <option value="Heather">Heather</option>
                  <option value="Lloyd">Lloyd</option>
                </select>
              </div>
              <div class="form-field">
                <label>Market Timing</label>
                <input type="text" id="fub-market-timing" placeholder="Q1 2025">
              </div>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="cma-section">
            <h3>‚ö° Quick FUB Actions</h3>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="fub-create-task">
                <label for="fub-create-task">Create Follow-Up Task</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="fub-add-note">
                <label for="fub-add-note">Add Intelligence Note</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="fub-send-email">
                <label for="fub-send-email">Send CMA Email</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="fub-update-stage">
                <label for="fub-update-stage">Update Lead Stage</label>
              </div>
            </div>
          </div>
          
          <!-- FUB Actions -->
          <div class="search-actions">
            <button class="btn btn-primary" onclick="syncToFUB()">
              üíæ Sync to FUB
            </button>
            <button class="btn btn-success" onclick="viewFUBFields()">
              üëÅÔ∏è View Current Fields
            </button>
            <button class="btn btn-secondary" onclick="refreshFUBData()">
              üîÑ Refresh from FUB
            </button>
          </div>
          
          <!-- Sync Result -->
          <div id="fub-result" style="margin-top: 24px;"></div>
        </div>
      `;
    }
    
    async function syncToFUB() {
      if (!currentLead?.id) {
        showMessage('No lead selected', 'warning');
        return;
      }
      
      const updates = {
        leadId: currentLead.id,
        customFields: {
          customWILLOWBehavioralScore: document.getElementById('fub-score').value,
          customWILLOWPriorityLevel: document.getElementById('fub-priority').value,
          customWILLOWCMAGenerated: document.getElementById('fub-cma-generated').value,
          customWILLOWCMALink: document.getElementById('fub-cma-link').value,
          customWILLOWAssignedPartner: document.getElementById('fub-partner').value,
          customWILLOWMarketTiming: document.getElementById('fub-market-timing').value,
          customWILLOWLastAnalyzed: new Date().toISOString().split('T')[0]
        },
        actions: {
          createTask: document.getElementById('fub-create-task').checked,
          addNote: document.getElementById('fub-add-note').checked,
          sendEmail: document.getElementById('fub-send-email').checked,
          updateStage: document.getElementById('fub-update-stage').checked
        }
      };
      
      try {
        showLoading('Syncing to Follow Up Boss...');
        
        const response = await fetch(`${API_BASE}/fub-sync`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        document.getElementById('fub-result').innerHTML = `
          <div class="cma-section" style="background: #d1fae5; border: 2px solid #10b981;">
            <h3>‚úÖ Successfully Synced to FUB</h3>
            <p style="color: #065f46;">Updated ${result.fieldsUpdated || 0} custom fields and completed ${result.actionsCompleted || 0} actions.</p>
          </div>
        `;
        
        hideLoading();
        showMessage('FUB sync completed successfully!', 'success');
        
      } catch (error) {
        console.error('FUB sync error:', error);
        showMessage(`FUB sync failed: ${error.message}`, 'error');
        hideLoading();
      }
    }
    
    async function syncCMAToFUB(leadId, cmaResult) {
      // Auto-sync CMA data after generation
      const updates = {
        leadId: leadId,
        customFields: {
          customWILLOWCMAGenerated: new Date().toISOString().split('T')[0],
          customWILLOWCMALink: cmaResult.cma_url,
          customWILLOWLastAnalyzed: new Date().toISOString().split('T')[0]
        }
      };
      
      try {
        const response = await fetch(`${API_BASE}/fub-sync`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updates)
        });
        
        if (response.ok) {
          console.log('CMA auto-synced to FUB');
        }
      } catch (error) {
        console.error('CMA auto-sync error:', error);
      }
    }
    
    async function viewFUBFields() {
      showMessage('Loading current FUB fields...', 'success');
      // TODO: Implement FUB field viewer
    }
    
    async function refreshFUBData() {
      showLoading('Refreshing from FUB...');
      // TODO: Implement FUB data refresh
      setTimeout(() => {
        hideLoading();
        showMessage('FUB data refreshed', 'success');
      }, 1000);
    }
    
    // ==========================================
    // ADMIN FUNCTIONS
    // ==========================================
    
    function bulkOperations() {
      if (currentUser.role !== 'admin') {
        showMessage('Admin access required', 'error');
        return;
      }
      
      showMessage('Bulk operations interface coming soon', 'success');
      // TODO: Implement bulk operations
    }
    
    function systemSettings() {
      if (currentUser.role !== 'admin') {
        showMessage('Admin access required', 'error');
        return;
      }
      
      showMessage('System settings interface coming soon', 'success');
      // TODO: Implement system settings
    }
    
    function userManagement() {
      if (currentUser.role !== 'admin') {
        showMessage('Admin access required', 'error');
        return;
      }
      
      showMessage('User management interface coming soon', 'success');
      // TODO: Implement user management
    }
    
    function viewAuditLog() {
      if (currentUser.role !== 'admin') {
        showMessage('Admin access required', 'error');
        return;
      }
      
      showMessage('Audit log viewer coming soon', 'success');
      // TODO: Implement audit log viewer
    }
    
    // ==========================================
    // UI HELPERS
    // ==========================================
    
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }
    
    function showLoading(message) {
      const container = document.getElementById('intelligence-tab');
      container.innerHTML = `
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>${message}</p>
        </div>
      `;
    }
    
    function hideLoading() {
      // Loading will be replaced by actual content
    }
    
    function showMessage(text, type = 'success') {
      const box = document.getElementById('messageBox');
      box.textContent = text;
      box.className = `message ${type} show`;
      
      setTimeout(() => {
        box.classList.remove('show');
      }, 5000);
    }
    
    function hideMessage() {
      document.getElementById('messageBox').classList.remove('show');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      const date = new Date(dateStr);
      return date.toLocaleDateString();
    }
    
    function emailCMA(cmaUrl) {
      if (!currentLead?.id) {
        showMessage('No lead selected', 'warning');
        return;
      }
      
      showMessage('Email CMA feature coming soon', 'success');
      // TODO: Implement email CMA functionality
    }
  </script>
</body>
</html>

<style>
/* Smart CMA Interface Styles */
.param-control {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
}

.param-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.param-header label {
  font-weight: 600;
  color: #1e293b;
  font-size: 16px;
}

.smart-badge {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.param-input-group {
  display: flex;
  align-items: center;
  gap: 12px;
}

.param-input-group input[type="range"] {
  flex: 1;
  height: 6px;
  border-radius: 3px;
  background: #e2e8f0;
  outline: none;
}

.param-input-group input[type="range"]::-webkit-slider-thumb {
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.param-input-group input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.param-input-group input[type="number"] {
  width: 80px;
  padding: 8px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  font-size: 15px;
  font-weight: 600;
  text-align: center;
}

.param-unit {
  color: #64748b;
  font-size: 14px;
  font-weight: 600;
  min-width: 50px;
}

.param-reasoning {
  margin-top: 12px;
  padding: 12px;
  background: #f8fafc;
  border-left: 3px solid #667eea;
  border-radius: 4px;
}

.param-reasoning small {
  color: #475569;
  line-height: 1.5;
}

.confidence-badge {
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.confidence-badge.high {
  background: #d1fae5;
  color: #065f46;
  border: 2px solid #10b981;
}

.confidence-badge.medium {
  background: #fef3c7;
  color: #92400e;
  border: 2px solid #fbbf24;
}

.confidence-badge.low {
  background: #fee2e2;
  color: #991b1b;
  border: 2px solid #ef4444;
}

.smart-banner {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border: 2px solid #3b82f6;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  display: flex;
  align-items: start;
  gap: 16px;
}

.smart-banner-icon {
  font-size: 32px;
}

.smart-banner-content strong {
  display: block;
  color: #1e40af;
  font-size: 16px;
  margin-bottom: 6px;
}

.smart-banner-content p {
  color: #1e40af;
  font-size: 14px;
  line-height: 1.6;
  margin: 0;
}
</style>
