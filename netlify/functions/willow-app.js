/**
 * WILLOW V50 FUB Embedded App - Netlify Function
 * LAZY LOAD ARCHITECTURE: User clicks button to load intelligence
 * Fixed circular dependency in getMockTriggeredPatterns()
 */

const crypto = require('crypto');

const FUB_API_KEY = process.env.FUB_API_KEY || 'fka_0oHt62NxmsExO6x69p08ix82zx8ii1hzrj';
const FUB_SECRET_KEY = process.env.FUB_SECRET_KEY || 'f1e0c6af664bc1525ecd8fecba255235';
const CLOUDCMA_API_KEY = process.env.CLOUDCMA_API_KEY || '742f4a46e1780904da090d721a9bae7b';

const HTML_TEMPLATE_B64 = 'PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0idXRmLTgiPgogIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wIj4KICA8dGl0bGU+V0lMTE9XIFY1MCBJbnRlbGxpZ2VuY2UgU3lzdGVtPC90aXRsZT4KICA8IS0tIENSSVRJQ0FMOiBObyBYLUZyYW1lLU9wdGlvbnMgaGVhZGVyIGZvciBGVUIgY29tcGxpYW5jZSAtLT4KICA8c3R5bGU+CiAgICAvKiBGb2xsb3cgVXAgQm9zcyBTdHlsZSBDb21wbGlhbmNlICovCiAgICA6cm9vdCB7CiAgICAgIC0tZnViLXByaW1hcnk6ICMyNTYzZWI7CiAgICAgIC0tZnViLXNlY29uZGFyeTogIzY0NzQ4YjsKICAgICAgLS1mdWItc3VjY2VzczogIzE2YTM0YTsKICAgICAgLS1mdWItd2FybmluZzogI2VhYjMwODsKICAgICAgLS1mdWItZGFuZ2VyOiAjZGMyNjI2OwogICAgICAtLWZ1Yi1iYWNrZ3JvdW5kOiAjZjhmYWZjOwogICAgICAtLWZ1Yi1jYXJkOiAjZmZmZmZmOwogICAgICAtLWZ1Yi1ib3JkZXI6ICNlMmU4ZjA7CiAgICAgIC0tZnViLXRleHQ6ICMwZjE3MmE7CiAgICAgIC0tZnViLXRleHQtbXV0ZWQ6ICM2NDc0OGI7CiAgICB9CgogICAgKiB7CiAgICAgIG1hcmdpbjogMDsKICAgICAgcGFkZGluZzogMDsKICAgICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIH0KCiAgICBib2R5IHsKICAgICAgZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgJ1NlZ29lIFVJJywgUm9ib3RvLCBzYW5zLXNlcmlmOwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYmFja2dyb3VuZCk7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dCk7CiAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgbGluZS1oZWlnaHQ6IDEuNTsKICAgIH0KCiAgICAjd2lsbG93LWNvbnRhaW5lciB7CiAgICAgIGJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsKICAgICAgbWluLWhlaWdodDogNjAwcHg7CiAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgYm94LXNoYWRvdzogMCAxcHggM3B4IHJnYmEoMCwwLDAsMC4xKTsKICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIH0KCiAgICAvKiBUYWIgTmF2aWdhdGlvbiAqLwogICAgI3dpbGxvdy10YWJzIHsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOwogICAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7CiAgICAgIHBhZGRpbmc6IDA7CiAgICAgIG1hcmdpbjogMDsKICAgICAgZmxleC1zaHJpbms6IDA7CiAgICB9CgogICAgLnRhYi1idXR0b24gewogICAgICBmbGV4OiAxOwogICAgICBwYWRkaW5nOiAxMnB4IDhweDsKICAgICAgYm9yZGVyOiBub25lOwogICAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICBmb250LXNpemU6IDEzcHg7CiAgICAgIGZvbnQtd2VpZ2h0OiA1MDA7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItc2Vjb25kYXJ5KTsKICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnMgZWFzZTsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKICAgIH0KCiAgICAudGFiLWJ1dHRvbjpob3ZlciB7CiAgICAgIGJhY2tncm91bmQ6IHJnYmEoMzcsIDk5LCAyMzUsIDAuMDUpOwogICAgfQoKICAgIC50YWItYnV0dG9uLmFjdGl2ZSB7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGJhY2tncm91bmQ6IHJnYmEoMzcsIDk5LCAyMzUsIDAuMDUpOwogICAgfQoKICAgIC8qIENvbnRlbnQgQXJlYSAqLwogICAgI3dpbGxvdy1jb250ZW50IHsKICAgICAgZmxleDogMTsKICAgICAgcGFkZGluZzogMjBweDsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOwogICAgICBvdmVyZmxvdy15OiBhdXRvOwogICAgICBtYXgtaGVpZ2h0OiA1NTBweDsKICAgIH0KCiAgICAvKiBMb2FkaW5nIFN0YXRlICovCiAgICAubG9hZGluZyB7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICBoZWlnaHQ6IDIwMHB4OwogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgfQoKICAgIC5sb2FkaW5nOjphZnRlciB7CiAgICAgIGNvbnRlbnQ6ICcnOwogICAgICB3aWR0aDogMjBweDsKICAgICAgaGVpZ2h0OiAyMHB4OwogICAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHZhcigtLWZ1Yi1wcmltYXJ5KTsKICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICBhbmltYXRpb246IHNwaW4gMXMgbGluZWFyIGluZmluaXRlOwogICAgICBtYXJnaW4tbGVmdDogMTBweDsKICAgIH0KCiAgICBAa2V5ZnJhbWVzIHNwaW4gewogICAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDBkZWcpOyB9CiAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpOyB9CiAgICB9CgogICAgLyogSW50ZWxsaWdlbmNlIERhc2hib2FyZCAqLwogICAgLnNjb3JlLXNlY3Rpb24gewogICAgICBkaXNwbGF5OiBncmlkOwogICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IGF1dG8gMWZyOwogICAgICBnYXA6IDIwcHg7CiAgICAgIG1hcmdpbi1ib3R0b206IDI1cHg7CiAgICAgIHBhZGRpbmc6IDIwcHg7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICNmOGZhZmMgMCUsICNlMmU4ZjAgMTAwJSk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOwogICAgfQoKICAgIC5zY29yZS1nYXVnZSB7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGdhcDogMTBweDsKICAgIH0KCiAgICAuZ2F1Z2UtY2lyY2xlIHsKICAgICAgd2lkdGg6IDEwMHB4OwogICAgICBoZWlnaHQ6IDEwMHB4OwogICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgIGJhY2tncm91bmQ6IGNvbmljLWdyYWRpZW50KHZhcigtLWZ1Yi1wcmltYXJ5KSAwZGVnLCB2YXIoLS1mdWItcHJpbWFyeSkgY2FsYyh2YXIoLS1zY29yZS1wZXJjZW50KSAqIDMuNmRlZyksIHZhcigtLWZ1Yi1ib3JkZXIpIGNhbGModmFyKC0tc2NvcmUtcGVyY2VudCkgKiAzLjZkZWcpLCB2YXIoLS1mdWItYm9yZGVyKSAzNjBkZWcpOwogICAgICBkaXNwbGF5OiBmbGV4OwogICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgfQoKICAgIC5nYXVnZS1jaXJjbGU6OmJlZm9yZSB7CiAgICAgIGNvbnRlbnQ6ICcnOwogICAgICB3aWR0aDogNzBweDsKICAgICAgaGVpZ2h0OiA3MHB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgfQoKICAgIC5zY29yZS12YWx1ZSB7CiAgICAgIGZvbnQtc2l6ZTogMjRweDsKICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIHotaW5kZXg6IDE7CiAgICB9CgogICAgLnNjb3JlLWxhYmVsIHsKICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgICB6LWluZGV4OiAxOwogICAgfQoKICAgIC5wcmlvcml0eS1iYWRnZSB7CiAgICAgIHBhZGRpbmc6IDZweCAxMnB4OwogICAgICBib3JkZXItcmFkaXVzOiAyMHB4OwogICAgICBmb250LXNpemU6IDEycHg7CiAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgfQoKICAgIC5wcmlvcml0eS1iYWRnZS5jcml0aWNhbCB7IGJhY2tncm91bmQ6ICNmZWYyZjI7IGNvbG9yOiAjZGMyNjI2OyB9CiAgICAucHJpb3JpdHktYmFkZ2Uuc3VwZXJfaG90IHsgYmFja2dyb3VuZDogI2ZmZjdlZDsgY29sb3I6ICNlYTU4MGM7IH0KICAgIC5wcmlvcml0eS1iYWRnZS5ob3QgeyBiYWNrZ3JvdW5kOiAjZmVmY2U4OyBjb2xvcjogI2NhOGEwNDsgfQogICAgLnByaW9yaXR5LWJhZGdlLndhcm0geyBiYWNrZ3JvdW5kOiAjZjBmZGY0OyBjb2xvcjogIzE2YTM0YTsgfQogICAgLnByaW9yaXR5LWJhZGdlLmNvbGQgeyBiYWNrZ3JvdW5kOiAjZjhmYWZjOyBjb2xvcjogIzY0NzQ4YjsgfQoKICAgIC5zY29yZS1jb21wb25lbnRzIHsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgZ2FwOiAxMnB4OwogICAgICBmbGV4OiAxOwogICAgfQoKICAgIC5jb21wb25lbnQgewogICAgICBkaXNwbGF5OiBncmlkOwogICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDEwMHB4IDYwcHggMWZyOwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICBnYXA6IDEwcHg7CiAgICAgIHBhZGRpbmc6IDhweCAxMnB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7CiAgICB9CgogICAgLmNvbXBvbmVudCBsYWJlbCB7CiAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgZm9udC13ZWlnaHQ6IDUwMDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi10ZXh0KTsKICAgIH0KCiAgICAuY29tcG9uZW50IHZhbHVlIHsKICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICBmb250LXdlaWdodDogYm9sZDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi1wcmltYXJ5KTsKICAgIH0KCiAgICAuY29tcG9uZW50IGJhciB7CiAgICAgIGhlaWdodDogNnB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgYm9yZGVyLXJhZGl1czogM3B4OwogICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB9CgogICAgLmNvbXBvbmVudCBiYXI6OmJlZm9yZSB7CiAgICAgIGNvbnRlbnQ6ICcnOwogICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgIHRvcDogMDsKICAgICAgbGVmdDogMDsKICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDNweDsKICAgICAgd2lkdGg6IHZhcigtLWJhci13aWR0aCwgMCUpOwogICAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjVzIGVhc2U7CiAgICB9CgogICAgLyogUXVpY2sgQWN0aW9ucyBTaWRlYmFyICovCiAgICAucXVpY2stYWN0aW9ucyB7CiAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgdG9wOiAyMHB4OwogICAgICByaWdodDogMjBweDsKICAgICAgd2lkdGg6IDI1MHB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOwogICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDZweCByZ2JhKDAsMCwwLDAuMSk7CiAgICAgIHotaW5kZXg6IDEwMDA7CiAgICAgIG1heC1oZWlnaHQ6IDQwMHB4OwogICAgICBvdmVyZmxvdy15OiBhdXRvOwogICAgfQoKICAgIC5xdWljay1hY3Rpb25zIGgzIHsKICAgICAgcGFkZGluZzogMTVweDsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLXByaW1hcnkpOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgbWFyZ2luOiAwOwogICAgfQoKICAgIC5hY3Rpb24taXRlbSB7CiAgICAgIHBhZGRpbmc6IDEycHggMTVweDsKICAgICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOwogICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQgMC4yczsKICAgIH0KCiAgICAuYWN0aW9uLWl0ZW06aG92ZXIgewogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYmFja2dyb3VuZCk7CiAgICB9CgogICAgLmFjdGlvbi1pdGVtOmxhc3QtY2hpbGQgewogICAgICBib3JkZXItYm90dG9tOiBub25lOwogICAgfQoKICAgIC5hY3Rpb24tcHJpb3JpdHkgewogICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICAgIHdpZHRoOiA4cHg7CiAgICAgIGhlaWdodDogOHB4OwogICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgIG1hcmdpbi1yaWdodDogOHB4OwogICAgfQoKICAgIC5hY3Rpb24tcHJpb3JpdHkuY3JpdGljYWwgeyBiYWNrZ3JvdW5kOiAjZGMyNjI2OyB9CiAgICAuYWN0aW9uLXByaW9yaXR5LnN1cGVyX2hvdCB7IGJhY2tncm91bmQ6ICNlYTU4MGM7IH0KICAgIC5hY3Rpb24tcHJpb3JpdHkuaG90IHsgYmFja2dyb3VuZDogI2NhOGEwNDsgfQoKICAgIC5hY3Rpb24tdGV4dCB7CiAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi10ZXh0KTsKICAgIH0KCiAgICAuYWN0aW9uLWNvdW50IHsKICAgICAgZmxvYXQ6IHJpZ2h0OwogICAgICBmb250LXNpemU6IDExcHg7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7CiAgICAgIGJhY2tncm91bmQ6IHZhcigtLWZ1Yi1iYWNrZ3JvdW5kKTsKICAgICAgcGFkZGluZzogMnB4IDZweDsKICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIH0KCiAgICAvKiBQYXR0ZXJuIEl0ZW1zICovCiAgICAucGF0dGVybnMtc2VjdGlvbiB7CiAgICAgIG1hcmdpbi1ib3R0b206IDI1cHg7CiAgICB9CgogICAgLnBhdHRlcm5zLXNlY3Rpb24gaDMgewogICAgICBmb250LXNpemU6IDE2cHg7CiAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dCk7CiAgICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgcGFkZGluZy1ib3R0b206IDhweDsKICAgIH0KCiAgICAucGF0dGVybi1pdGVtIHsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOwogICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICBwYWRkaW5nOiAxNXB4OwogICAgICBtYXJnaW4tYm90dG9tOiAxMnB4OwogICAgICB0cmFuc2l0aW9uOiBib3JkZXItY29sb3IgMC4yczsKICAgIH0KCiAgICAucGF0dGVybi1pdGVtOmhvdmVyIHsKICAgICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICB9CgogICAgLnBhdHRlcm4taGVhZGVyIHsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgZ2FwOiAxMHB4OwogICAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB9CgogICAgLnBhdHRlcm4taWNvbiB7CiAgICAgIGZvbnQtc2l6ZTogMThweDsKICAgIH0KCiAgICAucGF0dGVybi1uYW1lIHsKICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi10ZXh0KTsKICAgICAgZmxleDogMTsKICAgIH0KCiAgICAuY29udmVyc2lvbi1yYXRlIHsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLXN1Y2Nlc3MpOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIHBhZGRpbmc6IDJweCA4cHg7CiAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgIGZvbnQtc2l6ZTogMTFweDsKICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICB9CgogICAgLnBhdHRlcm4tZGVzY3JpcHRpb24gewogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgICBmb250LXNpemU6IDEzcHg7CiAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgIGxpbmUtaGVpZ2h0OiAxLjQ7CiAgICB9CgogICAgLmFjdGlvbi1idG4gewogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgYm9yZGVyOiBub25lOwogICAgICBwYWRkaW5nOiA4cHggMTZweDsKICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgZm9udC13ZWlnaHQ6IDUwMDsKICAgICAgdHJhbnNpdGlvbjogYmFja2dyb3VuZCAwLjJzOwogICAgfQoKICAgIC5hY3Rpb24tYnRuOmhvdmVyIHsKICAgICAgYmFja2dyb3VuZDogIzFkNGVkODsKICAgIH0KCiAgICAvKiBFcnJvci9EZWJ1ZyBTdGF0ZXMgKi8KICAgIC5kZWJ1Zy1zdGF0ZSB7CiAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgcGFkZGluZzogNDBweCAyMHB4OwogICAgfQoKICAgIC5kZWJ1Zy1zdGF0ZSBoMiB7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dCk7CiAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICB9CgogICAgLmRlYnVnLXN0YXRlIHAgewogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgICBtYXJnaW4tYm90dG9tOiAyMHB4OwogICAgfQoKICAgIC5kZWJ1Zy1idG4gewogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgYm9yZGVyOiBub25lOwogICAgICBwYWRkaW5nOiAxMHB4IDIwcHg7CiAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICBmb250LXNpemU6IDE0cHg7CiAgICB9CgogICAgLyogUmVzcG9uc2l2ZSBEZXNpZ24gKi8KICAgIEBtZWRpYSAobWF4LXdpZHRoOiA3NjhweCkgewogICAgICAjd2lsbG93LWNvbnRhaW5lciB7CiAgICAgICAgbWFyZ2luOiAwOwogICAgICAgIGJvcmRlci1yYWRpdXM6IDA7CiAgICAgICAgbWluLWhlaWdodDogMTAwdmg7CiAgICAgIH0KCiAgICAgIC50YWItYnV0dG9uIHsKICAgICAgICBwYWRkaW5nOiAxMHB4IDZweDsKICAgICAgICBmb250LXNpemU6IDExcHg7CiAgICAgIH0KCiAgICAgIC5zY29yZS1zZWN0aW9uIHsKICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmcjsKICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgIH0KCiAgICAgIC5jb21wb25lbnQgewogICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogODBweCA1MHB4IDFmcjsKICAgICAgICBmb250LXNpemU6IDExcHg7CiAgICAgIH0KCiAgICAgIC5xdWljay1hY3Rpb25zIHsKICAgICAgICBkaXNwbGF5OiBub25lOyAvKiBIaWRlIG9uIG1vYmlsZSAqLwogICAgICB9CiAgICB9CgogICAgLyogSGlkZGVuIGJ5IGRlZmF1bHQgKi8KICAgIC50YWItY29udGVudCB7CiAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICB9CgogICAgLnRhYi1jb250ZW50LmFjdGl2ZSB7CiAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgfQogICAgLyogU3Bpbm5lciBhbmltYXRpb24gZm9yIGxvYWRpbmcgc3RhdGUgKi8KICAgIEBrZXlmcmFtZXMgc3BpbiB7CiAgICAgIDAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0KICAgICAgMTAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0KICAgIH0KICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgogIDwhLS0gUkVRVUlSRUQgRlVCIEludGVncmF0aW9uIC0tPgogIDxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiBzcmM9Imh0dHBzOi8vZWlhLmZvbGxvd3VwYm9zcy5jb20vZW1iZWRkZWRBcHBzLXYxLjAuMC5qcyI+PC9zY3JpcHQ+CgogIDxkaXYgaWQ9IndpbGxvdy1jb250YWluZXIiPgogICAgPCEtLSBOYXZpZ2F0aW9uIFRhYnMgLS0+CiAgICA8bmF2IGlkPSJ3aWxsb3ctdGFicyI+CiAgICAgIDxidXR0b24gY2xhc3M9InRhYi1idXR0b24gYWN0aXZlIiBkYXRhLXRhYj0iaW50ZWxsaWdlbmNlIj7wn46vIEludGVsbGlnZW5jZTwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIiBkYXRhLXRhYj0iY21hIj7wn5OIIENNQTwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIiBkYXRhLXRhYj0iYW5hbHl0aWNzIj7wn5OKIEFuYWx5dGljczwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIiBkYXRhLXRhYj0icGFydG5lcnMiPvCfpJ0gUGFydG5lcnM8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBjbGFzcz0idGFiLWJ1dHRvbiIgZGF0YS10YWI9InByb3BlcnR5Ij7wn4+gIFByb3BlcnR5PC9idXR0b24+CiAgICAgIDxidXR0b24gY2xhc3M9InRhYi1idXR0b24iIGRhdGEtdGFiPSJjb21tdW5pY2F0aW9uIj7wn5OnIENvbW11bmljYXRpb248L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBjbGFzcz0idGFiLWJ1dHRvbiIgZGF0YS10YWI9Im1hbmFnZW1lbnQiPuKame+4jyBTeXN0ZW08L2J1dHRvbj4KICAgIDwvbmF2PgoKICAgIDwhLS0gQ29udGVudCBBcmVhIC0tPgogICAgPG1haW4gaWQ9IndpbGxvdy1jb250ZW50Ij4KICAgICAgCiAgICAgIDwhLS0gSW50ZWxsaWdlbmNlIERhc2hib2FyZCBUYWIgLS0+CiAgICAgIDxkaXYgaWQ9ImludGVsbGlnZW5jZS1jb250ZW50IiBjbGFzcz0idGFiLWNvbnRlbnQgYWN0aXZlIj4KICAgICAgICA8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIFdJTExPVyBJbnRlbGxpZ2VuY2U8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8IS0tIENNQSBHZW5lcmF0aW9uIFRhYiAtLT4KICAgICAgPGRpdiBpZD0iY21hLWNvbnRlbnQiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+TG9hZGluZyBDTUEgU3lzdGVtPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgPCEtLSBBbmFseXRpY3MgVGFiIC0tPgogICAgICA8ZGl2IGlkPSJhbmFseXRpY3MtY29udGVudCIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIEFuYWx5dGljczwvZGl2PgogICAgICA8L2Rpdj4KCiAgICAgIDwhLS0gUGFydG5lcnMgVGFiIC0tPgogICAgICA8ZGl2IGlkPSJwYXJ0bmVycy1jb250ZW50IiBjbGFzcz0idGFiLWNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcgUGFydG5lciBTeXN0ZW08L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8IS0tIFByb3BlcnR5IFRhYiAtLT4KICAgICAgPGRpdiBpZD0icHJvcGVydHktY29udGVudCIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIFByb3BlcnR5IEludGVsbGlnZW5jZTwvZGl2PgogICAgICA8L2Rpdj4KCiAgICAgIDwhLS0gQ29tbXVuaWNhdGlvbiBUYWIgLS0+CiAgICAgIDxkaXYgaWQ9ImNvbW11bmljYXRpb24tY29udGVudCIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIENvbW11bmljYXRpb24gQ2VudGVyPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgPCEtLSBNYW5hZ2VtZW50IFRhYiAtLT4KICAgICAgPGRpdiBpZD0ibWFuYWdlbWVudC1jb250ZW50IiBjbGFzcz0idGFiLWNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcgU3lzdGVtIE1hbmFnZW1lbnQ8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgPC9tYWluPgogIDwvZGl2PgoKICA8IS0tIFF1aWNrIEFjdGlvbnMgU2lkZWJhciAtLT4KICA8ZGl2IGNsYXNzPSJxdWljay1hY3Rpb25zIiBpZD0icXVpY2stYWN0aW9ucyIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7Ij4KICAgIDxoMz7imqEgUXVpY2sgQWN0aW9uczwvaDM+CiAgICA8ZGl2IGlkPSJxdWljay1hY3Rpb25zLWNvbnRlbnQiPgogICAgICA8ZGl2IGNsYXNzPSJhY3Rpb24taXRlbSI+CiAgICAgICAgPHNwYW4gY2xhc3M9ImFjdGlvbi1wcmlvcml0eSBjcml0aWNhbCI+PC9zcGFuPgogICAgICAgIDxzcGFuIGNsYXNzPSJhY3Rpb24tdGV4dCI+TG9hZGluZyBhY3Rpb25zLi4uPC9zcGFuPgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogIDwvZGl2PgoKICA8c2NyaXB0PgogICAgLyoqCiAgICAgKiBXSUxMT1cgVjUwIEVtYmVkZGVkIEFwcCBKYXZhU2NyaXB0CiAgICAgKiBDb21wbGV0ZSBGVUIgY29tcGxpYW5jZSB3aXRoIG11bHRpLWZlYXR1cmUgYXJjaGl0ZWN0dXJlCiAgICAgKi8KICAgIAogICAgY2xhc3MgV0lMTE9XRW1iZWRkZWRBcHAgewogICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICB0aGlzLmNvbnRleHQgPSBudWxsOwogICAgICAgIHRoaXMucGVyc29uID0gbnVsbDsKICAgICAgICB0aGlzLmludGVsbGlnZW5jZSA9IG51bGw7CiAgICAgICAgdGhpcy5jdXJyZW50VGFiID0gJ2ludGVsbGlnZW5jZSc7CiAgICAgICAgdGhpcy5kZWJ1Z1N0YXRlID0gbnVsbDsKICAgICAgICB0aGlzLmlzTG9hZGVkID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgLy8gTEFaWSBMT0FEIFBBVFRFUk46IFNob3cgbG9hZCBidXR0b24sIGRvbid0IGF1dG8taW5pdGlhbGl6ZQogICAgICAgIHRoaXMuc2hvd0xvYWRCdXR0b24oKTsKICAgICAgfQoKICAgICAgc2hvd0xvYWRCdXR0b24oKSB7CiAgICAgICAgY29uc3QgY29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3aWxsb3ctY29udGVudCcpOwogICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gYAogICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsgYWxpZ24taXRlbXM6IGNlbnRlcjsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7IGhlaWdodDogNDAwcHg7IGdhcDogMjBweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7Ij4KICAgICAgICAgICAgICA8aDIgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dCk7IG1hcmdpbi1ib3R0b206IDEwcHg7Ij5XSUxMT1cgVjUwIEludGVsbGlnZW5jZSBTeXN0ZW08L2gyPgogICAgICAgICAgICAgIDxwIHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBmb250LXNpemU6IDE0cHg7Ij5FbmhhbmNlZCBCZWhhdmlvcmFsIFNjb3JpbmcgJiBPbW5pcHJlc2VudCBJbnRlbGxpZ2VuY2U8L3A+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8YnV0dG9uIAogICAgICAgICAgICAgIG9uY2xpY2s9IndpbmRvdy53aWxsb3dBcHAubG9hZEludGVsbGlnZW5jZU5vdygpIiAKICAgICAgICAgICAgICBzdHlsZT0iCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgICAgICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgICAgICAgICBib3JkZXI6IG5vbmU7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiAxNHB4IDMycHg7CiAgICAgICAgICAgICAgICBmb250LXNpemU6IDE1cHg7CiAgICAgICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnMgZWFzZTsKICAgICAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMnB4IDRweCByZ2JhKDAsMCwwLDAuMSk7CiAgICAgICAgICAgICAgIgogICAgICAgICAgICAgIG9ubW91c2VvdmVyPSJ0aGlzLnN0eWxlLmJhY2tncm91bmQ9JyMxZDRlZDgnOyB0aGlzLnN0eWxlLnRyYW5zZm9ybT0ndHJhbnNsYXRlWSgtMXB4KSc7IHRoaXMuc3R5bGUuYm94U2hhZG93PScwIDRweCA4cHggcmdiYSgwLDAsMCwwLjE1KSciCiAgICAgICAgICAgICAgb25tb3VzZW91dD0idGhpcy5zdHlsZS5iYWNrZ3JvdW5kPScjMjU2M2ViJzsgdGhpcy5zdHlsZS50cmFuc2Zvcm09J3RyYW5zbGF0ZVkoMCknOyB0aGlzLnN0eWxlLmJveFNoYWRvdz0nMCAycHggNHB4IHJnYmEoMCwwLDAsMC4xKSciCiAgICAgICAgICAgID4KICAgICAgICAgICAgICBMb2FkIFdJTExPVyBJbnRlbGxpZ2VuY2UKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgIDxwIHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBmb250LXNpemU6IDEycHg7Ij5DbGljayB0byBhbmFseXplIGJlaGF2aW9yYWwgZGF0YSBmcm9tIEZlbGxvLCBDbG91ZENNQSwgV0lMTE9XLCBhbmQgU2llcnJhPC9wPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgYXN5bmMgbG9hZEludGVsbGlnZW5jZU5vdygpIHsKICAgICAgICBpZiAodGhpcy5pc0xvYWRlZCkgcmV0dXJuOyAvLyBQcmV2ZW50IGRvdWJsZS1sb2FkaW5nCiAgICAgICAgCiAgICAgICAgY29uc3QgY29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3aWxsb3ctY29udGVudCcpOwogICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gYAogICAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsiPgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9IndpZHRoOiA0MHB4OyBoZWlnaHQ6IDQwcHg7IGJvcmRlcjogNHB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyBib3JkZXItdG9wLWNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7IGJvcmRlci1yYWRpdXM6IDUwJTsgYW5pbWF0aW9uOiBzcGluIDFzIGxpbmVhciBpbmZpbml0ZTsgbWFyZ2luOiAwIGF1dG8gMTVweDsiPjwvZGl2PgogICAgICAgICAgICAgIDxwPkxvYWRpbmcgV0lMTE9XIEludGVsbGlnZW5jZS4uLjwvcD4KICAgICAgICAgICAgICA8cCBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBtYXJnaW4tdG9wOiA4cHg7Ij5BbmFseXppbmcgYmVoYXZpb3JhbCBkYXRhLi4uPC9wPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgICAgCiAgICAgICAgdHJ5IHsKICAgICAgICAgIC8vIFBhcnNlIEZVQiBjb250ZXh0IGZyb20gVVJMIHBhcmFtZXRlcnMKICAgICAgICAgIGF3YWl0IHRoaXMucGFyc2VDb250ZXh0KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIEhhbmRsZSBkZWJ1ZyBzdGF0ZXMKICAgICAgICAgIGlmICh0aGlzLmRlYnVnU3RhdGUpIHsKICAgICAgICAgICAgdGhpcy5oYW5kbGVEZWJ1Z1N0YXRlKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBMb2FkIFdJTExPVyBpbnRlbGxpZ2VuY2UKICAgICAgICAgIGF3YWl0IHRoaXMubG9hZEludGVsbGlnZW5jZSgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBSZXN0b3JlIHRhYiBzdHJ1Y3R1cmUgKHdhcyBkZXN0cm95ZWQgYnkgbG9hZGluZyBzcGlubmVyKQogICAgICAgICAgdGhpcy5yZXN0b3JlVGFiU3RydWN0dXJlKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFNldHVwIGV2ZW50IGxpc3RlbmVycwogICAgICAgICAgdGhpcy5zZXR1cEV2ZW50TGlzdGVuZXJzKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIE1hcmsgYXMgbG9hZGVkCiAgICAgICAgICB0aGlzLmlzTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgIAogICAgICAgICAgLy8gUmVuZGVyIGluaXRpYWwgY29udGVudAogICAgICAgICAgYXdhaXQgdGhpcy5yZW5kZXJDdXJyZW50VGFiKCk7CiAgICAgICAgICAKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgY29uc29sZS5lcnJvcignV0lMTE9XIEFwcCBJbml0aWFsaXphdGlvbiBFcnJvcjonLCBlcnJvcik7CiAgICAgICAgICB0aGlzLnNob3dFcnJvcihgRmFpbGVkIHRvIGxvYWQgV0lMTE9XIGludGVsbGlnZW5jZTogJHtlcnJvci5tZXNzYWdlfWApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgYXN5bmMgcGFyc2VDb250ZXh0KCkgewogICAgICAgIGNvbnN0IHVybFBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCk7CiAgICAgICAgY29uc3QgY29udGV4dFBhcmFtID0gdXJsUGFyYW1zLmdldCgnY29udGV4dCcpOwogICAgICAgIGNvbnN0IHNpZ25hdHVyZVBhcmFtID0gdXJsUGFyYW1zLmdldCgnc2lnbmF0dXJlJyk7CiAgICAgICAgY29uc3QgZGVtb01vZGUgPSB1cmxQYXJhbXMuZ2V0KCdkZW1vJyk7CgogICAgICAgIC8vIERlbW8gbW9kZSBmb3IgdGVzdGluZyBvdXRzaWRlIEZVQiBpZnJhbWUKICAgICAgICBpZiAoIWNvbnRleHRQYXJhbSAmJiBkZW1vTW9kZSA9PT0gJ3RydWUnKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnUnVubmluZyBpbiBERU1PIG1vZGUnKTsKICAgICAgICAgIHRoaXMucGVyc29uID0gewogICAgICAgICAgICBuYW1lOiAnRGVtbyBDb250YWN0JywKICAgICAgICAgICAgZW1haWw6ICdkZW1vQGV4YW1wbGUuY29tJywKICAgICAgICAgICAgY3VzdG9tRmVsbG9MZWFkU2NvcmU6IDg1LAogICAgICAgICAgICBjdXN0b21GZWxsb09mRGFzaGJvYXJkQ2xpY2tzOiAxMiwKICAgICAgICAgICAgY3VzdG9tRmVsbG9PZkVtYWlsQ2xpY2tzOiA4LAogICAgICAgICAgICBjdXN0b21GZWxsb09mRm9ybVN1Ym1pc3Npb25zOiAzLAogICAgICAgICAgICBjdXN0b21XSUxMT1dDTUFWaWV3czogNSwKICAgICAgICAgICAgY3VzdG9tV0lMTE9XSG90U2NvcmU6IDc1CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFjb250ZXh0UGFyYW0pIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gY29udGV4dCBwYXJhbWV0ZXIgcHJvdmlkZWQuIFRoaXMgYXBwIG11c3QgYmUgYWNjZXNzZWQgdGhyb3VnaCBGb2xsb3cgVXAgQm9zcyBpZnJhbWUuJyk7CiAgICAgICAgfQoKICAgICAgICAvLyBEZWNvZGUgYmFzZTY0IGNvbnRleHQKICAgICAgICB0cnkgewogICAgICAgICAgY29uc29sZS5sb2coJ0ZVQiBDb250ZXh0IFBhcmFtZXRlciAoZmlyc3QgMTAwIGNoYXJzKTonLCBjb250ZXh0UGFyYW0uc3Vic3RyaW5nKDAsIDEwMCkpOwogICAgICAgICAgY29uc3QgZGVjb2RlZENvbnRleHQgPSBKU09OLnBhcnNlKGF0b2IoY29udGV4dFBhcmFtKSk7CiAgICAgICAgICB0aGlzLmNvbnRleHQgPSBkZWNvZGVkQ29udGV4dDsKICAgICAgICAgIHRoaXMucGVyc29uID0gZGVjb2RlZENvbnRleHQucGVyc29uOwogICAgICAgICAgdGhpcy5kZWJ1Z1N0YXRlID0gZGVjb2RlZENvbnRleHQuZGVidWdTdGF0ZTsKICAgICAgICAgIAogICAgICAgICAgY29uc29sZS5sb2coJ0ZVQiBDb250ZXh0IGxvYWRlZCBzdWNjZXNzZnVsbHknKTsKICAgICAgICAgIGNvbnNvbGUubG9nKCdQZXJzb24gZGF0YTonLCB0aGlzLnBlcnNvbiA/ICdQcmVzZW50JyA6ICdNaXNzaW5nJyk7CiAgICAgICAgICBjb25zb2xlLmxvZygnRGVidWcgc3RhdGU6JywgdGhpcy5kZWJ1Z1N0YXRlIHx8ICdOb25lJyk7CiAgICAgICAgICAKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgY29uc29sZS5lcnJvcignQ29udGV4dCBkZWNvZGUgZXJyb3IgZGV0YWlsczonLCBlcnJvcik7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCdDb250ZXh0IHBhcmFtZXRlciBsZW5ndGg6JywgY29udGV4dFBhcmFtLmxlbmd0aCk7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBkZWNvZGUgRlVCIGNvbnRleHQ6ICR7ZXJyb3IubWVzc2FnZX1gKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGhhbmRsZURlYnVnU3RhdGUoKSB7CiAgICAgICAgY29uc3QgY29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3aWxsb3ctY29udGVudCcpOwogICAgICAgIAogICAgICAgIHN3aXRjaCh0aGlzLmRlYnVnU3RhdGUpIHsKICAgICAgICAgIGNhc2UgJ3dvcmtpbmcnOgogICAgICAgICAgICAvLyBDb250aW51ZSB3aXRoIG5vcm1hbCBvcGVyYXRpb24KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIAogICAgICAgICAgY2FzZSAnYWNjb3VudF9ub3RfZm91bmQnOgogICAgICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IHRoaXMucmVuZGVyQWNjb3VudE5vdEZvdW5kKCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAKICAgICAgICAgIGNhc2UgJ3VzZXJfbm90X2ZvdW5kJzoKICAgICAgICAgICAgY29udGVudC5pbm5lckhUTUwgPSB0aGlzLnJlbmRlclVzZXJOb3RGb3VuZCgpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgCiAgICAgICAgICBjYXNlICdwZXJzb25fbm90X2ZvdW5kJzoKICAgICAgICAgICAgY29udGVudC5pbm5lckhUTUwgPSB0aGlzLnJlbmRlclBlcnNvbk5vdEZvdW5kKCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAKICAgICAgICAgIGNhc2UgJ3VuYXV0aG9yaXplZCc6CiAgICAgICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJVbmF1dGhvcml6ZWQoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIAogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgY29udGVudC5pbm5lckhUTUwgPSB0aGlzLnJlbmRlclVua25vd25TdGF0ZSgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmVuZGVyQWNjb3VudE5vdEZvdW5kKCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZWJ1Zy1zdGF0ZSI+CiAgICAgICAgICAgIDxoMj5BY2NvdW50IFNldHVwIFJlcXVpcmVkPC9oMj4KICAgICAgICAgICAgPHA+WW91ciBGb2xsb3cgVXAgQm9zcyBhY2NvdW50IG5lZWRzIHRvIGJlIGNvbmZpZ3VyZWQgZm9yIFdJTExPVyBpbnRlZ3JhdGlvbi48L3A+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImRlYnVnLWJ0biIgb25jbGljaz0id2luZG93Lm9wZW4oJ21haWx0bzpnbGVubkBodWRzb252YWxsZXlzb2xkLmNvbT9zdWJqZWN0PVdJTExPVyBBY2NvdW50IFNldHVwJykiPgogICAgICAgICAgICAgIENvbnRhY3QgR2xlbm4gZm9yIFNldHVwCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgcmVuZGVyVXNlck5vdEZvdW5kKCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZWJ1Zy1zdGF0ZSI+CiAgICAgICAgICAgIDxoMj5Vc2VyIE5vdCBGb3VuZDwvaDI+CiAgICAgICAgICAgIDxwPllvdXIgdXNlciBhY2NvdW50IGlzIG5vdCBjb25maWd1cmVkIGluIHRoZSBXSUxMT1cgc3lzdGVtLjwvcD4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZGVidWctYnRuIiBvbmNsaWNrPSJ3aW5kb3cub3BlbignbWFpbHRvOmdsZW5uQGh1ZHNvbnZhbGxleXNvbGQuY29tP3N1YmplY3Q9V0lMTE9XIFVzZXIgQWNjZXNzJykiPgogICAgICAgICAgICAgIFJlcXVlc3QgQWNjZXNzCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgcmVuZGVyUGVyc29uTm90Rm91bmQoKSB7CiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImRlYnVnLXN0YXRlIj4KICAgICAgICAgICAgPGgyPkNvbnRhY3QgTm90IEZvdW5kPC9oMj4KICAgICAgICAgICAgPHA+VGhpcyBjb250YWN0IGlzIG5vdCB5ZXQgaW4gdGhlIFdJTExPVyBpbnRlbGxpZ2VuY2Ugc3lzdGVtLjwvcD4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZGVidWctYnRuIiBvbmNsaWNrPSJ0aGlzLmFkZFBlcnNvblRvV0lMTE9XKCkiPgogICAgICAgICAgICAgIEFkZCB0byBXSUxMT1cgU3lzdGVtCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgcmVuZGVyVW5hdXRob3JpemVkKCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZWJ1Zy1zdGF0ZSI+CiAgICAgICAgICAgIDxoMj5BY2Nlc3MgRGVuaWVkPC9oMj4KICAgICAgICAgICAgPHA+WW91IGRvbid0IGhhdmUgcGVybWlzc2lvbiB0byBhY2Nlc3MgdGhlIFdJTExPVyBzeXN0ZW0uPC9wPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJkZWJ1Zy1idG4iIG9uY2xpY2s9IndpbmRvdy5vcGVuKCdtYWlsdG86Z2xlbm5AaHVkc29udmFsbGV5c29sZC5jb20/c3ViamVjdD1XSUxMT1cgQWNjZXNzIFJlcXVlc3QnKSI+CiAgICAgICAgICAgICAgUmVxdWVzdCBQZXJtaXNzaW9uCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgcmVuZGVyVW5rbm93blN0YXRlKCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZWJ1Zy1zdGF0ZSI+CiAgICAgICAgICAgIDxoMj5TeXN0ZW0gRXJyb3I8L2gyPgogICAgICAgICAgICA8cD5Vbmtub3duIGRlYnVnIHN0YXRlIGVuY291bnRlcmVkLjwvcD4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZGVidWctYnRuIiBvbmNsaWNrPSJsb2NhdGlvbi5yZWxvYWQoKSI+CiAgICAgICAgICAgICAgUmV0cnkKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICBhc3luYyBsb2FkSW50ZWxsaWdlbmNlKCkgewogICAgICAgIC8vIENoZWNrIGlmIHNlcnZlciBwcmUtY2FsY3VsYXRlZCBpbnRlbGxpZ2VuY2UKICAgICAgICBpZiAod2luZG93LldJTExPV19JTlRFTExJR0VOQ0UpIHsKICAgICAgICAgIHRoaXMuaW50ZWxsaWdlbmNlID0gd2luZG93LldJTExPV19JTlRFTExJR0VOQ0U7CiAgICAgICAgICBjb25zb2xlLmxvZygnV0lMTE9XIEludGVsbGlnZW5jZSBsb2FkZWQgZnJvbSBzZXJ2ZXI6JywgdGhpcy5pbnRlbGxpZ2VuY2UpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBGYWxsYmFjayB0byBjbGllbnQtc2lkZSBjYWxjdWxhdGlvbgogICAgICAgIHRoaXMuaW50ZWxsaWdlbmNlID0gewogICAgICAgICAgdG90YWxTY29yZTogdGhpcy5jYWxjdWxhdGVNb2NrU2NvcmUoKSwKICAgICAgICAgIGNsYXNzaWZpY2F0aW9uOiB0aGlzLmNsYXNzaWZ5U2NvcmUodGhpcy5jYWxjdWxhdGVNb2NrU2NvcmUoKSksCiAgICAgICAgICBjb21wb25lbnRzOiB7CiAgICAgICAgICAgIGZlbGxvOiB0aGlzLmdldE1vY2tGZWxsb1Njb3JlKCksCiAgICAgICAgICAgIGNsb3VkQ01BOiB0aGlzLmdldE1vY2tDbG91ZENNQVNjb3JlKCksCiAgICAgICAgICAgIHdpbGxvdzogdGhpcy5nZXRNb2NrV0lMTE9XU2NvcmUoKSwKICAgICAgICAgICAgc2llcnJhOiB0aGlzLmdldE1vY2tTaWVycmFTY29yZSgpCiAgICAgICAgICB9LAogICAgICAgICAgdHJpZ2dlcmVkUGF0dGVybnM6IHRoaXMuZ2V0TW9ja1RyaWdnZXJlZFBhdHRlcm5zKCkKICAgICAgICB9OwoKICAgICAgICBjb25zb2xlLmxvZygnV0lMTE9XIEludGVsbGlnZW5jZSBsb2FkZWQgKGNsaWVudC1zaWRlKTonLCB0aGlzLmludGVsbGlnZW5jZSk7CiAgICAgIH0KCiAgICAgIGNhbGN1bGF0ZU1vY2tTY29yZSgpIHsKICAgICAgICAvLyBNb2NrIGJlaGF2aW9yYWwgc2NvcmluZyBiYXNlZCBvbiBwZXJzb24gZGF0YQogICAgICAgIGlmICghdGhpcy5wZXJzb24pIHJldHVybiA0NTsKICAgICAgICAKICAgICAgICBsZXQgc2NvcmUgPSAwOwogICAgICAgIAogICAgICAgIC8vIE1vY2sgRmVsbG8gaW50ZWxsaWdlbmNlICgzNSUgd2VpZ2h0KQogICAgICAgIGNvbnN0IGZlbGxvU2NvcmUgPSB0aGlzLnBlcnNvbi5jdXN0b21GZWxsb0xlYWRTY29yZSB8fCA1MDsKICAgICAgICBzY29yZSArPSAoZmVsbG9TY29yZSAqIDAuMzUpOwogICAgICAgIAogICAgICAgIC8vIE1vY2sgQ2xvdWRDTUEgKDI1JSB3ZWlnaHQpCiAgICAgICAgY29uc3QgY21hVmlld3MgPSB0aGlzLnBlcnNvbi5jdXN0b21XSUxMT1dDTUFWaWV3cyB8fCAwOwogICAgICAgIHNjb3JlICs9IChNYXRoLm1pbihjbWFWaWV3cyAqIDUsIDI1KSk7CiAgICAgICAgCiAgICAgICAgLy8gTW9jayBXSUxMT1cgKDI1JSB3ZWlnaHQpICAKICAgICAgICBjb25zdCBob3RTY29yZSA9IHRoaXMucGVyc29uLmN1c3RvbVdJTExPV0hvdFNjb3JlIHx8IDI1OwogICAgICAgIHNjb3JlICs9IChob3RTY29yZSAqIDAuMjUpOwogICAgICAgIAogICAgICAgIC8vIE1vY2sgU2llcnJhICgxNSUgd2VpZ2h0KQogICAgICAgIHNjb3JlICs9IDEwOyAvLyBCYXNlIFNpZXJyYSBzY29yZQogICAgICAgIAogICAgICAgIHJldHVybiBNYXRoLm1pbihNYXRoLnJvdW5kKHNjb3JlKSwgMTAwKTsKICAgICAgfQoKICAgICAgZ2V0TW9ja0ZlbGxvU2NvcmUoKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKCh0aGlzLnBlcnNvbj8uY3VzdG9tRmVsbG9MZWFkU2NvcmUgfHwgNTApICogMC4zNSwgMzUpOwogICAgICB9CgogICAgICBnZXRNb2NrQ2xvdWRDTUFTY29yZSgpIHsKICAgICAgICBjb25zdCB2aWV3cyA9IHRoaXMucGVyc29uPy5jdXN0b21XSUxMT1dDTUFWaWV3cyB8fCAwOwogICAgICAgIHJldHVybiBNYXRoLm1pbih2aWV3cyAqIDUsIDI1KTsKICAgICAgfQoKICAgICAgZ2V0TW9ja1dJTExPV1Njb3JlKCkgewogICAgICAgIHJldHVybiAodGhpcy5wZXJzb24/LmN1c3RvbVdJTExPV0hvdFNjb3JlIHx8IDI1KSAqIDAuMjU7CiAgICAgIH0KCiAgICAgIGdldE1vY2tTaWVycmFTY29yZSgpIHsKICAgICAgICByZXR1cm4gMTA7IC8vIEJhc2Ugc2NvcmUKICAgICAgfQoKICAgICAgY2xhc3NpZnlTY29yZShzY29yZSkgewogICAgICAgIGlmIChzY29yZSA+PSA5NSkgcmV0dXJuICdDUklUSUNBTCc7CiAgICAgICAgaWYgKHNjb3JlID49IDg1KSByZXR1cm4gJ1NVUEVSX0hPVCc7CiAgICAgICAgaWYgKHNjb3JlID49IDcwKSByZXR1cm4gJ0hPVCc7CiAgICAgICAgaWYgKHNjb3JlID49IDQwKSByZXR1cm4gJ1dBUk0nOwogICAgICAgIHJldHVybiAnQ09MRCc7CiAgICAgIH0KCiAgICAgIGdldE1vY2tUcmlnZ2VyZWRQYXR0ZXJucygpIHsKICAgICAgICBjb25zdCBwYXR0ZXJucyA9IFtdOwogICAgICAgIAogICAgICAgIC8vIENhbGN1bGF0ZSBzY29yZSBsb2NhbGx5IHRvIGF2b2lkIGNpcmN1bGFyIGRlcGVuZGVuY3kKICAgICAgICBjb25zdCBsb2NhbFNjb3JlID0gdGhpcy5jYWxjdWxhdGVNb2NrU2NvcmUoKTsKICAgICAgICAKICAgICAgICBpZiAobG9jYWxTY29yZSA+PSA4NSkgewogICAgICAgICAgcGF0dGVybnMucHVzaCh7CiAgICAgICAgICAgIGlkOiAxMiwKICAgICAgICAgICAgbmFtZTogJ09tbmlwcmVzZW50IEludGVsbGlnZW5jZSBDb25zZW5zdXMnLAogICAgICAgICAgICBpY29uOiAn8J+OrycsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnTXVsdGlwbGUgc3lzdGVtcyBpbmRpY2F0ZSBoaWdoIGNvbnZlcnNpb24gcHJvYmFiaWxpdHknLAogICAgICAgICAgICBjb252ZXJzaW9uUmF0ZTogOTgsCiAgICAgICAgICAgIHByaW9yaXR5OiAnQ1JJVElDQUwnLAogICAgICAgICAgICBhY3Rpb25MYWJlbDogJ0NvbnRhY3QgSW1tZWRpYXRlbHknCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMucGVyc29uPy5jdXN0b21GZWxsb09mRGFzaGJvYXJkQ2xpY2tzID49IDMpIHsKICAgICAgICAgIHBhdHRlcm5zLnB1c2goewogICAgICAgICAgICBpZDogMiwKICAgICAgICAgICAgbmFtZTogJ0Rhc2hib2FyZCBBY3Rpdml0eSBTcGlrZScsCiAgICAgICAgICAgIGljb246ICfwn5OKJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdNdWx0aXBsZSBwcm9wZXJ0eSBkYXNoYm9hcmQgdmlld3MgaW5kaWNhdGUgc2VsbGVyIGludGVudCcsCiAgICAgICAgICAgIGNvbnZlcnNpb25SYXRlOiA5MiwKICAgICAgICAgICAgcHJpb3JpdHk6ICdISUdIJywKICAgICAgICAgICAgYWN0aW9uTGFiZWw6ICdHZW5lcmF0ZSBDTUEnCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnBlcnNvbj8uY3VzdG9tV0lMTE9XQ01BVmlld3MgPj0gMSkgewogICAgICAgICAgcGF0dGVybnMucHVzaCh7CiAgICAgICAgICAgIGlkOiAxMCwKICAgICAgICAgICAgbmFtZTogJ0NNQSBFbmdhZ2VtZW50JywKICAgICAgICAgICAgaWNvbjogJ/Cfk4gnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0FjdGl2ZSBlbmdhZ2VtZW50IHdpdGggcHJldmlvdXMgQ01BIHJlcG9ydHMnLAogICAgICAgICAgICBjb252ZXJzaW9uUmF0ZTogODUsCiAgICAgICAgICAgIHByaW9yaXR5OiAnTUVESVVNJywKICAgICAgICAgICAgYWN0aW9uTGFiZWw6ICdGb2xsb3cgVXAnCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBwYXR0ZXJuczsKICAgICAgfQoKICAgICAgcmVzdG9yZVRhYlN0cnVjdHVyZSgpIHsKICAgICAgICBjb25zdCBjb250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpbGxvdy1jb250ZW50Jyk7CiAgICAgICAgY29udGVudC5pbm5lckhUTUwgPSBgCiAgICAgICAgICA8ZGl2IGlkPSJpbnRlbGxpZ2VuY2UtY29udGVudCIgY2xhc3M9InRhYi1jb250ZW50IGFjdGl2ZSI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcuLi48L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBpZD0iY21hLWNvbnRlbnQiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcgQ01BIFN5c3RlbTwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGlkPSJhbmFseXRpY3MtY29udGVudCIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+TG9hZGluZyBBbmFseXRpY3M8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBpZD0icGFydG5lcnMtY29udGVudCIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+TG9hZGluZyBQYXJ0bmVyIFN5c3RlbTwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGlkPSJwcm9wZXJ0eS1jb250ZW50IiBjbGFzcz0idGFiLWNvbnRlbnQiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIFByb3BlcnR5IEludGVsbGlnZW5jZTwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGlkPSJjb21tdW5pY2F0aW9uLWNvbnRlbnQiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcgQ29tbXVuaWNhdGlvbiBDZW50ZXI8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBpZD0ibWFuYWdlbWVudC1jb250ZW50IiBjbGFzcz0idGFiLWNvbnRlbnQiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIFN5c3RlbSBNYW5hZ2VtZW50PC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICBzZXR1cEV2ZW50TGlzdGVuZXJzKCkgewogICAgICAgIC8vIFRhYiBzd2l0Y2hpbmcKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiLWJ1dHRvbicpLmZvckVhY2goYnV0dG9uID0+IHsKICAgICAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHRhYk5hbWUgPSBlLnRhcmdldC5kYXRhc2V0LnRhYjsKICAgICAgICAgICAgdGhpcy5zd2l0Y2hUYWIodGFiTmFtZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gV2luZG93IHJlc2l6ZQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCAoKSA9PiB7CiAgICAgICAgICB0aGlzLmhhbmRsZVJlc2l6ZSgpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBhc3luYyBzd2l0Y2hUYWIodGFiTmFtZSkgewogICAgICAgIC8vIFVwZGF0ZSBhY3RpdmUgdGFiCiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRhYi1idXR0b24nKS5mb3JFYWNoKGJ0biA9PiBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJykpOwogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYFtkYXRhLXRhYj0iJHt0YWJOYW1lfSJdYCkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CgogICAgICAgIC8vIEhpZGUgYWxsIGNvbnRlbnQKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiLWNvbnRlbnQnKS5mb3JFYWNoKGNvbnRlbnQgPT4gY29udGVudC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSk7CiAgICAgICAgCiAgICAgICAgLy8gU2hvdyBzZWxlY3RlZCBjb250ZW50CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYCR7dGFiTmFtZX0tY29udGVudGApLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwoKICAgICAgICB0aGlzLmN1cnJlbnRUYWIgPSB0YWJOYW1lOwogICAgICAgIGF3YWl0IHRoaXMucmVuZGVyQ3VycmVudFRhYigpOwogICAgICB9CgogICAgICBhc3luYyByZW5kZXJDdXJyZW50VGFiKCkgewogICAgICAgIGNvbnN0IGNvbnRlbnREaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgJHt0aGlzLmN1cnJlbnRUYWJ9LWNvbnRlbnRgKTsKICAgICAgICAKICAgICAgICBzd2l0Y2godGhpcy5jdXJyZW50VGFiKSB7CiAgICAgICAgICBjYXNlICdpbnRlbGxpZ2VuY2UnOgogICAgICAgICAgICBjb250ZW50RGl2LmlubmVySFRNTCA9IHRoaXMucmVuZGVySW50ZWxsaWdlbmNlRGFzaGJvYXJkKCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnY21hJzoKICAgICAgICAgICAgY29udGVudERpdi5pbm5lckhUTUwgPSB0aGlzLnJlbmRlckNNQUh1YigpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ2FuYWx5dGljcyc6CiAgICAgICAgICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJBbmFseXRpY3MoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdwYXJ0bmVycyc6CiAgICAgICAgICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJQYXJ0bmVycygpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ3Byb3BlcnR5JzoKICAgICAgICAgICAgY29udGVudERpdi5pbm5lckhUTUwgPSB0aGlzLnJlbmRlclByb3BlcnR5KCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnY29tbXVuaWNhdGlvbic6CiAgICAgICAgICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJDb21tdW5pY2F0aW9uKCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnbWFuYWdlbWVudCc6CiAgICAgICAgICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJNYW5hZ2VtZW50KCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIHF1aWNrIGFjdGlvbnMKICAgICAgICB0aGlzLnVwZGF0ZVF1aWNrQWN0aW9ucygpOwogICAgICB9CgogICAgICByZW5kZXJJbnRlbGxpZ2VuY2VEYXNoYm9hcmQoKSB7CiAgICAgICAgaWYgKCF0aGlzLmludGVsbGlnZW5jZSkgcmV0dXJuICc8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIGludGVsbGlnZW5jZS4uLjwvZGl2Pic7CgogICAgICAgIGNvbnN0IHNjb3JlID0gdGhpcy5pbnRlbGxpZ2VuY2UudG90YWxTY29yZTsKICAgICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IHRoaXMuaW50ZWxsaWdlbmNlLmNsYXNzaWZpY2F0aW9uLnRvTG93ZXJDYXNlKCk7CgogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJpbnRlbGxpZ2VuY2UtZGFzaGJvYXJkIj4KICAgICAgICAgICAgCiAgICAgICAgICAgIDwhLS0gUHJpbWFyeSBTY29yZSBEaXNwbGF5IC0tPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzY29yZS1zZWN0aW9uIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzY29yZS1nYXVnZSI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJnYXVnZS1jaXJjbGUiIHN0eWxlPSItLXNjb3JlLXBlcmNlbnQ6ICR7c2NvcmV9Ij4KICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InNjb3JlLXZhbHVlIj4ke3Njb3JlfTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InNjb3JlLWxhYmVsIj4vMTAwPC9zcGFuPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcmlvcml0eS1iYWRnZSAke2NsYXNzaWZpY2F0aW9ufSI+CiAgICAgICAgICAgICAgICAgICR7dGhpcy5pbnRlbGxpZ2VuY2UuY2xhc3NpZmljYXRpb259CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAKICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzY29yZS1jb21wb25lbnRzIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbXBvbmVudCBmZWxsbyI+CiAgICAgICAgICAgICAgICAgIDxsYWJlbD5GZWxsbyBJbnRlbGxpZ2VuY2U8L2xhYmVsPgogICAgICAgICAgICAgICAgICA8dmFsdWU+JHt0aGlzLmludGVsbGlnZW5jZS5jb21wb25lbnRzLmZlbGxvLnRvRml4ZWQoMSl9LzM1PC92YWx1ZT4KICAgICAgICAgICAgICAgICAgPGJhciBzdHlsZT0iLS1iYXItd2lkdGg6ICR7KHRoaXMuaW50ZWxsaWdlbmNlLmNvbXBvbmVudHMuZmVsbG8vMzUpKjEwMH0lIj48L2Jhcj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29tcG9uZW50IGNsb3VkY21hIj4KICAgICAgICAgICAgICAgICAgPGxhYmVsPkNsb3VkQ01BIE1MUzwvbGFiZWw+CiAgICAgICAgICAgICAgICAgIDx2YWx1ZT4ke3RoaXMuaW50ZWxsaWdlbmNlLmNvbXBvbmVudHMuY2xvdWRDTUEudG9GaXhlZCgxKX0vMjU8L3ZhbHVlPgogICAgICAgICAgICAgICAgICA8YmFyIHN0eWxlPSItLWJhci13aWR0aDogJHsodGhpcy5pbnRlbGxpZ2VuY2UuY29tcG9uZW50cy5jbG91ZENNQS8yNSkqMTAwfSUiPjwvYmFyPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb21wb25lbnQgd2lsbG93Ij4KICAgICAgICAgICAgICAgICAgPGxhYmVsPldJTExPVzwvbGFiZWw+CiAgICAgICAgICAgICAgICAgIDx2YWx1ZT4ke3RoaXMuaW50ZWxsaWdlbmNlLmNvbXBvbmVudHMud2lsbG93LnRvRml4ZWQoMSl9LzI1PC92YWx1ZT4KICAgICAgICAgICAgICAgICAgPGJhciBzdHlsZT0iLS1iYXItd2lkdGg6ICR7KHRoaXMuaW50ZWxsaWdlbmNlLmNvbXBvbmVudHMud2lsbG93LzI1KSoxMDB9JSI+PC9iYXI+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbXBvbmVudCBzaWVycmEiPgogICAgICAgICAgICAgICAgICA8bGFiZWw+U2llcnJhPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgPHZhbHVlPiR7dGhpcy5pbnRlbGxpZ2VuY2UuY29tcG9uZW50cy5zaWVycmEudG9GaXhlZCgxKX0vMTU8L3ZhbHVlPgogICAgICAgICAgICAgICAgICA8YmFyIHN0eWxlPSItLWJhci13aWR0aDogJHsodGhpcy5pbnRlbGxpZ2VuY2UuY29tcG9uZW50cy5zaWVycmEvMTUpKjEwMH0lIj48L2Jhcj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgCiAgICAgICAgICAgIDwhLS0gVHJpZ2dlcmVkIFBhdHRlcm5zIC0tPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJwYXR0ZXJucy1zZWN0aW9uIj4KICAgICAgICAgICAgICA8aDM+8J+OryBBY3RpdmUgVHJpZ2dlciBQYXR0ZXJuczwvaDM+CiAgICAgICAgICAgICAgJHt0aGlzLnJlbmRlclRyaWdnZXJlZFBhdHRlcm5zKCl9CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPCEtLSBDb250YWN0IEluZm9ybWF0aW9uIC0tPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJwYXR0ZXJucy1zZWN0aW9uIj4KICAgICAgICAgICAgICA8aDM+8J+TiyBDb250YWN0IEludGVsbGlnZW5jZTwvaDM+CiAgICAgICAgICAgICAgJHt0aGlzLnJlbmRlckNvbnRhY3RJbnRlbGxpZ2VuY2UoKX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgcmVuZGVyVHJpZ2dlcmVkUGF0dGVybnMoKSB7CiAgICAgICAgaWYgKCF0aGlzLmludGVsbGlnZW5jZS50cmlnZ2VyZWRQYXR0ZXJucy5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiAnPHAgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7IGZvbnQtc3R5bGU6IGl0YWxpYzsiPk5vIGFjdGl2ZSBwYXR0ZXJucyBkZXRlY3RlZC4gQ29udGludWUgbW9uaXRvcmluZyBmb3IgYmVoYXZpb3JhbCB0cmlnZ2Vycy48L3A+JzsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmludGVsbGlnZW5jZS50cmlnZ2VyZWRQYXR0ZXJucy5tYXAocGF0dGVybiA9PiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJwYXR0ZXJuLWl0ZW0gcHJpb3JpdHktJHtwYXR0ZXJuLnByaW9yaXR5LnRvTG93ZXJDYXNlKCl9Ij4KICAgICAgICAgICAgPGRpdiBjbGFzcz0icGF0dGVybi1oZWFkZXIiPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwYXR0ZXJuLWljb24iPiR7cGF0dGVybi5pY29ufTwvc3Bhbj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGF0dGVybi1uYW1lIj4ke3BhdHRlcm4ubmFtZX08L3NwYW4+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNvbnZlcnNpb24tcmF0ZSI+JHtwYXR0ZXJuLmNvbnZlcnNpb25SYXRlfSU8L3NwYW4+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJwYXR0ZXJuLWRlc2NyaXB0aW9uIj4ke3BhdHRlcm4uZGVzY3JpcHRpb259PC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InBhdHRlcm4tYWN0aW9uIj4KICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJhY3Rpb24tYnRuIiBvbmNsaWNrPSJ3aW5kb3cud2lsbG93QXBwLmV4ZWN1dGVQYXR0ZXJuKCcke3BhdHRlcm4uaWR9JykiPgogICAgICAgICAgICAgICAgJHtwYXR0ZXJuLmFjdGlvbkxhYmVsfQogICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGApLmpvaW4oJycpOwogICAgICB9CgogICAgICByZW5kZXJDb250YWN0SW50ZWxsaWdlbmNlKCkgewogICAgICAgIGNvbnN0IHBlcnNvbiA9IHRoaXMucGVyc29uOwogICAgICAgIGlmICghcGVyc29uKSByZXR1cm4gJzxwPk5vIGNvbnRhY3QgZGF0YSBhdmFpbGFibGU8L3A+JzsKCiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMTVweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsiPgogICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEwcHg7Ij4ke3BlcnNvbi5maXJzdE5hbWUgfHwgJ1Vua25vd24nfSAke3BlcnNvbi5sYXN0TmFtZSB8fCAnQ29udGFjdCd9PC9oND4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoYXV0by1maXQsIG1pbm1heCgyMDBweCwgMWZyKSk7IGdhcDogMTVweDsiPgogICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICA8bGFiZWwgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPlByaW1hcnkgRW1haWw8L2xhYmVsPjxicj4KICAgICAgICAgICAgICAgIDxzcGFuPiR7cGVyc29uLmVtYWlscz8uWzBdPy52YWx1ZSB8fCAnTm90IHByb3ZpZGVkJ308L3NwYW4+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+UHJpbWFyeSBQaG9uZTwvbGFiZWw+PGJyPgogICAgICAgICAgICAgICAgPHNwYW4+JHtwZXJzb24ucGhvbmVzPy5bMF0/LnZhbHVlIHx8ICdOb3QgcHJvdmlkZWQnfTwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5TdGFnZTwvbGFiZWw+PGJyPgogICAgICAgICAgICAgICAgPHNwYW4+JHtwZXJzb24uc3RhZ2U/Lm5hbWUgfHwgJ1Vua25vd24nfTwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5Qcm9wZXJ0aWVzIE93bmVkPC9sYWJlbD48YnI+CiAgICAgICAgICAgICAgICA8c3Bhbj4ke3BlcnNvbi5jdXN0b21GZWxsb09mUHJvcGVydGllcyB8fCAxfTwvc3Bhbj4KICAgICAgICAgICAgICAgICR7KHBlcnNvbi5jdXN0b21GZWxsb09mUHJvcGVydGllcyB8fCAwKSA+PSAzID8gJzxzcGFuIHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXdhcm5pbmcpOyBmb250LXdlaWdodDogYm9sZDsgbWFyZ2luLWxlZnQ6IDVweDsiPklOVkVTVE9SPC9zcGFuPicgOiAnJ30KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICByZW5kZXJDTUFIdWIoKSB7CiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImNtYS1odWIiPgogICAgICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbi1ib3R0b206IDIwcHg7Ij7wn5OIIENNQSBHZW5lcmF0aW9uICYgTWFuYWdlbWVudDwvaDM+CiAgICAgICAgICAgIAogICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IG1hcmdpbi1ib3R0b206IDIwcHg7Ij4KICAgICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE1cHg7Ij5HZW5lcmF0ZSBQcm9mZXNzaW9uYWwgQ01BPC9oND4KICAgICAgICAgICAgICAKICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciBhdXRvOyBnYXA6IDEwcHg7IGFsaWduLWl0ZW1zOiBlbmQ7Ij4KICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogYmxvY2s7IG1hcmdpbi1ib3R0b206IDVweDsgZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+UHJvcGVydHkgQWRkcmVzczwvbGFiZWw+CiAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBpZD0iY21hLWFkZHJlc3MiIHBsYWNlaG9sZGVyPSJFbnRlciBwcm9wZXJ0eSBhZGRyZXNzLi4uIiBzdHlsZT0id2lkdGg6IDEwMCU7IHBhZGRpbmc6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IGJvcmRlci1yYWRpdXM6IDRweDsiIC8+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImFjdGlvbi1idG4iIG9uY2xpY2s9IndpbmRvdy53aWxsb3dBcHAuZ2VuZXJhdGVDTUEoKSIgc3R5bGU9InBhZGRpbmc6IDhweCAxNnB4OyI+CiAgICAgICAgICAgICAgICAgIPCfmoAgR2VuZXJhdGUgQ01BCiAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAKICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOiAxNXB4OyBwYWRkaW5nOiAxMHB4OyBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYmFja2dyb3VuZCk7IGJvcmRlci1yYWRpdXM6IDRweDsiPgogICAgICAgICAgICAgICAgPHNtYWxsIHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+CiAgICAgICAgICAgICAgICAgIDxzdHJvbmc+QmVoYXZpb3JhbCBPcHRpbWl6YXRpb246PC9zdHJvbmc+IAogICAgICAgICAgICAgICAgICAke3RoaXMuaW50ZWxsaWdlbmNlPy5jbGFzc2lmaWNhdGlvbn0gcHJpb3JpdHkg4oCiIAogICAgICAgICAgICAgICAgICAke3RoaXMuZ2V0T3B0aW1pemVkUmFkaXVzKCl9IG1pbGUgcmFkaXVzIOKAoiAKICAgICAgICAgICAgICAgICAgJHt0aGlzLmdldE9wdGltaXplZENvbXBhcmFibGVzKCl9IGNvbXBhcmFibGVzCiAgICAgICAgICAgICAgICA8L3NtYWxsPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMjBweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsiPgogICAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPvCfj6AgUmVjZW50IENNQSBBY3Rpdml0eTwvaDQ+CiAgICAgICAgICAgICAgJHt0aGlzLnJlbmRlckNNQUhpc3RvcnkoKX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICBnZXRPcHRpbWl6ZWRSYWRpdXMoKSB7CiAgICAgICAgY29uc3QgY2xhc3NpZmljYXRpb24gPSB0aGlzLmludGVsbGlnZW5jZT8uY2xhc3NpZmljYXRpb247CiAgICAgICAgc3dpdGNoKGNsYXNzaWZpY2F0aW9uKSB7CiAgICAgICAgICBjYXNlICdDUklUSUNBTCc6IHJldHVybiAnMC41JzsKICAgICAgICAgIGNhc2UgJ1NVUEVSX0hPVCc6IHJldHVybiAnMC42JzsKICAgICAgICAgIGNhc2UgJ0hPVCc6IHJldHVybiAnMC43NSc7CiAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gJzEuMCc7CiAgICAgICAgfQogICAgICB9CgogICAgICBnZXRPcHRpbWl6ZWRDb21wYXJhYmxlcygpIHsKICAgICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IHRoaXMuaW50ZWxsaWdlbmNlPy5jbGFzc2lmaWNhdGlvbjsKICAgICAgICBzd2l0Y2goY2xhc3NpZmljYXRpb24pIHsKICAgICAgICAgIGNhc2UgJ0NSSVRJQ0FMJzogcmV0dXJuICcyMCc7CiAgICAgICAgICBjYXNlICdTVVBFUl9IT1QnOiByZXR1cm4gJzE3JzsKICAgICAgICAgIGNhc2UgJ0hPVCc6IHJldHVybiAnMTUnOwogICAgICAgICAgZGVmYXVsdDogcmV0dXJuICcxMCc7CiAgICAgICAgfQogICAgICB9CgogICAgICByZW5kZXJDTUFIaXN0b3J5KCkgewogICAgICAgIC8vIE1vY2sgQ01BIGhpc3RvcnkKICAgICAgICBjb25zdCBsYXN0Q01BRGF0ZSA9IHRoaXMucGVyc29uPy5jdXN0b21XSUxMT1dDTUFEYXRlOwogICAgICAgIGNvbnN0IGNtYUxpbmsgPSB0aGlzLnBlcnNvbj8uY3VzdG9tV0lMTE9XQ01BTGluazsKICAgICAgICAKICAgICAgICBpZiAobGFzdENNQURhdGUgJiYgY21hTGluaykgewogICAgICAgICAgcmV0dXJuIGAKICAgICAgICAgICAgPGRpdiBzdHlsZT0icGFkZGluZzogMTVweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IGJvcmRlci1yYWRpdXM6IDZweDsiPgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsgYWxpZ24taXRlbXM6IGNlbnRlcjsiPgogICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgPHN0cm9uZz5MYXRlc3QgQ01BPC9zdHJvbmc+PGJyPgogICAgICAgICAgICAgICAgICA8c21hbGwgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5HZW5lcmF0ZWQ6ICR7bmV3IERhdGUobGFzdENNQURhdGUpLnRvTG9jYWxlRGF0ZVN0cmluZygpfTwvc21hbGw+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxhIGhyZWY9IiR7Y21hTGlua30iIHRhcmdldD0iX2JsYW5rIiBjbGFzcz0iYWN0aW9uLWJ0biIgc3R5bGU9InRleHQtZGVjb3JhdGlvbjogbm9uZTsiPgogICAgICAgICAgICAgICAgICDwn5GB77iPIFZpZXcgQ01BCiAgICAgICAgICAgICAgICA8L2E+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgYDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuICc8cCBzdHlsZT0iY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsgZm9udC1zdHlsZTogaXRhbGljOyI+Tm8gcHJldmlvdXMgQ01BcyBmb3VuZC4gR2VuZXJhdGUgZmlyc3QgQ01BIGFib3ZlLjwvcD4nOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmVuZGVyQW5hbHl0aWNzKCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJhbmFseXRpY3MtZGFzaGJvYXJkIj4KICAgICAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW4tYm90dG9tOiAyMHB4OyI+8J+TiiBMZWFkIEFuYWx5dGljcyAmIFBlcmZvcm1hbmNlPC9oMz4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KGF1dG8tZml0LCBtaW5tYXgoMjAwcHgsIDFmcikpOyBnYXA6IDE1cHg7IG1hcmdpbi1ib3R0b206IDIwcHg7Ij4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDE1cHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IHRleHQtYWxpZ246IGNlbnRlcjsiPgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAyNHB4OyBmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi1wcmltYXJ5KTsiPiR7dGhpcy5pbnRlbGxpZ2VuY2U/LnRvdGFsU2NvcmUgfHwgMH08L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPkludGVsbGlnZW5jZSBTY29yZTwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMTVweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgdGV4dC1hbGlnbjogY2VudGVyOyI+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDI0cHg7IGZvbnQtd2VpZ2h0OiBib2xkOyBjb2xvcjogdmFyKC0tZnViLXN1Y2Nlc3MpOyI+JHt0aGlzLmdldENvbnZlcnNpb25Qcm9iYWJpbGl0eSgpfSU8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPkNvbnZlcnNpb24gUHJvYmFiaWxpdHk8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDE1cHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IHRleHQtYWxpZ246IGNlbnRlcjsiPgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAyNHB4OyBmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi13YXJuaW5nKTsiPiR7dGhpcy5wZXJzb24/LmN1c3RvbUZlbGxvT2ZQcm9wZXJ0aWVzIHx8IDF9PC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5Qcm9wZXJ0aWVzIE93bmVkPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyI+CiAgICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+8J+TiCBSZXZlbnVlIE9wcG9ydHVuaXR5PC9oND4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDE4cHg7IGNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7IG1hcmdpbi1ib3R0b206IDEwcHg7Ij4KICAgICAgICAgICAgICAgIEVzdGltYXRlZCBDb21taXNzaW9uOiA8c3Ryb25nPiR7dGhpcy5jYWxjdWxhdGVDb21taXNzaW9uT3Bwb3J0dW5pdHkoKX08L3N0cm9uZz4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8cCBzdHlsZT0iY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsgZm9udC1zaXplOiAxM3B4OyI+CiAgICAgICAgICAgICAgICBCYXNlZCBvbiAke3RoaXMuaW50ZWxsaWdlbmNlPy5jbGFzc2lmaWNhdGlvbn0gcHJpb3JpdHkgbGV2ZWwgYW5kICR7dGhpcy5wZXJzb24/LmN1c3RvbUZlbGxvT2ZQcm9wZXJ0aWVzIHx8IDF9IHByb3BlcnR5IG93bmVyc2hpcC4KICAgICAgICAgICAgICAgICR7KHRoaXMucGVyc29uPy5jdXN0b21GZWxsb09mUHJvcGVydGllcyB8fCAwKSA+PSAzID8gJ0lOVkVTVE9SIHByb2ZpbGUgZGV0ZWN0ZWQgLSBwb3RlbnRpYWwgZm9yIG11bHRpcGxlIHRyYW5zYWN0aW9ucy4nIDogJyd9CiAgICAgICAgICAgICAgPC9wPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIGdldENvbnZlcnNpb25Qcm9iYWJpbGl0eSgpIHsKICAgICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IHRoaXMuaW50ZWxsaWdlbmNlPy5jbGFzc2lmaWNhdGlvbjsKICAgICAgICBjb25zdCByYXRlcyA9IHsKICAgICAgICAgICdDUklUSUNBTCc6IDk4LAogICAgICAgICAgJ1NVUEVSX0hPVCc6IDkwLAogICAgICAgICAgJ0hPVCc6IDc1LAogICAgICAgICAgJ1dBUk0nOiAzNSwKICAgICAgICAgICdDT0xEJzogMTUKICAgICAgICB9OwogICAgICAgIHJldHVybiByYXRlc1tjbGFzc2lmaWNhdGlvbl0gfHwgMTU7CiAgICAgIH0KCiAgICAgIGNhbGN1bGF0ZUNvbW1pc3Npb25PcHBvcnR1bml0eSgpIHsKICAgICAgICBjb25zdCBiYXNlQ29tbWlzc2lvbiA9IDIwMDAwOyAvLyBBdmVyYWdlIEdsZW5uIGNvbW1pc3Npb24KICAgICAgICBjb25zdCBwcm9wZXJ0aWVzID0gdGhpcy5wZXJzb24/LmN1c3RvbUZlbGxvT2ZQcm9wZXJ0aWVzIHx8IDE7CiAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IE1hdGgubWluKHByb3BlcnRpZXMsIDMpOyAvLyBDYXAgYXQgMyBmb3IgZGlzcGxheQogICAgICAgIGNvbnN0IHRvdGFsID0gYmFzZUNvbW1pc3Npb24gKiBtdWx0aXBsaWVyOwogICAgICAgIAogICAgICAgIHJldHVybiBgJCR7dG90YWwudG9Mb2NhbGVTdHJpbmcoKX1gOwogICAgICB9CgogICAgICByZW5kZXJQYXJ0bmVycygpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBjbGFzcz0icGFydG5lcnMtZGFzaGJvYXJkIj4KICAgICAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW4tYm90dG9tOiAyMHB4OyI+8J+knSBQYXJ0bmVyIENvb3JkaW5hdGlvbiBTeXN0ZW08L2gzPgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyBtYXJnaW4tYm90dG9tOiAyMHB4OyI+CiAgICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+8J+OryBPcHRpbWFsIFBhcnRuZXIgQXNzaWdubWVudDwvaDQ+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0icGFkZGluZzogMTVweDsgYmFja2dyb3VuZDogdmFyKC0tZnViLWJhY2tncm91bmQpOyBib3JkZXItcmFkaXVzOiA2cHg7Ij4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiBib2xkOyBtYXJnaW4tYm90dG9tOiA1cHg7Ij5SZWNvbW1lbmRlZDogJHt0aGlzLmdldE9wdGltYWxQYXJ0bmVyKCl9PC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBmb250LXNpemU6IDEzcHg7Ij4ke3RoaXMuZ2V0UGFydG5lclJhdGlvbmFsZSgpfTwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KGF1dG8tZml0LCBtaW5tYXgoMjUwcHgsIDFmcikpOyBnYXA6IDE1cHg7Ij4KICAgICAgICAgICAgICAke3RoaXMucmVuZGVyUGFydG5lckNhcmRzKCl9CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgZ2V0T3B0aW1hbFBhcnRuZXIoKSB7CiAgICAgICAgY29uc3Qgc2NvcmUgPSB0aGlzLmludGVsbGlnZW5jZT8udG90YWxTY29yZSB8fCAwOwogICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSB0aGlzLnBlcnNvbj8uY3VzdG9tRmVsbG9PZlByb3BlcnRpZXMgfHwgMTsKICAgICAgICAKICAgICAgICBpZiAoc2NvcmUgPj0gOTUgfHwgcHJvcGVydGllcyA+PSAzKSByZXR1cm4gJ0dsZW5uIEZpdHpnZXJhbGQnOwogICAgICAgIGlmIChzY29yZSA+PSA4NSkgcmV0dXJuICdKdXN0aW4gUGhpbGxpcHMnOyAgCiAgICAgICAgaWYgKHByb3BlcnRpZXMgPj0gMikgcmV0dXJuICdMbG95ZCBHcmF5JzsKICAgICAgICByZXR1cm4gJ0hlYXRoZXIgTWFydGluJzsKICAgICAgfQoKICAgICAgZ2V0UGFydG5lclJhdGlvbmFsZSgpIHsKICAgICAgICBjb25zdCBwYXJ0bmVyID0gdGhpcy5nZXRPcHRpbWFsUGFydG5lcigpOwogICAgICAgIGNvbnN0IHJhdGlvbmFsZXMgPSB7CiAgICAgICAgICAnR2xlbm4gRml0emdlcmFsZCc6ICdTeXN0ZW0gb3duZXIgKyBsdXh1cnkgc3BlY2lhbGlzdCArIGhpZ2ggcHJpb3JpdHkgbGVhZCcsCiAgICAgICAgICAnSnVzdGluIFBoaWxsaXBzJzogJ01hbmFnaW5nIGJyb2tlciArIHByZW1pdW0gY2xpZW50IGV4cGVyaWVuY2UnLAogICAgICAgICAgJ0xsb3lkIEdyYXknOiAnSW52ZXN0bWVudCBzcGVjaWFsaXN0ICsgYnV5ZXIgcmVwcmVzZW50YXRpb24gZXhwZXJ0JywKICAgICAgICAgICdIZWF0aGVyIE1hcnRpbic6ICdSZXNpZGVudGlhbCBzcGVjaWFsaXN0ICsgZmlyc3QtdGltZSBidXllciBleHBlcnQnCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gcmF0aW9uYWxlc1twYXJ0bmVyXSB8fCAnU3RhbmRhcmQgcmVzaWRlbnRpYWwgYXNzaWdubWVudCc7CiAgICAgIH0KCiAgICAgIHJlbmRlclBhcnRuZXJDYXJkcygpIHsKICAgICAgICBjb25zdCBwYXJ0bmVycyA9IFsKICAgICAgICAgIHsgbmFtZTogJ0dsZW5uIEZpdHpnZXJhbGQnLCByb2xlOiAnU3lzdGVtIE93bmVyJywgc3BlY2lhbGl6YXRpb246ICdMdXh1cnkgKyBUZWNobm9sb2d5JywgYWN0aXZlOiAyNSwgY29udmVyc2lvbjogOTIgfSwKICAgICAgICAgIHsgbmFtZTogJ0p1c3RpbiBQaGlsbGlwcycsIHJvbGU6ICdNYW5hZ2luZyBCcm9rZXInLCBzcGVjaWFsaXphdGlvbjogJ1ByZW1pdW0gQ2xpZW50cycsIGFjdGl2ZTogMTgsIGNvbnZlcnNpb246IDg4IH0sCiAgICAgICAgICB7IG5hbWU6ICdIZWF0aGVyIE1hcnRpbicsIHJvbGU6ICdSZXNpZGVudGlhbCBTcGVjaWFsaXN0Jywgc3BlY2lhbGl6YXRpb246ICdGaXJzdC1UaW1lIEJ1eWVycycsIGFjdGl2ZTogMjIsIGNvbnZlcnNpb246IDg1IH0sCiAgICAgICAgICB7IG5hbWU6ICdMbG95ZCBHcmF5Jywgcm9sZTogJ0ludmVzdG1lbnQgU3BlY2lhbGlzdCcsIHNwZWNpYWxpemF0aW9uOiAnQnV5ZXIgUmVwcmVzZW50YXRpb24nLCBhY3RpdmU6IDE1LCBjb252ZXJzaW9uOiA4MiB9CiAgICAgICAgXTsKCiAgICAgICAgcmV0dXJuIHBhcnRuZXJzLm1hcChwYXJ0bmVyID0+IGAKICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMTVweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsiPgogICAgICAgICAgICA8aDUgc3R5bGU9Im1hcmdpbi1ib3R0b206IDVweDsiPiR7cGFydG5lci5uYW1lfTwvaDU+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7IGZvbnQtc2l6ZTogMTJweDsgbWFyZ2luLWJvdHRvbTogMTBweDsiPiR7cGFydG5lci5yb2xlfTwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDExcHg7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPiR7cGFydG5lci5zcGVjaWFsaXphdGlvbn08L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOyI+CiAgICAgICAgICAgICAgPHNtYWxsPkFjdGl2ZTogJHtwYXJ0bmVyLmFjdGl2ZX08L3NtYWxsPgogICAgICAgICAgICAgIDxzbWFsbD5Db252OiAke3BhcnRuZXIuY29udmVyc2lvbn0lPC9zbWFsbD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgKS5qb2luKCcnKTsKICAgICAgfQoKICAgICAgcmVuZGVyUHJvcGVydHkoKSB7CiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9InByb3BlcnR5LWRhc2hib2FyZCI+CiAgICAgICAgICAgIDxoMyBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMjBweDsiPvCfj6AgUHJvcGVydHkgSW50ZWxsaWdlbmNlIEh1YjwvaDM+CiAgICAgICAgICAgIAogICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IG1hcmdpbi1ib3R0b206IDIwcHg7Ij4KICAgICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE1cHg7Ij7wn5OKIE1hcmtldCBJbnRlbGxpZ2VuY2U8L2g0PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KGF1dG8tZml0LCBtaW5tYXgoMTUwcHgsIDFmcikpOyBnYXA6IDEwcHg7Ij4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogMTBweDsiPgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi1zdWNjZXNzKTsiPlVQPC9kaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPk1hcmtldCBUcmVuZDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7IHBhZGRpbmc6IDEwcHg7Ij4KICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IGJvbGQ7IGNvbG9yOiB2YXIoLS1mdWItd2FybmluZyk7Ij5NRURJVU08L2Rpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+SW52ZW50b3J5PC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogMTBweDsiPgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi1wcmltYXJ5KTsiPjQ1IGRheXM8L2Rpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+QXZnIERPTTwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgJHt0aGlzLnJlbmRlckhvbWViZWF0U3RhdHVzKCl9CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICByZW5kZXJIb21lYmVhdFN0YXR1cygpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyI+CiAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPvCfk4ggSG9tZWJlYXQgTW9uaXRvcmluZzwvaDQ+CiAgICAgICAgICAgIDxwIHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBmb250LXN0eWxlOiBpdGFsaWM7Ij4KICAgICAgICAgICAgICBIb21lYmVhdCBpbnRlZ3JhdGlvbiBlbmFibGVzIGF1dG9tYXRpYyBtYXJrZXQgdmFsdWUgbW9uaXRvcmluZyBhbmQgYWxlcnRzLgogICAgICAgICAgICAgIENvbnRhY3QgR2xlbm4gdG8gYWN0aXZhdGUgcHJvcGVydHkgbW9uaXRvcmluZyBmb3IgdGhpcyBjbGllbnQuCiAgICAgICAgICAgIDwvcD4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYWN0aW9uLWJ0biIgc3R5bGU9Im1hcmdpbi10b3A6IDEwcHg7IiBvbmNsaWNrPSJ3aW5kb3cud2lsbG93QXBwLmFjdGl2YXRlSG9tZWJlYXQoKSI+CiAgICAgICAgICAgICAgQWN0aXZhdGUgSG9tZWJlYXQKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICByZW5kZXJDb21tdW5pY2F0aW9uKCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb21tdW5pY2F0aW9uLWRhc2hib2FyZCI+CiAgICAgICAgICAgIDxoMyBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMjBweDsiPvCfk6cgQ29tbXVuaWNhdGlvbiAmIEZvbGxvdy1VcCBDZW50ZXI8L2gzPgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyBtYXJnaW4tYm90dG9tOiAyMHB4OyI+CiAgICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+8J+TrCBFbWFpbCBJbnRlbGxpZ2VuY2U8L2g0PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KGF1dG8tZml0LCBtaW5tYXgoMTUwcHgsIDFmcikpOyBnYXA6IDEwcHg7Ij4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogMTBweDsiPgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi1wcmltYXJ5KTsiPiR7dGhpcy5wZXJzb24/LmN1c3RvbUZlbGxvT2ZFbWFpbENsaWNrcyB8fCAwfTwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5FbWFpbCBDbGlja3M8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0idGV4dC1hbGlnbjogY2VudGVyOyBwYWRkaW5nOiAxMHB4OyI+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiBib2xkOyBjb2xvcjogdmFyKC0tZnViLXN1Y2Nlc3MpOyI+QWN0aXZlPC9kaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPlN0YXR1czwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7IHBhZGRpbmc6IDEwcHg7Ij4KICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IGJvbGQ7IGNvbG9yOiB2YXIoLS1mdWItd2FybmluZyk7Ij5FbWFpbDwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5QcmVmZXJyZWQ8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMjBweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsiPgogICAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPuKaoSBSZWNvbW1lbmRlZCBGb2xsb3ctVXA8L2g0PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9InBhZGRpbmc6IDE1cHg7IGJhY2tncm91bmQ6IHZhcigtLWZ1Yi1iYWNrZ3JvdW5kKTsgYm9yZGVyLXJhZGl1czogNnB4OyI+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogYm9sZDsgbWFyZ2luLWJvdHRvbTogNXB4OyI+TmV4dCBBY3Rpb246ICR7dGhpcy5nZXROZXh0QWN0aW9uKCl9PC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBmb250LXNpemU6IDEzcHg7IG1hcmdpbi1ib3R0b206IDEwcHg7Ij4ke3RoaXMuZ2V0QWN0aW9uUmVhc29uKCl9PC9kaXY+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJhY3Rpb24tYnRuIiBvbmNsaWNrPSJ3aW5kb3cud2lsbG93QXBwLmV4ZWN1dGVGb2xsb3dVcCgpIj4KICAgICAgICAgICAgICAgICAgRXhlY3V0ZSBGb2xsb3ctVXAKICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIGdldE5leHRBY3Rpb24oKSB7CiAgICAgICAgY29uc3QgY2xhc3NpZmljYXRpb24gPSB0aGlzLmludGVsbGlnZW5jZT8uY2xhc3NpZmljYXRpb247CiAgICAgICAgY29uc3QgYWN0aW9ucyA9IHsKICAgICAgICAgICdDUklUSUNBTCc6ICdDYWxsIHdpdGhpbiAxNSBtaW51dGVzJywKICAgICAgICAgICdTVVBFUl9IT1QnOiAnQ2FsbCB0b2RheScsCiAgICAgICAgICAnSE9UJzogJ0VtYWlsICsgQ01BIGdlbmVyYXRpb24nLCAKICAgICAgICAgICdXQVJNJzogJ051cnR1cmluZyBlbWFpbCBzZXF1ZW5jZScsCiAgICAgICAgICAnQ09MRCc6ICdNb250aGx5IHRvdWNocG9pbnQnCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gYWN0aW9uc1tjbGFzc2lmaWNhdGlvbl0gfHwgJ1N0YW5kYXJkIGZvbGxvdy11cCc7CiAgICAgIH0KCiAgICAgIGdldEFjdGlvblJlYXNvbigpIHsKICAgICAgICByZXR1cm4gYEJhc2VkIG9uICR7dGhpcy5pbnRlbGxpZ2VuY2U/LmNsYXNzaWZpY2F0aW9ufSBwcmlvcml0eSBhbmQgYmVoYXZpb3JhbCBpbnRlbGxpZ2VuY2UgYW5hbHlzaXMuYDsKICAgICAgfQoKICAgICAgcmVuZGVyTWFuYWdlbWVudCgpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBjbGFzcz0ibWFuYWdlbWVudC1kYXNoYm9hcmQiPgogICAgICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbi1ib3R0b206IDIwcHg7Ij7impnvuI8gU3lzdGVtIE1hbmFnZW1lbnQgJiBTeW5jPC9oMz4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMjBweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgbWFyZ2luLWJvdHRvbTogMjBweDsiPgogICAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPvCflIQgSW50ZWdyYXRpb24gU3RhdHVzPC9oND4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdChhdXRvLWZpdCwgbWlubWF4KDIwMHB4LCAxZnIpKTsgZ2FwOiAxMHB4OyI+CiAgICAgICAgICAgICAgICAke3RoaXMucmVuZGVySW50ZWdyYXRpb25TdGF0dXMoKX0KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7Ij4KICAgICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE1cHg7Ij7wn5OKIEN1c3RvbSBGaWVsZHMgKCR7dGhpcy5nZXRDdXN0b21GaWVsZENvdW50KCl9IHRvdGFsKTwvaDQ+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAxM3B4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBsaW5lLWhlaWdodDogMS42OyI+CiAgICAgICAgICAgICAgICDigKIgPHN0cm9uZz4yMiBXSUxMT1cgZmllbGRzPC9zdHJvbmc+ICh3cml0ZS1lbmFibGVkKTogQmVoYXZpb3JhbCBpbnRlbGxpZ2VuY2UsIENNQSBkYXRhLCBtYXJrZXQgYW5hbHlzaXM8YnI+CiAgICAgICAgICAgICAgICDigKIgPHN0cm9uZz4xNiBGZWxsbyBmaWVsZHM8L3N0cm9uZz4gKHJlYWQtb25seSk6IExlYWQgc2NvcmluZywgZW5nYWdlbWVudCBtZXRyaWNzLCBwcm9wZXJ0eSBpbnRlbGxpZ2VuY2U8YnI+CiAgICAgICAgICAgICAgICDigKIgPHN0cm9uZz4xNSBDbG91ZENNQSBmaWVsZHM8L3N0cm9uZz4gKHdyaXRlLWVuYWJsZWQpOiBNTFMgaW50ZWxsaWdlbmNlLCBtYXJrZXQgY29uZGl0aW9ucywgQ01BIGFuYWx5dGljczxicj4KICAgICAgICAgICAgICAgIOKAoiA8c3Ryb25nPjIgT3RoZXIgZmllbGRzPC9zdHJvbmc+OiBBZGRpdGlvbmFsIHByb3BlcnR5IGFuZCBzeXN0ZW0gZGF0YQogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHJlbmRlckludGVncmF0aW9uU3RhdHVzKCkgewogICAgICAgIGNvbnN0IGludGVncmF0aW9ucyA9IFsKICAgICAgICAgIHsgbmFtZTogJ0ZvbGxvdyBVcCBCb3NzJywgc3RhdHVzOiAnQ29ubmVjdGVkJywgY29sb3I6ICd2YXIoLS1mdWItc3VjY2VzcyknIH0sCiAgICAgICAgICB7IG5hbWU6ICdGZWxsbyBQbGF0Zm9ybScsIHN0YXR1czogJ1N5bmNlZCcsIGNvbG9yOiAndmFyKC0tZnViLXN1Y2Nlc3MpJyB9LAogICAgICAgICAgeyBuYW1lOiAnQ2xvdWRDTUEnLCBzdGF0dXM6ICdPcGVyYXRpb25hbCcsIGNvbG9yOiAndmFyKC0tZnViLXN1Y2Nlc3MpJyB9LAogICAgICAgICAgeyBuYW1lOiAnU2llcnJhIEludGVyYWN0aXZlJywgc3RhdHVzOiAnSW50ZWdyYXRlZCcsIGNvbG9yOiAndmFyKC0tZnViLXN1Y2Nlc3MpJyB9CiAgICAgICAgXTsKCiAgICAgICAgcmV0dXJuIGludGVncmF0aW9ucy5tYXAoaW50ZWdyYXRpb24gPT4gYAogICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOyBhbGlnbi1pdGVtczogY2VudGVyOyBwYWRkaW5nOiA4cHggMDsgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LXNpemU6IDEzcHg7Ij4ke2ludGVncmF0aW9uLm5hbWV9PC9zcGFuPgogICAgICAgICAgICA8c3BhbiBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogJHtpbnRlZ3JhdGlvbi5jb2xvcn07IGZvbnQtd2VpZ2h0OiBib2xkOyI+JHtpbnRlZ3JhdGlvbi5zdGF0dXN9PC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYCkuam9pbignJyk7CiAgICAgIH0KCiAgICAgIGdldEN1c3RvbUZpZWxkQ291bnQoKSB7CiAgICAgICAgcmV0dXJuIDU1OyAvLyAyMiBXSUxMT1cgKyAxNiBGZWxsbyArIDE1IENsb3VkQ01BICsgMiBvdGhlcgogICAgICB9CgogICAgICB1cGRhdGVRdWlja0FjdGlvbnMoKSB7CiAgICAgICAgY29uc3QgcXVpY2tBY3Rpb25zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1aWNrLWFjdGlvbnMnKTsKICAgICAgICBjb25zdCBxdWlja0FjdGlvbnNDb250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1aWNrLWFjdGlvbnMtY29udGVudCcpOwogICAgICAgIAogICAgICAgIGlmICghdGhpcy5pbnRlbGxpZ2VuY2UpIHsKICAgICAgICAgIHF1aWNrQWN0aW9ucy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgYWN0aW9ucyA9IFtdOwogICAgICAgIAogICAgICAgIGlmICh0aGlzLmludGVsbGlnZW5jZS5jbGFzc2lmaWNhdGlvbiA9PT0gJ0NSSVRJQ0FMJykgewogICAgICAgICAgYWN0aW9ucy5wdXNoKHsgcHJpb3JpdHk6ICdjcml0aWNhbCcsIHRleHQ6ICdDYWxsIGltbWVkaWF0ZWx5JywgY291bnQ6IDEgfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh0aGlzLmludGVsbGlnZW5jZS5jbGFzc2lmaWNhdGlvbiA9PT0gJ1NVUEVSX0hPVCcpIHsKICAgICAgICAgIGFjdGlvbnMucHVzaCh7IHByaW9yaXR5OiAnc3VwZXJfaG90JywgdGV4dDogJ0NhbGwgdG9kYXknLCBjb3VudDogMSB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuaW50ZWxsaWdlbmNlLmNsYXNzaWZpY2F0aW9uID09PSAnSE9UJykgewogICAgICAgICAgYWN0aW9ucy5wdXNoKHsgcHJpb3JpdHk6ICdob3QnLCB0ZXh0OiAnR2VuZXJhdGUgQ01BJywgY291bnQ6IDEgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoYWN0aW9ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBxdWlja0FjdGlvbnNDb250ZW50LmlubmVySFRNTCA9IGFjdGlvbnMubWFwKGFjdGlvbiA9PiBgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbi1pdGVtIj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iYWN0aW9uLXByaW9yaXR5ICR7YWN0aW9uLnByaW9yaXR5fSI+PC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJhY3Rpb24tdGV4dCI+JHthY3Rpb24udGV4dH08L3NwYW4+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImFjdGlvbi1jb3VudCI+JHthY3Rpb24uY291bnR9PC9zcGFuPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIGApLmpvaW4oJycpOwogICAgICAgICAgCiAgICAgICAgICBxdWlja0FjdGlvbnMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHF1aWNrQWN0aW9ucy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaGFuZGxlUmVzaXplKCkgewogICAgICAgIC8vIEhhbmRsZSByZXNwb25zaXZlIGJlaGF2aW9yCiAgICAgICAgY29uc3QgcXVpY2tBY3Rpb25zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1aWNrLWFjdGlvbnMnKTsKICAgICAgICBpZiAod2luZG93LmlubmVyV2lkdGggPD0gNzY4KSB7CiAgICAgICAgICBxdWlja0FjdGlvbnMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW50ZWxsaWdlbmNlICYmIHRoaXMuaW50ZWxsaWdlbmNlLmNsYXNzaWZpY2F0aW9uICE9PSAnQ09MRCcpIHsKICAgICAgICAgIHF1aWNrQWN0aW9ucy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHNob3dFcnJvcihtZXNzYWdlKSB7CiAgICAgICAgY29uc3QgY29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3aWxsb3ctY29udGVudCcpOwogICAgICAgIAogICAgICAgIC8vIExvZyB0byBjb25zb2xlIGZvciBkZWJ1Z2dpbmcKICAgICAgICBjb25zb2xlLmVycm9yKCdXSUxMT1cgU3lzdGVtIEVycm9yOicsIG1lc3NhZ2UpOwogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0N1cnJlbnQgVVJMOicsIHdpbmRvdy5sb2NhdGlvbi5ocmVmKTsKICAgICAgICBjb25zb2xlLmVycm9yKCdVUkwgUGFyYW1ldGVyczonLCB3aW5kb3cubG9jYXRpb24uc2VhcmNoKTsKICAgICAgICAKICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImRlYnVnLXN0YXRlIj4KICAgICAgICAgICAgPGgyPlN5c3RlbSBFcnJvcjwvaDI+CiAgICAgICAgICAgIDxwPiR7bWVzc2FnZX08L3A+CiAgICAgICAgICAgIDxkZXRhaWxzIHN0eWxlPSJtYXJnaW4tdG9wOiAyMHB4OyB0ZXh0LWFsaWduOiBsZWZ0OyI+CiAgICAgICAgICAgICAgPHN1bW1hcnkgc3R5bGU9ImN1cnNvcjogcG9pbnRlcjsgY29sb3I6IHZhcigtLWZ1Yi1zZWNvbmRhcnkpOyBmb250LXNpemU6IDEycHg7Ij5UZWNobmljYWwgRGV0YWlscyAoQ2xpY2sgdG8gZXhwYW5kKTwvc3VtbWFyeT4KICAgICAgICAgICAgICA8cHJlIHN0eWxlPSJtYXJnaW4tdG9wOiAxMHB4OyBwYWRkaW5nOiAxMHB4OyBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYmFja2dyb3VuZCk7IGJvcmRlci1yYWRpdXM6IDRweDsgZm9udC1zaXplOiAxMXB4OyBvdmVyZmxvdy14OiBhdXRvOyI+JHttZXNzYWdlfVxuXG5VUkw6ICR7d2luZG93LmxvY2F0aW9uLmhyZWZ9XG5cbk9wZW4gYnJvd3NlciBjb25zb2xlIChGMTIpIGZvciBtb3JlIGRldGFpbHMuPC9wcmU+CiAgICAgICAgICAgIDwvZGV0YWlscz4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZGVidWctYnRuIiBvbmNsaWNrPSJsb2NhdGlvbi5yZWxvYWQoKSIgc3R5bGU9Im1hcmdpbi10b3A6IDE1cHg7Ij4KICAgICAgICAgICAgICBSZXRyeQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZGVidWctYnRuIiBvbmNsaWNrPSJ3aW5kb3cub3BlbignbWFpbHRvOmdsZW5uQGh1ZHNvbnZhbGxleXNvbGQuY29tP3N1YmplY3Q9V0lMTE9XIFN5c3RlbSBFcnJvciZib2R5PScgKyBlbmNvZGVVUklDb21wb25lbnQoJ0Vycm9yOiAnICsgJyR7bWVzc2FnZX0nICsgJ1xcblxcblVSTDogJyArIHdpbmRvdy5sb2NhdGlvbi5ocmVmKSkiIHN0eWxlPSJtYXJnaW4tdG9wOiAxMHB4OyBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItc2Vjb25kYXJ5KTsiPgogICAgICAgICAgICAgIFJlcG9ydCBFcnJvciB0byBHbGVubgogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIC8vIEFjdGlvbiBNZXRob2RzIChjYWxsZWQgZnJvbSBVSSkKICAgICAgYXN5bmMgZXhlY3V0ZVBhdHRlcm4ocGF0dGVybklkKSB7CiAgICAgICAgY29uc29sZS5sb2coJ0V4ZWN1dGluZyBwYXR0ZXJuOicsIHBhdHRlcm5JZCk7CiAgICAgICAgYWxlcnQoYEV4ZWN1dGluZyB0cmlnZ2VyIHBhdHRlcm4gJHtwYXR0ZXJuSWR9LiBJbiBwcm9kdWN0aW9uLCB0aGlzIHdvdWxkIHRyaWdnZXIgYXBwcm9wcmlhdGUgd29ya2Zsb3dzLmApOwogICAgICB9CgogICAgICBhc3luYyBnZW5lcmF0ZUNNQSgpIHsKICAgICAgICBjb25zdCBhZGRyZXNzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NtYS1hZGRyZXNzJyk/LnZhbHVlOwogICAgICAgIGlmICghYWRkcmVzcykgewogICAgICAgICAgYWxlcnQoJ1BsZWFzZSBlbnRlciBhIHByb3BlcnR5IGFkZHJlc3MnKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc29sZS5sb2coJ0dlbmVyYXRpbmcgQ01BIGZvcjonLCBhZGRyZXNzKTsKICAgICAgICBhbGVydChgR2VuZXJhdGluZyBDTUEgZm9yICR7YWRkcmVzc30uIEluIHByb2R1Y3Rpb24sIHRoaXMgd291bGQgdHJpZ2dlciBDbG91ZENNQSBnZW5lcmF0aW9uIHdpdGggYmVoYXZpb3JhbCBvcHRpbWl6YXRpb24uYCk7CiAgICAgIH0KCiAgICAgIGFzeW5jIGV4ZWN1dGVGb2xsb3dVcCgpIHsKICAgICAgICBjb25zb2xlLmxvZygnRXhlY3V0aW5nIGZvbGxvdy11cCcpOwogICAgICAgIGFsZXJ0KCdFeGVjdXRpbmcgZm9sbG93LXVwIGFjdGlvbi4gSW4gcHJvZHVjdGlvbiwgdGhpcyB3b3VsZCBjcmVhdGUgdGFza3MgYW5kIHNlbmQgY29tbXVuaWNhdGlvbnMuJyk7CiAgICAgIH0KCiAgICAgIGFzeW5jIGFjdGl2YXRlSG9tZWJlYXQoKSB7CiAgICAgICAgY29uc29sZS5sb2coJ0FjdGl2YXRpbmcgSG9tZWJlYXQnKTsKICAgICAgICBhbGVydCgnQWN0aXZhdGluZyBIb21lYmVhdCBtb25pdG9yaW5nLiBJbiBwcm9kdWN0aW9uLCB0aGlzIHdvdWxkIHNldHVwIGF1dG9tYXRlZCBtYXJrZXQgdmFsdWUgdHJhY2tpbmcuJyk7CiAgICAgIH0KCiAgICAgIGFzeW5jIGFkZFBlcnNvblRvV0lMTE9XKCkgewogICAgICAgIGNvbnNvbGUubG9nKCdBZGRpbmcgcGVyc29uIHRvIFdJTExPVycpOwogICAgICAgIGFsZXJ0KCdBZGRpbmcgY29udGFjdCB0byBXSUxMT1cgc3lzdGVtLiBJbiBwcm9kdWN0aW9uLCB0aGlzIHdvdWxkIGluaXRpYWxpemUgYmVoYXZpb3JhbCBpbnRlbGxpZ2VuY2UgdHJhY2tpbmcuJyk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBJbml0aWFsaXplIGFwcCB3aGVuIHBhZ2UgbG9hZHMKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoKSA9PiB7CiAgICAgIHdpbmRvdy53aWxsb3dBcHAgPSBuZXcgV0lMTE9XRW1iZWRkZWRBcHAoKTsKICAgIH0pOwoKICAgIC8vIEhhbmRsZSBGVUIgZW1iZWRkZWQgYXBwIGV2ZW50cwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCAoZXZlbnQpID0+IHsKICAgICAgLy8gSGFuZGxlIGFueSBGVUItc3BlY2lmaWMgZXZlbnRzCiAgICAgIGNvbnNvbGUubG9nKCdGVUIgRXZlbnQgcmVjZWl2ZWQ6JywgZXZlbnQpOwogICAgfSk7CiAgPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPg==';

function calculateOmnipresentScore(person) {
  const felloIntelligence = {
    leadScore: person.customFelloLeadScore || 0,
    dashboardClicks: person.customFelloOfDashboardClicks || 0,
    emailClicks: person.customFelloOfEmailClicks || 0,
    formSubmissions: person.customFelloOfFormSubmissions || 0,
    sellingTimeline: person.customFelloSellingTimeline || 'Unknown',
    propertiesOwned: person.customFelloOfProperties || 1
  };
  
  const felloScore = calculateFelloScore(felloIntelligence);
  const cloudCMAScore = 10;
  const willowScore = 10;
  const sierraScore = 10;
  
  const totalScore = Math.min(felloScore + cloudCMAScore + willowScore + sierraScore, 100);
  
  return {
    totalScore: totalScore,
    components: { fello: felloScore, cloudCMA: cloudCMAScore, willow: willowScore, sierra: sierraScore },
    classification: classifyPriority(totalScore),
    triggeredPatterns: evaluateTriggers(person)
  };
}

function calculateFelloScore(fello) {
  let score = 0;
  if (fello.leadScore >= 80) score += 15;
  else if (fello.leadScore >= 60) score += 10;
  else if (fello.leadScore >= 40) score += 5;
  if (fello.dashboardClicks > 10) score += 10;
  else if (fello.dashboardClicks > 5) score += 7;
  else if (fello.dashboardClicks > 0) score += 3;
  if (fello.emailClicks > 5) score += 5;
  else if (fello.emailClicks > 0) score += 2;
  if (fello.formSubmissions > 0) score += 5;
  return Math.min(score, 35);
}

function classifyPriority(score) {
  if (score >= 90) return 'CRITICAL';
  if (score >= 75) return 'SUPER_HOT';
  if (score >= 60) return 'HOT';
  if (score >= 40) return 'WARM';
  return 'COLD';
}

function evaluateTriggers(person) {
  const triggers = [];
  if ((person.customFelloLeadScore || 0) >= 80) {
    triggers.push({ id: 1, name: 'Ultra High Fello Score', severity: 'CRITICAL' });
  }
  if ((person.customFelloOfDashboardClicks || 0) >= 10) {
    triggers.push({ id: 2, name: 'High Dashboard Engagement', severity: 'HOT' });
  }
  return triggers;
}

exports.handler = async (event, context) => {
  console.log('WILLOW Function invoked (Lazy-Load, Fixed Circular Dependency)');
  
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Content-Type': 'text/html',
    'X-Content-Type-Options': 'nosniff',
    'X-XSS-Protection': '1; mode=block'
  };
  
  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }
  
  try {
    const params = event.queryStringParameters || {};
    const contextParam = params.context;
    
    let personData = null;
    let intelligenceData = null;
    
    if (contextParam) {
      try {
        const decodedContext = Buffer.from(contextParam, 'base64').toString('utf-8');
        const contextObj = JSON.parse(decodedContext);
        personData = contextObj.person || null;
        
        if (personData) {
          intelligenceData = calculateOmnipresentScore(personData);
          console.log('Intelligence calculated:', intelligenceData.totalScore);
        }
      } catch (err) {
        console.error('Context decode error:', err);
      }
    }
    
    let htmlTemplate = Buffer.from(HTML_TEMPLATE_B64, 'base64').toString('utf-8');
    
    if (intelligenceData && personData) {
      const dataScript = "<script>window.WILLOW_INTELLIGENCE=" + JSON.stringify(intelligenceData) + ";window.WILLOW_PERSON=" + JSON.stringify(personData) + ";</script>";
      htmlTemplate = htmlTemplate.replace('</head>', dataScript + '</head>');
    }
    
    return { statusCode: 200, headers, body: htmlTemplate };
    
  } catch (error) {
    console.error('Function error:', error);
    return {
      statusCode: 500,
      headers,
      body: "<html><body><h1>Server Error</h1><p>" + error.message + "</p></body></html>"
    };
  }
};
