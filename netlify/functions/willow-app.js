/**
 * WILLOW V50 FUB Embedded App - Netlify Function
 * Complete Follow Up Boss integration with behavioral intelligence
 */

const crypto = require('crypto');

// Environment variables
const FUB_API_KEY = process.env.FUB_API_KEY || 'fka_0oHt62NxmsExO6x69p08ix82zx8ii1hzrj';
const FUB_SECRET_KEY = process.env.FUB_SECRET_KEY || 'f1e0c6af664bc1525ecd8fecba255235';
const CLOUDCMA_API_KEY = process.env.CLOUDCMA_API_KEY || '742f4a46e1780904da090d721a9bae7b';

// Base64-encoded HTML template (avoids Lambda ES6 parsing issues)
const HTML_TEMPLATE_B64 = 'PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0idXRmLTgiPgogIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wIj4KICA8dGl0bGU+V0lMTE9XIFY1MCBJbnRlbGxpZ2VuY2UgU3lzdGVtPC90aXRsZT4KICA8IS0tIENSSVRJQ0FMOiBObyBYLUZyYW1lLU9wdGlvbnMgaGVhZGVyIGZvciBGVUIgY29tcGxpYW5jZSAtLT4KICA8c3R5bGU+CiAgICAvKiBGb2xsb3cgVXAgQm9zcyBTdHlsZSBDb21wbGlhbmNlICovCiAgICA6cm9vdCB7CiAgICAgIC0tZnViLXByaW1hcnk6ICMyNTYzZWI7CiAgICAgIC0tZnViLXNlY29uZGFyeTogIzY0NzQ4YjsKICAgICAgLS1mdWItc3VjY2VzczogIzE2YTM0YTsKICAgICAgLS1mdWItd2FybmluZzogI2VhYjMwODsKICAgICAgLS1mdWItZGFuZ2VyOiAjZGMyNjI2OwogICAgICAtLWZ1Yi1iYWNrZ3JvdW5kOiAjZjhmYWZjOwogICAgICAtLWZ1Yi1jYXJkOiAjZmZmZmZmOwogICAgICAtLWZ1Yi1ib3JkZXI6ICNlMmU4ZjA7CiAgICAgIC0tZnViLXRleHQ6ICMwZjE3MmE7CiAgICAgIC0tZnViLXRleHQtbXV0ZWQ6ICM2NDc0OGI7CiAgICB9CgogICAgKiB7CiAgICAgIG1hcmdpbjogMDsKICAgICAgcGFkZGluZzogMDsKICAgICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIH0KCiAgICBib2R5IHsKICAgICAgZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgJ1NlZ29lIFVJJywgUm9ib3RvLCBzYW5zLXNlcmlmOwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYmFja2dyb3VuZCk7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dCk7CiAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgbGluZS1oZWlnaHQ6IDEuNTsKICAgIH0KCiAgICAjd2lsbG93LWNvbnRhaW5lciB7CiAgICAgIGJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsKICAgICAgbWluLWhlaWdodDogNjAwcHg7CiAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgYm94LXNoYWRvdzogMCAxcHggM3B4IHJnYmEoMCwwLDAsMC4xKTsKICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIH0KCiAgICAvKiBUYWIgTmF2aWdhdGlvbiAqLwogICAgI3dpbGxvdy10YWJzIHsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOwogICAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7CiAgICAgIHBhZGRpbmc6IDA7CiAgICAgIG1hcmdpbjogMDsKICAgICAgZmxleC1zaHJpbms6IDA7CiAgICB9CgogICAgLnRhYi1idXR0b24gewogICAgICBmbGV4OiAxOwogICAgICBwYWRkaW5nOiAxMnB4IDhweDsKICAgICAgYm9yZGVyOiBub25lOwogICAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICBmb250LXNpemU6IDEzcHg7CiAgICAgIGZvbnQtd2VpZ2h0OiA1MDA7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItc2Vjb25kYXJ5KTsKICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnMgZWFzZTsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKICAgIH0KCiAgICAudGFiLWJ1dHRvbjpob3ZlciB7CiAgICAgIGJhY2tncm91bmQ6IHJnYmEoMzcsIDk5LCAyMzUsIDAuMDUpOwogICAgfQoKICAgIC50YWItYnV0dG9uLmFjdGl2ZSB7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGJhY2tncm91bmQ6IHJnYmEoMzcsIDk5LCAyMzUsIDAuMDUpOwogICAgfQoKICAgIC8qIENvbnRlbnQgQXJlYSAqLwogICAgI3dpbGxvdy1jb250ZW50IHsKICAgICAgZmxleDogMTsKICAgICAgcGFkZGluZzogMjBweDsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOwogICAgICBvdmVyZmxvdy15OiBhdXRvOwogICAgICBtYXgtaGVpZ2h0OiA1NTBweDsKICAgIH0KCiAgICAvKiBMb2FkaW5nIFN0YXRlICovCiAgICAubG9hZGluZyB7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICBoZWlnaHQ6IDIwMHB4OwogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgfQoKICAgIC5sb2FkaW5nOjphZnRlciB7CiAgICAgIGNvbnRlbnQ6ICcnOwogICAgICB3aWR0aDogMjBweDsKICAgICAgaGVpZ2h0OiAyMHB4OwogICAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHZhcigtLWZ1Yi1wcmltYXJ5KTsKICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICBhbmltYXRpb246IHNwaW4gMXMgbGluZWFyIGluZmluaXRlOwogICAgICBtYXJnaW4tbGVmdDogMTBweDsKICAgIH0KCiAgICBAa2V5ZnJhbWVzIHNwaW4gewogICAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDBkZWcpOyB9CiAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpOyB9CiAgICB9CgogICAgLyogSW50ZWxsaWdlbmNlIERhc2hib2FyZCAqLwogICAgLnNjb3JlLXNlY3Rpb24gewogICAgICBkaXNwbGF5OiBncmlkOwogICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IGF1dG8gMWZyOwogICAgICBnYXA6IDIwcHg7CiAgICAgIG1hcmdpbi1ib3R0b206IDI1cHg7CiAgICAgIHBhZGRpbmc6IDIwcHg7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICNmOGZhZmMgMCUsICNlMmU4ZjAgMTAwJSk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOwogICAgfQoKICAgIC5zY29yZS1nYXVnZSB7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGdhcDogMTBweDsKICAgIH0KCiAgICAuZ2F1Z2UtY2lyY2xlIHsKICAgICAgd2lkdGg6IDEwMHB4OwogICAgICBoZWlnaHQ6IDEwMHB4OwogICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgIGJhY2tncm91bmQ6IGNvbmljLWdyYWRpZW50KHZhcigtLWZ1Yi1wcmltYXJ5KSAwZGVnLCB2YXIoLS1mdWItcHJpbWFyeSkgY2FsYyh2YXIoLS1zY29yZS1wZXJjZW50KSAqIDMuNmRlZyksIHZhcigtLWZ1Yi1ib3JkZXIpIGNhbGModmFyKC0tc2NvcmUtcGVyY2VudCkgKiAzLjZkZWcpLCB2YXIoLS1mdWItYm9yZGVyKSAzNjBkZWcpOwogICAgICBkaXNwbGF5OiBmbGV4OwogICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgfQoKICAgIC5nYXVnZS1jaXJjbGU6OmJlZm9yZSB7CiAgICAgIGNvbnRlbnQ6ICcnOwogICAgICB3aWR0aDogNzBweDsKICAgICAgaGVpZ2h0OiA3MHB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgfQoKICAgIC5zY29yZS12YWx1ZSB7CiAgICAgIGZvbnQtc2l6ZTogMjRweDsKICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIHotaW5kZXg6IDE7CiAgICB9CgogICAgLnNjb3JlLWxhYmVsIHsKICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgICB6LWluZGV4OiAxOwogICAgfQoKICAgIC5wcmlvcml0eS1iYWRnZSB7CiAgICAgIHBhZGRpbmc6IDZweCAxMnB4OwogICAgICBib3JkZXItcmFkaXVzOiAyMHB4OwogICAgICBmb250LXNpemU6IDEycHg7CiAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgfQoKICAgIC5wcmlvcml0eS1iYWRnZS5jcml0aWNhbCB7IGJhY2tncm91bmQ6ICNmZWYyZjI7IGNvbG9yOiAjZGMyNjI2OyB9CiAgICAucHJpb3JpdHktYmFkZ2Uuc3VwZXJfaG90IHsgYmFja2dyb3VuZDogI2ZmZjdlZDsgY29sb3I6ICNlYTU4MGM7IH0KICAgIC5wcmlvcml0eS1iYWRnZS5ob3QgeyBiYWNrZ3JvdW5kOiAjZmVmY2U4OyBjb2xvcjogI2NhOGEwNDsgfQogICAgLnByaW9yaXR5LWJhZGdlLndhcm0geyBiYWNrZ3JvdW5kOiAjZjBmZGY0OyBjb2xvcjogIzE2YTM0YTsgfQogICAgLnByaW9yaXR5LWJhZGdlLmNvbGQgeyBiYWNrZ3JvdW5kOiAjZjhmYWZjOyBjb2xvcjogIzY0NzQ4YjsgfQoKICAgIC5zY29yZS1jb21wb25lbnRzIHsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgZ2FwOiAxMnB4OwogICAgICBmbGV4OiAxOwogICAgfQoKICAgIC5jb21wb25lbnQgewogICAgICBkaXNwbGF5OiBncmlkOwogICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDEwMHB4IDYwcHggMWZyOwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICBnYXA6IDEwcHg7CiAgICAgIHBhZGRpbmc6IDhweCAxMnB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7CiAgICB9CgogICAgLmNvbXBvbmVudCBsYWJlbCB7CiAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgZm9udC13ZWlnaHQ6IDUwMDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi10ZXh0KTsKICAgIH0KCiAgICAuY29tcG9uZW50IHZhbHVlIHsKICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICBmb250LXdlaWdodDogYm9sZDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi1wcmltYXJ5KTsKICAgIH0KCiAgICAuY29tcG9uZW50IGJhciB7CiAgICAgIGhlaWdodDogNnB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgYm9yZGVyLXJhZGl1czogM3B4OwogICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB9CgogICAgLmNvbXBvbmVudCBiYXI6OmJlZm9yZSB7CiAgICAgIGNvbnRlbnQ6ICcnOwogICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgIHRvcDogMDsKICAgICAgbGVmdDogMDsKICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDNweDsKICAgICAgd2lkdGg6IHZhcigtLWJhci13aWR0aCwgMCUpOwogICAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjVzIGVhc2U7CiAgICB9CgogICAgLyogUXVpY2sgQWN0aW9ucyBTaWRlYmFyICovCiAgICAucXVpY2stYWN0aW9ucyB7CiAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgdG9wOiAyMHB4OwogICAgICByaWdodDogMjBweDsKICAgICAgd2lkdGg6IDI1MHB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOwogICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDZweCByZ2JhKDAsMCwwLDAuMSk7CiAgICAgIHotaW5kZXg6IDEwMDA7CiAgICAgIG1heC1oZWlnaHQ6IDQwMHB4OwogICAgICBvdmVyZmxvdy15OiBhdXRvOwogICAgfQoKICAgIC5xdWljay1hY3Rpb25zIGgzIHsKICAgICAgcGFkZGluZzogMTVweDsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLXByaW1hcnkpOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgbWFyZ2luOiAwOwogICAgfQoKICAgIC5hY3Rpb24taXRlbSB7CiAgICAgIHBhZGRpbmc6IDEycHggMTVweDsKICAgICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOwogICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQgMC4yczsKICAgIH0KCiAgICAuYWN0aW9uLWl0ZW06aG92ZXIgewogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYmFja2dyb3VuZCk7CiAgICB9CgogICAgLmFjdGlvbi1pdGVtOmxhc3QtY2hpbGQgewogICAgICBib3JkZXItYm90dG9tOiBub25lOwogICAgfQoKICAgIC5hY3Rpb24tcHJpb3JpdHkgewogICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICAgIHdpZHRoOiA4cHg7CiAgICAgIGhlaWdodDogOHB4OwogICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgIG1hcmdpbi1yaWdodDogOHB4OwogICAgfQoKICAgIC5hY3Rpb24tcHJpb3JpdHkuY3JpdGljYWwgeyBiYWNrZ3JvdW5kOiAjZGMyNjI2OyB9CiAgICAuYWN0aW9uLXByaW9yaXR5LnN1cGVyX2hvdCB7IGJhY2tncm91bmQ6ICNlYTU4MGM7IH0KICAgIC5hY3Rpb24tcHJpb3JpdHkuaG90IHsgYmFja2dyb3VuZDogI2NhOGEwNDsgfQoKICAgIC5hY3Rpb24tdGV4dCB7CiAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi10ZXh0KTsKICAgIH0KCiAgICAuYWN0aW9uLWNvdW50IHsKICAgICAgZmxvYXQ6IHJpZ2h0OwogICAgICBmb250LXNpemU6IDExcHg7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7CiAgICAgIGJhY2tncm91bmQ6IHZhcigtLWZ1Yi1iYWNrZ3JvdW5kKTsKICAgICAgcGFkZGluZzogMnB4IDZweDsKICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIH0KCiAgICAvKiBQYXR0ZXJuIEl0ZW1zICovCiAgICAucGF0dGVybnMtc2VjdGlvbiB7CiAgICAgIG1hcmdpbi1ib3R0b206IDI1cHg7CiAgICB9CgogICAgLnBhdHRlcm5zLXNlY3Rpb24gaDMgewogICAgICBmb250LXNpemU6IDE2cHg7CiAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dCk7CiAgICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgcGFkZGluZy1ib3R0b206IDhweDsKICAgIH0KCiAgICAucGF0dGVybi1pdGVtIHsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOwogICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICBwYWRkaW5nOiAxNXB4OwogICAgICBtYXJnaW4tYm90dG9tOiAxMnB4OwogICAgICB0cmFuc2l0aW9uOiBib3JkZXItY29sb3IgMC4yczsKICAgIH0KCiAgICAucGF0dGVybi1pdGVtOmhvdmVyIHsKICAgICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICB9CgogICAgLnBhdHRlcm4taGVhZGVyIHsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgZ2FwOiAxMHB4OwogICAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB9CgogICAgLnBhdHRlcm4taWNvbiB7CiAgICAgIGZvbnQtc2l6ZTogMThweDsKICAgIH0KCiAgICAucGF0dGVybi1uYW1lIHsKICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi10ZXh0KTsKICAgICAgZmxleDogMTsKICAgIH0KCiAgICAuY29udmVyc2lvbi1yYXRlIHsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLXN1Y2Nlc3MpOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIHBhZGRpbmc6IDJweCA4cHg7CiAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgIGZvbnQtc2l6ZTogMTFweDsKICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICB9CgogICAgLnBhdHRlcm4tZGVzY3JpcHRpb24gewogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgICBmb250LXNpemU6IDEzcHg7CiAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgIGxpbmUtaGVpZ2h0OiAxLjQ7CiAgICB9CgogICAgLmFjdGlvbi1idG4gewogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgYm9yZGVyOiBub25lOwogICAgICBwYWRkaW5nOiA4cHggMTZweDsKICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgZm9udC13ZWlnaHQ6IDUwMDsKICAgICAgdHJhbnNpdGlvbjogYmFja2dyb3VuZCAwLjJzOwogICAgfQoKICAgIC5hY3Rpb24tYnRuOmhvdmVyIHsKICAgICAgYmFja2dyb3VuZDogIzFkNGVkODsKICAgIH0KCiAgICAvKiBFcnJvci9EZWJ1ZyBTdGF0ZXMgKi8KICAgIC5kZWJ1Zy1zdGF0ZSB7CiAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgcGFkZGluZzogNDBweCAyMHB4OwogICAgfQoKICAgIC5kZWJ1Zy1zdGF0ZSBoMiB7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dCk7CiAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICB9CgogICAgLmRlYnVnLXN0YXRlIHAgewogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgICBtYXJnaW4tYm90dG9tOiAyMHB4OwogICAgfQoKICAgIC5kZWJ1Zy1idG4gewogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgYm9yZGVyOiBub25lOwogICAgICBwYWRkaW5nOiAxMHB4IDIwcHg7CiAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICBmb250LXNpemU6IDE0cHg7CiAgICB9CgogICAgLyogUmVzcG9uc2l2ZSBEZXNpZ24gKi8KICAgIEBtZWRpYSAobWF4LXdpZHRoOiA3NjhweCkgewogICAgICAjd2lsbG93LWNvbnRhaW5lciB7CiAgICAgICAgbWFyZ2luOiAwOwogICAgICAgIGJvcmRlci1yYWRpdXM6IDA7CiAgICAgICAgbWluLWhlaWdodDogMTAwdmg7CiAgICAgIH0KCiAgICAgIC50YWItYnV0dG9uIHsKICAgICAgICBwYWRkaW5nOiAxMHB4IDZweDsKICAgICAgICBmb250LXNpemU6IDExcHg7CiAgICAgIH0KCiAgICAgIC5zY29yZS1zZWN0aW9uIHsKICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmcjsKICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgIH0KCiAgICAgIC5jb21wb25lbnQgewogICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogODBweCA1MHB4IDFmcjsKICAgICAgICBmb250LXNpemU6IDExcHg7CiAgICAgIH0KCiAgICAgIC5xdWljay1hY3Rpb25zIHsKICAgICAgICBkaXNwbGF5OiBub25lOyAvKiBIaWRlIG9uIG1vYmlsZSAqLwogICAgICB9CiAgICB9CgogICAgLyogSGlkZGVuIGJ5IGRlZmF1bHQgKi8KICAgIC50YWItY29udGVudCB7CiAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICB9CgogICAgLnRhYi1jb250ZW50LmFjdGl2ZSB7CiAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgfQogIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CiAgPCEtLSBSRVFVSVJFRCBGVUIgSW50ZWdyYXRpb24gLS0+CiAgPHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiIHNyYz0iaHR0cHM6Ly9laWEuZm9sbG93dXBib3NzLmNvbS9lbWJlZGRlZEFwcHMtdjEuMC4wLmpzIj48L3NjcmlwdD4KCiAgPGRpdiBpZD0id2lsbG93LWNvbnRhaW5lciI+CiAgICA8IS0tIE5hdmlnYXRpb24gVGFicyAtLT4KICAgIDxuYXYgaWQ9IndpbGxvdy10YWJzIj4KICAgICAgPGJ1dHRvbiBjbGFzcz0idGFiLWJ1dHRvbiBhY3RpdmUiIGRhdGEtdGFiPSJpbnRlbGxpZ2VuY2UiPvCfjq8gSW50ZWxsaWdlbmNlPC9idXR0b24+CiAgICAgIDxidXR0b24gY2xhc3M9InRhYi1idXR0b24iIGRhdGEtdGFiPSJjbWEiPvCfk4ggQ01BPC9idXR0b24+CiAgICAgIDxidXR0b24gY2xhc3M9InRhYi1idXR0b24iIGRhdGEtdGFiPSJhbmFseXRpY3MiPvCfk4ogQW5hbHl0aWNzPC9idXR0b24+CiAgICAgIDxidXR0b24gY2xhc3M9InRhYi1idXR0b24iIGRhdGEtdGFiPSJwYXJ0bmVycyI+8J+knSBQYXJ0bmVyczwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIiBkYXRhLXRhYj0icHJvcGVydHkiPvCfj6AgUHJvcGVydHk8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBjbGFzcz0idGFiLWJ1dHRvbiIgZGF0YS10YWI9ImNvbW11bmljYXRpb24iPvCfk6cgQ29tbXVuaWNhdGlvbjwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIiBkYXRhLXRhYj0ibWFuYWdlbWVudCI+4pqZ77iPIFN5c3RlbTwvYnV0dG9uPgogICAgPC9uYXY+CgogICAgPCEtLSBDb250ZW50IEFyZWEgLS0+CiAgICA8bWFpbiBpZD0id2lsbG93LWNvbnRlbnQiPgogICAgICAKICAgICAgPCEtLSBJbnRlbGxpZ2VuY2UgRGFzaGJvYXJkIFRhYiAtLT4KICAgICAgPGRpdiBpZD0iaW50ZWxsaWdlbmNlLWNvbnRlbnQiIGNsYXNzPSJ0YWItY29udGVudCBhY3RpdmUiPgogICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcgV0lMTE9XIEludGVsbGlnZW5jZTwvZGl2PgogICAgICA8L2Rpdj4KCiAgICAgIDwhLS0gQ01BIEdlbmVyYXRpb24gVGFiIC0tPgogICAgICA8ZGl2IGlkPSJjbWEtY29udGVudCIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIENNQSBTeXN0ZW08L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8IS0tIEFuYWx5dGljcyBUYWIgLS0+CiAgICAgIDxkaXYgaWQ9ImFuYWx5dGljcy1jb250ZW50IiBjbGFzcz0idGFiLWNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcgQW5hbHl0aWNzPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgPCEtLSBQYXJ0bmVycyBUYWIgLS0+CiAgICAgIDxkaXYgaWQ9InBhcnRuZXJzLWNvbnRlbnQiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+TG9hZGluZyBQYXJ0bmVyIFN5c3RlbTwvZGl2PgogICAgICA8L2Rpdj4KCiAgICAgIDwhLS0gUHJvcGVydHkgVGFiIC0tPgogICAgICA8ZGl2IGlkPSJwcm9wZXJ0eS1jb250ZW50IiBjbGFzcz0idGFiLWNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcgUHJvcGVydHkgSW50ZWxsaWdlbmNlPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgPCEtLSBDb21tdW5pY2F0aW9uIFRhYiAtLT4KICAgICAgPGRpdiBpZD0iY29tbXVuaWNhdGlvbi1jb250ZW50IiBjbGFzcz0idGFiLWNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcgQ29tbXVuaWNhdGlvbiBDZW50ZXI8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8IS0tIE1hbmFnZW1lbnQgVGFiIC0tPgogICAgICA8ZGl2IGlkPSJtYW5hZ2VtZW50LWNvbnRlbnQiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+TG9hZGluZyBTeXN0ZW0gTWFuYWdlbWVudDwvZGl2PgogICAgICA8L2Rpdj4KCiAgICA8L21haW4+CiAgPC9kaXY+CgogIDwhLS0gUXVpY2sgQWN0aW9ucyBTaWRlYmFyIC0tPgogIDxkaXYgY2xhc3M9InF1aWNrLWFjdGlvbnMiIGlkPSJxdWljay1hY3Rpb25zIiBzdHlsZT0iZGlzcGxheTogbm9uZTsiPgogICAgPGgzPuKaoSBRdWljayBBY3Rpb25zPC9oMz4KICAgIDxkaXYgaWQ9InF1aWNrLWFjdGlvbnMtY29udGVudCI+CiAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbi1pdGVtIj4KICAgICAgICA8c3BhbiBjbGFzcz0iYWN0aW9uLXByaW9yaXR5IGNyaXRpY2FsIj48L3NwYW4+CiAgICAgICAgPHNwYW4gY2xhc3M9ImFjdGlvbi10ZXh0Ij5Mb2FkaW5nIGFjdGlvbnMuLi48L3NwYW4+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgPC9kaXY+CgogIDxzY3JpcHQ+CiAgICAvKioKICAgICAqIFdJTExPVyBWNTAgRW1iZWRkZWQgQXBwIEphdmFTY3JpcHQKICAgICAqIENvbXBsZXRlIEZVQiBjb21wbGlhbmNlIHdpdGggbXVsdGktZmVhdHVyZSBhcmNoaXRlY3R1cmUKICAgICAqLwogICAgCiAgICBjbGFzcyBXSUxMT1dFbWJlZGRlZEFwcCB7CiAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAgICAgdGhpcy5wZXJzb24gPSBudWxsOwogICAgICAgIHRoaXMuaW50ZWxsaWdlbmNlID0gbnVsbDsKICAgICAgICB0aGlzLmN1cnJlbnRUYWIgPSAnaW50ZWxsaWdlbmNlJzsKICAgICAgICB0aGlzLmRlYnVnU3RhdGUgPSBudWxsOwogICAgICAgIAogICAgICAgIHRoaXMuaW5pdCgpOwogICAgICB9CgogICAgICBhc3luYyBpbml0KCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAvLyBQYXJzZSBGVUIgY29udGV4dCBmcm9tIFVSTCBwYXJhbWV0ZXJzCiAgICAgICAgICBhd2FpdCB0aGlzLnBhcnNlQ29udGV4dCgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBIYW5kbGUgZGVidWcgc3RhdGVzCiAgICAgICAgICBpZiAodGhpcy5kZWJ1Z1N0YXRlKSB7CiAgICAgICAgICAgIHRoaXMuaGFuZGxlRGVidWdTdGF0ZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTG9hZCBXSUxMT1cgaW50ZWxsaWdlbmNlCiAgICAgICAgICBhd2FpdCB0aGlzLmxvYWRJbnRlbGxpZ2VuY2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gU2V0dXAgZXZlbnQgbGlzdGVuZXJzCiAgICAgICAgICB0aGlzLnNldHVwRXZlbnRMaXN0ZW5lcnMoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gUmVuZGVyIGluaXRpYWwgY29udGVudAogICAgICAgICAgYXdhaXQgdGhpcy5yZW5kZXJDdXJyZW50VGFiKCk7CiAgICAgICAgICAKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgY29uc29sZS5lcnJvcignV0lMTE9XIEFwcCBJbml0aWFsaXphdGlvbiBFcnJvcjonLCBlcnJvcik7CiAgICAgICAgICB0aGlzLnNob3dFcnJvcignRmFpbGVkIHRvIGluaXRpYWxpemUgV0lMTE9XIHN5c3RlbScpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgYXN5bmMgcGFyc2VDb250ZXh0KCkgewogICAgICAgIGNvbnN0IHVybFBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCk7CiAgICAgICAgY29uc3QgY29udGV4dFBhcmFtID0gdXJsUGFyYW1zLmdldCgnY29udGV4dCcpOwogICAgICAgIGNvbnN0IHNpZ25hdHVyZVBhcmFtID0gdXJsUGFyYW1zLmdldCgnc2lnbmF0dXJlJyk7CgogICAgICAgIGlmICghY29udGV4dFBhcmFtKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbnRleHQgcGFyYW1ldGVyIHByb3ZpZGVkJyk7CiAgICAgICAgfQoKICAgICAgICAvLyBEZWNvZGUgYmFzZTY0IGNvbnRleHQKICAgICAgICB0cnkgewogICAgICAgICAgY29uc3QgZGVjb2RlZENvbnRleHQgPSBKU09OLnBhcnNlKGF0b2IoY29udGV4dFBhcmFtKSk7CiAgICAgICAgICB0aGlzLmNvbnRleHQgPSBkZWNvZGVkQ29udGV4dDsKICAgICAgICAgIHRoaXMucGVyc29uID0gZGVjb2RlZENvbnRleHQucGVyc29uOwogICAgICAgICAgdGhpcy5kZWJ1Z1N0YXRlID0gZGVjb2RlZENvbnRleHQuZGVidWdTdGF0ZTsKICAgICAgICAgIAogICAgICAgICAgY29uc29sZS5sb2coJ0ZVQiBDb250ZXh0IGxvYWRlZDonLCB0aGlzLmNvbnRleHQpOwogICAgICAgICAgCiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGRlY29kZSBGVUIgY29udGV4dCcpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaGFuZGxlRGVidWdTdGF0ZSgpIHsKICAgICAgICBjb25zdCBjb250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpbGxvdy1jb250ZW50Jyk7CiAgICAgICAgCiAgICAgICAgc3dpdGNoKHRoaXMuZGVidWdTdGF0ZSkgewogICAgICAgICAgY2FzZSAnd29ya2luZyc6CiAgICAgICAgICAgIC8vIENvbnRpbnVlIHdpdGggbm9ybWFsIG9wZXJhdGlvbgogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgCiAgICAgICAgICBjYXNlICdhY2NvdW50X25vdF9mb3VuZCc6CiAgICAgICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJBY2NvdW50Tm90Rm91bmQoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIAogICAgICAgICAgY2FzZSAndXNlcl9ub3RfZm91bmQnOgogICAgICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IHRoaXMucmVuZGVyVXNlck5vdEZvdW5kKCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAKICAgICAgICAgIGNhc2UgJ3BlcnNvbl9ub3RfZm91bmQnOgogICAgICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IHRoaXMucmVuZGVyUGVyc29uTm90Rm91bmQoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIAogICAgICAgICAgY2FzZSAndW5hdXRob3JpemVkJzoKICAgICAgICAgICAgY29udGVudC5pbm5lckhUTUwgPSB0aGlzLnJlbmRlclVuYXV0aG9yaXplZCgpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IHRoaXMucmVuZGVyVW5rbm93blN0YXRlKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZW5kZXJBY2NvdW50Tm90Rm91bmQoKSB7CiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImRlYnVnLXN0YXRlIj4KICAgICAgICAgICAgPGgyPkFjY291bnQgU2V0dXAgUmVxdWlyZWQ8L2gyPgogICAgICAgICAgICA8cD5Zb3VyIEZvbGxvdyBVcCBCb3NzIGFjY291bnQgbmVlZHMgdG8gYmUgY29uZmlndXJlZCBmb3IgV0lMTE9XIGludGVncmF0aW9uLjwvcD4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZGVidWctYnRuIiBvbmNsaWNrPSJ3aW5kb3cub3BlbignbWFpbHRvOmdsZW5uQGh1ZHNvbnZhbGxleXNvbGQuY29tP3N1YmplY3Q9V0lMTE9XIEFjY291bnQgU2V0dXAnKSI+CiAgICAgICAgICAgICAgQ29udGFjdCBHbGVubiBmb3IgU2V0dXAKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICByZW5kZXJVc2VyTm90Rm91bmQoKSB7CiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImRlYnVnLXN0YXRlIj4KICAgICAgICAgICAgPGgyPlVzZXIgTm90IEZvdW5kPC9oMj4KICAgICAgICAgICAgPHA+WW91ciB1c2VyIGFjY291bnQgaXMgbm90IGNvbmZpZ3VyZWQgaW4gdGhlIFdJTExPVyBzeXN0ZW0uPC9wPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJkZWJ1Zy1idG4iIG9uY2xpY2s9IndpbmRvdy5vcGVuKCdtYWlsdG86Z2xlbm5AaHVkc29udmFsbGV5c29sZC5jb20/c3ViamVjdD1XSUxMT1cgVXNlciBBY2Nlc3MnKSI+CiAgICAgICAgICAgICAgUmVxdWVzdCBBY2Nlc3MKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICByZW5kZXJQZXJzb25Ob3RGb3VuZCgpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBjbGFzcz0iZGVidWctc3RhdGUiPgogICAgICAgICAgICA8aDI+Q29udGFjdCBOb3QgRm91bmQ8L2gyPgogICAgICAgICAgICA8cD5UaGlzIGNvbnRhY3QgaXMgbm90IHlldCBpbiB0aGUgV0lMTE9XIGludGVsbGlnZW5jZSBzeXN0ZW0uPC9wPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJkZWJ1Zy1idG4iIG9uY2xpY2s9InRoaXMuYWRkUGVyc29uVG9XSUxMT1coKSI+CiAgICAgICAgICAgICAgQWRkIHRvIFdJTExPVyBTeXN0ZW0KICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICByZW5kZXJVbmF1dGhvcml6ZWQoKSB7CiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImRlYnVnLXN0YXRlIj4KICAgICAgICAgICAgPGgyPkFjY2VzcyBEZW5pZWQ8L2gyPgogICAgICAgICAgICA8cD5Zb3UgZG9uJ3QgaGF2ZSBwZXJtaXNzaW9uIHRvIGFjY2VzcyB0aGUgV0lMTE9XIHN5c3RlbS48L3A+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImRlYnVnLWJ0biIgb25jbGljaz0id2luZG93Lm9wZW4oJ21haWx0bzpnbGVubkBodWRzb252YWxsZXlzb2xkLmNvbT9zdWJqZWN0PVdJTExPVyBBY2Nlc3MgUmVxdWVzdCcpIj4KICAgICAgICAgICAgICBSZXF1ZXN0IFBlcm1pc3Npb24KICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICByZW5kZXJVbmtub3duU3RhdGUoKSB7CiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImRlYnVnLXN0YXRlIj4KICAgICAgICAgICAgPGgyPlN5c3RlbSBFcnJvcjwvaDI+CiAgICAgICAgICAgIDxwPlVua25vd24gZGVidWcgc3RhdGUgZW5jb3VudGVyZWQuPC9wPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJkZWJ1Zy1idG4iIG9uY2xpY2s9ImxvY2F0aW9uLnJlbG9hZCgpIj4KICAgICAgICAgICAgICBSZXRyeQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIGFzeW5jIGxvYWRJbnRlbGxpZ2VuY2UoKSB7CiAgICAgICAgLy8gU2ltdWxhdGUgbG9hZGluZyBXSUxMT1cgaW50ZWxsaWdlbmNlCiAgICAgICAgLy8gSW4gcHJvZHVjdGlvbiwgdGhpcyB3b3VsZCBtYWtlIEFQSSBjYWxscyB0byBiYWNrZW5kCiAgICAgICAgCiAgICAgICAgdGhpcy5pbnRlbGxpZ2VuY2UgPSB7CiAgICAgICAgICB0b3RhbFNjb3JlOiB0aGlzLmNhbGN1bGF0ZU1vY2tTY29yZSgpLAogICAgICAgICAgY2xhc3NpZmljYXRpb246IHRoaXMuY2xhc3NpZnlTY29yZSh0aGlzLmNhbGN1bGF0ZU1vY2tTY29yZSgpKSwKICAgICAgICAgIGNvbXBvbmVudHM6IHsKICAgICAgICAgICAgZmVsbG86IHRoaXMuZ2V0TW9ja0ZlbGxvU2NvcmUoKSwKICAgICAgICAgICAgY2xvdWRDTUE6IHRoaXMuZ2V0TW9ja0Nsb3VkQ01BU2NvcmUoKSwKICAgICAgICAgICAgd2lsbG93OiB0aGlzLmdldE1vY2tXSUxMT1dTY29yZSgpLAogICAgICAgICAgICBzaWVycmE6IHRoaXMuZ2V0TW9ja1NpZXJyYVNjb3JlKCkKICAgICAgICAgIH0sCiAgICAgICAgICB0cmlnZ2VyZWRQYXR0ZXJuczogdGhpcy5nZXRNb2NrVHJpZ2dlcmVkUGF0dGVybnMoKQogICAgICAgIH07CgogICAgICAgIGNvbnNvbGUubG9nKCdXSUxMT1cgSW50ZWxsaWdlbmNlIGxvYWRlZDonLCB0aGlzLmludGVsbGlnZW5jZSk7CiAgICAgIH0KCiAgICAgIGNhbGN1bGF0ZU1vY2tTY29yZSgpIHsKICAgICAgICAvLyBNb2NrIGJlaGF2aW9yYWwgc2NvcmluZyBiYXNlZCBvbiBwZXJzb24gZGF0YQogICAgICAgIGlmICghdGhpcy5wZXJzb24pIHJldHVybiA0NTsKICAgICAgICAKICAgICAgICBsZXQgc2NvcmUgPSAwOwogICAgICAgIAogICAgICAgIC8vIE1vY2sgRmVsbG8gaW50ZWxsaWdlbmNlICgzNSUgd2VpZ2h0KQogICAgICAgIGNvbnN0IGZlbGxvU2NvcmUgPSB0aGlzLnBlcnNvbi5jdXN0b21GZWxsb0xlYWRTY29yZSB8fCA1MDsKICAgICAgICBzY29yZSArPSAoZmVsbG9TY29yZSAqIDAuMzUpOwogICAgICAgIAogICAgICAgIC8vIE1vY2sgQ2xvdWRDTUEgKDI1JSB3ZWlnaHQpCiAgICAgICAgY29uc3QgY21hVmlld3MgPSB0aGlzLnBlcnNvbi5jdXN0b21XSUxMT1dDTUFWaWV3cyB8fCAwOwogICAgICAgIHNjb3JlICs9IChNYXRoLm1pbihjbWFWaWV3cyAqIDUsIDI1KSk7CiAgICAgICAgCiAgICAgICAgLy8gTW9jayBXSUxMT1cgKDI1JSB3ZWlnaHQpICAKICAgICAgICBjb25zdCBob3RTY29yZSA9IHRoaXMucGVyc29uLmN1c3RvbVdJTExPV0hvdFNjb3JlIHx8IDI1OwogICAgICAgIHNjb3JlICs9IChob3RTY29yZSAqIDAuMjUpOwogICAgICAgIAogICAgICAgIC8vIE1vY2sgU2llcnJhICgxNSUgd2VpZ2h0KQogICAgICAgIHNjb3JlICs9IDEwOyAvLyBCYXNlIFNpZXJyYSBzY29yZQogICAgICAgIAogICAgICAgIHJldHVybiBNYXRoLm1pbihNYXRoLnJvdW5kKHNjb3JlKSwgMTAwKTsKICAgICAgfQoKICAgICAgZ2V0TW9ja0ZlbGxvU2NvcmUoKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKCh0aGlzLnBlcnNvbj8uY3VzdG9tRmVsbG9MZWFkU2NvcmUgfHwgNTApICogMC4zNSwgMzUpOwogICAgICB9CgogICAgICBnZXRNb2NrQ2xvdWRDTUFTY29yZSgpIHsKICAgICAgICBjb25zdCB2aWV3cyA9IHRoaXMucGVyc29uPy5jdXN0b21XSUxMT1dDTUFWaWV3cyB8fCAwOwogICAgICAgIHJldHVybiBNYXRoLm1pbih2aWV3cyAqIDUsIDI1KTsKICAgICAgfQoKICAgICAgZ2V0TW9ja1dJTExPV1Njb3JlKCkgewogICAgICAgIHJldHVybiAodGhpcy5wZXJzb24/LmN1c3RvbVdJTExPV0hvdFNjb3JlIHx8IDI1KSAqIDAuMjU7CiAgICAgIH0KCiAgICAgIGdldE1vY2tTaWVycmFTY29yZSgpIHsKICAgICAgICByZXR1cm4gMTA7IC8vIEJhc2Ugc2NvcmUKICAgICAgfQoKICAgICAgY2xhc3NpZnlTY29yZShzY29yZSkgewogICAgICAgIGlmIChzY29yZSA+PSA5NSkgcmV0dXJuICdDUklUSUNBTCc7CiAgICAgICAgaWYgKHNjb3JlID49IDg1KSByZXR1cm4gJ1NVUEVSX0hPVCc7CiAgICAgICAgaWYgKHNjb3JlID49IDcwKSByZXR1cm4gJ0hPVCc7CiAgICAgICAgaWYgKHNjb3JlID49IDQwKSByZXR1cm4gJ1dBUk0nOwogICAgICAgIHJldHVybiAnQ09MRCc7CiAgICAgIH0KCiAgICAgIGdldE1vY2tUcmlnZ2VyZWRQYXR0ZXJucygpIHsKICAgICAgICBjb25zdCBwYXR0ZXJucyA9IFtdOwogICAgICAgIAogICAgICAgIGlmICh0aGlzLmludGVsbGlnZW5jZS50b3RhbFNjb3JlID49IDg1KSB7CiAgICAgICAgICBwYXR0ZXJucy5wdXNoKHsKICAgICAgICAgICAgaWQ6IDEyLAogICAgICAgICAgICBuYW1lOiAnT21uaXByZXNlbnQgSW50ZWxsaWdlbmNlIENvbnNlbnN1cycsCiAgICAgICAgICAgIGljb246ICfwn46vJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdNdWx0aXBsZSBzeXN0ZW1zIGluZGljYXRlIGhpZ2ggY29udmVyc2lvbiBwcm9iYWJpbGl0eScsCiAgICAgICAgICAgIGNvbnZlcnNpb25SYXRlOiA5OCwKICAgICAgICAgICAgcHJpb3JpdHk6ICdDUklUSUNBTCcsCiAgICAgICAgICAgIGFjdGlvbkxhYmVsOiAnQ29udGFjdCBJbW1lZGlhdGVseScKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAodGhpcy5wZXJzb24/LmN1c3RvbUZlbGxvT2ZEYXNoYm9hcmRDbGlja3MgPj0gMykgewogICAgICAgICAgcGF0dGVybnMucHVzaCh7CiAgICAgICAgICAgIGlkOiAyLAogICAgICAgICAgICBuYW1lOiAnRGFzaGJvYXJkIEFjdGl2aXR5IFNwaWtlJywKICAgICAgICAgICAgaWNvbjogJ/Cfk4onLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ011bHRpcGxlIHByb3BlcnR5IGRhc2hib2FyZCB2aWV3cyBpbmRpY2F0ZSBzZWxsZXIgaW50ZW50JywKICAgICAgICAgICAgY29udmVyc2lvblJhdGU6IDkyLAogICAgICAgICAgICBwcmlvcml0eTogJ0hJR0gnLAogICAgICAgICAgICBhY3Rpb25MYWJlbDogJ0dlbmVyYXRlIENNQScKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucGVyc29uPy5jdXN0b21XSUxMT1dDTUFWaWV3cyA+PSAxKSB7CiAgICAgICAgICBwYXR0ZXJucy5wdXNoKHsKICAgICAgICAgICAgaWQ6IDEwLAogICAgICAgICAgICBuYW1lOiAnQ01BIEVuZ2FnZW1lbnQnLAogICAgICAgICAgICBpY29uOiAn8J+TiCcsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnQWN0aXZlIGVuZ2FnZW1lbnQgd2l0aCBwcmV2aW91cyBDTUEgcmVwb3J0cycsCiAgICAgICAgICAgIGNvbnZlcnNpb25SYXRlOiA4NSwKICAgICAgICAgICAgcHJpb3JpdHk6ICdNRURJVU0nLAogICAgICAgICAgICBhY3Rpb25MYWJlbDogJ0ZvbGxvdyBVcCcKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHBhdHRlcm5zOwogICAgICB9CgogICAgICBzZXR1cEV2ZW50TGlzdGVuZXJzKCkgewogICAgICAgIC8vIFRhYiBzd2l0Y2hpbmcKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiLWJ1dHRvbicpLmZvckVhY2goYnV0dG9uID0+IHsKICAgICAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHRhYk5hbWUgPSBlLnRhcmdldC5kYXRhc2V0LnRhYjsKICAgICAgICAgICAgdGhpcy5zd2l0Y2hUYWIodGFiTmFtZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gV2luZG93IHJlc2l6ZQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCAoKSA9PiB7CiAgICAgICAgICB0aGlzLmhhbmRsZVJlc2l6ZSgpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBhc3luYyBzd2l0Y2hUYWIodGFiTmFtZSkgewogICAgICAgIC8vIFVwZGF0ZSBhY3RpdmUgdGFiCiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRhYi1idXR0b24nKS5mb3JFYWNoKGJ0biA9PiBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJykpOwogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYFtkYXRhLXRhYj0iJHt0YWJOYW1lfSJdYCkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CgogICAgICAgIC8vIEhpZGUgYWxsIGNvbnRlbnQKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiLWNvbnRlbnQnKS5mb3JFYWNoKGNvbnRlbnQgPT4gY29udGVudC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSk7CiAgICAgICAgCiAgICAgICAgLy8gU2hvdyBzZWxlY3RlZCBjb250ZW50CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYCR7dGFiTmFtZX0tY29udGVudGApLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwoKICAgICAgICB0aGlzLmN1cnJlbnRUYWIgPSB0YWJOYW1lOwogICAgICAgIGF3YWl0IHRoaXMucmVuZGVyQ3VycmVudFRhYigpOwogICAgICB9CgogICAgICBhc3luYyByZW5kZXJDdXJyZW50VGFiKCkgewogICAgICAgIGNvbnN0IGNvbnRlbnREaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgJHt0aGlzLmN1cnJlbnRUYWJ9LWNvbnRlbnRgKTsKICAgICAgICAKICAgICAgICBzd2l0Y2godGhpcy5jdXJyZW50VGFiKSB7CiAgICAgICAgICBjYXNlICdpbnRlbGxpZ2VuY2UnOgogICAgICAgICAgICBjb250ZW50RGl2LmlubmVySFRNTCA9IHRoaXMucmVuZGVySW50ZWxsaWdlbmNlRGFzaGJvYXJkKCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnY21hJzoKICAgICAgICAgICAgY29udGVudERpdi5pbm5lckhUTUwgPSB0aGlzLnJlbmRlckNNQUh1YigpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ2FuYWx5dGljcyc6CiAgICAgICAgICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJBbmFseXRpY3MoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdwYXJ0bmVycyc6CiAgICAgICAgICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJQYXJ0bmVycygpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ3Byb3BlcnR5JzoKICAgICAgICAgICAgY29udGVudERpdi5pbm5lckhUTUwgPSB0aGlzLnJlbmRlclByb3BlcnR5KCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnY29tbXVuaWNhdGlvbic6CiAgICAgICAgICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJDb21tdW5pY2F0aW9uKCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnbWFuYWdlbWVudCc6CiAgICAgICAgICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJNYW5hZ2VtZW50KCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIHF1aWNrIGFjdGlvbnMKICAgICAgICB0aGlzLnVwZGF0ZVF1aWNrQWN0aW9ucygpOwogICAgICB9CgogICAgICByZW5kZXJJbnRlbGxpZ2VuY2VEYXNoYm9hcmQoKSB7CiAgICAgICAgaWYgKCF0aGlzLmludGVsbGlnZW5jZSkgcmV0dXJuICc8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIGludGVsbGlnZW5jZS4uLjwvZGl2Pic7CgogICAgICAgIGNvbnN0IHNjb3JlID0gdGhpcy5pbnRlbGxpZ2VuY2UudG90YWxTY29yZTsKICAgICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IHRoaXMuaW50ZWxsaWdlbmNlLmNsYXNzaWZpY2F0aW9uLnRvTG93ZXJDYXNlKCk7CgogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJpbnRlbGxpZ2VuY2UtZGFzaGJvYXJkIj4KICAgICAgICAgICAgCiAgICAgICAgICAgIDwhLS0gUHJpbWFyeSBTY29yZSBEaXNwbGF5IC0tPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzY29yZS1zZWN0aW9uIj4KICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzY29yZS1nYXVnZSI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJnYXVnZS1jaXJjbGUiIHN0eWxlPSItLXNjb3JlLXBlcmNlbnQ6ICR7c2NvcmV9Ij4KICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InNjb3JlLXZhbHVlIj4ke3Njb3JlfTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InNjb3JlLWxhYmVsIj4vMTAwPC9zcGFuPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcmlvcml0eS1iYWRnZSAke2NsYXNzaWZpY2F0aW9ufSI+CiAgICAgICAgICAgICAgICAgICR7dGhpcy5pbnRlbGxpZ2VuY2UuY2xhc3NpZmljYXRpb259CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAKICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzY29yZS1jb21wb25lbnRzIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbXBvbmVudCBmZWxsbyI+CiAgICAgICAgICAgICAgICAgIDxsYWJlbD5GZWxsbyBJbnRlbGxpZ2VuY2U8L2xhYmVsPgogICAgICAgICAgICAgICAgICA8dmFsdWU+JHt0aGlzLmludGVsbGlnZW5jZS5jb21wb25lbnRzLmZlbGxvLnRvRml4ZWQoMSl9LzM1PC92YWx1ZT4KICAgICAgICAgICAgICAgICAgPGJhciBzdHlsZT0iLS1iYXItd2lkdGg6ICR7KHRoaXMuaW50ZWxsaWdlbmNlLmNvbXBvbmVudHMuZmVsbG8vMzUpKjEwMH0lIj48L2Jhcj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29tcG9uZW50IGNsb3VkY21hIj4KICAgICAgICAgICAgICAgICAgPGxhYmVsPkNsb3VkQ01BIE1MUzwvbGFiZWw+CiAgICAgICAgICAgICAgICAgIDx2YWx1ZT4ke3RoaXMuaW50ZWxsaWdlbmNlLmNvbXBvbmVudHMuY2xvdWRDTUEudG9GaXhlZCgxKX0vMjU8L3ZhbHVlPgogICAgICAgICAgICAgICAgICA8YmFyIHN0eWxlPSItLWJhci13aWR0aDogJHsodGhpcy5pbnRlbGxpZ2VuY2UuY29tcG9uZW50cy5jbG91ZENNQS8yNSkqMTAwfSUiPjwvYmFyPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb21wb25lbnQgd2lsbG93Ij4KICAgICAgICAgICAgICAgICAgPGxhYmVsPldJTExPVzwvbGFiZWw+CiAgICAgICAgICAgICAgICAgIDx2YWx1ZT4ke3RoaXMuaW50ZWxsaWdlbmNlLmNvbXBvbmVudHMud2lsbG93LnRvRml4ZWQoMSl9LzI1PC92YWx1ZT4KICAgICAgICAgICAgICAgICAgPGJhciBzdHlsZT0iLS1iYXItd2lkdGg6ICR7KHRoaXMuaW50ZWxsaWdlbmNlLmNvbXBvbmVudHMud2lsbG93LzI1KSoxMDB9JSI+PC9iYXI+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbXBvbmVudCBzaWVycmEiPgogICAgICAgICAgICAgICAgICA8bGFiZWw+U2llcnJhPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgPHZhbHVlPiR7dGhpcy5pbnRlbGxpZ2VuY2UuY29tcG9uZW50cy5zaWVycmEudG9GaXhlZCgxKX0vMTU8L3ZhbHVlPgogICAgICAgICAgICAgICAgICA8YmFyIHN0eWxlPSItLWJhci13aWR0aDogJHsodGhpcy5pbnRlbGxpZ2VuY2UuY29tcG9uZW50cy5zaWVycmEvMTUpKjEwMH0lIj48L2Jhcj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgCiAgICAgICAgICAgIDwhLS0gVHJpZ2dlcmVkIFBhdHRlcm5zIC0tPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJwYXR0ZXJucy1zZWN0aW9uIj4KICAgICAgICAgICAgICA8aDM+8J+OryBBY3RpdmUgVHJpZ2dlciBQYXR0ZXJuczwvaDM+CiAgICAgICAgICAgICAgJHt0aGlzLnJlbmRlclRyaWdnZXJlZFBhdHRlcm5zKCl9CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPCEtLSBDb250YWN0IEluZm9ybWF0aW9uIC0tPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJwYXR0ZXJucy1zZWN0aW9uIj4KICAgICAgICAgICAgICA8aDM+8J+TiyBDb250YWN0IEludGVsbGlnZW5jZTwvaDM+CiAgICAgICAgICAgICAgJHt0aGlzLnJlbmRlckNvbnRhY3RJbnRlbGxpZ2VuY2UoKX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgcmVuZGVyVHJpZ2dlcmVkUGF0dGVybnMoKSB7CiAgICAgICAgaWYgKCF0aGlzLmludGVsbGlnZW5jZS50cmlnZ2VyZWRQYXR0ZXJucy5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiAnPHAgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7IGZvbnQtc3R5bGU6IGl0YWxpYzsiPk5vIGFjdGl2ZSBwYXR0ZXJucyBkZXRlY3RlZC4gQ29udGludWUgbW9uaXRvcmluZyBmb3IgYmVoYXZpb3JhbCB0cmlnZ2Vycy48L3A+JzsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmludGVsbGlnZW5jZS50cmlnZ2VyZWRQYXR0ZXJucy5tYXAocGF0dGVybiA9PiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJwYXR0ZXJuLWl0ZW0gcHJpb3JpdHktJHtwYXR0ZXJuLnByaW9yaXR5LnRvTG93ZXJDYXNlKCl9Ij4KICAgICAgICAgICAgPGRpdiBjbGFzcz0icGF0dGVybi1oZWFkZXIiPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwYXR0ZXJuLWljb24iPiR7cGF0dGVybi5pY29ufTwvc3Bhbj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGF0dGVybi1uYW1lIj4ke3BhdHRlcm4ubmFtZX08L3NwYW4+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNvbnZlcnNpb24tcmF0ZSI+JHtwYXR0ZXJuLmNvbnZlcnNpb25SYXRlfSU8L3NwYW4+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJwYXR0ZXJuLWRlc2NyaXB0aW9uIj4ke3BhdHRlcm4uZGVzY3JpcHRpb259PC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InBhdHRlcm4tYWN0aW9uIj4KICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJhY3Rpb24tYnRuIiBvbmNsaWNrPSJ3aW5kb3cud2lsbG93QXBwLmV4ZWN1dGVQYXR0ZXJuKCcke3BhdHRlcm4uaWR9JykiPgogICAgICAgICAgICAgICAgJHtwYXR0ZXJuLmFjdGlvbkxhYmVsfQogICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGApLmpvaW4oJycpOwogICAgICB9CgogICAgICByZW5kZXJDb250YWN0SW50ZWxsaWdlbmNlKCkgewogICAgICAgIGNvbnN0IHBlcnNvbiA9IHRoaXMucGVyc29uOwogICAgICAgIGlmICghcGVyc29uKSByZXR1cm4gJzxwPk5vIGNvbnRhY3QgZGF0YSBhdmFpbGFibGU8L3A+JzsKCiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMTVweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsiPgogICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEwcHg7Ij4ke3BlcnNvbi5maXJzdE5hbWUgfHwgJ1Vua25vd24nfSAke3BlcnNvbi5sYXN0TmFtZSB8fCAnQ29udGFjdCd9PC9oND4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoYXV0by1maXQsIG1pbm1heCgyMDBweCwgMWZyKSk7IGdhcDogMTVweDsiPgogICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICA8bGFiZWwgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPlByaW1hcnkgRW1haWw8L2xhYmVsPjxicj4KICAgICAgICAgICAgICAgIDxzcGFuPiR7cGVyc29uLmVtYWlscz8uWzBdPy52YWx1ZSB8fCAnTm90IHByb3ZpZGVkJ308L3NwYW4+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+UHJpbWFyeSBQaG9uZTwvbGFiZWw+PGJyPgogICAgICAgICAgICAgICAgPHNwYW4+JHtwZXJzb24ucGhvbmVzPy5bMF0/LnZhbHVlIHx8ICdOb3QgcHJvdmlkZWQnfTwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5TdGFnZTwvbGFiZWw+PGJyPgogICAgICAgICAgICAgICAgPHNwYW4+JHtwZXJzb24uc3RhZ2U/Lm5hbWUgfHwgJ1Vua25vd24nfTwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5Qcm9wZXJ0aWVzIE93bmVkPC9sYWJlbD48YnI+CiAgICAgICAgICAgICAgICA8c3Bhbj4ke3BlcnNvbi5jdXN0b21GZWxsb09mUHJvcGVydGllcyB8fCAxfTwvc3Bhbj4KICAgICAgICAgICAgICAgICR7KHBlcnNvbi5jdXN0b21GZWxsb09mUHJvcGVydGllcyB8fCAwKSA+PSAzID8gJzxzcGFuIHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXdhcm5pbmcpOyBmb250LXdlaWdodDogYm9sZDsgbWFyZ2luLWxlZnQ6IDVweDsiPklOVkVTVE9SPC9zcGFuPicgOiAnJ30KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICByZW5kZXJDTUFIdWIoKSB7CiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImNtYS1odWIiPgogICAgICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbi1ib3R0b206IDIwcHg7Ij7wn5OIIENNQSBHZW5lcmF0aW9uICYgTWFuYWdlbWVudDwvaDM+CiAgICAgICAgICAgIAogICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IG1hcmdpbi1ib3R0b206IDIwcHg7Ij4KICAgICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE1cHg7Ij5HZW5lcmF0ZSBQcm9mZXNzaW9uYWwgQ01BPC9oND4KICAgICAgICAgICAgICAKICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciBhdXRvOyBnYXA6IDEwcHg7IGFsaWduLWl0ZW1zOiBlbmQ7Ij4KICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogYmxvY2s7IG1hcmdpbi1ib3R0b206IDVweDsgZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+UHJvcGVydHkgQWRkcmVzczwvbGFiZWw+CiAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBpZD0iY21hLWFkZHJlc3MiIHBsYWNlaG9sZGVyPSJFbnRlciBwcm9wZXJ0eSBhZGRyZXNzLi4uIiBzdHlsZT0id2lkdGg6IDEwMCU7IHBhZGRpbmc6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IGJvcmRlci1yYWRpdXM6IDRweDsiIC8+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImFjdGlvbi1idG4iIG9uY2xpY2s9IndpbmRvdy53aWxsb3dBcHAuZ2VuZXJhdGVDTUEoKSIgc3R5bGU9InBhZGRpbmc6IDhweCAxNnB4OyI+CiAgICAgICAgICAgICAgICAgIPCfmoAgR2VuZXJhdGUgQ01BCiAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAKICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOiAxNXB4OyBwYWRkaW5nOiAxMHB4OyBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYmFja2dyb3VuZCk7IGJvcmRlci1yYWRpdXM6IDRweDsiPgogICAgICAgICAgICAgICAgPHNtYWxsIHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+CiAgICAgICAgICAgICAgICAgIDxzdHJvbmc+QmVoYXZpb3JhbCBPcHRpbWl6YXRpb246PC9zdHJvbmc+IAogICAgICAgICAgICAgICAgICAke3RoaXMuaW50ZWxsaWdlbmNlPy5jbGFzc2lmaWNhdGlvbn0gcHJpb3JpdHkg4oCiIAogICAgICAgICAgICAgICAgICAke3RoaXMuZ2V0T3B0aW1pemVkUmFkaXVzKCl9IG1pbGUgcmFkaXVzIOKAoiAKICAgICAgICAgICAgICAgICAgJHt0aGlzLmdldE9wdGltaXplZENvbXBhcmFibGVzKCl9IGNvbXBhcmFibGVzCiAgICAgICAgICAgICAgICA8L3NtYWxsPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMjBweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsiPgogICAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPvCfj6AgUmVjZW50IENNQSBBY3Rpdml0eTwvaDQ+CiAgICAgICAgICAgICAgJHt0aGlzLnJlbmRlckNNQUhpc3RvcnkoKX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICBnZXRPcHRpbWl6ZWRSYWRpdXMoKSB7CiAgICAgICAgY29uc3QgY2xhc3NpZmljYXRpb24gPSB0aGlzLmludGVsbGlnZW5jZT8uY2xhc3NpZmljYXRpb247CiAgICAgICAgc3dpdGNoKGNsYXNzaWZpY2F0aW9uKSB7CiAgICAgICAgICBjYXNlICdDUklUSUNBTCc6IHJldHVybiAnMC41JzsKICAgICAgICAgIGNhc2UgJ1NVUEVSX0hPVCc6IHJldHVybiAnMC42JzsKICAgICAgICAgIGNhc2UgJ0hPVCc6IHJldHVybiAnMC43NSc7CiAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gJzEuMCc7CiAgICAgICAgfQogICAgICB9CgogICAgICBnZXRPcHRpbWl6ZWRDb21wYXJhYmxlcygpIHsKICAgICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IHRoaXMuaW50ZWxsaWdlbmNlPy5jbGFzc2lmaWNhdGlvbjsKICAgICAgICBzd2l0Y2goY2xhc3NpZmljYXRpb24pIHsKICAgICAgICAgIGNhc2UgJ0NSSVRJQ0FMJzogcmV0dXJuICcyMCc7CiAgICAgICAgICBjYXNlICdTVVBFUl9IT1QnOiByZXR1cm4gJzE3JzsKICAgICAgICAgIGNhc2UgJ0hPVCc6IHJldHVybiAnMTUnOwogICAgICAgICAgZGVmYXVsdDogcmV0dXJuICcxMCc7CiAgICAgICAgfQogICAgICB9CgogICAgICByZW5kZXJDTUFIaXN0b3J5KCkgewogICAgICAgIC8vIE1vY2sgQ01BIGhpc3RvcnkKICAgICAgICBjb25zdCBsYXN0Q01BRGF0ZSA9IHRoaXMucGVyc29uPy5jdXN0b21XSUxMT1dDTUFEYXRlOwogICAgICAgIGNvbnN0IGNtYUxpbmsgPSB0aGlzLnBlcnNvbj8uY3VzdG9tV0lMTE9XQ01BTGluazsKICAgICAgICAKICAgICAgICBpZiAobGFzdENNQURhdGUgJiYgY21hTGluaykgewogICAgICAgICAgcmV0dXJuIGAKICAgICAgICAgICAgPGRpdiBzdHlsZT0icGFkZGluZzogMTVweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IGJvcmRlci1yYWRpdXM6IDZweDsiPgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsgYWxpZ24taXRlbXM6IGNlbnRlcjsiPgogICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgPHN0cm9uZz5MYXRlc3QgQ01BPC9zdHJvbmc+PGJyPgogICAgICAgICAgICAgICAgICA8c21hbGwgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5HZW5lcmF0ZWQ6ICR7bmV3IERhdGUobGFzdENNQURhdGUpLnRvTG9jYWxlRGF0ZVN0cmluZygpfTwvc21hbGw+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxhIGhyZWY9IiR7Y21hTGlua30iIHRhcmdldD0iX2JsYW5rIiBjbGFzcz0iYWN0aW9uLWJ0biIgc3R5bGU9InRleHQtZGVjb3JhdGlvbjogbm9uZTsiPgogICAgICAgICAgICAgICAgICDwn5GB77iPIFZpZXcgQ01BCiAgICAgICAgICAgICAgICA8L2E+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgYDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuICc8cCBzdHlsZT0iY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsgZm9udC1zdHlsZTogaXRhbGljOyI+Tm8gcHJldmlvdXMgQ01BcyBmb3VuZC4gR2VuZXJhdGUgZmlyc3QgQ01BIGFib3ZlLjwvcD4nOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmVuZGVyQW5hbHl0aWNzKCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJhbmFseXRpY3MtZGFzaGJvYXJkIj4KICAgICAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW4tYm90dG9tOiAyMHB4OyI+8J+TiiBMZWFkIEFuYWx5dGljcyAmIFBlcmZvcm1hbmNlPC9oMz4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KGF1dG8tZml0LCBtaW5tYXgoMjAwcHgsIDFmcikpOyBnYXA6IDE1cHg7IG1hcmdpbi1ib3R0b206IDIwcHg7Ij4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDE1cHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IHRleHQtYWxpZ246IGNlbnRlcjsiPgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAyNHB4OyBmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi1wcmltYXJ5KTsiPiR7dGhpcy5pbnRlbGxpZ2VuY2U/LnRvdGFsU2NvcmUgfHwgMH08L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPkludGVsbGlnZW5jZSBTY29yZTwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMTVweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgdGV4dC1hbGlnbjogY2VudGVyOyI+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDI0cHg7IGZvbnQtd2VpZ2h0OiBib2xkOyBjb2xvcjogdmFyKC0tZnViLXN1Y2Nlc3MpOyI+JHt0aGlzLmdldENvbnZlcnNpb25Qcm9iYWJpbGl0eSgpfSU8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPkNvbnZlcnNpb24gUHJvYmFiaWxpdHk8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDE1cHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IHRleHQtYWxpZ246IGNlbnRlcjsiPgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAyNHB4OyBmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi13YXJuaW5nKTsiPiR7dGhpcy5wZXJzb24/LmN1c3RvbUZlbGxvT2ZQcm9wZXJ0aWVzIHx8IDF9PC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5Qcm9wZXJ0aWVzIE93bmVkPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyI+CiAgICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+8J+TiCBSZXZlbnVlIE9wcG9ydHVuaXR5PC9oND4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDE4cHg7IGNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7IG1hcmdpbi1ib3R0b206IDEwcHg7Ij4KICAgICAgICAgICAgICAgIEVzdGltYXRlZCBDb21taXNzaW9uOiA8c3Ryb25nPiR7dGhpcy5jYWxjdWxhdGVDb21taXNzaW9uT3Bwb3J0dW5pdHkoKX08L3N0cm9uZz4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8cCBzdHlsZT0iY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsgZm9udC1zaXplOiAxM3B4OyI+CiAgICAgICAgICAgICAgICBCYXNlZCBvbiAke3RoaXMuaW50ZWxsaWdlbmNlPy5jbGFzc2lmaWNhdGlvbn0gcHJpb3JpdHkgbGV2ZWwgYW5kICR7dGhpcy5wZXJzb24/LmN1c3RvbUZlbGxvT2ZQcm9wZXJ0aWVzIHx8IDF9IHByb3BlcnR5IG93bmVyc2hpcC4KICAgICAgICAgICAgICAgICR7KHRoaXMucGVyc29uPy5jdXN0b21GZWxsb09mUHJvcGVydGllcyB8fCAwKSA+PSAzID8gJ0lOVkVTVE9SIHByb2ZpbGUgZGV0ZWN0ZWQgLSBwb3RlbnRpYWwgZm9yIG11bHRpcGxlIHRyYW5zYWN0aW9ucy4nIDogJyd9CiAgICAgICAgICAgICAgPC9wPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIGdldENvbnZlcnNpb25Qcm9iYWJpbGl0eSgpIHsKICAgICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IHRoaXMuaW50ZWxsaWdlbmNlPy5jbGFzc2lmaWNhdGlvbjsKICAgICAgICBjb25zdCByYXRlcyA9IHsKICAgICAgICAgICdDUklUSUNBTCc6IDk4LAogICAgICAgICAgJ1NVUEVSX0hPVCc6IDkwLAogICAgICAgICAgJ0hPVCc6IDc1LAogICAgICAgICAgJ1dBUk0nOiAzNSwKICAgICAgICAgICdDT0xEJzogMTUKICAgICAgICB9OwogICAgICAgIHJldHVybiByYXRlc1tjbGFzc2lmaWNhdGlvbl0gfHwgMTU7CiAgICAgIH0KCiAgICAgIGNhbGN1bGF0ZUNvbW1pc3Npb25PcHBvcnR1bml0eSgpIHsKICAgICAgICBjb25zdCBiYXNlQ29tbWlzc2lvbiA9IDIwMDAwOyAvLyBBdmVyYWdlIEdsZW5uIGNvbW1pc3Npb24KICAgICAgICBjb25zdCBwcm9wZXJ0aWVzID0gdGhpcy5wZXJzb24/LmN1c3RvbUZlbGxvT2ZQcm9wZXJ0aWVzIHx8IDE7CiAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IE1hdGgubWluKHByb3BlcnRpZXMsIDMpOyAvLyBDYXAgYXQgMyBmb3IgZGlzcGxheQogICAgICAgIGNvbnN0IHRvdGFsID0gYmFzZUNvbW1pc3Npb24gKiBtdWx0aXBsaWVyOwogICAgICAgIAogICAgICAgIHJldHVybiBgJCR7dG90YWwudG9Mb2NhbGVTdHJpbmcoKX1gOwogICAgICB9CgogICAgICByZW5kZXJQYXJ0bmVycygpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBjbGFzcz0icGFydG5lcnMtZGFzaGJvYXJkIj4KICAgICAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW4tYm90dG9tOiAyMHB4OyI+8J+knSBQYXJ0bmVyIENvb3JkaW5hdGlvbiBTeXN0ZW08L2gzPgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyBtYXJnaW4tYm90dG9tOiAyMHB4OyI+CiAgICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+8J+OryBPcHRpbWFsIFBhcnRuZXIgQXNzaWdubWVudDwvaDQ+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0icGFkZGluZzogMTVweDsgYmFja2dyb3VuZDogdmFyKC0tZnViLWJhY2tncm91bmQpOyBib3JkZXItcmFkaXVzOiA2cHg7Ij4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiBib2xkOyBtYXJnaW4tYm90dG9tOiA1cHg7Ij5SZWNvbW1lbmRlZDogJHt0aGlzLmdldE9wdGltYWxQYXJ0bmVyKCl9PC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBmb250LXNpemU6IDEzcHg7Ij4ke3RoaXMuZ2V0UGFydG5lclJhdGlvbmFsZSgpfTwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KGF1dG8tZml0LCBtaW5tYXgoMjUwcHgsIDFmcikpOyBnYXA6IDE1cHg7Ij4KICAgICAgICAgICAgICAke3RoaXMucmVuZGVyUGFydG5lckNhcmRzKCl9CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgZ2V0T3B0aW1hbFBhcnRuZXIoKSB7CiAgICAgICAgY29uc3Qgc2NvcmUgPSB0aGlzLmludGVsbGlnZW5jZT8udG90YWxTY29yZSB8fCAwOwogICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSB0aGlzLnBlcnNvbj8uY3VzdG9tRmVsbG9PZlByb3BlcnRpZXMgfHwgMTsKICAgICAgICAKICAgICAgICBpZiAoc2NvcmUgPj0gOTUgfHwgcHJvcGVydGllcyA+PSAzKSByZXR1cm4gJ0dsZW5uIEZpdHpnZXJhbGQnOwogICAgICAgIGlmIChzY29yZSA+PSA4NSkgcmV0dXJuICdKdXN0aW4gUGhpbGxpcHMnOyAgCiAgICAgICAgaWYgKHByb3BlcnRpZXMgPj0gMikgcmV0dXJuICdMbG95ZCBHcmF5JzsKICAgICAgICByZXR1cm4gJ0hlYXRoZXIgTWFydGluJzsKICAgICAgfQoKICAgICAgZ2V0UGFydG5lclJhdGlvbmFsZSgpIHsKICAgICAgICBjb25zdCBwYXJ0bmVyID0gdGhpcy5nZXRPcHRpbWFsUGFydG5lcigpOwogICAgICAgIGNvbnN0IHJhdGlvbmFsZXMgPSB7CiAgICAgICAgICAnR2xlbm4gRml0emdlcmFsZCc6ICdTeXN0ZW0gb3duZXIgKyBsdXh1cnkgc3BlY2lhbGlzdCArIGhpZ2ggcHJpb3JpdHkgbGVhZCcsCiAgICAgICAgICAnSnVzdGluIFBoaWxsaXBzJzogJ01hbmFnaW5nIGJyb2tlciArIHByZW1pdW0gY2xpZW50IGV4cGVyaWVuY2UnLAogICAgICAgICAgJ0xsb3lkIEdyYXknOiAnSW52ZXN0bWVudCBzcGVjaWFsaXN0ICsgYnV5ZXIgcmVwcmVzZW50YXRpb24gZXhwZXJ0JywKICAgICAgICAgICdIZWF0aGVyIE1hcnRpbic6ICdSZXNpZGVudGlhbCBzcGVjaWFsaXN0ICsgZmlyc3QtdGltZSBidXllciBleHBlcnQnCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gcmF0aW9uYWxlc1twYXJ0bmVyXSB8fCAnU3RhbmRhcmQgcmVzaWRlbnRpYWwgYXNzaWdubWVudCc7CiAgICAgIH0KCiAgICAgIHJlbmRlclBhcnRuZXJDYXJkcygpIHsKICAgICAgICBjb25zdCBwYXJ0bmVycyA9IFsKICAgICAgICAgIHsgbmFtZTogJ0dsZW5uIEZpdHpnZXJhbGQnLCByb2xlOiAnU3lzdGVtIE93bmVyJywgc3BlY2lhbGl6YXRpb246ICdMdXh1cnkgKyBUZWNobm9sb2d5JywgYWN0aXZlOiAyNSwgY29udmVyc2lvbjogOTIgfSwKICAgICAgICAgIHsgbmFtZTogJ0p1c3RpbiBQaGlsbGlwcycsIHJvbGU6ICdNYW5hZ2luZyBCcm9rZXInLCBzcGVjaWFsaXphdGlvbjogJ1ByZW1pdW0gQ2xpZW50cycsIGFjdGl2ZTogMTgsIGNvbnZlcnNpb246IDg4IH0sCiAgICAgICAgICB7IG5hbWU6ICdIZWF0aGVyIE1hcnRpbicsIHJvbGU6ICdSZXNpZGVudGlhbCBTcGVjaWFsaXN0Jywgc3BlY2lhbGl6YXRpb246ICdGaXJzdC1UaW1lIEJ1eWVycycsIGFjdGl2ZTogMjIsIGNvbnZlcnNpb246IDg1IH0sCiAgICAgICAgICB7IG5hbWU6ICdMbG95ZCBHcmF5Jywgcm9sZTogJ0ludmVzdG1lbnQgU3BlY2lhbGlzdCcsIHNwZWNpYWxpemF0aW9uOiAnQnV5ZXIgUmVwcmVzZW50YXRpb24nLCBhY3RpdmU6IDE1LCBjb252ZXJzaW9uOiA4MiB9CiAgICAgICAgXTsKCiAgICAgICAgcmV0dXJuIHBhcnRuZXJzLm1hcChwYXJ0bmVyID0+IGAKICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMTVweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsiPgogICAgICAgICAgICA8aDUgc3R5bGU9Im1hcmdpbi1ib3R0b206IDVweDsiPiR7cGFydG5lci5uYW1lfTwvaDU+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7IGZvbnQtc2l6ZTogMTJweDsgbWFyZ2luLWJvdHRvbTogMTBweDsiPiR7cGFydG5lci5yb2xlfTwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDExcHg7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPiR7cGFydG5lci5zcGVjaWFsaXphdGlvbn08L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOyI+CiAgICAgICAgICAgICAgPHNtYWxsPkFjdGl2ZTogJHtwYXJ0bmVyLmFjdGl2ZX08L3NtYWxsPgogICAgICAgICAgICAgIDxzbWFsbD5Db252OiAke3BhcnRuZXIuY29udmVyc2lvbn0lPC9zbWFsbD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgKS5qb2luKCcnKTsKICAgICAgfQoKICAgICAgcmVuZGVyUHJvcGVydHkoKSB7CiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9InByb3BlcnR5LWRhc2hib2FyZCI+CiAgICAgICAgICAgIDxoMyBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMjBweDsiPvCfj6AgUHJvcGVydHkgSW50ZWxsaWdlbmNlIEh1YjwvaDM+CiAgICAgICAgICAgIAogICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IG1hcmdpbi1ib3R0b206IDIwcHg7Ij4KICAgICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE1cHg7Ij7wn5OKIE1hcmtldCBJbnRlbGxpZ2VuY2U8L2g0PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KGF1dG8tZml0LCBtaW5tYXgoMTUwcHgsIDFmcikpOyBnYXA6IDEwcHg7Ij4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogMTBweDsiPgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi1zdWNjZXNzKTsiPlVQPC9kaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPk1hcmtldCBUcmVuZDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7IHBhZGRpbmc6IDEwcHg7Ij4KICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IGJvbGQ7IGNvbG9yOiB2YXIoLS1mdWItd2FybmluZyk7Ij5NRURJVU08L2Rpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+SW52ZW50b3J5PC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogMTBweDsiPgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi1wcmltYXJ5KTsiPjQ1IGRheXM8L2Rpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+QXZnIERPTTwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgJHt0aGlzLnJlbmRlckhvbWViZWF0U3RhdHVzKCl9CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICByZW5kZXJIb21lYmVhdFN0YXR1cygpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyI+CiAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPvCfk4ggSG9tZWJlYXQgTW9uaXRvcmluZzwvaDQ+CiAgICAgICAgICAgIDxwIHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBmb250LXN0eWxlOiBpdGFsaWM7Ij4KICAgICAgICAgICAgICBIb21lYmVhdCBpbnRlZ3JhdGlvbiBlbmFibGVzIGF1dG9tYXRpYyBtYXJrZXQgdmFsdWUgbW9uaXRvcmluZyBhbmQgYWxlcnRzLgogICAgICAgICAgICAgIENvbnRhY3QgR2xlbm4gdG8gYWN0aXZhdGUgcHJvcGVydHkgbW9uaXRvcmluZyBmb3IgdGhpcyBjbGllbnQuCiAgICAgICAgICAgIDwvcD4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYWN0aW9uLWJ0biIgc3R5bGU9Im1hcmdpbi10b3A6IDEwcHg7IiBvbmNsaWNrPSJ3aW5kb3cud2lsbG93QXBwLmFjdGl2YXRlSG9tZWJlYXQoKSI+CiAgICAgICAgICAgICAgQWN0aXZhdGUgSG9tZWJlYXQKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICByZW5kZXJDb21tdW5pY2F0aW9uKCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJjb21tdW5pY2F0aW9uLWRhc2hib2FyZCI+CiAgICAgICAgICAgIDxoMyBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMjBweDsiPvCfk6cgQ29tbXVuaWNhdGlvbiAmIEZvbGxvdy1VcCBDZW50ZXI8L2gzPgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyBtYXJnaW4tYm90dG9tOiAyMHB4OyI+CiAgICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+8J+TrCBFbWFpbCBJbnRlbGxpZ2VuY2U8L2g0PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KGF1dG8tZml0LCBtaW5tYXgoMTUwcHgsIDFmcikpOyBnYXA6IDEwcHg7Ij4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogMTBweDsiPgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi1wcmltYXJ5KTsiPiR7dGhpcy5wZXJzb24/LmN1c3RvbUZlbGxvT2ZFbWFpbENsaWNrcyB8fCAwfTwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5FbWFpbCBDbGlja3M8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0idGV4dC1hbGlnbjogY2VudGVyOyBwYWRkaW5nOiAxMHB4OyI+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiBib2xkOyBjb2xvcjogdmFyKC0tZnViLXN1Y2Nlc3MpOyI+QWN0aXZlPC9kaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPlN0YXR1czwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7IHBhZGRpbmc6IDEwcHg7Ij4KICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IGJvbGQ7IGNvbG9yOiB2YXIoLS1mdWItd2FybmluZyk7Ij5FbWFpbDwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5QcmVmZXJyZWQ8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMjBweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsiPgogICAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPuKaoSBSZWNvbW1lbmRlZCBGb2xsb3ctVXA8L2g0PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9InBhZGRpbmc6IDE1cHg7IGJhY2tncm91bmQ6IHZhcigtLWZ1Yi1iYWNrZ3JvdW5kKTsgYm9yZGVyLXJhZGl1czogNnB4OyI+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogYm9sZDsgbWFyZ2luLWJvdHRvbTogNXB4OyI+TmV4dCBBY3Rpb246ICR7dGhpcy5nZXROZXh0QWN0aW9uKCl9PC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBmb250LXNpemU6IDEzcHg7IG1hcmdpbi1ib3R0b206IDEwcHg7Ij4ke3RoaXMuZ2V0QWN0aW9uUmVhc29uKCl9PC9kaXY+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJhY3Rpb24tYnRuIiBvbmNsaWNrPSJ3aW5kb3cud2lsbG93QXBwLmV4ZWN1dGVGb2xsb3dVcCgpIj4KICAgICAgICAgICAgICAgICAgRXhlY3V0ZSBGb2xsb3ctVXAKICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIGdldE5leHRBY3Rpb24oKSB7CiAgICAgICAgY29uc3QgY2xhc3NpZmljYXRpb24gPSB0aGlzLmludGVsbGlnZW5jZT8uY2xhc3NpZmljYXRpb247CiAgICAgICAgY29uc3QgYWN0aW9ucyA9IHsKICAgICAgICAgICdDUklUSUNBTCc6ICdDYWxsIHdpdGhpbiAxNSBtaW51dGVzJywKICAgICAgICAgICdTVVBFUl9IT1QnOiAnQ2FsbCB0b2RheScsCiAgICAgICAgICAnSE9UJzogJ0VtYWlsICsgQ01BIGdlbmVyYXRpb24nLCAKICAgICAgICAgICdXQVJNJzogJ051cnR1cmluZyBlbWFpbCBzZXF1ZW5jZScsCiAgICAgICAgICAnQ09MRCc6ICdNb250aGx5IHRvdWNocG9pbnQnCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gYWN0aW9uc1tjbGFzc2lmaWNhdGlvbl0gfHwgJ1N0YW5kYXJkIGZvbGxvdy11cCc7CiAgICAgIH0KCiAgICAgIGdldEFjdGlvblJlYXNvbigpIHsKICAgICAgICByZXR1cm4gYEJhc2VkIG9uICR7dGhpcy5pbnRlbGxpZ2VuY2U/LmNsYXNzaWZpY2F0aW9ufSBwcmlvcml0eSBhbmQgYmVoYXZpb3JhbCBpbnRlbGxpZ2VuY2UgYW5hbHlzaXMuYDsKICAgICAgfQoKICAgICAgcmVuZGVyTWFuYWdlbWVudCgpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBjbGFzcz0ibWFuYWdlbWVudC1kYXNoYm9hcmQiPgogICAgICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbi1ib3R0b206IDIwcHg7Ij7impnvuI8gU3lzdGVtIE1hbmFnZW1lbnQgJiBTeW5jPC9oMz4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMjBweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgbWFyZ2luLWJvdHRvbTogMjBweDsiPgogICAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPvCflIQgSW50ZWdyYXRpb24gU3RhdHVzPC9oND4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdChhdXRvLWZpdCwgbWlubWF4KDIwMHB4LCAxZnIpKTsgZ2FwOiAxMHB4OyI+CiAgICAgICAgICAgICAgICAke3RoaXMucmVuZGVySW50ZWdyYXRpb25TdGF0dXMoKX0KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7Ij4KICAgICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE1cHg7Ij7wn5OKIEN1c3RvbSBGaWVsZHMgKCR7dGhpcy5nZXRDdXN0b21GaWVsZENvdW50KCl9IHRvdGFsKTwvaDQ+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAxM3B4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBsaW5lLWhlaWdodDogMS42OyI+CiAgICAgICAgICAgICAgICDigKIgPHN0cm9uZz4yMiBXSUxMT1cgZmllbGRzPC9zdHJvbmc+ICh3cml0ZS1lbmFibGVkKTogQmVoYXZpb3JhbCBpbnRlbGxpZ2VuY2UsIENNQSBkYXRhLCBtYXJrZXQgYW5hbHlzaXM8YnI+CiAgICAgICAgICAgICAgICDigKIgPHN0cm9uZz4xNiBGZWxsbyBmaWVsZHM8L3N0cm9uZz4gKHJlYWQtb25seSk6IExlYWQgc2NvcmluZywgZW5nYWdlbWVudCBtZXRyaWNzLCBwcm9wZXJ0eSBpbnRlbGxpZ2VuY2U8YnI+CiAgICAgICAgICAgICAgICDigKIgPHN0cm9uZz4xNSBDbG91ZENNQSBmaWVsZHM8L3N0cm9uZz4gKHdyaXRlLWVuYWJsZWQpOiBNTFMgaW50ZWxsaWdlbmNlLCBtYXJrZXQgY29uZGl0aW9ucywgQ01BIGFuYWx5dGljczxicj4KICAgICAgICAgICAgICAgIOKAoiA8c3Ryb25nPjIgT3RoZXIgZmllbGRzPC9zdHJvbmc+OiBBZGRpdGlvbmFsIHByb3BlcnR5IGFuZCBzeXN0ZW0gZGF0YQogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHJlbmRlckludGVncmF0aW9uU3RhdHVzKCkgewogICAgICAgIGNvbnN0IGludGVncmF0aW9ucyA9IFsKICAgICAgICAgIHsgbmFtZTogJ0ZvbGxvdyBVcCBCb3NzJywgc3RhdHVzOiAnQ29ubmVjdGVkJywgY29sb3I6ICd2YXIoLS1mdWItc3VjY2VzcyknIH0sCiAgICAgICAgICB7IG5hbWU6ICdGZWxsbyBQbGF0Zm9ybScsIHN0YXR1czogJ1N5bmNlZCcsIGNvbG9yOiAndmFyKC0tZnViLXN1Y2Nlc3MpJyB9LAogICAgICAgICAgeyBuYW1lOiAnQ2xvdWRDTUEnLCBzdGF0dXM6ICdPcGVyYXRpb25hbCcsIGNvbG9yOiAndmFyKC0tZnViLXN1Y2Nlc3MpJyB9LAogICAgICAgICAgeyBuYW1lOiAnU2llcnJhIEludGVyYWN0aXZlJywgc3RhdHVzOiAnSW50ZWdyYXRlZCcsIGNvbG9yOiAndmFyKC0tZnViLXN1Y2Nlc3MpJyB9CiAgICAgICAgXTsKCiAgICAgICAgcmV0dXJuIGludGVncmF0aW9ucy5tYXAoaW50ZWdyYXRpb24gPT4gYAogICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOyBhbGlnbi1pdGVtczogY2VudGVyOyBwYWRkaW5nOiA4cHggMDsgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LXNpemU6IDEzcHg7Ij4ke2ludGVncmF0aW9uLm5hbWV9PC9zcGFuPgogICAgICAgICAgICA8c3BhbiBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogJHtpbnRlZ3JhdGlvbi5jb2xvcn07IGZvbnQtd2VpZ2h0OiBib2xkOyI+JHtpbnRlZ3JhdGlvbi5zdGF0dXN9PC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYCkuam9pbignJyk7CiAgICAgIH0KCiAgICAgIGdldEN1c3RvbUZpZWxkQ291bnQoKSB7CiAgICAgICAgcmV0dXJuIDU1OyAvLyAyMiBXSUxMT1cgKyAxNiBGZWxsbyArIDE1IENsb3VkQ01BICsgMiBvdGhlcgogICAgICB9CgogICAgICB1cGRhdGVRdWlja0FjdGlvbnMoKSB7CiAgICAgICAgY29uc3QgcXVpY2tBY3Rpb25zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1aWNrLWFjdGlvbnMnKTsKICAgICAgICBjb25zdCBxdWlja0FjdGlvbnNDb250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1aWNrLWFjdGlvbnMtY29udGVudCcpOwogICAgICAgIAogICAgICAgIGlmICghdGhpcy5pbnRlbGxpZ2VuY2UpIHsKICAgICAgICAgIHF1aWNrQWN0aW9ucy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgYWN0aW9ucyA9IFtdOwogICAgICAgIAogICAgICAgIGlmICh0aGlzLmludGVsbGlnZW5jZS5jbGFzc2lmaWNhdGlvbiA9PT0gJ0NSSVRJQ0FMJykgewogICAgICAgICAgYWN0aW9ucy5wdXNoKHsgcHJpb3JpdHk6ICdjcml0aWNhbCcsIHRleHQ6ICdDYWxsIGltbWVkaWF0ZWx5JywgY291bnQ6IDEgfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh0aGlzLmludGVsbGlnZW5jZS5jbGFzc2lmaWNhdGlvbiA9PT0gJ1NVUEVSX0hPVCcpIHsKICAgICAgICAgIGFjdGlvbnMucHVzaCh7IHByaW9yaXR5OiAnc3VwZXJfaG90JywgdGV4dDogJ0NhbGwgdG9kYXknLCBjb3VudDogMSB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuaW50ZWxsaWdlbmNlLmNsYXNzaWZpY2F0aW9uID09PSAnSE9UJykgewogICAgICAgICAgYWN0aW9ucy5wdXNoKHsgcHJpb3JpdHk6ICdob3QnLCB0ZXh0OiAnR2VuZXJhdGUgQ01BJywgY291bnQ6IDEgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoYWN0aW9ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBxdWlja0FjdGlvbnNDb250ZW50LmlubmVySFRNTCA9IGFjdGlvbnMubWFwKGFjdGlvbiA9PiBgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbi1pdGVtIj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iYWN0aW9uLXByaW9yaXR5ICR7YWN0aW9uLnByaW9yaXR5fSI+PC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJhY3Rpb24tdGV4dCI+JHthY3Rpb24udGV4dH08L3NwYW4+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImFjdGlvbi1jb3VudCI+JHthY3Rpb24uY291bnR9PC9zcGFuPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIGApLmpvaW4oJycpOwogICAgICAgICAgCiAgICAgICAgICBxdWlja0FjdGlvbnMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHF1aWNrQWN0aW9ucy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaGFuZGxlUmVzaXplKCkgewogICAgICAgIC8vIEhhbmRsZSByZXNwb25zaXZlIGJlaGF2aW9yCiAgICAgICAgY29uc3QgcXVpY2tBY3Rpb25zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1aWNrLWFjdGlvbnMnKTsKICAgICAgICBpZiAod2luZG93LmlubmVyV2lkdGggPD0gNzY4KSB7CiAgICAgICAgICBxdWlja0FjdGlvbnMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW50ZWxsaWdlbmNlICYmIHRoaXMuaW50ZWxsaWdlbmNlLmNsYXNzaWZpY2F0aW9uICE9PSAnQ09MRCcpIHsKICAgICAgICAgIHF1aWNrQWN0aW9ucy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHNob3dFcnJvcihtZXNzYWdlKSB7CiAgICAgICAgY29uc3QgY29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3aWxsb3ctY29udGVudCcpOwogICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gYAogICAgICAgICAgPGRpdiBjbGFzcz0iZGVidWctc3RhdGUiPgogICAgICAgICAgICA8aDI+U3lzdGVtIEVycm9yPC9oMj4KICAgICAgICAgICAgPHA+JHttZXNzYWdlfTwvcD4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZGVidWctYnRuIiBvbmNsaWNrPSJsb2NhdGlvbi5yZWxvYWQoKSI+CiAgICAgICAgICAgICAgUmV0cnkKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICAvLyBBY3Rpb24gTWV0aG9kcyAoY2FsbGVkIGZyb20gVUkpCiAgICAgIGFzeW5jIGV4ZWN1dGVQYXR0ZXJuKHBhdHRlcm5JZCkgewogICAgICAgIGNvbnNvbGUubG9nKCdFeGVjdXRpbmcgcGF0dGVybjonLCBwYXR0ZXJuSWQpOwogICAgICAgIGFsZXJ0KGBFeGVjdXRpbmcgdHJpZ2dlciBwYXR0ZXJuICR7cGF0dGVybklkfS4gSW4gcHJvZHVjdGlvbiwgdGhpcyB3b3VsZCB0cmlnZ2VyIGFwcHJvcHJpYXRlIHdvcmtmbG93cy5gKTsKICAgICAgfQoKICAgICAgYXN5bmMgZ2VuZXJhdGVDTUEoKSB7CiAgICAgICAgY29uc3QgYWRkcmVzcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbWEtYWRkcmVzcycpPy52YWx1ZTsKICAgICAgICBpZiAoIWFkZHJlc3MpIHsKICAgICAgICAgIGFsZXJ0KCdQbGVhc2UgZW50ZXIgYSBwcm9wZXJ0eSBhZGRyZXNzJyk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNvbnNvbGUubG9nKCdHZW5lcmF0aW5nIENNQSBmb3I6JywgYWRkcmVzcyk7CiAgICAgICAgYWxlcnQoYEdlbmVyYXRpbmcgQ01BIGZvciAke2FkZHJlc3N9LiBJbiBwcm9kdWN0aW9uLCB0aGlzIHdvdWxkIHRyaWdnZXIgQ2xvdWRDTUEgZ2VuZXJhdGlvbiB3aXRoIGJlaGF2aW9yYWwgb3B0aW1pemF0aW9uLmApOwogICAgICB9CgogICAgICBhc3luYyBleGVjdXRlRm9sbG93VXAoKSB7CiAgICAgICAgY29uc29sZS5sb2coJ0V4ZWN1dGluZyBmb2xsb3ctdXAnKTsKICAgICAgICBhbGVydCgnRXhlY3V0aW5nIGZvbGxvdy11cCBhY3Rpb24uIEluIHByb2R1Y3Rpb24sIHRoaXMgd291bGQgY3JlYXRlIHRhc2tzIGFuZCBzZW5kIGNvbW11bmljYXRpb25zLicpOwogICAgICB9CgogICAgICBhc3luYyBhY3RpdmF0ZUhvbWViZWF0KCkgewogICAgICAgIGNvbnNvbGUubG9nKCdBY3RpdmF0aW5nIEhvbWViZWF0Jyk7CiAgICAgICAgYWxlcnQoJ0FjdGl2YXRpbmcgSG9tZWJlYXQgbW9uaXRvcmluZy4gSW4gcHJvZHVjdGlvbiwgdGhpcyB3b3VsZCBzZXR1cCBhdXRvbWF0ZWQgbWFya2V0IHZhbHVlIHRyYWNraW5nLicpOwogICAgICB9CgogICAgICBhc3luYyBhZGRQZXJzb25Ub1dJTExPVygpIHsKICAgICAgICBjb25zb2xlLmxvZygnQWRkaW5nIHBlcnNvbiB0byBXSUxMT1cnKTsKICAgICAgICBhbGVydCgnQWRkaW5nIGNvbnRhY3QgdG8gV0lMTE9XIHN5c3RlbS4gSW4gcHJvZHVjdGlvbiwgdGhpcyB3b3VsZCBpbml0aWFsaXplIGJlaGF2aW9yYWwgaW50ZWxsaWdlbmNlIHRyYWNraW5nLicpOwogICAgICB9CiAgICB9CgogICAgLy8gSW5pdGlhbGl6ZSBhcHAgd2hlbiBwYWdlIGxvYWRzCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgKCkgPT4gewogICAgICB3aW5kb3cud2lsbG93QXBwID0gbmV3IFdJTExPV0VtYmVkZGVkQXBwKCk7CiAgICB9KTsKCiAgICAvLyBIYW5kbGUgRlVCIGVtYmVkZGVkIGFwcCBldmVudHMKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgKGV2ZW50KSA9PiB7CiAgICAgIC8vIEhhbmRsZSBhbnkgRlVCLXNwZWNpZmljIGV2ZW50cwogICAgICBjb25zb2xlLmxvZygnRlVCIEV2ZW50IHJlY2VpdmVkOicsIGV2ZW50KTsKICAgIH0pOwogIDwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4=';

/**
 * HMAC SHA256 Signature Verification (FUB Security)
 */
function isFromFollowUpBoss(context, signature) {
  const calculated = crypto
    .createHmac('sha256', FUB_SECRET_KEY)
    .update(context)
    .digest('hex');
  return calculated === signature;
}

/**
 * Enhanced Behavioral Scoring V4.0 Algorithm
 * Omnipresent Intelligence: Fello 35% + CloudCMA 25% + WILLOW 25% + Sierra 15%
 */
function calculateOmnipresentScore(person) {
  
  const felloIntelligence = {
    leadScore: person.customFelloLeadScore || 0,
    dashboardClicks: person.customFelloOfDashboardClicks || 0,
    emailClicks: person.customFelloOfEmailClicks || 0,
    formSubmissions: person.customFelloOfFormSubmissions || 0,
    sellingTimeline: person.customFelloSellingTimeline || 'Unknown',
    propertiesOwned: person.customFelloOfProperties || 1
  };
  
  const felloScore = calculateFelloScore(felloIntelligence);
  const cloudCMAScore = 10;
  const willowScore = 10;
  const sierraScore = 10;
  
  const totalScore = Math.min(felloScore + cloudCMAScore + willowScore + sierraScore, 100);
  
  return {
    totalScore: totalScore,
    components: {
      fello: felloScore,
      cloudCMA: cloudCMAScore,
      willow: willowScore,
      sierra: sierraScore
    },
    classification: classifyPriority(totalScore),
    triggeredPatterns: evaluateTriggers(person)
  };
}

function calculateFelloScore(fello) {
  let score = 0;
  
  if (fello.leadScore >= 80) score += 15;
  else if (fello.leadScore >= 60) score += 10;
  else if (fello.leadScore >= 40) score += 5;
  
  if (fello.dashboardClicks > 10) score += 10;
  else if (fello.dashboardClicks > 5) score += 7;
  else if (fello.dashboardClicks > 0) score += 3;
  
  if (fello.emailClicks > 5) score += 5;
  else if (fello.emailClicks > 0) score += 2;
  
  if (fello.formSubmissions > 0) score += 5;
  
  return Math.min(score, 35);
}

function classifyPriority(score) {
  if (score >= 90) return 'CRITICAL';
  if (score >= 75) return 'SUPER_HOT';
  if (score >= 60) return 'HOT';
  if (score >= 40) return 'WARM';
  return 'COLD';
}

function evaluateTriggers(person) {
  const triggers = [];
  
  if ((person.customFelloLeadScore || 0) >= 80) {
    triggers.push({
      id: 1,
      name: 'Ultra High Fello Score',
      severity: 'CRITICAL'
    });
  }
  
  if ((person.customFelloOfDashboardClicks || 0) >= 10) {
    triggers.push({
      id: 2,
      name: 'High Dashboard Engagement',
      severity: 'HOT'
    });
  }
  
  return triggers;
}

/**
 * Main Lambda Handler
 */
exports.handler = async (event, context) => {
  
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Content-Type': 'text/html',
    'X-Content-Type-Options': 'nosniff',
    'X-XSS-Protection': '1; mode=block'
  };
  
  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }
  
  try {
    const params = event.queryStringParameters || {};
    const contextParam = params.context;
    const signatureParam = params.signature;
    
    let personData = null;
    let intelligenceData = null;
    
    if (contextParam) {
      try {
        const decodedContext = Buffer.from(contextParam, 'base64').toString('utf-8');
        const contextObj = JSON.parse(decodedContext);
        personData = contextObj.person || null;
        
        if (personData) {
          intelligenceData = calculateOmnipresentScore(personData);
        }
      } catch (err) {
        console.error('Context decode error:', err);
      }
    }
    
    // Decode Base64 HTML template
    let htmlTemplate = Buffer.from(HTML_TEMPLATE_B64, 'base64').toString('utf-8');
    
    // Inject intelligence data if available
    if (intelligenceData && personData) {
      const dataScript = `
    <script>
      window.WILLOW_INTELLIGENCE = ${JSON.stringify(intelligenceData)};
      window.WILLOW_PERSON = ${JSON.stringify(personData)};
    </script>
  `;
      // Insert before closing head tag
      htmlTemplate = htmlTemplate.replace('</head>', `${dataScript}</head>`);
    }
    
    return {
      statusCode: 200,
      headers,
      body: htmlTemplate
    };
    
  } catch (error) {
    console.error('Function error:', error);
    return {
      statusCode: 500,
      headers,
      body: `<html><body><h1>Error</h1><p>${error.message}</p></body></html>`
    };
  }
};
