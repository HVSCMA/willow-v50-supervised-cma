/**
 * WILLOW V50 FUB Embedded App - Netlify Function
 * LAZY LOAD ARCHITECTURE: User clicks button to load intelligence
 * Fixed circular dependency in getMockTriggeredPatterns()
 */

const crypto = require('crypto');
const https = require('https');

const FUB_API_KEY = process.env.FUB_API_KEY || 'fka_0oHt62NxmsExO6x69p08ix82zx8ii1hzrj';
const FUB_SECRET_KEY = process.env.FUB_SECRET_KEY || 'f1e0c6af664bc1525ecd8fecba255235';
const CLOUDCMA_API_KEY = process.env.CLOUDCMA_API_KEY || '742f4a46e1780904da090d721a9bae7b';

const HTML_TEMPLATE_B64 = 'PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0idXRmLTgiPgogIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wIj4KICA8dGl0bGU+V0lMTE9XIFY1MCBJbnRlbGxpZ2VuY2UgU3lzdGVtPC90aXRsZT4KICA8IS0tIENSSVRJQ0FMOiBObyBYLUZyYW1lLU9wdGlvbnMgaGVhZGVyIGZvciBGVUIgY29tcGxpYW5jZSAtLT4KICA8c3R5bGU+CiAgICAvKiBGb2xsb3cgVXAgQm9zcyBTdHlsZSBDb21wbGlhbmNlICovCiAgICA6cm9vdCB7CiAgICAgIC0tZnViLXByaW1hcnk6ICMyNTYzZWI7CiAgICAgIC0tZnViLXNlY29uZGFyeTogIzY0NzQ4YjsKICAgICAgLS1mdWItc3VjY2VzczogIzE2YTM0YTsKICAgICAgLS1mdWItd2FybmluZzogI2VhYjMwODsKICAgICAgLS1mdWItZGFuZ2VyOiAjZGMyNjI2OwogICAgICAtLWZ1Yi1iYWNrZ3JvdW5kOiAjZjhmYWZjOwogICAgICAtLWZ1Yi1jYXJkOiAjZmZmZmZmOwogICAgICAtLWZ1Yi1ib3JkZXI6ICNlMmU4ZjA7CiAgICAgIC0tZnViLXRleHQ6ICMwZjE3MmE7CiAgICAgIC0tZnViLXRleHQtbXV0ZWQ6ICM2NDc0OGI7CiAgICB9CgogICAgKiB7CiAgICAgIG1hcmdpbjogMDsKICAgICAgcGFkZGluZzogMDsKICAgICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIH0KCiAgICBib2R5IHsKICAgICAgZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgJ1NlZ29lIFVJJywgUm9ib3RvLCBzYW5zLXNlcmlmOwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYmFja2dyb3VuZCk7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dCk7CiAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgbGluZS1oZWlnaHQ6IDEuNTsKICAgIH0KCiAgICAjd2lsbG93LWNvbnRhaW5lciB7CiAgICAgIGJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsKICAgICAgbWluLWhlaWdodDogNjAwcHg7CiAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgYm94LXNoYWRvdzogMCAxcHggM3B4IHJnYmEoMCwwLDAsMC4xKTsKICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIH0KCiAgICAvKiBUYWIgTmF2aWdhdGlvbiAqLwogICAgI3dpbGxvdy10YWJzIHsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOwogICAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7CiAgICAgIHBhZGRpbmc6IDA7CiAgICAgIG1hcmdpbjogMDsKICAgICAgZmxleC1zaHJpbms6IDA7CiAgICB9CgogICAgLnRhYi1idXR0b24gewogICAgICBmbGV4OiAxOwogICAgICBwYWRkaW5nOiAxMnB4IDhweDsKICAgICAgYm9yZGVyOiBub25lOwogICAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICBmb250LXNpemU6IDEzcHg7CiAgICAgIGZvbnQtd2VpZ2h0OiA1MDA7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItc2Vjb25kYXJ5KTsKICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnMgZWFzZTsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKICAgIH0KCiAgICAudGFiLWJ1dHRvbjpob3ZlciB7CiAgICAgIGJhY2tncm91bmQ6IHJnYmEoMzcsIDk5LCAyMzUsIDAuMDUpOwogICAgfQoKICAgIC50YWItYnV0dG9uLmFjdGl2ZSB7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGJhY2tncm91bmQ6IHJnYmEoMzcsIDk5LCAyMzUsIDAuMDUpOwogICAgfQoKICAgIC8qIENvbnRlbnQgQXJlYSAqLwogICAgI3dpbGxvdy1jb250ZW50IHsKICAgICAgZmxleDogMTsKICAgICAgcGFkZGluZzogMjBweDsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOwogICAgICBvdmVyZmxvdy15OiBhdXRvOwogICAgICBtYXgtaGVpZ2h0OiA1NTBweDsKICAgIH0KCiAgICAvKiBMb2FkaW5nIFN0YXRlICovCiAgICAubG9hZGluZyB7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICBoZWlnaHQ6IDIwMHB4OwogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgfQoKICAgIC5sb2FkaW5nOjphZnRlciB7CiAgICAgIGNvbnRlbnQ6ICcnOwogICAgICB3aWR0aDogMjBweDsKICAgICAgaGVpZ2h0OiAyMHB4OwogICAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHZhcigtLWZ1Yi1wcmltYXJ5KTsKICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICBhbmltYXRpb246IHNwaW4gMXMgbGluZWFyIGluZmluaXRlOwogICAgICBtYXJnaW4tbGVmdDogMTBweDsKICAgIH0KCiAgICBAa2V5ZnJhbWVzIHNwaW4gewogICAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDBkZWcpOyB9CiAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpOyB9CiAgICB9CgogICAgLyogSW50ZWxsaWdlbmNlIERhc2hib2FyZCAqLwogICAgLnNjb3JlLXNlY3Rpb24gewogICAgICBkaXNwbGF5OiBncmlkOwogICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IGF1dG8gMWZyOwogICAgICBnYXA6IDIwcHg7CiAgICAgIG1hcmdpbi1ib3R0b206IDI1cHg7CiAgICAgIHBhZGRpbmc6IDIwcHg7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICNmOGZhZmMgMCUsICNlMmU4ZjAgMTAwJSk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOwogICAgfQoKICAgIC5zY29yZS1nYXVnZSB7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGdhcDogMTBweDsKICAgIH0KCiAgICAuZ2F1Z2UtY2lyY2xlIHsKICAgICAgd2lkdGg6IDEwMHB4OwogICAgICBoZWlnaHQ6IDEwMHB4OwogICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgIGJhY2tncm91bmQ6IGNvbmljLWdyYWRpZW50KHZhcigtLWZ1Yi1wcmltYXJ5KSAwZGVnLCB2YXIoLS1mdWItcHJpbWFyeSkgY2FsYyh2YXIoLS1zY29yZS1wZXJjZW50KSAqIDMuNmRlZyksIHZhcigtLWZ1Yi1ib3JkZXIpIGNhbGModmFyKC0tc2NvcmUtcGVyY2VudCkgKiAzLjZkZWcpLCB2YXIoLS1mdWItYm9yZGVyKSAzNjBkZWcpOwogICAgICBkaXNwbGF5OiBmbGV4OwogICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgfQoKICAgIC5nYXVnZS1jaXJjbGU6OmJlZm9yZSB7CiAgICAgIGNvbnRlbnQ6ICcnOwogICAgICB3aWR0aDogNzBweDsKICAgICAgaGVpZ2h0OiA3MHB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgfQoKICAgIC5zY29yZS12YWx1ZSB7CiAgICAgIGZvbnQtc2l6ZTogMjRweDsKICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIHotaW5kZXg6IDE7CiAgICB9CgogICAgLnNjb3JlLWxhYmVsIHsKICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgICB6LWluZGV4OiAxOwogICAgfQoKICAgIC5wcmlvcml0eS1iYWRnZSB7CiAgICAgIHBhZGRpbmc6IDZweCAxMnB4OwogICAgICBib3JkZXItcmFkaXVzOiAyMHB4OwogICAgICBmb250LXNpemU6IDEycHg7CiAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgfQoKICAgIC5wcmlvcml0eS1iYWRnZS5jcml0aWNhbCB7IGJhY2tncm91bmQ6ICNmZWYyZjI7IGNvbG9yOiAjZGMyNjI2OyB9CiAgICAucHJpb3JpdHktYmFkZ2Uuc3VwZXJfaG90IHsgYmFja2dyb3VuZDogI2ZmZjdlZDsgY29sb3I6ICNlYTU4MGM7IH0KICAgIC5wcmlvcml0eS1iYWRnZS5ob3QgeyBiYWNrZ3JvdW5kOiAjZmVmY2U4OyBjb2xvcjogI2NhOGEwNDsgfQogICAgLnByaW9yaXR5LWJhZGdlLndhcm0geyBiYWNrZ3JvdW5kOiAjZjBmZGY0OyBjb2xvcjogIzE2YTM0YTsgfQogICAgLnByaW9yaXR5LWJhZGdlLmNvbGQgeyBiYWNrZ3JvdW5kOiAjZjhmYWZjOyBjb2xvcjogIzY0NzQ4YjsgfQoKICAgIC5zY29yZS1jb21wb25lbnRzIHsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgZ2FwOiAxMnB4OwogICAgICBmbGV4OiAxOwogICAgfQoKICAgIC5jb21wb25lbnQgewogICAgICBkaXNwbGF5OiBncmlkOwogICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDEwMHB4IDYwcHggMWZyOwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICBnYXA6IDEwcHg7CiAgICAgIHBhZGRpbmc6IDhweCAxMnB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7CiAgICB9CgogICAgLmNvbXBvbmVudCBsYWJlbCB7CiAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgZm9udC13ZWlnaHQ6IDUwMDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi10ZXh0KTsKICAgIH0KCiAgICAuY29tcG9uZW50IHZhbHVlIHsKICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICBmb250LXdlaWdodDogYm9sZDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi1wcmltYXJ5KTsKICAgIH0KCiAgICAuY29tcG9uZW50IGJhciB7CiAgICAgIGhlaWdodDogNnB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgYm9yZGVyLXJhZGl1czogM3B4OwogICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB9CgogICAgLmNvbXBvbmVudCBiYXI6OmJlZm9yZSB7CiAgICAgIGNvbnRlbnQ6ICcnOwogICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgIHRvcDogMDsKICAgICAgbGVmdDogMDsKICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGJvcmRlci1yYWRpdXM6IDNweDsKICAgICAgd2lkdGg6IHZhcigtLWJhci13aWR0aCwgMCUpOwogICAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjVzIGVhc2U7CiAgICB9CgogICAgLyogUXVpY2sgQWN0aW9ucyBTaWRlYmFyICovCiAgICAucXVpY2stYWN0aW9ucyB7CiAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgdG9wOiAyMHB4OwogICAgICByaWdodDogMjBweDsKICAgICAgd2lkdGg6IDI1MHB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOwogICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDZweCByZ2JhKDAsMCwwLDAuMSk7CiAgICAgIHotaW5kZXg6IDEwMDA7CiAgICAgIG1heC1oZWlnaHQ6IDQwMHB4OwogICAgICBvdmVyZmxvdy15OiBhdXRvOwogICAgfQoKICAgIC5xdWljay1hY3Rpb25zIGgzIHsKICAgICAgcGFkZGluZzogMTVweDsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLXByaW1hcnkpOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgbWFyZ2luOiAwOwogICAgfQoKICAgIC5hY3Rpb24taXRlbSB7CiAgICAgIHBhZGRpbmc6IDEycHggMTVweDsKICAgICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOwogICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQgMC4yczsKICAgIH0KCiAgICAuYWN0aW9uLWl0ZW06aG92ZXIgewogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYmFja2dyb3VuZCk7CiAgICB9CgogICAgLmFjdGlvbi1pdGVtOmxhc3QtY2hpbGQgewogICAgICBib3JkZXItYm90dG9tOiBub25lOwogICAgfQoKICAgIC5hY3Rpb24tcHJpb3JpdHkgewogICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICAgIHdpZHRoOiA4cHg7CiAgICAgIGhlaWdodDogOHB4OwogICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgIG1hcmdpbi1yaWdodDogOHB4OwogICAgfQoKICAgIC5hY3Rpb24tcHJpb3JpdHkuY3JpdGljYWwgeyBiYWNrZ3JvdW5kOiAjZGMyNjI2OyB9CiAgICAuYWN0aW9uLXByaW9yaXR5LnN1cGVyX2hvdCB7IGJhY2tncm91bmQ6ICNlYTU4MGM7IH0KICAgIC5hY3Rpb24tcHJpb3JpdHkuaG90IHsgYmFja2dyb3VuZDogI2NhOGEwNDsgfQoKICAgIC5hY3Rpb24tdGV4dCB7CiAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi10ZXh0KTsKICAgIH0KCiAgICAuYWN0aW9uLWNvdW50IHsKICAgICAgZmxvYXQ6IHJpZ2h0OwogICAgICBmb250LXNpemU6IDExcHg7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7CiAgICAgIGJhY2tncm91bmQ6IHZhcigtLWZ1Yi1iYWNrZ3JvdW5kKTsKICAgICAgcGFkZGluZzogMnB4IDZweDsKICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgIH0KCiAgICAvKiBQYXR0ZXJuIEl0ZW1zICovCiAgICAucGF0dGVybnMtc2VjdGlvbiB7CiAgICAgIG1hcmdpbi1ib3R0b206IDI1cHg7CiAgICB9CgogICAgLnBhdHRlcm5zLXNlY3Rpb24gaDMgewogICAgICBmb250LXNpemU6IDE2cHg7CiAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dCk7CiAgICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgcGFkZGluZy1ib3R0b206IDhweDsKICAgIH0KCiAgICAucGF0dGVybi1pdGVtIHsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOwogICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsKICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICBwYWRkaW5nOiAxNXB4OwogICAgICBtYXJnaW4tYm90dG9tOiAxMnB4OwogICAgICB0cmFuc2l0aW9uOiBib3JkZXItY29sb3IgMC4yczsKICAgIH0KCiAgICAucGF0dGVybi1pdGVtOmhvdmVyIHsKICAgICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICB9CgogICAgLnBhdHRlcm4taGVhZGVyIHsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgZ2FwOiAxMHB4OwogICAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICB9CgogICAgLnBhdHRlcm4taWNvbiB7CiAgICAgIGZvbnQtc2l6ZTogMThweDsKICAgIH0KCiAgICAucGF0dGVybi1uYW1lIHsKICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgY29sb3I6IHZhcigtLWZ1Yi10ZXh0KTsKICAgICAgZmxleDogMTsKICAgIH0KCiAgICAuY29udmVyc2lvbi1yYXRlIHsKICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLXN1Y2Nlc3MpOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIHBhZGRpbmc6IDJweCA4cHg7CiAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgIGZvbnQtc2l6ZTogMTFweDsKICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICB9CgogICAgLnBhdHRlcm4tZGVzY3JpcHRpb24gewogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgICBmb250LXNpemU6IDEzcHg7CiAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgIGxpbmUtaGVpZ2h0OiAxLjQ7CiAgICB9CgogICAgLmFjdGlvbi1idG4gewogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgYm9yZGVyOiBub25lOwogICAgICBwYWRkaW5nOiA4cHggMTZweDsKICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgZm9udC13ZWlnaHQ6IDUwMDsKICAgICAgdHJhbnNpdGlvbjogYmFja2dyb3VuZCAwLjJzOwogICAgfQoKICAgIC5hY3Rpb24tYnRuOmhvdmVyIHsKICAgICAgYmFja2dyb3VuZDogIzFkNGVkODsKICAgIH0KCiAgICAvKiBFcnJvci9EZWJ1ZyBTdGF0ZXMgKi8KICAgIC5kZWJ1Zy1zdGF0ZSB7CiAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgcGFkZGluZzogNDBweCAyMHB4OwogICAgfQoKICAgIC5kZWJ1Zy1zdGF0ZSBoMiB7CiAgICAgIGNvbG9yOiB2YXIoLS1mdWItdGV4dCk7CiAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICB9CgogICAgLmRlYnVnLXN0YXRlIHAgewogICAgICBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOwogICAgICBtYXJnaW4tYm90dG9tOiAyMHB4OwogICAgfQoKICAgIC5kZWJ1Zy1idG4gewogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItcHJpbWFyeSk7CiAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgYm9yZGVyOiBub25lOwogICAgICBwYWRkaW5nOiAxMHB4IDIwcHg7CiAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICBmb250LXNpemU6IDE0cHg7CiAgICB9CgogICAgLyogUmVzcG9uc2l2ZSBEZXNpZ24gKi8KICAgIEBtZWRpYSAobWF4LXdpZHRoOiA3NjhweCkgewogICAgICAjd2lsbG93LWNvbnRhaW5lciB7CiAgICAgICAgbWFyZ2luOiAwOwogICAgICAgIGJvcmRlci1yYWRpdXM6IDA7CiAgICAgICAgbWluLWhlaWdodDogMTAwdmg7CiAgICAgIH0KCiAgICAgIC50YWItYnV0dG9uIHsKICAgICAgICBwYWRkaW5nOiAxMHB4IDZweDsKICAgICAgICBmb250LXNpemU6IDExcHg7CiAgICAgIH0KCiAgICAgIC5zY29yZS1zZWN0aW9uIHsKICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmcjsKICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgIH0KCiAgICAgIC5jb21wb25lbnQgewogICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogODBweCA1MHB4IDFmcjsKICAgICAgICBmb250LXNpemU6IDExcHg7CiAgICAgIH0KCiAgICAgIC5xdWljay1hY3Rpb25zIHsKICAgICAgICBkaXNwbGF5OiBub25lOyAvKiBIaWRlIG9uIG1vYmlsZSAqLwogICAgICB9CiAgICB9CgogICAgLyogSGlkZGVuIGJ5IGRlZmF1bHQgKi8KICAgIC50YWItY29udGVudCB7CiAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICB9CgogICAgLnRhYi1jb250ZW50LmFjdGl2ZSB7CiAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgfQogICAgLyogU3Bpbm5lciBhbmltYXRpb24gZm9yIGxvYWRpbmcgc3RhdGUgKi8KICAgIEBrZXlmcmFtZXMgc3BpbiB7CiAgICAgIDAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0KICAgICAgMTAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0KICAgIH0KICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgogIDwhLS0gUkVRVUlSRUQgRlVCIEludGVncmF0aW9uIC0tPgogIDxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiBzcmM9Imh0dHBzOi8vZWlhLmZvbGxvd3VwYm9zcy5jb20vZW1iZWRkZWRBcHBzLXYxLjAuMC5qcyI+PC9zY3JpcHQ+CgogIDxkaXYgaWQ9IndpbGxvdy1jb250YWluZXIiPgogICAgPCEtLSBOYXZpZ2F0aW9uIFRhYnMgLS0+CiAgICA8bmF2IGlkPSJ3aWxsb3ctdGFicyI+CiAgICAgIDxidXR0b24gY2xhc3M9InRhYi1idXR0b24gYWN0aXZlIiBkYXRhLXRhYj0iaW50ZWxsaWdlbmNlIj7wn46vIEludGVsbGlnZW5jZSBEYXNoYm9hcmQ8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBjbGFzcz0idGFiLWJ1dHRvbiIgZGF0YS10YWI9ImNtYSI+8J+TiCBDTUEgJiBQcm9wZXJ0eSBJbnRlbDwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIiBkYXRhLXRhYj0iYWN0aXZpdHkiPvCfk6cgQ29tbXVuaWNhdGlvbiAmIEFjdGl2aXR5PC9idXR0b24+CiAgICA8L25hdj4KCiAgICA8IS0tIENvbnRlbnQgQXJlYSAtLT4KICAgIDxtYWluIGlkPSJ3aWxsb3ctY29udGVudCI+CiAgICAgIAogICAgICA8IS0tIEludGVsbGlnZW5jZSBEYXNoYm9hcmQgVGFiIC0tPgogICAgICA8ZGl2IGlkPSJpbnRlbGxpZ2VuY2UtY29udGVudCIgY2xhc3M9InRhYi1jb250ZW50IGFjdGl2ZSI+CiAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+TG9hZGluZyBXSUxMT1cgSW50ZWxsaWdlbmNlPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgPCEtLSBDTUEgR2VuZXJhdGlvbiBUYWIgLS0+CiAgICAgIDxkaXYgaWQ9ImNtYS1jb250ZW50IiBjbGFzcz0idGFiLWNvbnRlbnQiPgogICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcgQ01BIFN5c3RlbTwvZGl2PgogICAgICA8L2Rpdj4KCiAgICAgIDwhLS0gQW5hbHl0aWNzIFRhYiAtLT4KICAgICAgPGRpdiBpZD0iYW5hbHl0aWNzLWNvbnRlbnQiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+TG9hZGluZyBBbmFseXRpY3M8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8IS0tIFBhcnRuZXJzIFRhYiAtLT4KICAgICAgPGRpdiBpZD0icGFydG5lcnMtY29udGVudCIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIFBhcnRuZXIgU3lzdGVtPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgPCEtLSBQcm9wZXJ0eSBUYWIgLS0+CiAgICAgIDxkaXYgaWQ9InByb3BlcnR5LWNvbnRlbnQiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+TG9hZGluZyBQcm9wZXJ0eSBJbnRlbGxpZ2VuY2U8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8IS0tIENvbW11bmljYXRpb24gVGFiIC0tPgogICAgICA8ZGl2IGlkPSJjb21tdW5pY2F0aW9uLWNvbnRlbnQiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+TG9hZGluZyBDb21tdW5pY2F0aW9uIENlbnRlcjwvZGl2PgogICAgICA8L2Rpdj4KCiAgICAgIDwhLS0gTWFuYWdlbWVudCBUYWIgLS0+CiAgICAgIDxkaXYgaWQ9Im1hbmFnZW1lbnQtY29udGVudCIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIFN5c3RlbSBNYW5hZ2VtZW50PC9kaXY+CiAgICAgIDwvZGl2PgoKICAgIDwvbWFpbj4KICA8L2Rpdj4KCiAgPCEtLSBRdWljayBBY3Rpb25zIFNpZGViYXIgLS0+CiAgPGRpdiBjbGFzcz0icXVpY2stYWN0aW9ucyIgaWQ9InF1aWNrLWFjdGlvbnMiIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+CiAgICA8aDM+4pqhIFF1aWNrIEFjdGlvbnM8L2gzPgogICAgPGRpdiBpZD0icXVpY2stYWN0aW9ucy1jb250ZW50Ij4KICAgICAgPGRpdiBjbGFzcz0iYWN0aW9uLWl0ZW0iPgogICAgICAgIDxzcGFuIGNsYXNzPSJhY3Rpb24tcHJpb3JpdHkgY3JpdGljYWwiPjwvc3Bhbj4KICAgICAgICA8c3BhbiBjbGFzcz0iYWN0aW9uLXRleHQiPkxvYWRpbmcgYWN0aW9ucy4uLjwvc3Bhbj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KCiAgPHNjcmlwdD4KICAgIC8qKgogICAgICogV0lMTE9XIFY1MCBFbWJlZGRlZCBBcHAgSmF2YVNjcmlwdAogICAgICogQ29tcGxldGUgRlVCIGNvbXBsaWFuY2Ugd2l0aCBtdWx0aS1mZWF0dXJlIGFyY2hpdGVjdHVyZQogICAgICovCiAgICAKICAgIGNsYXNzIFdJTExPV0VtYmVkZGVkQXBwIHsKICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgICAgICB0aGlzLnBlcnNvbiA9IG51bGw7CiAgICAgICAgdGhpcy5pbnRlbGxpZ2VuY2UgPSBudWxsOwogICAgICAgIHRoaXMuY3VycmVudFRhYiA9ICdpbnRlbGxpZ2VuY2UnOwogICAgICAgIHRoaXMuZGVidWdTdGF0ZSA9IG51bGw7CiAgICAgICAgdGhpcy5pc0xvYWRlZCA9IGZhbHNlOwogICAgICAgIAogICAgICAgIC8vIExBWlkgTE9BRCBQQVRURVJOOiBTaG93IGxvYWQgYnV0dG9uLCBkb24ndCBhdXRvLWluaXRpYWxpemUKICAgICAgICB0aGlzLnNob3dMb2FkQnV0dG9uKCk7CiAgICAgIH0KCiAgICAgIHNob3dMb2FkQnV0dG9uKCkgewogICAgICAgIGNvbnN0IGNvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2lsbG93LWNvbnRlbnQnKTsKICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IGAKICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBoZWlnaHQ6IDQwMHB4OyBnYXA6IDIwcHg7Ij4KICAgICAgICAgICAgPGRpdiBzdHlsZT0idGV4dC1hbGlnbjogY2VudGVyOyI+CiAgICAgICAgICAgICAgPGgyIHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQpOyBtYXJnaW4tYm90dG9tOiAxMHB4OyI+V0lMTE9XIFY1MCBJbnRlbGxpZ2VuY2UgU3lzdGVtPC9oMj4KICAgICAgICAgICAgICA8cCBzdHlsZT0iY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsgZm9udC1zaXplOiAxNHB4OyI+RW5oYW5jZWQgQmVoYXZpb3JhbCBTY29yaW5nICYgT21uaXByZXNlbnQgSW50ZWxsaWdlbmNlPC9wPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGJ1dHRvbiAKICAgICAgICAgICAgICBvbmNsaWNrPSJ3aW5kb3cud2lsbG93QXBwLmxvYWRJbnRlbGxpZ2VuY2VOb3coKSIgCiAgICAgICAgICAgICAgc3R5bGU9IgogICAgICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tZnViLXByaW1hcnkpOwogICAgICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgICAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgICAgICAgICAgcGFkZGluZzogMTRweCAzMnB4OwogICAgICAgICAgICAgICAgZm9udC1zaXplOiAxNXB4OwogICAgICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzIGVhc2U7CiAgICAgICAgICAgICAgICBib3gtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjEpOwogICAgICAgICAgICAgICIKICAgICAgICAgICAgICBvbm1vdXNlb3Zlcj0idGhpcy5zdHlsZS5iYWNrZ3JvdW5kPScjMWQ0ZWQ4JzsgdGhpcy5zdHlsZS50cmFuc2Zvcm09J3RyYW5zbGF0ZVkoLTFweCknOyB0aGlzLnN0eWxlLmJveFNoYWRvdz0nMCA0cHggOHB4IHJnYmEoMCwwLDAsMC4xNSknIgogICAgICAgICAgICAgIG9ubW91c2VvdXQ9InRoaXMuc3R5bGUuYmFja2dyb3VuZD0nIzI1NjNlYic7IHRoaXMuc3R5bGUudHJhbnNmb3JtPSd0cmFuc2xhdGVZKDApJzsgdGhpcy5zdHlsZS5ib3hTaGFkb3c9JzAgMnB4IDRweCByZ2JhKDAsMCwwLDAuMSknIgogICAgICAgICAgICA+CiAgICAgICAgICAgICAgTG9hZCBXSUxMT1cgSW50ZWxsaWdlbmNlCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8cCBzdHlsZT0iY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsgZm9udC1zaXplOiAxMnB4OyI+Q2xpY2sgdG8gYW5hbHl6ZSBiZWhhdmlvcmFsIGRhdGEgZnJvbSBGZWxsbywgQ2xvdWRDTUEsIFdJTExPVywgYW5kIFNpZXJyYTwvcD4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIGFzeW5jIGxvYWRJbnRlbGxpZ2VuY2VOb3coKSB7CiAgICAgICAgaWYgKHRoaXMuaXNMb2FkZWQpIHJldHVybjsgLy8gUHJldmVudCBkb3VibGUtbG9hZGluZwogICAgICAgIAogICAgICAgIGNvbnN0IGNvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2lsbG93LWNvbnRlbnQnKTsKICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7Ij4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJ3aWR0aDogNDBweDsgaGVpZ2h0OiA0MHB4OyBib3JkZXI6IDRweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgYm9yZGVyLXRvcC1jb2xvcjogdmFyKC0tZnViLXByaW1hcnkpOyBib3JkZXItcmFkaXVzOiA1MCU7IGFuaW1hdGlvbjogc3BpbiAxcyBsaW5lYXIgaW5maW5pdGU7IG1hcmdpbjogMCBhdXRvIDE1cHg7Ij48L2Rpdj4KICAgICAgICAgICAgICA8cD5Mb2FkaW5nIFdJTExPVyBJbnRlbGxpZ2VuY2UuLi48L3A+CiAgICAgICAgICAgICAgPHAgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsgbWFyZ2luLXRvcDogOHB4OyI+QW5hbHl6aW5nIGJlaGF2aW9yYWwgZGF0YS4uLjwvcD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAvLyBQYXJzZSBGVUIgY29udGV4dCBmcm9tIFVSTCBwYXJhbWV0ZXJzCiAgICAgICAgICBhd2FpdCB0aGlzLnBhcnNlQ29udGV4dCgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBIYW5kbGUgZGVidWcgc3RhdGVzCiAgICAgICAgICBpZiAodGhpcy5kZWJ1Z1N0YXRlKSB7CiAgICAgICAgICAgIHRoaXMuaGFuZGxlRGVidWdTdGF0ZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTG9hZCBXSUxMT1cgaW50ZWxsaWdlbmNlCiAgICAgICAgICBhd2FpdCB0aGlzLmxvYWRJbnRlbGxpZ2VuY2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gUmVzdG9yZSB0YWIgc3RydWN0dXJlICh3YXMgZGVzdHJveWVkIGJ5IGxvYWRpbmcgc3Bpbm5lcikKICAgICAgICAgIHRoaXMucmVzdG9yZVRhYlN0cnVjdHVyZSgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXR1cCBldmVudCBsaXN0ZW5lcnMKICAgICAgICAgIHRoaXMuc2V0dXBFdmVudExpc3RlbmVycygpOwogICAgICAgICAgCiAgICAgICAgICAvLyBNYXJrIGFzIGxvYWRlZAogICAgICAgICAgdGhpcy5pc0xvYWRlZCA9IHRydWU7CiAgICAgICAgICAKICAgICAgICAgIC8vIFJlbmRlciBpbml0aWFsIGNvbnRlbnQKICAgICAgICAgIGF3YWl0IHRoaXMucmVuZGVyQ3VycmVudFRhYigpOwogICAgICAgICAgCiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1dJTExPVyBBcHAgSW5pdGlhbGl6YXRpb24gRXJyb3I6JywgZXJyb3IpOwogICAgICAgICAgdGhpcy5zaG93RXJyb3IoYEZhaWxlZCB0byBsb2FkIFdJTExPVyBpbnRlbGxpZ2VuY2U6ICR7ZXJyb3IubWVzc2FnZX1gKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGFzeW5jIHBhcnNlQ29udGV4dCgpIHsKICAgICAgICBjb25zdCB1cmxQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpOwogICAgICAgIGNvbnN0IGNvbnRleHRQYXJhbSA9IHVybFBhcmFtcy5nZXQoJ2NvbnRleHQnKTsKICAgICAgICBjb25zdCBzaWduYXR1cmVQYXJhbSA9IHVybFBhcmFtcy5nZXQoJ3NpZ25hdHVyZScpOwogICAgICAgIGNvbnN0IGRlbW9Nb2RlID0gdXJsUGFyYW1zLmdldCgnZGVtbycpOwoKICAgICAgICAvLyBEZW1vIG1vZGUgZm9yIHRlc3Rpbmcgb3V0c2lkZSBGVUIgaWZyYW1lCiAgICAgICAgaWYgKCFjb250ZXh0UGFyYW0gJiYgZGVtb01vZGUgPT09ICd0cnVlJykgewogICAgICAgICAgY29uc29sZS5sb2coJ1J1bm5pbmcgaW4gREVNTyBtb2RlJyk7CiAgICAgICAgICB0aGlzLnBlcnNvbiA9IHsKICAgICAgICAgICAgbmFtZTogJ0RlbW8gQ29udGFjdCcsCiAgICAgICAgICAgIGVtYWlsOiAnZGVtb0BleGFtcGxlLmNvbScsCiAgICAgICAgICAgIGN1c3RvbUZlbGxvTGVhZFNjb3JlOiA4NSwKICAgICAgICAgICAgY3VzdG9tRmVsbG9PZkRhc2hib2FyZENsaWNrczogMTIsCiAgICAgICAgICAgIGN1c3RvbUZlbGxvT2ZFbWFpbENsaWNrczogOCwKICAgICAgICAgICAgY3VzdG9tRmVsbG9PZkZvcm1TdWJtaXNzaW9uczogMywKICAgICAgICAgICAgY3VzdG9tV0lMTE9XQ01BVmlld3M6IDUsCiAgICAgICAgICAgIGN1c3RvbVdJTExPV0hvdFNjb3JlOiA3NQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICghY29udGV4dFBhcmFtKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbnRleHQgcGFyYW1ldGVyIHByb3ZpZGVkLiBUaGlzIGFwcCBtdXN0IGJlIGFjY2Vzc2VkIHRocm91Z2ggRm9sbG93IFVwIEJvc3MgaWZyYW1lLicpOwogICAgICAgIH0KCiAgICAgICAgLy8gRGVjb2RlIGJhc2U2NCBjb250ZXh0CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdGVUIgQ29udGV4dCBQYXJhbWV0ZXIgKGZpcnN0IDEwMCBjaGFycyk6JywgY29udGV4dFBhcmFtLnN1YnN0cmluZygwLCAxMDApKTsKICAgICAgICAgIGNvbnN0IGRlY29kZWRDb250ZXh0ID0gSlNPTi5wYXJzZShhdG9iKGNvbnRleHRQYXJhbSkpOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gZGVjb2RlZENvbnRleHQ7CiAgICAgICAgICB0aGlzLnBlcnNvbiA9IGRlY29kZWRDb250ZXh0LnBlcnNvbjsKICAgICAgICAgIHRoaXMuZGVidWdTdGF0ZSA9IGRlY29kZWRDb250ZXh0LmRlYnVnU3RhdGU7CiAgICAgICAgICAKICAgICAgICAgIGNvbnNvbGUubG9nKCdGVUIgQ29udGV4dCBsb2FkZWQgc3VjY2Vzc2Z1bGx5Jyk7CiAgICAgICAgICBjb25zb2xlLmxvZygnUGVyc29uIGRhdGE6JywgdGhpcy5wZXJzb24gPyAnUHJlc2VudCcgOiAnTWlzc2luZycpOwogICAgICAgICAgY29uc29sZS5sb2coJ0RlYnVnIHN0YXRlOicsIHRoaXMuZGVidWdTdGF0ZSB8fCAnTm9uZScpOwogICAgICAgICAgCiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvbnRleHQgZGVjb2RlIGVycm9yIGRldGFpbHM6JywgZXJyb3IpOwogICAgICAgICAgY29uc29sZS5lcnJvcignQ29udGV4dCBwYXJhbWV0ZXIgbGVuZ3RoOicsIGNvbnRleHRQYXJhbS5sZW5ndGgpOwogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZGVjb2RlIEZVQiBjb250ZXh0OiAke2Vycm9yLm1lc3NhZ2V9YCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBoYW5kbGVEZWJ1Z1N0YXRlKCkgewogICAgICAgIGNvbnN0IGNvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2lsbG93LWNvbnRlbnQnKTsKICAgICAgICAKICAgICAgICBzd2l0Y2godGhpcy5kZWJ1Z1N0YXRlKSB7CiAgICAgICAgICBjYXNlICd3b3JraW5nJzoKICAgICAgICAgICAgLy8gQ29udGludWUgd2l0aCBub3JtYWwgb3BlcmF0aW9uCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAKICAgICAgICAgIGNhc2UgJ2FjY291bnRfbm90X2ZvdW5kJzoKICAgICAgICAgICAgY29udGVudC5pbm5lckhUTUwgPSB0aGlzLnJlbmRlckFjY291bnROb3RGb3VuZCgpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgCiAgICAgICAgICBjYXNlICd1c2VyX25vdF9mb3VuZCc6CiAgICAgICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJVc2VyTm90Rm91bmQoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIAogICAgICAgICAgY2FzZSAncGVyc29uX25vdF9mb3VuZCc6CiAgICAgICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJQZXJzb25Ob3RGb3VuZCgpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgCiAgICAgICAgICBjYXNlICd1bmF1dGhvcml6ZWQnOgogICAgICAgICAgICBjb250ZW50LmlubmVySFRNTCA9IHRoaXMucmVuZGVyVW5hdXRob3JpemVkKCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJVbmtub3duU3RhdGUoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJlbmRlckFjY291bnROb3RGb3VuZCgpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBjbGFzcz0iZGVidWctc3RhdGUiPgogICAgICAgICAgICA8aDI+QWNjb3VudCBTZXR1cCBSZXF1aXJlZDwvaDI+CiAgICAgICAgICAgIDxwPllvdXIgRm9sbG93IFVwIEJvc3MgYWNjb3VudCBuZWVkcyB0byBiZSBjb25maWd1cmVkIGZvciBXSUxMT1cgaW50ZWdyYXRpb24uPC9wPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJkZWJ1Zy1idG4iIG9uY2xpY2s9IndpbmRvdy5vcGVuKCdtYWlsdG86Z2xlbm5AaHVkc29udmFsbGV5c29sZC5jb20/c3ViamVjdD1XSUxMT1cgQWNjb3VudCBTZXR1cCcpIj4KICAgICAgICAgICAgICBDb250YWN0IEdsZW5uIGZvciBTZXR1cAogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHJlbmRlclVzZXJOb3RGb3VuZCgpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBjbGFzcz0iZGVidWctc3RhdGUiPgogICAgICAgICAgICA8aDI+VXNlciBOb3QgRm91bmQ8L2gyPgogICAgICAgICAgICA8cD5Zb3VyIHVzZXIgYWNjb3VudCBpcyBub3QgY29uZmlndXJlZCBpbiB0aGUgV0lMTE9XIHN5c3RlbS48L3A+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImRlYnVnLWJ0biIgb25jbGljaz0id2luZG93Lm9wZW4oJ21haWx0bzpnbGVubkBodWRzb252YWxsZXlzb2xkLmNvbT9zdWJqZWN0PVdJTExPVyBVc2VyIEFjY2VzcycpIj4KICAgICAgICAgICAgICBSZXF1ZXN0IEFjY2VzcwogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHJlbmRlclBlcnNvbk5vdEZvdW5kKCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJkZWJ1Zy1zdGF0ZSI+CiAgICAgICAgICAgIDxoMj5Db250YWN0IE5vdCBGb3VuZDwvaDI+CiAgICAgICAgICAgIDxwPlRoaXMgY29udGFjdCBpcyBub3QgeWV0IGluIHRoZSBXSUxMT1cgaW50ZWxsaWdlbmNlIHN5c3RlbS48L3A+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImRlYnVnLWJ0biIgb25jbGljaz0idGhpcy5hZGRQZXJzb25Ub1dJTExPVygpIj4KICAgICAgICAgICAgICBBZGQgdG8gV0lMTE9XIFN5c3RlbQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHJlbmRlclVuYXV0aG9yaXplZCgpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBjbGFzcz0iZGVidWctc3RhdGUiPgogICAgICAgICAgICA8aDI+QWNjZXNzIERlbmllZDwvaDI+CiAgICAgICAgICAgIDxwPllvdSBkb24ndCBoYXZlIHBlcm1pc3Npb24gdG8gYWNjZXNzIHRoZSBXSUxMT1cgc3lzdGVtLjwvcD4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZGVidWctYnRuIiBvbmNsaWNrPSJ3aW5kb3cub3BlbignbWFpbHRvOmdsZW5uQGh1ZHNvbnZhbGxleXNvbGQuY29tP3N1YmplY3Q9V0lMTE9XIEFjY2VzcyBSZXF1ZXN0JykiPgogICAgICAgICAgICAgIFJlcXVlc3QgUGVybWlzc2lvbgogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHJlbmRlclVua25vd25TdGF0ZSgpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBjbGFzcz0iZGVidWctc3RhdGUiPgogICAgICAgICAgICA8aDI+U3lzdGVtIEVycm9yPC9oMj4KICAgICAgICAgICAgPHA+VW5rbm93biBkZWJ1ZyBzdGF0ZSBlbmNvdW50ZXJlZC48L3A+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImRlYnVnLWJ0biIgb25jbGljaz0ibG9jYXRpb24ucmVsb2FkKCkiPgogICAgICAgICAgICAgIFJldHJ5CiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgYXN5bmMgbG9hZEludGVsbGlnZW5jZSgpIHsKICAgICAgICAvLyBDaGVjayBpZiBzZXJ2ZXIgcHJlLWNhbGN1bGF0ZWQgaW50ZWxsaWdlbmNlCiAgICAgICAgaWYgKHdpbmRvdy5XSUxMT1dfSU5URUxMSUdFTkNFKSB7CiAgICAgICAgICB0aGlzLmludGVsbGlnZW5jZSA9IHdpbmRvdy5XSUxMT1dfSU5URUxMSUdFTkNFOwogICAgICAgICAgY29uc29sZS5sb2coJ1dJTExPVyBJbnRlbGxpZ2VuY2UgbG9hZGVkIGZyb20gc2VydmVyOicsIHRoaXMuaW50ZWxsaWdlbmNlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gRmFsbGJhY2sgdG8gY2xpZW50LXNpZGUgY2FsY3VsYXRpb24KICAgICAgICB0aGlzLmludGVsbGlnZW5jZSA9IHsKICAgICAgICAgIHRvdGFsU2NvcmU6IHRoaXMuY2FsY3VsYXRlTW9ja1Njb3JlKCksCiAgICAgICAgICBjbGFzc2lmaWNhdGlvbjogdGhpcy5jbGFzc2lmeVNjb3JlKHRoaXMuY2FsY3VsYXRlTW9ja1Njb3JlKCkpLAogICAgICAgICAgY29tcG9uZW50czogewogICAgICAgICAgICBmZWxsbzogdGhpcy5nZXRNb2NrRmVsbG9TY29yZSgpLAogICAgICAgICAgICBjbG91ZENNQTogdGhpcy5nZXRNb2NrQ2xvdWRDTUFTY29yZSgpLAogICAgICAgICAgICB3aWxsb3c6IHRoaXMuZ2V0TW9ja1dJTExPV1Njb3JlKCksCiAgICAgICAgICAgIHNpZXJyYTogdGhpcy5nZXRNb2NrU2llcnJhU2NvcmUoKQogICAgICAgICAgfSwKICAgICAgICAgIHRyaWdnZXJlZFBhdHRlcm5zOiB0aGlzLmdldE1vY2tUcmlnZ2VyZWRQYXR0ZXJucygpCiAgICAgICAgfTsKCiAgICAgICAgY29uc29sZS5sb2coJ1dJTExPVyBJbnRlbGxpZ2VuY2UgbG9hZGVkIChjbGllbnQtc2lkZSk6JywgdGhpcy5pbnRlbGxpZ2VuY2UpOwogICAgICB9CgogICAgICBjYWxjdWxhdGVNb2NrU2NvcmUoKSB7CiAgICAgICAgLy8gTW9jayBiZWhhdmlvcmFsIHNjb3JpbmcgYmFzZWQgb24gcGVyc29uIGRhdGEKICAgICAgICBpZiAoIXRoaXMucGVyc29uKSByZXR1cm4gNDU7CiAgICAgICAgCiAgICAgICAgbGV0IHNjb3JlID0gMDsKICAgICAgICAKICAgICAgICAvLyBNb2NrIEZlbGxvIGludGVsbGlnZW5jZSAoMzUlIHdlaWdodCkKICAgICAgICBjb25zdCBmZWxsb1Njb3JlID0gdGhpcy5wZXJzb24uY3VzdG9tRmVsbG9MZWFkU2NvcmUgfHwgNTA7CiAgICAgICAgc2NvcmUgKz0gKGZlbGxvU2NvcmUgKiAwLjM1KTsKICAgICAgICAKICAgICAgICAvLyBNb2NrIENsb3VkQ01BICgyNSUgd2VpZ2h0KQogICAgICAgIGNvbnN0IGNtYVZpZXdzID0gdGhpcy5wZXJzb24uY3VzdG9tV0lMTE9XQ01BVmlld3MgfHwgMDsKICAgICAgICBzY29yZSArPSAoTWF0aC5taW4oY21hVmlld3MgKiA1LCAyNSkpOwogICAgICAgIAogICAgICAgIC8vIE1vY2sgV0lMTE9XICgyNSUgd2VpZ2h0KSAgCiAgICAgICAgY29uc3QgaG90U2NvcmUgPSB0aGlzLnBlcnNvbi5jdXN0b21XSUxMT1dIb3RTY29yZSB8fCAyNTsKICAgICAgICBzY29yZSArPSAoaG90U2NvcmUgKiAwLjI1KTsKICAgICAgICAKICAgICAgICAvLyBNb2NrIFNpZXJyYSAoMTUlIHdlaWdodCkKICAgICAgICBzY29yZSArPSAxMDsgLy8gQmFzZSBTaWVycmEgc2NvcmUKICAgICAgICAKICAgICAgICByZXR1cm4gTWF0aC5taW4oTWF0aC5yb3VuZChzY29yZSksIDEwMCk7CiAgICAgIH0KCiAgICAgIGdldE1vY2tGZWxsb1Njb3JlKCkgewogICAgICAgIHJldHVybiBNYXRoLm1pbigodGhpcy5wZXJzb24/LmN1c3RvbUZlbGxvTGVhZFNjb3JlIHx8IDUwKSAqIDAuMzUsIDM1KTsKICAgICAgfQoKICAgICAgZ2V0TW9ja0Nsb3VkQ01BU2NvcmUoKSB7CiAgICAgICAgY29uc3Qgdmlld3MgPSB0aGlzLnBlcnNvbj8uY3VzdG9tV0lMTE9XQ01BVmlld3MgfHwgMDsKICAgICAgICByZXR1cm4gTWF0aC5taW4odmlld3MgKiA1LCAyNSk7CiAgICAgIH0KCiAgICAgIGdldE1vY2tXSUxMT1dTY29yZSgpIHsKICAgICAgICByZXR1cm4gKHRoaXMucGVyc29uPy5jdXN0b21XSUxMT1dIb3RTY29yZSB8fCAyNSkgKiAwLjI1OwogICAgICB9CgogICAgICBnZXRNb2NrU2llcnJhU2NvcmUoKSB7CiAgICAgICAgcmV0dXJuIDEwOyAvLyBCYXNlIHNjb3JlCiAgICAgIH0KCiAgICAgIGNsYXNzaWZ5U2NvcmUoc2NvcmUpIHsKICAgICAgICBpZiAoc2NvcmUgPj0gOTUpIHJldHVybiAnQ1JJVElDQUwnOwogICAgICAgIGlmIChzY29yZSA+PSA4NSkgcmV0dXJuICdTVVBFUl9IT1QnOwogICAgICAgIGlmIChzY29yZSA+PSA3MCkgcmV0dXJuICdIT1QnOwogICAgICAgIGlmIChzY29yZSA+PSA0MCkgcmV0dXJuICdXQVJNJzsKICAgICAgICByZXR1cm4gJ0NPTEQnOwogICAgICB9CgogICAgICBnZXRNb2NrVHJpZ2dlcmVkUGF0dGVybnMoKSB7CiAgICAgICAgY29uc3QgcGF0dGVybnMgPSBbXTsKICAgICAgICAKICAgICAgICAvLyBDYWxjdWxhdGUgc2NvcmUgbG9jYWxseSB0byBhdm9pZCBjaXJjdWxhciBkZXBlbmRlbmN5CiAgICAgICAgY29uc3QgbG9jYWxTY29yZSA9IHRoaXMuY2FsY3VsYXRlTW9ja1Njb3JlKCk7CiAgICAgICAgCiAgICAgICAgaWYgKGxvY2FsU2NvcmUgPj0gODUpIHsKICAgICAgICAgIHBhdHRlcm5zLnB1c2goewogICAgICAgICAgICBpZDogMTIsCiAgICAgICAgICAgIG5hbWU6ICdPbW5pcHJlc2VudCBJbnRlbGxpZ2VuY2UgQ29uc2Vuc3VzJywKICAgICAgICAgICAgaWNvbjogJ/Cfjq8nLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ011bHRpcGxlIHN5c3RlbXMgaW5kaWNhdGUgaGlnaCBjb252ZXJzaW9uIHByb2JhYmlsaXR5JywKICAgICAgICAgICAgY29udmVyc2lvblJhdGU6IDk4LAogICAgICAgICAgICBwcmlvcml0eTogJ0NSSVRJQ0FMJywKICAgICAgICAgICAgYWN0aW9uTGFiZWw6ICdDb250YWN0IEltbWVkaWF0ZWx5JwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh0aGlzLnBlcnNvbj8uY3VzdG9tRmVsbG9PZkRhc2hib2FyZENsaWNrcyA+PSAzKSB7CiAgICAgICAgICBwYXR0ZXJucy5wdXNoKHsKICAgICAgICAgICAgaWQ6IDIsCiAgICAgICAgICAgIG5hbWU6ICdEYXNoYm9hcmQgQWN0aXZpdHkgU3Bpa2UnLAogICAgICAgICAgICBpY29uOiAn8J+TiicsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnTXVsdGlwbGUgcHJvcGVydHkgZGFzaGJvYXJkIHZpZXdzIGluZGljYXRlIHNlbGxlciBpbnRlbnQnLAogICAgICAgICAgICBjb252ZXJzaW9uUmF0ZTogOTIsCiAgICAgICAgICAgIHByaW9yaXR5OiAnSElHSCcsCiAgICAgICAgICAgIGFjdGlvbkxhYmVsOiAnR2VuZXJhdGUgQ01BJwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wZXJzb24/LmN1c3RvbVdJTExPV0NNQVZpZXdzID49IDEpIHsKICAgICAgICAgIHBhdHRlcm5zLnB1c2goewogICAgICAgICAgICBpZDogMTAsCiAgICAgICAgICAgIG5hbWU6ICdDTUEgRW5nYWdlbWVudCcsCiAgICAgICAgICAgIGljb246ICfwn5OIJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdBY3RpdmUgZW5nYWdlbWVudCB3aXRoIHByZXZpb3VzIENNQSByZXBvcnRzJywKICAgICAgICAgICAgY29udmVyc2lvblJhdGU6IDg1LAogICAgICAgICAgICBwcmlvcml0eTogJ01FRElVTScsCiAgICAgICAgICAgIGFjdGlvbkxhYmVsOiAnRm9sbG93IFVwJwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcGF0dGVybnM7CiAgICAgIH0KCiAgICAgIHJlc3RvcmVUYWJTdHJ1Y3R1cmUoKSB7CiAgICAgICAgY29uc3QgY29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3aWxsb3ctY29udGVudCcpOwogICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gYAogICAgICAgICAgPGRpdiBpZD0iaW50ZWxsaWdlbmNlLWNvbnRlbnQiIGNsYXNzPSJ0YWItY29udGVudCBhY3RpdmUiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJsb2FkaW5nIj5Mb2FkaW5nIEludGVsbGlnZW5jZSBEYXNoYm9hcmQuLi48L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBpZD0iY21hLWNvbnRlbnQiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcgQ01BICYgUHJvcGVydHkgSW50ZWwuLi48L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBpZD0iYWN0aXZpdHktY29udGVudCIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+TG9hZGluZyBDb21tdW5pY2F0aW9uICYgQWN0aXZpdHkuLi48L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHNldHVwRXZlbnRMaXN0ZW5lcnMoKSB7CiAgICAgICAgLy8gVGFiIHN3aXRjaGluZwogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy50YWItYnV0dG9uJykuZm9yRWFjaChidXR0b24gPT4gewogICAgICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgY29uc3QgdGFiTmFtZSA9IGUudGFyZ2V0LmRhdGFzZXQudGFiOwogICAgICAgICAgICB0aGlzLnN3aXRjaFRhYih0YWJOYW1lKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyBXaW5kb3cgcmVzaXplCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsICgpID0+IHsKICAgICAgICAgIHRoaXMuaGFuZGxlUmVzaXplKCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGFzeW5jIHN3aXRjaFRhYih0YWJOYW1lKSB7CiAgICAgICAgLy8gVXBkYXRlIGFjdGl2ZSB0YWIKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiLWJ1dHRvbicpLmZvckVhY2goYnRuID0+IGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSk7CiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgW2RhdGEtdGFiPSIke3RhYk5hbWV9Il1gKS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKCiAgICAgICAgLy8gSGlkZSBhbGwgY29udGVudAogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy50YWItY29udGVudCcpLmZvckVhY2goY29udGVudCA9PiBjb250ZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpKTsKICAgICAgICAKICAgICAgICAvLyBTaG93IHNlbGVjdGVkIGNvbnRlbnQKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgJHt0YWJOYW1lfS1jb250ZW50YCkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CgogICAgICAgIHRoaXMuY3VycmVudFRhYiA9IHRhYk5hbWU7CiAgICAgICAgYXdhaXQgdGhpcy5yZW5kZXJDdXJyZW50VGFiKCk7CiAgICAgIH0KCiAgICAgIGFzeW5jIHJlbmRlckN1cnJlbnRUYWIoKSB7CiAgICAgICAgY29uc3QgY29udGVudERpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGAke3RoaXMuY3VycmVudFRhYn0tY29udGVudGApOwogICAgICAgIAogICAgICAgIHN3aXRjaCh0aGlzLmN1cnJlbnRUYWIpIHsKICAgICAgICAgIGNhc2UgJ2ludGVsbGlnZW5jZSc6CiAgICAgICAgICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJJbnRlbGxpZ2VuY2VEYXNoYm9hcmQoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdjbWEnOgogICAgICAgICAgICBjb250ZW50RGl2LmlubmVySFRNTCA9IHRoaXMucmVuZGVyQ01BSHViKCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnYWN0aXZpdHknOgogICAgICAgICAgICBjb250ZW50RGl2LmlubmVySFRNTCA9IHRoaXMucmVuZGVyQWN0aXZpdHlIdWIoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgcXVpY2sgYWN0aW9ucwogICAgICAgIHRoaXMudXBkYXRlUXVpY2tBY3Rpb25zKCk7CiAgICAgIH0KCiAgICAgIHJlbmRlckludGVsbGlnZW5jZURhc2hib2FyZCgpIHsKICAgICAgICBpZiAoIXRoaXMuaW50ZWxsaWdlbmNlKSByZXR1cm4gJzxkaXYgY2xhc3M9ImxvYWRpbmciPkxvYWRpbmcgaW50ZWxsaWdlbmNlLi4uPC9kaXY+JzsKCiAgICAgICAgY29uc3Qgc2NvcmUgPSB0aGlzLmludGVsbGlnZW5jZS50b3RhbFNjb3JlOwogICAgICAgIGNvbnN0IGNsYXNzaWZpY2F0aW9uID0gdGhpcy5pbnRlbGxpZ2VuY2UuY2xhc3NpZmljYXRpb24udG9Mb3dlckNhc2UoKTsKCiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImludGVsbGlnZW5jZS1kYXNoYm9hcmQiPgogICAgICAgICAgICAKICAgICAgICAgICAgPCEtLSBQcmltYXJ5IFNjb3JlIERpc3BsYXkgLS0+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InNjb3JlLXNlY3Rpb24iPgogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNjb3JlLWdhdWdlIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImdhdWdlLWNpcmNsZSIgc3R5bGU9Ii0tc2NvcmUtcGVyY2VudDogJHtzY29yZX0iPgogICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic2NvcmUtdmFsdWUiPiR7c2NvcmV9PC9zcGFuPgogICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic2NvcmUtbGFiZWwiPi8xMDA8L3NwYW4+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByaW9yaXR5LWJhZGdlICR7Y2xhc3NpZmljYXRpb259Ij4KICAgICAgICAgICAgICAgICAgJHt0aGlzLmludGVsbGlnZW5jZS5jbGFzc2lmaWNhdGlvbn0KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIAogICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNjb3JlLWNvbXBvbmVudHMiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29tcG9uZW50IGZlbGxvIj4KICAgICAgICAgICAgICAgICAgPGxhYmVsPkZlbGxvIEludGVsbGlnZW5jZTwvbGFiZWw+CiAgICAgICAgICAgICAgICAgIDx2YWx1ZT4ke3RoaXMuaW50ZWxsaWdlbmNlLmNvbXBvbmVudHMuZmVsbG8udG9GaXhlZCgxKX0vMzU8L3ZhbHVlPgogICAgICAgICAgICAgICAgICA8YmFyIHN0eWxlPSItLWJhci13aWR0aDogJHsodGhpcy5pbnRlbGxpZ2VuY2UuY29tcG9uZW50cy5mZWxsby8zNSkqMTAwfSUiPjwvYmFyPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb21wb25lbnQgY2xvdWRjbWEiPgogICAgICAgICAgICAgICAgICA8bGFiZWw+Q2xvdWRDTUEgTUxTPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgPHZhbHVlPiR7dGhpcy5pbnRlbGxpZ2VuY2UuY29tcG9uZW50cy5jbG91ZENNQS50b0ZpeGVkKDEpfS8yNTwvdmFsdWU+CiAgICAgICAgICAgICAgICAgIDxiYXIgc3R5bGU9Ii0tYmFyLXdpZHRoOiAkeyh0aGlzLmludGVsbGlnZW5jZS5jb21wb25lbnRzLmNsb3VkQ01BLzI1KSoxMDB9JSI+PC9iYXI+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbXBvbmVudCB3aWxsb3ciPgogICAgICAgICAgICAgICAgICA8bGFiZWw+V0lMTE9XPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgPHZhbHVlPiR7dGhpcy5pbnRlbGxpZ2VuY2UuY29tcG9uZW50cy53aWxsb3cudG9GaXhlZCgxKX0vMjU8L3ZhbHVlPgogICAgICAgICAgICAgICAgICA8YmFyIHN0eWxlPSItLWJhci13aWR0aDogJHsodGhpcy5pbnRlbGxpZ2VuY2UuY29tcG9uZW50cy53aWxsb3cvMjUpKjEwMH0lIj48L2Jhcj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29tcG9uZW50IHNpZXJyYSI+CiAgICAgICAgICAgICAgICAgIDxsYWJlbD5TaWVycmE8L2xhYmVsPgogICAgICAgICAgICAgICAgICA8dmFsdWU+JHt0aGlzLmludGVsbGlnZW5jZS5jb21wb25lbnRzLnNpZXJyYS50b0ZpeGVkKDEpfS8xNTwvdmFsdWU+CiAgICAgICAgICAgICAgICAgIDxiYXIgc3R5bGU9Ii0tYmFyLXdpZHRoOiAkeyh0aGlzLmludGVsbGlnZW5jZS5jb21wb25lbnRzLnNpZXJyYS8xNSkqMTAwfSUiPjwvYmFyPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPCEtLSBUcmlnZ2VyZWQgUGF0dGVybnMgLS0+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InBhdHRlcm5zLXNlY3Rpb24iPgogICAgICAgICAgICAgIDxoMz7wn46vIEFjdGl2ZSBUcmlnZ2VyIFBhdHRlcm5zPC9oMz4KICAgICAgICAgICAgICAke3RoaXMucmVuZGVyVHJpZ2dlcmVkUGF0dGVybnMoKX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgICA8IS0tIENvbnRhY3QgSW5mb3JtYXRpb24gLS0+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InBhdHRlcm5zLXNlY3Rpb24iPgogICAgICAgICAgICAgIDxoMz7wn5OLIENvbnRhY3QgSW50ZWxsaWdlbmNlPC9oMz4KICAgICAgICAgICAgICAke3RoaXMucmVuZGVyQ29udGFjdEludGVsbGlnZW5jZSgpfQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgCiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICByZW5kZXJUcmlnZ2VyZWRQYXR0ZXJucygpIHsKICAgICAgICBpZiAoIXRoaXMuaW50ZWxsaWdlbmNlLnRyaWdnZXJlZFBhdHRlcm5zLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuICc8cCBzdHlsZT0iY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsgZm9udC1zdHlsZTogaXRhbGljOyI+Tm8gYWN0aXZlIHBhdHRlcm5zIGRldGVjdGVkLiBDb250aW51ZSBtb25pdG9yaW5nIGZvciBiZWhhdmlvcmFsIHRyaWdnZXJzLjwvcD4nOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZWxsaWdlbmNlLnRyaWdnZXJlZFBhdHRlcm5zLm1hcChwYXR0ZXJuID0+IGAKICAgICAgICAgIDxkaXYgY2xhc3M9InBhdHRlcm4taXRlbSBwcmlvcml0eS0ke3BhdHRlcm4ucHJpb3JpdHkudG9Mb3dlckNhc2UoKX0iPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJwYXR0ZXJuLWhlYWRlciI+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InBhdHRlcm4taWNvbiI+JHtwYXR0ZXJuLmljb259PC9zcGFuPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwYXR0ZXJuLW5hbWUiPiR7cGF0dGVybi5uYW1lfTwvc3Bhbj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iY29udmVyc2lvbi1yYXRlIj4ke3BhdHRlcm4uY29udmVyc2lvblJhdGV9JTwvc3Bhbj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InBhdHRlcm4tZGVzY3JpcHRpb24iPiR7cGF0dGVybi5kZXNjcmlwdGlvbn08L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0icGF0dGVybi1hY3Rpb24iPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImFjdGlvbi1idG4iIG9uY2xpY2s9IndpbmRvdy53aWxsb3dBcHAuZXhlY3V0ZVBhdHRlcm4oJyR7cGF0dGVybi5pZH0nKSI+CiAgICAgICAgICAgICAgICAke3BhdHRlcm4uYWN0aW9uTGFiZWx9CiAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYCkuam9pbignJyk7CiAgICAgIH0KCiAgICAgIHJlbmRlckNvbnRhY3RJbnRlbGxpZ2VuY2UoKSB7CiAgICAgICAgY29uc3QgcGVyc29uID0gdGhpcy5wZXJzb247CiAgICAgICAgaWYgKCFwZXJzb24pIHJldHVybiAnPHA+Tm8gY29udGFjdCBkYXRhIGF2YWlsYWJsZTwvcD4nOwoKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAxNXB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyI+CiAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTBweDsiPiR7cGVyc29uLmZpcnN0TmFtZSB8fCAnVW5rbm93bid9ICR7cGVyc29uLmxhc3ROYW1lIHx8ICdDb250YWN0J308L2g0PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdChhdXRvLWZpdCwgbWlubWF4KDIwMHB4LCAxZnIpKTsgZ2FwOiAxNXB4OyI+CiAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+UHJpbWFyeSBFbWFpbDwvbGFiZWw+PGJyPgogICAgICAgICAgICAgICAgPHNwYW4+JHtwZXJzb24uZW1haWxzPy5bMF0/LnZhbHVlIHx8ICdOb3QgcHJvdmlkZWQnfTwvc3Bhbj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5QcmltYXJ5IFBob25lPC9sYWJlbD48YnI+CiAgICAgICAgICAgICAgICA8c3Bhbj4ke3BlcnNvbi5waG9uZXM/LlswXT8udmFsdWUgfHwgJ05vdCBwcm92aWRlZCd9PC9zcGFuPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICA8bGFiZWwgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPlN0YWdlPC9sYWJlbD48YnI+CiAgICAgICAgICAgICAgICA8c3Bhbj4ke3BlcnNvbi5zdGFnZT8ubmFtZSB8fCAnVW5rbm93bid9PC9zcGFuPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICA8bGFiZWwgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPlByb3BlcnRpZXMgT3duZWQ8L2xhYmVsPjxicj4KICAgICAgICAgICAgICAgIDxzcGFuPiR7cGVyc29uLmN1c3RvbUZlbGxvT2ZQcm9wZXJ0aWVzIHx8IDF9PC9zcGFuPgogICAgICAgICAgICAgICAgJHsocGVyc29uLmN1c3RvbUZlbGxvT2ZQcm9wZXJ0aWVzIHx8IDApID49IDMgPyAnPHNwYW4gc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItd2FybmluZyk7IGZvbnQtd2VpZ2h0OiBib2xkOyBtYXJnaW4tbGVmdDogNXB4OyI+SU5WRVNUT1I8L3NwYW4+JyA6ICcnfQogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHJlbmRlckNNQUh1YigpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBjbGFzcz0iY21hLWh1YiI+CiAgICAgICAgICAgIDxoMyBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMjBweDsiPvCfk4ggQ01BIEdlbmVyYXRpb24gJiBNYW5hZ2VtZW50PC9oMz4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMjBweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgbWFyZ2luLWJvdHRvbTogMjBweDsiPgogICAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPkdlbmVyYXRlIFByb2Zlc3Npb25hbCBDTUE8L2g0PgogICAgICAgICAgICAgIAogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIGF1dG87IGdhcDogMTBweDsgYWxpZ24taXRlbXM6IGVuZDsiPgogICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBibG9jazsgbWFyZ2luLWJvdHRvbTogNXB4OyBmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5Qcm9wZXJ0eSBBZGRyZXNzPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGlkPSJjbWEtYWRkcmVzcyIgcGxhY2Vob2xkZXI9IkVudGVyIHByb3BlcnR5IGFkZHJlc3MuLi4iIHN0eWxlPSJ3aWR0aDogMTAwJTsgcGFkZGluZzogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgYm9yZGVyLXJhZGl1czogNHB4OyIgLz4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYWN0aW9uLWJ0biIgb25jbGljaz0id2luZG93LndpbGxvd0FwcC5nZW5lcmF0ZUNNQSgpIiBzdHlsZT0icGFkZGluZzogOHB4IDE2cHg7Ij4KICAgICAgICAgICAgICAgICAg8J+agCBHZW5lcmF0ZSBDTUEKICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIAogICAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi10b3A6IDE1cHg7IHBhZGRpbmc6IDEwcHg7IGJhY2tncm91bmQ6IHZhcigtLWZ1Yi1iYWNrZ3JvdW5kKTsgYm9yZGVyLXJhZGl1czogNHB4OyI+CiAgICAgICAgICAgICAgICA8c21hbGwgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij4KICAgICAgICAgICAgICAgICAgPHN0cm9uZz5CZWhhdmlvcmFsIE9wdGltaXphdGlvbjo8L3N0cm9uZz4gCiAgICAgICAgICAgICAgICAgICR7dGhpcy5pbnRlbGxpZ2VuY2U/LmNsYXNzaWZpY2F0aW9ufSBwcmlvcml0eSDigKIgCiAgICAgICAgICAgICAgICAgICR7dGhpcy5nZXRPcHRpbWl6ZWRSYWRpdXMoKX0gbWlsZSByYWRpdXMg4oCiIAogICAgICAgICAgICAgICAgICAke3RoaXMuZ2V0T3B0aW1pemVkQ29tcGFyYWJsZXMoKX0gY29tcGFyYWJsZXMKICAgICAgICAgICAgICAgIDwvc21hbGw+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyI+CiAgICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+8J+PoCBSZWNlbnQgQ01BIEFjdGl2aXR5PC9oND4KICAgICAgICAgICAgICAke3RoaXMucmVuZGVyQ01BSGlzdG9yeSgpfQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIGdldE9wdGltaXplZFJhZGl1cygpIHsKICAgICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IHRoaXMuaW50ZWxsaWdlbmNlPy5jbGFzc2lmaWNhdGlvbjsKICAgICAgICBzd2l0Y2goY2xhc3NpZmljYXRpb24pIHsKICAgICAgICAgIGNhc2UgJ0NSSVRJQ0FMJzogcmV0dXJuICcwLjUnOwogICAgICAgICAgY2FzZSAnU1VQRVJfSE9UJzogcmV0dXJuICcwLjYnOwogICAgICAgICAgY2FzZSAnSE9UJzogcmV0dXJuICcwLjc1JzsKICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiAnMS4wJzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGdldE9wdGltaXplZENvbXBhcmFibGVzKCkgewogICAgICAgIGNvbnN0IGNsYXNzaWZpY2F0aW9uID0gdGhpcy5pbnRlbGxpZ2VuY2U/LmNsYXNzaWZpY2F0aW9uOwogICAgICAgIHN3aXRjaChjbGFzc2lmaWNhdGlvbikgewogICAgICAgICAgY2FzZSAnQ1JJVElDQUwnOiByZXR1cm4gJzIwJzsKICAgICAgICAgIGNhc2UgJ1NVUEVSX0hPVCc6IHJldHVybiAnMTcnOwogICAgICAgICAgY2FzZSAnSE9UJzogcmV0dXJuICcxNSc7CiAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gJzEwJzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJlbmRlckNNQUhpc3RvcnkoKSB7CiAgICAgICAgLy8gTW9jayBDTUEgaGlzdG9yeQogICAgICAgIGNvbnN0IGxhc3RDTUFEYXRlID0gdGhpcy5wZXJzb24/LmN1c3RvbVdJTExPV0NNQURhdGU7CiAgICAgICAgY29uc3QgY21hTGluayA9IHRoaXMucGVyc29uPy5jdXN0b21XSUxMT1dDTUFMaW5rOwogICAgICAgIAogICAgICAgIGlmIChsYXN0Q01BRGF0ZSAmJiBjbWFMaW5rKSB7CiAgICAgICAgICByZXR1cm4gYAogICAgICAgICAgICA8ZGl2IHN0eWxlPSJwYWRkaW5nOiAxNXB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgYm9yZGVyLXJhZGl1czogNnB4OyI+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOyBhbGlnbi1pdGVtczogY2VudGVyOyI+CiAgICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgICA8c3Ryb25nPkxhdGVzdCBDTUE8L3N0cm9uZz48YnI+CiAgICAgICAgICAgICAgICAgIDxzbWFsbCBzdHlsZT0iY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPkdlbmVyYXRlZDogJHtuZXcgRGF0ZShsYXN0Q01BRGF0ZSkudG9Mb2NhbGVEYXRlU3RyaW5nKCl9PC9zbWFsbD4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGEgaHJlZj0iJHtjbWFMaW5rfSIgdGFyZ2V0PSJfYmxhbmsiIGNsYXNzPSJhY3Rpb24tYnRuIiBzdHlsZT0idGV4dC1kZWNvcmF0aW9uOiBub25lOyI+CiAgICAgICAgICAgICAgICAgIPCfkYHvuI8gVmlldyBDTUEKICAgICAgICAgICAgICAgIDwvYT4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICBgOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gJzxwIHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBmb250LXN0eWxlOiBpdGFsaWM7Ij5ObyBwcmV2aW91cyBDTUFzIGZvdW5kLiBHZW5lcmF0ZSBmaXJzdCBDTUEgYWJvdmUuPC9wPic7CiAgICAgICAgfQogICAgICB9CgogICAgICByZW5kZXJBbmFseXRpY3MoKSB7CiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImFuYWx5dGljcy1kYXNoYm9hcmQiPgogICAgICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbi1ib3R0b206IDIwcHg7Ij7wn5OKIExlYWQgQW5hbHl0aWNzICYgUGVyZm9ybWFuY2U8L2gzPgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoYXV0by1maXQsIG1pbm1heCgyMDBweCwgMWZyKSk7IGdhcDogMTVweDsgbWFyZ2luLWJvdHRvbTogMjBweDsiPgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMTVweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgdGV4dC1hbGlnbjogY2VudGVyOyI+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDI0cHg7IGZvbnQtd2VpZ2h0OiBib2xkOyBjb2xvcjogdmFyKC0tZnViLXByaW1hcnkpOyI+JHt0aGlzLmludGVsbGlnZW5jZT8udG90YWxTY29yZSB8fCAwfTwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+SW50ZWxsaWdlbmNlIFNjb3JlPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAxNXB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyB0ZXh0LWFsaWduOiBjZW50ZXI7Ij4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMjRweDsgZm9udC13ZWlnaHQ6IGJvbGQ7IGNvbG9yOiB2YXIoLS1mdWItc3VjY2Vzcyk7Ij4ke3RoaXMuZ2V0Q29udmVyc2lvblByb2JhYmlsaXR5KCl9JTwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+Q29udmVyc2lvbiBQcm9iYWJpbGl0eTwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMTVweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgdGV4dC1hbGlnbjogY2VudGVyOyI+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDI0cHg7IGZvbnQtd2VpZ2h0OiBib2xkOyBjb2xvcjogdmFyKC0tZnViLXdhcm5pbmcpOyI+JHt0aGlzLnBlcnNvbj8uY3VzdG9tRmVsbG9PZlByb3BlcnRpZXMgfHwgMX08L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPlByb3BlcnRpZXMgT3duZWQ8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7Ij4KICAgICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE1cHg7Ij7wn5OIIFJldmVudWUgT3Bwb3J0dW5pdHk8L2g0PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMThweDsgY29sb3I6IHZhcigtLWZ1Yi1wcmltYXJ5KTsgbWFyZ2luLWJvdHRvbTogMTBweDsiPgogICAgICAgICAgICAgICAgRXN0aW1hdGVkIENvbW1pc3Npb246IDxzdHJvbmc+JHt0aGlzLmNhbGN1bGF0ZUNvbW1pc3Npb25PcHBvcnR1bml0eSgpfTwvc3Ryb25nPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDxwIHN0eWxlPSJjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyBmb250LXNpemU6IDEzcHg7Ij4KICAgICAgICAgICAgICAgIEJhc2VkIG9uICR7dGhpcy5pbnRlbGxpZ2VuY2U/LmNsYXNzaWZpY2F0aW9ufSBwcmlvcml0eSBsZXZlbCBhbmQgJHt0aGlzLnBlcnNvbj8uY3VzdG9tRmVsbG9PZlByb3BlcnRpZXMgfHwgMX0gcHJvcGVydHkgb3duZXJzaGlwLgogICAgICAgICAgICAgICAgJHsodGhpcy5wZXJzb24/LmN1c3RvbUZlbGxvT2ZQcm9wZXJ0aWVzIHx8IDApID49IDMgPyAnSU5WRVNUT1IgcHJvZmlsZSBkZXRlY3RlZCAtIHBvdGVudGlhbCBmb3IgbXVsdGlwbGUgdHJhbnNhY3Rpb25zLicgOiAnJ30KICAgICAgICAgICAgICA8L3A+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgZ2V0Q29udmVyc2lvblByb2JhYmlsaXR5KCkgewogICAgICAgIGNvbnN0IGNsYXNzaWZpY2F0aW9uID0gdGhpcy5pbnRlbGxpZ2VuY2U/LmNsYXNzaWZpY2F0aW9uOwogICAgICAgIGNvbnN0IHJhdGVzID0gewogICAgICAgICAgJ0NSSVRJQ0FMJzogOTgsCiAgICAgICAgICAnU1VQRVJfSE9UJzogOTAsCiAgICAgICAgICAnSE9UJzogNzUsCiAgICAgICAgICAnV0FSTSc6IDM1LAogICAgICAgICAgJ0NPTEQnOiAxNQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIHJhdGVzW2NsYXNzaWZpY2F0aW9uXSB8fCAxNTsKICAgICAgfQoKICAgICAgY2FsY3VsYXRlQ29tbWlzc2lvbk9wcG9ydHVuaXR5KCkgewogICAgICAgIGNvbnN0IGJhc2VDb21taXNzaW9uID0gMjAwMDA7IC8vIEF2ZXJhZ2UgR2xlbm4gY29tbWlzc2lvbgogICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSB0aGlzLnBlcnNvbj8uY3VzdG9tRmVsbG9PZlByb3BlcnRpZXMgfHwgMTsKICAgICAgICBjb25zdCBtdWx0aXBsaWVyID0gTWF0aC5taW4ocHJvcGVydGllcywgMyk7IC8vIENhcCBhdCAzIGZvciBkaXNwbGF5CiAgICAgICAgY29uc3QgdG90YWwgPSBiYXNlQ29tbWlzc2lvbiAqIG11bHRpcGxpZXI7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIGAkJHt0b3RhbC50b0xvY2FsZVN0cmluZygpfWA7CiAgICAgIH0KCiAgICAgIHJlbmRlclBhcnRuZXJzKCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJwYXJ0bmVycy1kYXNoYm9hcmQiPgogICAgICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbi1ib3R0b206IDIwcHg7Ij7wn6SdIFBhcnRuZXIgQ29vcmRpbmF0aW9uIFN5c3RlbTwvaDM+CiAgICAgICAgICAgIAogICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IG1hcmdpbi1ib3R0b206IDIwcHg7Ij4KICAgICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE1cHg7Ij7wn46vIE9wdGltYWwgUGFydG5lciBBc3NpZ25tZW50PC9oND4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJwYWRkaW5nOiAxNXB4OyBiYWNrZ3JvdW5kOiB2YXIoLS1mdWItYmFja2dyb3VuZCk7IGJvcmRlci1yYWRpdXM6IDZweDsiPgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IGJvbGQ7IG1hcmdpbi1ib3R0b206IDVweDsiPlJlY29tbWVuZGVkOiAke3RoaXMuZ2V0T3B0aW1hbFBhcnRuZXIoKX08L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7IGZvbnQtc2l6ZTogMTNweDsiPiR7dGhpcy5nZXRQYXJ0bmVyUmF0aW9uYWxlKCl9PC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoYXV0by1maXQsIG1pbm1heCgyNTBweCwgMWZyKSk7IGdhcDogMTVweDsiPgogICAgICAgICAgICAgICR7dGhpcy5yZW5kZXJQYXJ0bmVyQ2FyZHMoKX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgOwogICAgICB9CgogICAgICBnZXRPcHRpbWFsUGFydG5lcigpIHsKICAgICAgICBjb25zdCBzY29yZSA9IHRoaXMuaW50ZWxsaWdlbmNlPy50b3RhbFNjb3JlIHx8IDA7CiAgICAgICAgY29uc3QgcHJvcGVydGllcyA9IHRoaXMucGVyc29uPy5jdXN0b21GZWxsb09mUHJvcGVydGllcyB8fCAxOwogICAgICAgIAogICAgICAgIGlmIChzY29yZSA+PSA5NSB8fCBwcm9wZXJ0aWVzID49IDMpIHJldHVybiAnR2xlbm4gRml0emdlcmFsZCc7CiAgICAgICAgaWYgKHNjb3JlID49IDg1KSByZXR1cm4gJ0p1c3RpbiBQaGlsbGlwcyc7ICAKICAgICAgICBpZiAocHJvcGVydGllcyA+PSAyKSByZXR1cm4gJ0xsb3lkIEdyYXknOwogICAgICAgIHJldHVybiAnSGVhdGhlciBNYXJ0aW4nOwogICAgICB9CgogICAgICBnZXRQYXJ0bmVyUmF0aW9uYWxlKCkgewogICAgICAgIGNvbnN0IHBhcnRuZXIgPSB0aGlzLmdldE9wdGltYWxQYXJ0bmVyKCk7CiAgICAgICAgY29uc3QgcmF0aW9uYWxlcyA9IHsKICAgICAgICAgICdHbGVubiBGaXR6Z2VyYWxkJzogJ1N5c3RlbSBvd25lciArIGx1eHVyeSBzcGVjaWFsaXN0ICsgaGlnaCBwcmlvcml0eSBsZWFkJywKICAgICAgICAgICdKdXN0aW4gUGhpbGxpcHMnOiAnTWFuYWdpbmcgYnJva2VyICsgcHJlbWl1bSBjbGllbnQgZXhwZXJpZW5jZScsCiAgICAgICAgICAnTGxveWQgR3JheSc6ICdJbnZlc3RtZW50IHNwZWNpYWxpc3QgKyBidXllciByZXByZXNlbnRhdGlvbiBleHBlcnQnLAogICAgICAgICAgJ0hlYXRoZXIgTWFydGluJzogJ1Jlc2lkZW50aWFsIHNwZWNpYWxpc3QgKyBmaXJzdC10aW1lIGJ1eWVyIGV4cGVydCcKICAgICAgICB9OwogICAgICAgIHJldHVybiByYXRpb25hbGVzW3BhcnRuZXJdIHx8ICdTdGFuZGFyZCByZXNpZGVudGlhbCBhc3NpZ25tZW50JzsKICAgICAgfQoKICAgICAgcmVuZGVyUGFydG5lckNhcmRzKCkgewogICAgICAgIGNvbnN0IHBhcnRuZXJzID0gWwogICAgICAgICAgeyBuYW1lOiAnR2xlbm4gRml0emdlcmFsZCcsIHJvbGU6ICdTeXN0ZW0gT3duZXInLCBzcGVjaWFsaXphdGlvbjogJ0x1eHVyeSArIFRlY2hub2xvZ3knLCBhY3RpdmU6IDI1LCBjb252ZXJzaW9uOiA5MiB9LAogICAgICAgICAgeyBuYW1lOiAnSnVzdGluIFBoaWxsaXBzJywgcm9sZTogJ01hbmFnaW5nIEJyb2tlcicsIHNwZWNpYWxpemF0aW9uOiAnUHJlbWl1bSBDbGllbnRzJywgYWN0aXZlOiAxOCwgY29udmVyc2lvbjogODggfSwKICAgICAgICAgIHsgbmFtZTogJ0hlYXRoZXIgTWFydGluJywgcm9sZTogJ1Jlc2lkZW50aWFsIFNwZWNpYWxpc3QnLCBzcGVjaWFsaXphdGlvbjogJ0ZpcnN0LVRpbWUgQnV5ZXJzJywgYWN0aXZlOiAyMiwgY29udmVyc2lvbjogODUgfSwKICAgICAgICAgIHsgbmFtZTogJ0xsb3lkIEdyYXknLCByb2xlOiAnSW52ZXN0bWVudCBTcGVjaWFsaXN0Jywgc3BlY2lhbGl6YXRpb246ICdCdXllciBSZXByZXNlbnRhdGlvbicsIGFjdGl2ZTogMTUsIGNvbnZlcnNpb246IDgyIH0KICAgICAgICBdOwoKICAgICAgICByZXR1cm4gcGFydG5lcnMubWFwKHBhcnRuZXIgPT4gYAogICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAxNXB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyI+CiAgICAgICAgICAgIDxoNSBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNXB4OyI+JHtwYXJ0bmVyLm5hbWV9PC9oNT4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsgZm9udC1zaXplOiAxMnB4OyBtYXJnaW4tYm90dG9tOiAxMHB4OyI+JHtwYXJ0bmVyLnJvbGV9PC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTFweDsgbWFyZ2luLWJvdHRvbTogOHB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+JHtwYXJ0bmVyLnNwZWNpYWxpemF0aW9ufTwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47Ij4KICAgICAgICAgICAgICA8c21hbGw+QWN0aXZlOiAke3BhcnRuZXIuYWN0aXZlfTwvc21hbGw+CiAgICAgICAgICAgICAgPHNtYWxsPkNvbnY6ICR7cGFydG5lci5jb252ZXJzaW9ufSU8L3NtYWxsPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGApLmpvaW4oJycpOwogICAgICB9CgogICAgICByZW5kZXJQcm9wZXJ0eSgpIHsKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBjbGFzcz0icHJvcGVydHktZGFzaGJvYXJkIj4KICAgICAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW4tYm90dG9tOiAyMHB4OyI+8J+PoCBQcm9wZXJ0eSBJbnRlbGxpZ2VuY2UgSHViPC9oMz4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMjBweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgbWFyZ2luLWJvdHRvbTogMjBweDsiPgogICAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPvCfk4ogTWFya2V0IEludGVsbGlnZW5jZTwvaDQ+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoYXV0by1maXQsIG1pbm1heCgxNTBweCwgMWZyKSk7IGdhcDogMTBweDsiPgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0idGV4dC1hbGlnbjogY2VudGVyOyBwYWRkaW5nOiAxMHB4OyI+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiBib2xkOyBjb2xvcjogdmFyKC0tZnViLXN1Y2Nlc3MpOyI+VVA8L2Rpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+TWFya2V0IFRyZW5kPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogMTBweDsiPgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi13YXJuaW5nKTsiPk1FRElVTTwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5JbnZlbnRvcnk8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0idGV4dC1hbGlnbjogY2VudGVyOyBwYWRkaW5nOiAxMHB4OyI+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiBib2xkOyBjb2xvcjogdmFyKC0tZnViLXByaW1hcnkpOyI+NDUgZGF5czwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7Ij5BdmcgRE9NPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAke3RoaXMucmVuZGVySG9tZWJlYXRTdGF0dXMoKX0KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHJlbmRlckhvbWViZWF0U3RhdHVzKCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7Ij4KICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+8J+TiCBIb21lYmVhdCBNb25pdG9yaW5nPC9oND4KICAgICAgICAgICAgPHAgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7IGZvbnQtc3R5bGU6IGl0YWxpYzsiPgogICAgICAgICAgICAgIEhvbWViZWF0IGludGVncmF0aW9uIGVuYWJsZXMgYXV0b21hdGljIG1hcmtldCB2YWx1ZSBtb25pdG9yaW5nIGFuZCBhbGVydHMuCiAgICAgICAgICAgICAgQ29udGFjdCBHbGVubiB0byBhY3RpdmF0ZSBwcm9wZXJ0eSBtb25pdG9yaW5nIGZvciB0aGlzIGNsaWVudC4KICAgICAgICAgICAgPC9wPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJhY3Rpb24tYnRuIiBzdHlsZT0ibWFyZ2luLXRvcDogMTBweDsiIG9uY2xpY2s9IndpbmRvdy53aWxsb3dBcHAuYWN0aXZhdGVIb21lYmVhdCgpIj4KICAgICAgICAgICAgICBBY3RpdmF0ZSBIb21lYmVhdAogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHJlbmRlckNvbW11bmljYXRpb24oKSB7CiAgICAgICAgcmV0dXJuIGAKICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbW11bmljYXRpb24tZGFzaGJvYXJkIj4KICAgICAgICAgICAgPGgzIHN0eWxlPSJtYXJnaW4tYm90dG9tOiAyMHB4OyI+8J+TpyBDb21tdW5pY2F0aW9uICYgRm9sbG93LVVwIENlbnRlcjwvaDM+CiAgICAgICAgICAgIAogICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IG1hcmdpbi1ib3R0b206IDIwcHg7Ij4KICAgICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE1cHg7Ij7wn5OsIEVtYWlsIEludGVsbGlnZW5jZTwvaDQ+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoYXV0by1maXQsIG1pbm1heCgxNTBweCwgMWZyKSk7IGdhcDogMTBweDsiPgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0idGV4dC1hbGlnbjogY2VudGVyOyBwYWRkaW5nOiAxMHB4OyI+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiBib2xkOyBjb2xvcjogdmFyKC0tZnViLXByaW1hcnkpOyI+JHt0aGlzLnBlcnNvbj8uY3VzdG9tRmVsbG9PZkVtYWlsQ2xpY2tzIHx8IDB9PC9kaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPkVtYWlsIENsaWNrczwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7IHBhZGRpbmc6IDEwcHg7Ij4KICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IGJvbGQ7IGNvbG9yOiB2YXIoLS1mdWItc3VjY2Vzcyk7Ij5BY3RpdmU8L2Rpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAxMnB4OyBjb2xvcjogdmFyKC0tZnViLXRleHQtbXV0ZWQpOyI+U3RhdHVzPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogMTBweDsiPgogICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogYm9sZDsgY29sb3I6IHZhcigtLWZ1Yi13YXJuaW5nKTsiPkVtYWlsPC9kaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMTJweDsgY29sb3I6IHZhcigtLWZ1Yi10ZXh0LW11dGVkKTsiPlByZWZlcnJlZDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyI+CiAgICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+4pqhIFJlY29tbWVuZGVkIEZvbGxvdy1VcDwvaDQ+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0icGFkZGluZzogMTVweDsgYmFja2dyb3VuZDogdmFyKC0tZnViLWJhY2tncm91bmQpOyBib3JkZXItcmFkaXVzOiA2cHg7Ij4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiBib2xkOyBtYXJnaW4tYm90dG9tOiA1cHg7Ij5OZXh0IEFjdGlvbjogJHt0aGlzLmdldE5leHRBY3Rpb24oKX08L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7IGZvbnQtc2l6ZTogMTNweDsgbWFyZ2luLWJvdHRvbTogMTBweDsiPiR7dGhpcy5nZXRBY3Rpb25SZWFzb24oKX08L2Rpdj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImFjdGlvbi1idG4iIG9uY2xpY2s9IndpbmRvdy53aWxsb3dBcHAuZXhlY3V0ZUZvbGxvd1VwKCkiPgogICAgICAgICAgICAgICAgICBFeGVjdXRlIEZvbGxvdy1VcAogICAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgZ2V0TmV4dEFjdGlvbigpIHsKICAgICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IHRoaXMuaW50ZWxsaWdlbmNlPy5jbGFzc2lmaWNhdGlvbjsKICAgICAgICBjb25zdCBhY3Rpb25zID0gewogICAgICAgICAgJ0NSSVRJQ0FMJzogJ0NhbGwgd2l0aGluIDE1IG1pbnV0ZXMnLAogICAgICAgICAgJ1NVUEVSX0hPVCc6ICdDYWxsIHRvZGF5JywKICAgICAgICAgICdIT1QnOiAnRW1haWwgKyBDTUEgZ2VuZXJhdGlvbicsIAogICAgICAgICAgJ1dBUk0nOiAnTnVydHVyaW5nIGVtYWlsIHNlcXVlbmNlJywKICAgICAgICAgICdDT0xEJzogJ01vbnRobHkgdG91Y2hwb2ludCcKICAgICAgICB9OwogICAgICAgIHJldHVybiBhY3Rpb25zW2NsYXNzaWZpY2F0aW9uXSB8fCAnU3RhbmRhcmQgZm9sbG93LXVwJzsKICAgICAgfQoKICAgICAgZ2V0QWN0aW9uUmVhc29uKCkgewogICAgICAgIHJldHVybiBgQmFzZWQgb24gJHt0aGlzLmludGVsbGlnZW5jZT8uY2xhc3NpZmljYXRpb259IHByaW9yaXR5IGFuZCBiZWhhdmlvcmFsIGludGVsbGlnZW5jZSBhbmFseXNpcy5gOwogICAgICB9CgogICAgICByZW5kZXJNYW5hZ2VtZW50KCkgewogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJtYW5hZ2VtZW50LWRhc2hib2FyZCI+CiAgICAgICAgICAgIDxoMyBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMjBweDsiPuKame+4jyBTeXN0ZW0gTWFuYWdlbWVudCAmIFN5bmM8L2gzPgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyBtYXJnaW4tYm90dG9tOiAyMHB4OyI+CiAgICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+8J+UhCBJbnRlZ3JhdGlvbiBTdGF0dXM8L2g0PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KGF1dG8tZml0LCBtaW5tYXgoMjAwcHgsIDFmcikpOyBnYXA6IDEwcHg7Ij4KICAgICAgICAgICAgICAgICR7dGhpcy5yZW5kZXJJbnRlZ3JhdGlvblN0YXR1cygpfQogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMjBweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsiPgogICAgICAgICAgICAgIDxoNCBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPvCfk4ogQ3VzdG9tIEZpZWxkcyAoJHt0aGlzLmdldEN1c3RvbUZpZWxkQ291bnQoKX0gdG90YWwpPC9oND4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDEzcHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7IGxpbmUtaGVpZ2h0OiAxLjY7Ij4KICAgICAgICAgICAgICAgIOKAoiA8c3Ryb25nPjIyIFdJTExPVyBmaWVsZHM8L3N0cm9uZz4gKHdyaXRlLWVuYWJsZWQpOiBCZWhhdmlvcmFsIGludGVsbGlnZW5jZSwgQ01BIGRhdGEsIG1hcmtldCBhbmFseXNpczxicj4KICAgICAgICAgICAgICAgIOKAoiA8c3Ryb25nPjE2IEZlbGxvIGZpZWxkczwvc3Ryb25nPiAocmVhZC1vbmx5KTogTGVhZCBzY29yaW5nLCBlbmdhZ2VtZW50IG1ldHJpY3MsIHByb3BlcnR5IGludGVsbGlnZW5jZTxicj4KICAgICAgICAgICAgICAgIOKAoiA8c3Ryb25nPjE1IENsb3VkQ01BIGZpZWxkczwvc3Ryb25nPiAod3JpdGUtZW5hYmxlZCk6IE1MUyBpbnRlbGxpZ2VuY2UsIG1hcmtldCBjb25kaXRpb25zLCBDTUEgYW5hbHl0aWNzPGJyPgogICAgICAgICAgICAgICAg4oCiIDxzdHJvbmc+MiBPdGhlciBmaWVsZHM8L3N0cm9uZz46IEFkZGl0aW9uYWwgcHJvcGVydHkgYW5kIHN5c3RlbSBkYXRhCiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgcmVuZGVySW50ZWdyYXRpb25TdGF0dXMoKSB7CiAgICAgICAgY29uc3QgaW50ZWdyYXRpb25zID0gWwogICAgICAgICAgeyBuYW1lOiAnRm9sbG93IFVwIEJvc3MnLCBzdGF0dXM6ICdDb25uZWN0ZWQnLCBjb2xvcjogJ3ZhcigtLWZ1Yi1zdWNjZXNzKScgfSwKICAgICAgICAgIHsgbmFtZTogJ0ZlbGxvIFBsYXRmb3JtJywgc3RhdHVzOiAnU3luY2VkJywgY29sb3I6ICd2YXIoLS1mdWItc3VjY2VzcyknIH0sCiAgICAgICAgICB7IG5hbWU6ICdDbG91ZENNQScsIHN0YXR1czogJ09wZXJhdGlvbmFsJywgY29sb3I6ICd2YXIoLS1mdWItc3VjY2VzcyknIH0sCiAgICAgICAgICB7IG5hbWU6ICdTaWVycmEgSW50ZXJhY3RpdmUnLCBzdGF0dXM6ICdJbnRlZ3JhdGVkJywgY29sb3I6ICd2YXIoLS1mdWItc3VjY2VzcyknIH0KICAgICAgICBdOwoKICAgICAgICByZXR1cm4gaW50ZWdyYXRpb25zLm1hcChpbnRlZ3JhdGlvbiA9PiBgCiAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47IGFsaWduLWl0ZW1zOiBjZW50ZXI7IHBhZGRpbmc6IDhweCAwOyBib3JkZXItYm90dG9tOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7Ij4KICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTogMTNweDsiPiR7aW50ZWdyYXRpb24ubmFtZX08L3NwYW4+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiAke2ludGVncmF0aW9uLmNvbG9yfTsgZm9udC13ZWlnaHQ6IGJvbGQ7Ij4ke2ludGVncmF0aW9uLnN0YXR1c308L3NwYW4+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICBgKS5qb2luKCcnKTsKICAgICAgfQoKICAgICAgZ2V0Q3VzdG9tRmllbGRDb3VudCgpIHsKICAgICAgICByZXR1cm4gNTU7IC8vIDIyIFdJTExPVyArIDE2IEZlbGxvICsgMTUgQ2xvdWRDTUEgKyAyIG90aGVyCiAgICAgIH0KCiAgICAgIHJlbmRlckFjdGl2aXR5SHViKCkgewogICAgICAgIGNvbnN0IHBlcnNvbk5hbWUgPSB0aGlzLnBlcnNvbiA/IGAke3RoaXMucGVyc29uLmZpcnN0TmFtZSB8fCAnJ30gJHt0aGlzLnBlcnNvbi5sYXN0TmFtZSB8fCAnJ31gLnRyaW0oKSA6ICdDb250YWN0JzsKICAgICAgICBjb25zdCBwZXJzb25FbWFpbCA9IHRoaXMucGVyc29uPy5lbWFpbHM/LlswXT8udmFsdWUgfHwgJyc7CiAgICAgICAgY29uc3QgcGVyc29uUGhvbmUgPSB0aGlzLnBlcnNvbj8ucGhvbmVzPy5bMF0/LnZhbHVlIHx8ICcnOwogICAgICAgIAogICAgICAgIHJldHVybiBgCiAgICAgICAgICA8ZGl2IGNsYXNzPSJhY3Rpdml0eS1odWIiPgogICAgICAgICAgICAKICAgICAgICAgICAgPCEtLSBRdWljayBDb21tdW5pY2F0aW9uIEFjdGlvbnMgLS0+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6IHZhcigtLWZ1Yi1jYXJkKTsgcGFkZGluZzogMjBweDsgYm9yZGVyLXJhZGl1czogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgbWFyZ2luLWJvdHRvbTogMjBweDsiPgogICAgICAgICAgICAgIDxoMyBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTVweDsiPvCfk6cgUXVpY2sgQWN0aW9ucyBmb3IgJHtwZXJzb25OYW1lfTwvaDM+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoYXV0by1maXQsIG1pbm1heCgyMDBweCwgMWZyKSk7IGdhcDogMTJweDsiPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYWN0aW9uLWJ0biIgb25jbGljaz0id2luZG93LndpbGxvd0FwcC5zZW5kRW1haWwoJyR7cGVyc29uRW1haWx9JykiIHN0eWxlPSJ3aWR0aDogMTAwJTsgcGFkZGluZzogMTJweDsgZm9udC1zaXplOiAxNHB4OyI+CiAgICAgICAgICAgICAgICAgIPCfk6cgU2VuZCBFbWFpbAogICAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJhY3Rpb24tYnRuIiBvbmNsaWNrPSJ3aW5kb3cud2lsbG93QXBwLm1ha2VDYWxsKCcke3BlcnNvblBob25lfScpIiBzdHlsZT0id2lkdGg6IDEwMCU7IHBhZGRpbmc6IDEycHg7IGZvbnQtc2l6ZTogMTRweDsiPgogICAgICAgICAgICAgICAgICDwn5OeIENhbGwgJHtwZXJzb25QaG9uZX0KICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYWN0aW9uLWJ0biIgb25jbGljaz0id2luZG93LndpbGxvd0FwcC5zZW5kU01TKCcke3BlcnNvblBob25lfScpIiBzdHlsZT0id2lkdGg6IDEwMCU7IHBhZGRpbmc6IDEycHg7IGZvbnQtc2l6ZTogMTRweDsiPgogICAgICAgICAgICAgICAgICDwn5KsIFNlbmQgU01TCiAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImFjdGlvbi1idG4iIG9uY2xpY2s9IndpbmRvdy53aWxsb3dBcHAuc2NoZWR1bGVGb2xsb3dVcCgpIiBzdHlsZT0id2lkdGg6IDEwMCU7IHBhZGRpbmc6IDEycHg7IGZvbnQtc2l6ZTogMTRweDsiPgogICAgICAgICAgICAgICAgICDwn5OFIFNjaGVkdWxlIEZvbGxvdy11cAogICAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPCEtLSBQYXJ0bmVyIENvb3JkaW5hdGlvbiAtLT4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyBtYXJnaW4tYm90dG9tOiAyMHB4OyI+CiAgICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+8J+knSBQYXJ0bmVyIENvb3JkaW5hdGlvbjwvaDQ+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoYXV0by1maXQsIG1pbm1heCgxODBweCwgMWZyKSk7IGdhcDogMTBweDsiPgogICAgICAgICAgICAgICAgJHt0aGlzLnJlbmRlclBhcnRuZXJCdXR0b25zKCl9CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPCEtLSBBY3Rpdml0eSBUaW1lbGluZSAtLT4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogdmFyKC0tZnViLWNhcmQpOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyBtYXJnaW4tYm90dG9tOiAyMHB4OyI+CiAgICAgICAgICAgICAgPGg0IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyI+8J+TiiBSZWNlbnQgQWN0aXZpdHk8L2g0PgogICAgICAgICAgICAgICR7dGhpcy5yZW5kZXJBY3Rpdml0eVRpbWVsaW5lKCl9CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPCEtLSBOb3RlcyAmIENvbW1lbnRzIC0tPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiB2YXIoLS1mdWItY2FyZCk7IHBhZGRpbmc6IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7Ij4KICAgICAgICAgICAgICA8aDQgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE1cHg7Ij7wn5OdIE5vdGVzICYgSW50ZWxsaWdlbmNlPC9oND4KICAgICAgICAgICAgICA8dGV4dGFyZWEgaWQ9IndpbGxvdy1ub3RlcyIgcGxhY2Vob2xkZXI9IkFkZCBub3RlcyBhYm91dCB0aGlzIGNvbnRhY3QuLi4iIHN0eWxlPSJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMjBweDsgcGFkZGluZzogMTBweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tZnViLWJvcmRlcik7IGJvcmRlci1yYWRpdXM6IDRweDsgZm9udC1mYW1pbHk6IGluaGVyaXQ7IHJlc2l6ZTogdmVydGljYWw7Ij48L3RleHRhcmVhPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImFjdGlvbi1idG4iIG9uY2xpY2s9IndpbmRvdy53aWxsb3dBcHAuc2F2ZU5vdGVzKCkiIHN0eWxlPSJtYXJnaW4tdG9wOiAxMHB4OyBwYWRkaW5nOiA4cHggMTZweDsiPgogICAgICAgICAgICAgICAg8J+SviBTYXZlIE5vdGVzCiAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHJlbmRlclBhcnRuZXJCdXR0b25zKCkgewogICAgICAgIGNvbnN0IHBhcnRuZXJzID0gWwogICAgICAgICAgeyBuYW1lOiAnR2xlbm4nLCByb2xlOiAnUHJpbWFyeSBBZ2VudCcsIGF2YWlsYWJsZTogdHJ1ZSB9LAogICAgICAgICAgeyBuYW1lOiAnSnVzdGluJywgcm9sZTogJ0NvLUFnZW50JywgYXZhaWxhYmxlOiB0cnVlIH0sCiAgICAgICAgICB7IG5hbWU6ICdIZWF0aGVyJywgcm9sZTogJ1RyYW5zYWN0aW9uIENvb3JkaW5hdG9yJywgYXZhaWxhYmxlOiBmYWxzZSB9LAogICAgICAgICAgeyBuYW1lOiAnTGxveWQnLCByb2xlOiAnQnJva2VyJywgYXZhaWxhYmxlOiB0cnVlIH0KICAgICAgICBdOwogICAgICAgIAogICAgICAgIHJldHVybiBwYXJ0bmVycy5tYXAocGFydG5lciA9PiBgCiAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJhY3Rpb24tYnRuIiBvbmNsaWNrPSJ3aW5kb3cud2lsbG93QXBwLmFzc2lnblBhcnRuZXIoJyR7cGFydG5lci5uYW1lfScpIiAKICAgICAgICAgICAgICAgICAgc3R5bGU9InBhZGRpbmc6IDEwcHg7IGZvbnQtc2l6ZTogMTNweDsgb3BhY2l0eTogJHtwYXJ0bmVyLmF2YWlsYWJsZSA/ICcxJyA6ICcwLjYnfTsiPgogICAgICAgICAgICAke3BhcnRuZXIuYXZhaWxhYmxlID8gJ+KchScgOiAn4o+477iPJ30gJHtwYXJ0bmVyLm5hbWV9CiAgICAgICAgICAgIDxicj48c21hbGwgc3R5bGU9ImZvbnQtc2l6ZTogMTFweDsgb3BhY2l0eTogMC44OyI+JHtwYXJ0bmVyLnJvbGV9PC9zbWFsbD4KICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgIGApLmpvaW4oJycpOwogICAgICB9CgogICAgICByZW5kZXJBY3Rpdml0eVRpbWVsaW5lKCkgewogICAgICAgIGNvbnN0IGFjdGl2aXRpZXMgPSBbCiAgICAgICAgICB7IHRpbWU6ICcyIGhvdXJzIGFnbycsIHR5cGU6ICdlbWFpbCcsIGRlc2M6ICdPcGVuZWQgQ01BIGVtYWlsJyB9LAogICAgICAgICAgeyB0aW1lOiAnMSBkYXkgYWdvJywgdHlwZTogJ2Rhc2hib2FyZCcsIGRlc2M6ICdWaWV3ZWQgMyBwcm9wZXJ0aWVzIG9uIEZlbGxvIGRhc2hib2FyZCcgfSwKICAgICAgICAgIHsgdGltZTogJzMgZGF5cyBhZ28nLCB0eXBlOiAnZm9ybScsIGRlc2M6ICdTdWJtaXR0ZWQgcHJvcGVydHkgYWxlcnQgZm9ybScgfSwKICAgICAgICBdOwogICAgICAgIAogICAgICAgIGlmICghYWN0aXZpdGllcy5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiAnPHAgc3R5bGU9ImNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7IGZvbnQtc3R5bGU6IGl0YWxpYzsiPk5vIHJlY2VudCBhY3Rpdml0eSB0cmFja2VkLjwvcD4nOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gYAogICAgICAgICAgPGRpdiBzdHlsZT0iYm9yZGVyLWxlZnQ6IDJweCBzb2xpZCB2YXIoLS1mdWItYm9yZGVyKTsgcGFkZGluZy1sZWZ0OiAxNXB4OyI+CiAgICAgICAgICAgICR7YWN0aXZpdGllcy5tYXAoYWN0ID0+IGAKICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNXB4OyBwYWRkaW5nLWJvdHRvbTogMTVweDsgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHZhcigtLWZ1Yi1ib3JkZXIpOyI+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDEycHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dC1tdXRlZCk7IG1hcmdpbi1ib3R0b206IDNweDsiPiR7YWN0LnRpbWV9PC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDE0cHg7IGNvbG9yOiB2YXIoLS1mdWItdGV4dCk7Ij4ke2FjdC5kZXNjfTwvZGl2PgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICBgKS5qb2luKCcnKX0KICAgICAgICAgIDwvZGl2PgogICAgICAgIGA7CiAgICAgIH0KCiAgICAgIHVwZGF0ZVF1aWNrQWN0aW9ucygpIHsKICAgICAgICBjb25zdCBxdWlja0FjdGlvbnMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXVpY2stYWN0aW9ucycpOwogICAgICAgIGNvbnN0IHF1aWNrQWN0aW9uc0NvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXVpY2stYWN0aW9ucy1jb250ZW50Jyk7CiAgICAgICAgCiAgICAgICAgaWYgKCF0aGlzLmludGVsbGlnZW5jZSkgewogICAgICAgICAgcXVpY2tBY3Rpb25zLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25zdCBhY3Rpb25zID0gW107CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuaW50ZWxsaWdlbmNlLmNsYXNzaWZpY2F0aW9uID09PSAnQ1JJVElDQUwnKSB7CiAgICAgICAgICBhY3Rpb25zLnB1c2goeyBwcmlvcml0eTogJ2NyaXRpY2FsJywgdGV4dDogJ0NhbGwgaW1tZWRpYXRlbHknLCBjb3VudDogMSB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuaW50ZWxsaWdlbmNlLmNsYXNzaWZpY2F0aW9uID09PSAnU1VQRVJfSE9UJykgewogICAgICAgICAgYWN0aW9ucy5wdXNoKHsgcHJpb3JpdHk6ICdzdXBlcl9ob3QnLCB0ZXh0OiAnQ2FsbCB0b2RheScsIGNvdW50OiAxIH0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAodGhpcy5pbnRlbGxpZ2VuY2UuY2xhc3NpZmljYXRpb24gPT09ICdIT1QnKSB7CiAgICAgICAgICBhY3Rpb25zLnB1c2goeyBwcmlvcml0eTogJ2hvdCcsIHRleHQ6ICdHZW5lcmF0ZSBDTUEnLCBjb3VudDogMSB9KTsKICAgICAgICB9CgogICAgICAgIGlmIChhY3Rpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHF1aWNrQWN0aW9uc0NvbnRlbnQuaW5uZXJIVE1MID0gYWN0aW9ucy5tYXAoYWN0aW9uID0+IGAKICAgICAgICAgICAgPGRpdiBjbGFzcz0iYWN0aW9uLWl0ZW0iPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJhY3Rpb24tcHJpb3JpdHkgJHthY3Rpb24ucHJpb3JpdHl9Ij48L3NwYW4+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImFjdGlvbi10ZXh0Ij4ke2FjdGlvbi50ZXh0fTwvc3Bhbj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iYWN0aW9uLWNvdW50Ij4ke2FjdGlvbi5jb3VudH08L3NwYW4+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgYCkuam9pbignJyk7CiAgICAgICAgICAKICAgICAgICAgIHF1aWNrQWN0aW9ucy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcXVpY2tBY3Rpb25zLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQogICAgICB9CgogICAgICBoYW5kbGVSZXNpemUoKSB7CiAgICAgICAgLy8gSGFuZGxlIHJlc3BvbnNpdmUgYmVoYXZpb3IKICAgICAgICBjb25zdCBxdWlja0FjdGlvbnMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXVpY2stYWN0aW9ucycpOwogICAgICAgIGlmICh3aW5kb3cuaW5uZXJXaWR0aCA8PSA3NjgpIHsKICAgICAgICAgIHF1aWNrQWN0aW9ucy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnRlbGxpZ2VuY2UgJiYgdGhpcy5pbnRlbGxpZ2VuY2UuY2xhc3NpZmljYXRpb24gIT09ICdDT0xEJykgewogICAgICAgICAgcXVpY2tBY3Rpb25zLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIH0KICAgICAgfQoKICAgICAgc2hvd0Vycm9yKG1lc3NhZ2UpIHsKICAgICAgICBjb25zdCBjb250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpbGxvdy1jb250ZW50Jyk7CiAgICAgICAgCiAgICAgICAgLy8gTG9nIHRvIGNvbnNvbGUgZm9yIGRlYnVnZ2luZwogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1dJTExPVyBTeXN0ZW0gRXJyb3I6JywgbWVzc2FnZSk7CiAgICAgICAgY29uc29sZS5lcnJvcignQ3VycmVudCBVUkw6Jywgd2luZG93LmxvY2F0aW9uLmhyZWYpOwogICAgICAgIGNvbnNvbGUuZXJyb3IoJ1VSTCBQYXJhbWV0ZXJzOicsIHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpOwogICAgICAgIAogICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gYAogICAgICAgICAgPGRpdiBjbGFzcz0iZGVidWctc3RhdGUiPgogICAgICAgICAgICA8aDI+U3lzdGVtIEVycm9yPC9oMj4KICAgICAgICAgICAgPHA+JHttZXNzYWdlfTwvcD4KICAgICAgICAgICAgPGRldGFpbHMgc3R5bGU9Im1hcmdpbi10b3A6IDIwcHg7IHRleHQtYWxpZ246IGxlZnQ7Ij4KICAgICAgICAgICAgICA8c3VtbWFyeSBzdHlsZT0iY3Vyc29yOiBwb2ludGVyOyBjb2xvcjogdmFyKC0tZnViLXNlY29uZGFyeSk7IGZvbnQtc2l6ZTogMTJweDsiPlRlY2huaWNhbCBEZXRhaWxzIChDbGljayB0byBleHBhbmQpPC9zdW1tYXJ5PgogICAgICAgICAgICAgIDxwcmUgc3R5bGU9Im1hcmdpbi10b3A6IDEwcHg7IHBhZGRpbmc6IDEwcHg7IGJhY2tncm91bmQ6IHZhcigtLWZ1Yi1iYWNrZ3JvdW5kKTsgYm9yZGVyLXJhZGl1czogNHB4OyBmb250LXNpemU6IDExcHg7IG92ZXJmbG93LXg6IGF1dG87Ij4ke21lc3NhZ2V9XG5cblVSTDogJHt3aW5kb3cubG9jYXRpb24uaHJlZn1cblxuT3BlbiBicm93c2VyIGNvbnNvbGUgKEYxMikgZm9yIG1vcmUgZGV0YWlscy48L3ByZT4KICAgICAgICAgICAgPC9kZXRhaWxzPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJkZWJ1Zy1idG4iIG9uY2xpY2s9ImxvY2F0aW9uLnJlbG9hZCgpIiBzdHlsZT0ibWFyZ2luLXRvcDogMTVweDsiPgogICAgICAgICAgICAgIFJldHJ5CiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJkZWJ1Zy1idG4iIG9uY2xpY2s9IndpbmRvdy5vcGVuKCdtYWlsdG86Z2xlbm5AaHVkc29udmFsbGV5c29sZC5jb20/c3ViamVjdD1XSUxMT1cgU3lzdGVtIEVycm9yJmJvZHk9JyArIGVuY29kZVVSSUNvbXBvbmVudCgnRXJyb3I6ICcgKyAnJHttZXNzYWdlfScgKyAnXFxuXFxuVVJMOiAnICsgd2luZG93LmxvY2F0aW9uLmhyZWYpKSIgc3R5bGU9Im1hcmdpbi10b3A6IDEwcHg7IGJhY2tncm91bmQ6IHZhcigtLWZ1Yi1zZWNvbmRhcnkpOyI+CiAgICAgICAgICAgICAgUmVwb3J0IEVycm9yIHRvIEdsZW5uCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgYDsKICAgICAgfQoKICAgICAgLy8gQWN0aW9uIE1ldGhvZHMgKGNhbGxlZCBmcm9tIFVJKQogICAgICBhc3luYyBleGVjdXRlUGF0dGVybihwYXR0ZXJuSWQpIHsKICAgICAgICBjb25zb2xlLmxvZygnRXhlY3V0aW5nIHBhdHRlcm46JywgcGF0dGVybklkKTsKICAgICAgICBhbGVydChgRXhlY3V0aW5nIHRyaWdnZXIgcGF0dGVybiAke3BhdHRlcm5JZH0uIEluIHByb2R1Y3Rpb24sIHRoaXMgd291bGQgdHJpZ2dlciBhcHByb3ByaWF0ZSB3b3JrZmxvd3MuYCk7CiAgICAgIH0KCiAgICAgIGFzeW5jIGdlbmVyYXRlQ01BKCkgewogICAgICAgIGNvbnN0IGFkZHJlc3MgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY21hLWFkZHJlc3MnKT8udmFsdWU7CiAgICAgICAgaWYgKCFhZGRyZXNzKSB7CiAgICAgICAgICBhbGVydCgnUGxlYXNlIGVudGVyIGEgcHJvcGVydHkgYWRkcmVzcycpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBjb25zb2xlLmxvZygnR2VuZXJhdGluZyBDTUEgZm9yOicsIGFkZHJlc3MpOwogICAgICAgIGFsZXJ0KGBHZW5lcmF0aW5nIENNQSBmb3IgJHthZGRyZXNzfS4gSW4gcHJvZHVjdGlvbiwgdGhpcyB3b3VsZCB0cmlnZ2VyIENsb3VkQ01BIGdlbmVyYXRpb24gd2l0aCBiZWhhdmlvcmFsIG9wdGltaXphdGlvbi5gKTsKICAgICAgfQoKICAgICAgYXN5bmMgZXhlY3V0ZUZvbGxvd1VwKCkgewogICAgICAgIGNvbnNvbGUubG9nKCdFeGVjdXRpbmcgZm9sbG93LXVwJyk7CiAgICAgICAgYWxlcnQoJ0V4ZWN1dGluZyBmb2xsb3ctdXAgYWN0aW9uLiBJbiBwcm9kdWN0aW9uLCB0aGlzIHdvdWxkIGNyZWF0ZSB0YXNrcyBhbmQgc2VuZCBjb21tdW5pY2F0aW9ucy4nKTsKICAgICAgfQoKICAgICAgYXN5bmMgYWN0aXZhdGVIb21lYmVhdCgpIHsKICAgICAgICBjb25zb2xlLmxvZygnQWN0aXZhdGluZyBIb21lYmVhdCcpOwogICAgICAgIGFsZXJ0KCdBY3RpdmF0aW5nIEhvbWViZWF0IG1vbml0b3JpbmcuIEluIHByb2R1Y3Rpb24sIHRoaXMgd291bGQgc2V0dXAgYXV0b21hdGVkIG1hcmtldCB2YWx1ZSB0cmFja2luZy4nKTsKICAgICAgfQoKICAgICAgYXN5bmMgYWRkUGVyc29uVG9XSUxMT1coKSB7CiAgICAgICAgY29uc29sZS5sb2coJ0FkZGluZyBwZXJzb24gdG8gV0lMTE9XJyk7CiAgICAgICAgYWxlcnQoJ0FkZGluZyBjb250YWN0IHRvIFdJTExPVyBzeXN0ZW0uIEluIHByb2R1Y3Rpb24sIHRoaXMgd291bGQgaW5pdGlhbGl6ZSBiZWhhdmlvcmFsIGludGVsbGlnZW5jZSB0cmFja2luZy4nKTsKICAgICAgfQoKICAgICAgYXN5bmMgc2VuZEVtYWlsKGVtYWlsKSB7CiAgICAgICAgaWYgKCFlbWFpbCkgewogICAgICAgICAgYWxlcnQoJ05vIGVtYWlsIGFkZHJlc3MgYXZhaWxhYmxlJyk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnNvbGUubG9nKCdPcGVuaW5nIGVtYWlsIGNsaWVudCBmb3I6JywgZW1haWwpOwogICAgICAgIHdpbmRvdy5vcGVuKGBtYWlsdG86JHtlbWFpbH1gLCAnX2JsYW5rJyk7CiAgICAgIH0KCiAgICAgIGFzeW5jIG1ha2VDYWxsKHBob25lKSB7CiAgICAgICAgaWYgKCFwaG9uZSkgewogICAgICAgICAgYWxlcnQoJ05vIHBob25lIG51bWJlciBhdmFpbGFibGUnKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc29sZS5sb2coJ0luaXRpYXRpbmcgY2FsbCB0bzonLCBwaG9uZSk7CiAgICAgICAgYWxlcnQoYEluIHByb2R1Y3Rpb24sIHRoaXMgd291bGQgaW5pdGlhdGUgYSBjYWxsIHRvICR7cGhvbmV9IHZpYSBpbnRlZ3JhdGVkIHBob25lIHN5c3RlbS5gKTsKICAgICAgfQoKICAgICAgYXN5bmMgc2VuZFNNUyhwaG9uZSkgewogICAgICAgIGlmICghcGhvbmUpIHsKICAgICAgICAgIGFsZXJ0KCdObyBwaG9uZSBudW1iZXIgYXZhaWxhYmxlJyk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnNvbGUubG9nKCdPcGVuaW5nIFNNUyBmb3I6JywgcGhvbmUpOwogICAgICAgIHdpbmRvdy5vcGVuKGBzbXM6JHtwaG9uZX1gLCAnX2JsYW5rJyk7CiAgICAgIH0KCiAgICAgIGFzeW5jIHNjaGVkdWxlRm9sbG93VXAoKSB7CiAgICAgICAgY29uc29sZS5sb2coJ09wZW5pbmcgZm9sbG93LXVwIHNjaGVkdWxlcicpOwogICAgICAgIGFsZXJ0KCdJbiBwcm9kdWN0aW9uLCB0aGlzIHdvdWxkIG9wZW4gdGhlIEZVQiB0YXNrIHNjaGVkdWxlciB0byBjcmVhdGUgYSBmb2xsb3ctdXAgcmVtaW5kZXIuJyk7CiAgICAgIH0KCiAgICAgIGFzeW5jIGFzc2lnblBhcnRuZXIocGFydG5lck5hbWUpIHsKICAgICAgICBjb25zb2xlLmxvZygnQXNzaWduaW5nIHBhcnRuZXI6JywgcGFydG5lck5hbWUpOwogICAgICAgIGFsZXJ0KGBBc3NpZ25pbmcgJHtwYXJ0bmVyTmFtZX0gdG8gdGhpcyBjb250YWN0LiBJbiBwcm9kdWN0aW9uLCB0aGlzIHdvdWxkIHVwZGF0ZSBGVUIgYXNzaWdubWVudHMgYW5kIG5vdGlmeSB0aGUgcGFydG5lci5gKTsKICAgICAgfQoKICAgICAgYXN5bmMgc2F2ZU5vdGVzKCkgewogICAgICAgIGNvbnN0IG5vdGVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpbGxvdy1ub3RlcycpPy52YWx1ZTsKICAgICAgICBpZiAoIW5vdGVzKSB7CiAgICAgICAgICBhbGVydCgnUGxlYXNlIGVudGVyIHNvbWUgbm90ZXMgZmlyc3QnKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc29sZS5sb2coJ1NhdmluZyBub3RlczonLCBub3Rlcyk7CiAgICAgICAgYWxlcnQoYE5vdGVzIHNhdmVkIHN1Y2Nlc3NmdWxseS4gSW4gcHJvZHVjdGlvbiwgdGhpcyB3b3VsZCB1cGRhdGUgRlVCIGN1c3RvbSBmaWVsZHMgd2l0aDogJHtub3Rlcy5zdWJzdHJpbmcoMCwgNTApfS4uLmApOwogICAgICB9CgogICAgICBhc3luYyBleGVjdXRlUGF0dGVybihwYXR0ZXJuSWQpIHsKICAgICAgICBjb25zb2xlLmxvZygnRXhlY3V0aW5nIHBhdHRlcm46JywgcGF0dGVybklkKTsKICAgICAgICBhbGVydChgRXhlY3V0aW5nIHRyaWdnZXIgcGF0dGVybiAke3BhdHRlcm5JZH0uIEluIHByb2R1Y3Rpb24sIHRoaXMgd291bGQgaW5pdGlhdGUgYXV0b21hdGVkIHdvcmtmbG93cyBiYXNlZCBvbiB0aGUgcGF0dGVybi5gKTsKICAgICAgfQogICAgfQoKICAgIC8vIEluaXRpYWxpemUgYXBwIHdoZW4gcGFnZSBsb2FkcwogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsICgpID0+IHsKICAgICAgd2luZG93LndpbGxvd0FwcCA9IG5ldyBXSUxMT1dFbWJlZGRlZEFwcCgpOwogICAgfSk7CgogICAgLy8gSGFuZGxlIEZVQiBlbWJlZGRlZCBhcHAgZXZlbnRzCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIChldmVudCkgPT4gewogICAgICAvLyBIYW5kbGUgYW55IEZVQi1zcGVjaWZpYyBldmVudHMKICAgICAgY29uc29sZS5sb2coJ0ZVQiBFdmVudCByZWNlaXZlZDonLCBldmVudCk7CiAgICB9KTsKICA8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+';

function fetchFUBPerson(personId) {
  return new Promise((resolve, reject) => {
    const auth = Buffer.from(FUB_API_KEY + ':').toString('base64');
    const options = {
      hostname: 'api.followupboss.com',
      path: "/v1/people/" + personId,
      method: 'GET',
      headers: {
        'Authorization': 'Basic ' + auth,
        'Content-Type': 'application/json'
      }
    };
    
    const req = https.request(options, (res) => {
      let data = '';
      res.on('data', (chunk) => { data += chunk; });
      res.on('end', () => {
        if (res.statusCode === 200) {
          try {
            resolve(JSON.parse(data));
          } catch (e) {
            reject(new Error('Failed to parse FUB API response'));
          }
        } else {
          reject(new Error("FUB API returned status " + res.statusCode));
        }
      });
    });
    
    req.on('error', reject);
    req.end();
  });
}

function calculateOmnipresentScore(person) {
  const felloIntelligence = {
    leadScore: person.customFelloLeadScore || 0,
    dashboardClicks: person.customFelloOfDashboardClicks || 0,
    emailClicks: person.customFelloOfEmailClicks || 0,
    formSubmissions: person.customFelloOfFormSubmissions || 0,
    sellingTimeline: person.customFelloSellingTimeline || 'Unknown',
    propertiesOwned: person.customFelloOfProperties || 1
  };
  
  const felloScore = calculateFelloScore(felloIntelligence);
  const cloudCMAScore = 10;
  const willowScore = 10;
  const sierraScore = 10;
  
  const totalScore = Math.min(felloScore + cloudCMAScore + willowScore + sierraScore, 100);
  
  return {
    totalScore: totalScore,
    components: { fello: felloScore, cloudCMA: cloudCMAScore, willow: willowScore, sierra: sierraScore },
    classification: classifyPriority(totalScore),
    triggeredPatterns: evaluateTriggers(person)
  };
}

function calculateFelloScore(fello) {
  let score = 0;
  if (fello.leadScore >= 80) score += 15;
  else if (fello.leadScore >= 60) score += 10;
  else if (fello.leadScore >= 40) score += 5;
  if (fello.dashboardClicks > 10) score += 10;
  else if (fello.dashboardClicks > 5) score += 7;
  else if (fello.dashboardClicks > 0) score += 3;
  if (fello.emailClicks > 5) score += 5;
  else if (fello.emailClicks > 0) score += 2;
  if (fello.formSubmissions > 0) score += 5;
  return Math.min(score, 35);
}

function classifyPriority(score) {
  if (score >= 90) return 'CRITICAL';
  if (score >= 75) return 'SUPER_HOT';
  if (score >= 60) return 'HOT';
  if (score >= 40) return 'WARM';
  return 'COLD';
}

function evaluateTriggers(person) {
  const triggers = [];
  if ((person.customFelloLeadScore || 0) >= 80) {
    triggers.push({ id: 1, name: 'Ultra High Fello Score', severity: 'CRITICAL' });
  }
  if ((person.customFelloOfDashboardClicks || 0) >= 10) {
    triggers.push({ id: 2, name: 'High Dashboard Engagement', severity: 'HOT' });
  }
  return triggers;
}

exports.handler = async (event, context) => {
  console.log('WILLOW Function invoked (Lazy-Load, Fixed Circular Dependency)');
  
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Content-Type': 'text/html',
    'X-Content-Type-Options': 'nosniff',
    'X-XSS-Protection': '1; mode=block'
  };
  
  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }
  
  try {
    const params = event.queryStringParameters || {};
    const contextParam = params.context;
    
    let personData = null;
    let intelligenceData = null;
    
    if (contextParam) {
      try {
        const decodedContext = Buffer.from(contextParam, 'base64').toString('utf-8');
        const contextObj = JSON.parse(decodedContext);
        const basicPersonData = contextObj.person || null;
        
        if (basicPersonData && basicPersonData.id) {
          console.log('Fetching full person record from FUB API for person ID:', basicPersonData.id);
          try {
            personData = await fetchFUBPerson(basicPersonData.id);
            console.log('FUB API: Person fetched successfully with', Object.keys(personData).length, 'fields');
            intelligenceData = calculateOmnipresentScore(personData);
            console.log('Intelligence calculated from FUB data:', intelligenceData.totalScore);
          } catch (apiError) {
            console.error('FUB API fetch error:', apiError.message);
            personData = basicPersonData;
            intelligenceData = calculateOmnipresentScore(personData);
            console.log('Fallback to basic context data, score:', intelligenceData.totalScore);
          }
        }
      } catch (err) {
        console.error('Context decode error:', err);
      }
    }
    
    let htmlTemplate = Buffer.from(HTML_TEMPLATE_B64, 'base64').toString('utf-8');
    
    if (intelligenceData && personData) {
      const dataScript = "<script>window.WILLOW_INTELLIGENCE=" + JSON.stringify(intelligenceData) + ";window.WILLOW_PERSON=" + JSON.stringify(personData) + ";</script>";
      htmlTemplate = htmlTemplate.replace('</head>', dataScript + '</head>');
    }
    
    return { statusCode: 200, headers, body: htmlTemplate };
    
  } catch (error) {
    console.error('Function error:', error);
    return {
      statusCode: 500,
      headers,
      body: "<html><body><h1>Server Error</h1><p>" + error.message + "</p></body></html>"
    };
  }
};
