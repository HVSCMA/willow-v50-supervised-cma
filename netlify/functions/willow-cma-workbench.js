// WILLOW V50 CMA Workbench - Complete Netlify Function
// Purpose: Server-side FUB/CloudCMA API integration with HTML serving

const https = require('https');

// API Credentials
const FUB_API_KEY = process.env.FUB_API_KEY || 'fka_0oHt62NxmsExO6x69p08ix82zx8ii1hzrj';
const CLOUDCMA_API_KEY = process.env.CLOUDCMA_API_KEY || '742f4a46e1780904da090d721a9bae7b';
const WEBHOOK_URL = 'https://willow-v50-supervised-cma.netlify.app/.netlify/functions/cloudcma-webhook';

exports.handler = async (event, context) => {
    // CORS headers
    const headers = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Content-Type': 'application/json'
    };

    if (event.httpMethod === 'OPTIONS') {
        return { statusCode: 200, headers, body: '' };
    }

    try {
        // Parse request
        const params = event.httpMethod === 'GET' 
            ? event.queryStringParameters || {}
            : JSON.parse(event.body || '{}');

        const action = params.action;

        // If no action parameter, serve HTML interface (Base64 decoded)
        if (!action) {
            const htmlBase64 = 'PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgICA8dGl0bGU+V0lMTE9XIFY1MCAtIENNQSBXb3JrYmVuY2g8L3RpdGxlPgogICAgPCEtLSBGVUIgRW1iZWRkZWQgQXBwcyBTREsgLS0+CiAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJodHRwczovL2VpYS5mb2xsb3d1cGJvc3MuY29tL2VtYmVkZGVkQXBwcy12MS4wLjEuanMiPjwvc2NyaXB0PgogICAgPHN0eWxlPgogICAgICAgICogewogICAgICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgICAgIHBhZGRpbmc6IDA7CiAgICAgICAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICAgICAgfQoKICAgICAgICBib2R5IHsKICAgICAgICAgICAgZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgJ1NlZ29lIFVJJywgUm9ib3RvLCBPeHlnZW4sIFVidW50dSwgQ2FudGFyZWxsLCBzYW5zLXNlcmlmOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjNjY3ZWVhIDAlLCAjNzY0YmEyIDEwMCUpOwogICAgICAgICAgICBjb2xvcjogIzJkMzc0ODsKICAgICAgICAgICAgbGluZS1oZWlnaHQ6IDEuNjsKICAgICAgICB9CgogICAgICAgIC5jb250YWluZXIgewogICAgICAgICAgICBtYXgtd2lkdGg6IDE0MDBweDsKICAgICAgICAgICAgbWFyZ2luOiAwIGF1dG87CiAgICAgICAgICAgIHBhZGRpbmc6IDIwcHg7CiAgICAgICAgfQoKICAgICAgICAuaGVhZGVyIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDIwcHggMzBweDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCA0cHggNnB4IHJnYmEoMCwwLDAsMC4xKTsKICAgICAgICB9CgogICAgICAgIC5oZWFkZXIgaDEgewogICAgICAgICAgICBmb250LXNpemU6IDI0cHg7CiAgICAgICAgICAgIGNvbG9yOiAjNjY3ZWVhOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICAgICAgfQoKICAgICAgICAuaGVhZGVyIC5zdWJ0aXRsZSB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICAgICAgY29sb3I6ICM3MTgwOTY7CiAgICAgICAgfQoKICAgICAgICAudGFicyB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGdhcDogMTBweDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgICAgICB9CgogICAgICAgIC50YWItYnV0dG9uIHsKICAgICAgICAgICAgZmxleDogMTsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICAgICAgcGFkZGluZzogMTVweCAyMHB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMnB4OwogICAgICAgICAgICBmb250LXNpemU6IDE2cHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuM3MgZWFzZTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC4xKTsKICAgICAgICB9CgogICAgICAgIC50YWItYnV0dG9uOmhvdmVyIHsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0ycHgpOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDRweCA4cHggcmdiYSgwLDAsMCwwLjE1KTsKICAgICAgICB9CgogICAgICAgIC50YWItYnV0dG9uLmFjdGl2ZSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICM2NjdlZWEgMCUsICM3NjRiYTIgMTAwJSk7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICB9CgogICAgICAgIC50YWItY29udGVudCB7CiAgICAgICAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMnB4OwogICAgICAgICAgICBwYWRkaW5nOiAzMHB4OwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDRweCA2cHggcmdiYSgwLDAsMCwwLjEpOwogICAgICAgICAgICBtaW4taGVpZ2h0OiA2MDBweDsKICAgICAgICB9CgogICAgICAgIC50YWItY29udGVudC5hY3RpdmUgewogICAgICAgICAgICBkaXNwbGF5OiBibG9jazsKICAgICAgICB9CgogICAgICAgIC5zZWN0aW9uIHsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMzBweDsKICAgICAgICAgICAgcGFkZGluZy1ib3R0b206IDMwcHg7CiAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjZTJlOGYwOwogICAgICAgIH0KCiAgICAgICAgLnNlY3Rpb246bGFzdC1jaGlsZCB7CiAgICAgICAgICAgIGJvcmRlci1ib3R0b206IG5vbmU7CiAgICAgICAgfQoKICAgICAgICAuc2VjdGlvbi10aXRsZSB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMThweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgY29sb3I6ICMyZDM3NDg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGdhcDogMTBweDsKICAgICAgICB9CgogICAgICAgIC5mb3JtLWdyb3VwIHsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgICAgICB9CgogICAgICAgIC5mb3JtLWxhYmVsIHsKICAgICAgICAgICAgZGlzcGxheTogYmxvY2s7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGNvbG9yOiAjNGE1NTY4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICB9CgogICAgICAgIC5mb3JtLWlucHV0IHsKICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgIHBhZGRpbmc6IDEycHggMTVweDsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgI2UyZThmMDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBmb250LXNpemU6IDE0cHg7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGJvcmRlci1jb2xvciAwLjNzIGVhc2U7CiAgICAgICAgfQoKICAgICAgICAuZm9ybS1pbnB1dDpmb2N1cyB7CiAgICAgICAgICAgIG91dGxpbmU6IG5vbmU7CiAgICAgICAgICAgIGJvcmRlci1jb2xvcjogIzY2N2VlYTsKICAgICAgICB9CgogICAgICAgIC5mb3JtLXJvdyB7CiAgICAgICAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KGF1dG8tZml0LCBtaW5tYXgoMjAwcHgsIDFmcikpOwogICAgICAgICAgICBnYXA6IDE1cHg7CiAgICAgICAgfQoKICAgICAgICAuZm9ybS1zZWxlY3QgewogICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgcGFkZGluZzogMTJweCAxNXB4OwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjZTJlOGYwOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICB9CgogICAgICAgIC5jaGVja2JveC1ncm91cCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGdhcDogMTBweDsKICAgICAgICAgICAgbWFyZ2luOiAxNXB4IDA7CiAgICAgICAgfQoKICAgICAgICAuY2hlY2tib3gtZ3JvdXAgaW5wdXRbdHlwZT0iY2hlY2tib3giXSB7CiAgICAgICAgICAgIHdpZHRoOiAyMHB4OwogICAgICAgICAgICBoZWlnaHQ6IDIwcHg7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICB9CgogICAgICAgIC5jaGVja2JveC1ncm91cCBsYWJlbCB7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGNvbG9yOiAjNGE1NTY4OwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgfQoKICAgICAgICAuYnRuIHsKICAgICAgICAgICAgcGFkZGluZzogMTRweCAyOHB4OwogICAgICAgICAgICBib3JkZXI6IG5vbmU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxNnB4OwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjNzIGVhc2U7CiAgICAgICAgfQoKICAgICAgICAuYnRuLXByaW1hcnkgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjNjY3ZWVhIDAlLCAjNzY0YmEyIDEwMCUpOwogICAgICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgfQoKICAgICAgICAuYnRuLXByaW1hcnk6aG92ZXIgewogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTJweCk7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNnB4IDEycHggcmdiYSgxMDIsIDEyNiwgMjM0LCAwLjMpOwogICAgICAgIH0KCiAgICAgICAgLmJ0bi1zZWNvbmRhcnkgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZTJlOGYwOwogICAgICAgICAgICBjb2xvcjogIzRhNTU2ODsKICAgICAgICB9CgogICAgICAgIC5idG4tc2Vjb25kYXJ5OmhvdmVyIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2NiZDVlMDsKICAgICAgICB9CgogICAgICAgIC5idG4tZGFuZ2VyIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2ZjODE4MTsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgIH0KCiAgICAgICAgLmJ0bi1kYW5nZXI6aG92ZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjU2NTY1OwogICAgICAgIH0KCiAgICAgICAgLmJ0bi1ncm91cCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGdhcDogMTBweDsKICAgICAgICAgICAgbWFyZ2luLXRvcDogMjBweDsKICAgICAgICB9CgogICAgICAgIC5pbmZvLWNhcmQgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjdmYWZjOwogICAgICAgICAgICBib3JkZXItbGVmdDogNHB4IHNvbGlkICM2NjdlZWE7CiAgICAgICAgICAgIHBhZGRpbmc6IDE1cHggMjBweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAyMHB4OwogICAgICAgIH0KCiAgICAgICAgLmluZm8tY2FyZC10aXRsZSB7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIGNvbG9yOiAjMmQzNzQ4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICAgICAgfQoKICAgICAgICAuaW5mby1jYXJkLWNvbnRlbnQgewogICAgICAgICAgICBjb2xvcjogIzcxODA5NjsKICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICAgIH0KCiAgICAgICAgLmhvbWViZWF0LWl0ZW0gewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjdmYWZjOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDIwcHg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgICAgICAgIGJvcmRlci1sZWZ0OiA0cHggc29saWQgI2UyZThmMDsKICAgICAgICB9CgogICAgICAgIC5ob21lYmVhdC1pdGVtLmhpZ2gtZW5nYWdlbWVudCB7CiAgICAgICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiAjZjU2NTY1OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmNWY1OwogICAgICAgIH0KCiAgICAgICAgLmhvbWViZWF0LWl0ZW0ubWVkaXVtLWVuZ2FnZW1lbnQgewogICAgICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogI2VkODkzNjsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2ZmZmFmMDsKICAgICAgICB9CgogICAgICAgIC5ob21lYmVhdC1pdGVtLmxvdy1lbmdhZ2VtZW50IHsKICAgICAgICAgICAgYm9yZGVyLWxlZnQtY29sb3I6ICM0Mjk5ZTE7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNlYmY4ZmY7CiAgICAgICAgfQoKICAgICAgICAuaG9tZWJlYXQtaXRlbS5ub3QtYWNjZXB0ZWQgewogICAgICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogI2EwYWVjMDsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2VkZjJmNzsKICAgICAgICB9CgogICAgICAgIC5ob21lYmVhdC1oZWFkZXIgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgICAgfQoKICAgICAgICAuaG9tZWJlYXQtdGl0bGUgewogICAgICAgICAgICBmb250LXNpemU6IDE2cHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIGNvbG9yOiAjMmQzNzQ4OwogICAgICAgIH0KCiAgICAgICAgLmVuZ2FnZW1lbnQtYmFkZ2UgewogICAgICAgICAgICBwYWRkaW5nOiA2cHggMTJweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMjBweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgIH0KCiAgICAgICAgLmJhZGdlLWNyaXRpY2FsIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2Y1NjU2NTsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgIH0KCiAgICAgICAgLmJhZGdlLWhpZ2ggewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZWQ4OTM2OwogICAgICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgfQoKICAgICAgICAuYmFkZ2UtbWVkaXVtIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzQyOTllMTsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgIH0KCiAgICAgICAgLmJhZGdlLWxvdyB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNhMGFlYzA7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICB9CgogICAgICAgIC5iYWRnZS1ub3QtYWNjZXB0ZWQgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjNzE4MDk2OwogICAgICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgfQoKICAgICAgICAuaG9tZWJlYXQtc3RhdHMgewogICAgICAgICAgICBkaXNwbGF5OiBncmlkOwogICAgICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdChhdXRvLWZpdCwgbWlubWF4KDE1MHB4LCAxZnIpKTsKICAgICAgICAgICAgZ2FwOiAxMHB4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgICAgIH0KCiAgICAgICAgLnN0YXQtaXRlbSB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTNweDsKICAgICAgICAgICAgY29sb3I6ICM0YTU1Njg7CiAgICAgICAgfQoKICAgICAgICAuc3RhdC1sYWJlbCB7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGNvbG9yOiAjNzE4MDk2OwogICAgICAgIH0KCiAgICAgICAgLmFjdGlvbi1jYXJkIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2ZmZjVmNTsKICAgICAgICAgICAgYm9yZGVyLWxlZnQ6IDRweCBzb2xpZCAjZjU2NTY1OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDIwcHg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDIwcHg7CiAgICAgICAgfQoKICAgICAgICAuYWN0aW9uLWNhcmQuaG90IHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2ZmZmFmMDsKICAgICAgICAgICAgYm9yZGVyLWxlZnQtY29sb3I6ICNlZDg5MzY7CiAgICAgICAgfQoKICAgICAgICAuYWN0aW9uLWNhcmQud2FybSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNlYmY4ZmY7CiAgICAgICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiAjNDI5OWUxOwogICAgICAgIH0KCiAgICAgICAgLmFjdGlvbi1oZWFkZXIgewogICAgICAgICAgICBmb250LXNpemU6IDE2cHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGdhcDogMTBweDsKICAgICAgICB9CgogICAgICAgIC5hY3Rpb24tY29udGVudCB7CiAgICAgICAgICAgIG1hcmdpbjogMTVweCAwOwogICAgICAgICAgICBwYWRkaW5nOiAxNXB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgIH0KCiAgICAgICAgLnNjcmlwdC1ib3ggewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjdmYWZjOwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjZTJlOGYwOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDE1cHg7CiAgICAgICAgICAgIGZvbnQtc3R5bGU6IGl0YWxpYzsKICAgICAgICAgICAgY29sb3I6ICM0YTU1Njg7CiAgICAgICAgICAgIG1hcmdpbjogMTVweCAwOwogICAgICAgIH0KCiAgICAgICAgLmxvYWRpbmcgewogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgIHBhZGRpbmc6IDQwcHg7CiAgICAgICAgICAgIGNvbG9yOiAjNzE4MDk2OwogICAgICAgIH0KCiAgICAgICAgLnNwaW5uZXIgewogICAgICAgICAgICBib3JkZXI6IDRweCBzb2xpZCAjZTJlOGYwOwogICAgICAgICAgICBib3JkZXItdG9wOiA0cHggc29saWQgIzY2N2VlYTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICB3aWR0aDogNDBweDsKICAgICAgICAgICAgaGVpZ2h0OiA0MHB4OwogICAgICAgICAgICBhbmltYXRpb246IHNwaW4gMXMgbGluZWFyIGluZmluaXRlOwogICAgICAgICAgICBtYXJnaW46IDAgYXV0byAyMHB4OwogICAgICAgIH0KCiAgICAgICAgQGtleWZyYW1lcyBzcGluIHsKICAgICAgICAgICAgMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsgfQogICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMzYwZGVnKTsgfQogICAgICAgIH0KCiAgICAgICAgLmVycm9yIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2ZmZjVmNTsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgI2ZjODE4MTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBwYWRkaW5nOiAxNXB4OwogICAgICAgICAgICBjb2xvcjogI2M1MzAzMDsKICAgICAgICAgICAgbWFyZ2luOiAyMHB4IDA7CiAgICAgICAgfQoKICAgICAgICAuc3VjY2VzcyB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmMGZmZjQ7CiAgICAgICAgICAgIGJvcmRlcjogMnB4IHNvbGlkICM2OGQzOTE7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgcGFkZGluZzogMTVweDsKICAgICAgICAgICAgY29sb3I6ICMyMjU0M2Q7CiAgICAgICAgICAgIG1hcmdpbjogMjBweCAwOwogICAgICAgIH0KCiAgICAgICAgLmNvbGxhcHNpYmxlIHsKICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICAgICAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgICAgICB9CgogICAgICAgIC5jb2xsYXBzaWJsZTo6YmVmb3JlIHsKICAgICAgICAgICAgY29udGVudDogJ+KWvCAnOwogICAgICAgICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICAgICAgICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjNzIGVhc2U7CiAgICAgICAgfQoKICAgICAgICAuY29sbGFwc2libGUuY29sbGFwc2VkOjpiZWZvcmUgewogICAgICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgtOTBkZWcpOwogICAgICAgIH0KCiAgICAgICAgLmNvbGxhcHNpYmxlLWNvbnRlbnQgewogICAgICAgICAgICBtYXgtaGVpZ2h0OiAxMDAwcHg7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgICAgIHRyYW5zaXRpb246IG1heC1oZWlnaHQgMC4zcyBlYXNlOwogICAgICAgIH0KCiAgICAgICAgLmNvbGxhcHNpYmxlLWNvbnRlbnQuaGlkZGVuIHsKICAgICAgICAgICAgbWF4LWhlaWdodDogMDsKICAgICAgICB9CgogICAgICAgIC5zdW1tYXJ5LWdyaWQgewogICAgICAgICAgICBkaXNwbGF5OiBncmlkOwogICAgICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdChhdXRvLWZpdCwgbWlubWF4KDIwMHB4LCAxZnIpKTsKICAgICAgICAgICAgZ2FwOiAxNXB4OwogICAgICAgICAgICBtYXJnaW46IDIwcHggMDsKICAgICAgICB9CgogICAgICAgIC5zdW1tYXJ5LWNhcmQgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjNjY3ZWVhIDAlLCAjNzY0YmEyIDEwMCUpOwogICAgICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgICAgIHBhZGRpbmc6IDIwcHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgIH0KCiAgICAgICAgLnN1bW1hcnktbnVtYmVyIHsKICAgICAgICAgICAgZm9udC1zaXplOiAzMnB4OwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiA1cHg7CiAgICAgICAgfQoKICAgICAgICAuc3VtbWFyeS1sYWJlbCB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICAgICAgb3BhY2l0eTogMC45OwogICAgICAgIH0KCiAgICAgICAgLnJlc2VuZC13YXJuaW5nIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2ZmZmFmMDsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgI2VkODkzNjsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBwYWRkaW5nOiAxMnB4IDE1cHg7CiAgICAgICAgICAgIG1hcmdpbjogMTBweCAwOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDEwcHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTNweDsKICAgICAgICAgICAgY29sb3I6ICM3NDQyMTA7CiAgICAgICAgfQoKICAgICAgICAucmVzZW5kLXdhcm5pbmc6OmJlZm9yZSB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICfimqDvuI8nOwogICAgICAgICAgICBmb250LXNpemU6IDE4cHg7CiAgICAgICAgfQogICAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICAgIDxkaXYgY2xhc3M9ImNvbnRhaW5lciI+CiAgICAgICAgPGRpdiBjbGFzcz0iaGVhZGVyIj4KICAgICAgICAgICAgPGgxPvCfjq8gV0lMTE9XIFY1MCAtIENNQSBXb3JrYmVuY2g8L2gxPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdWJ0aXRsZSI+SG9tZWJlYXQtQ2VudHJpYyBJbnRlbGxpZ2VuY2UgfCBMZWFkOiA8c3BhbiBpZD0ibGVhZE5hbWUiPkxvYWRpbmcuLi48L3NwYW4+PC9kaXY+CiAgICAgICAgPC9kaXY+CgogICAgICAgIDxkaXYgY2xhc3M9InRhYnMiPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIGFjdGl2ZSIgb25jbGljaz0ic3dpdGNoVGFiKCdjbWEtd29ya2JlbmNoJykiPgogICAgICAgICAgICAgICAg8J+TiiBDTUEgV29ya2JlbmNoCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIiBvbmNsaWNrPSJzd2l0Y2hUYWIoJ2hvbWViZWF0LW1hbmFnZXInKSI+CiAgICAgICAgICAgICAgICDwn4+gIEhvbWViZWF0IE1hbmFnZXIKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InRhYi1idXR0b24iIG9uY2xpY2s9InN3aXRjaFRhYignYWN0aW9uLXBsYW5uZXInKSI+CiAgICAgICAgICAgICAgICDimqEgQWN0aW9uIFBsYW5uZXIKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgPC9kaXY+CgogICAgICAgIDwhLS0gVEFCIDE6IENNQSBXT1JLQkVOQ0ggLS0+CiAgICAgICAgPGRpdiBpZD0iY21hLXdvcmtiZW5jaCIgY2xhc3M9InRhYi1jb250ZW50IGFjdGl2ZSI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24iPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi10aXRsZSI+8J+TiyBFeGlzdGluZyBDTUEgU3RhdHVzPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGlkPSJleGlzdGluZ0NNQSIgY2xhc3M9ImluZm8tY2FyZCI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNwaW5uZXIiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICBMb2FkaW5nIENNQSBkYXRhLi4uCiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUiPvCfmoAgR2VuZXJhdGUgTmV3IENNQTwvZGl2PgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4KICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwiPlByb3BlcnR5IEFkZHJlc3MgKjwvbGFiZWw+CiAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGlkPSJjbWFBZGRyZXNzIiBjbGFzcz0iZm9ybS1pbnB1dCIgcGxhY2Vob2xkZXI9IjEyMyBNYWluIFN0LCBQb3VnaGtlZXBzaWUsIE5ZIDEyNjAxIj4KICAgICAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImJ0bi1ncm91cCIgc3R5bGU9Im1hcmdpbi1ib3R0b206IDIwcHg7Ij4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biBidG4tc2Vjb25kYXJ5IiBpZD0iYXV0b0ZpbGxCdXR0b24iIG9uY2xpY2s9ImF1dG9GaWxsUHJvcGVydHlEYXRhKCkiIHN0eWxlPSJiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjMTBiOTgxIDAlLCAjMDU5NjY5IDEwMCUpOyBjb2xvcjogd2hpdGU7Ij4KICAgICAgICAgICAgICAgICAgICAgICAg8J+UjSBBdXRvLUZpbGwgUHJvcGVydHkgRGF0YSAoQVRUT00pCiAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iYXR0b21TcGlubmVyIiBjbGFzcz0ic3Bpbm5lciIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7IHdpZHRoOiAyMHB4OyBoZWlnaHQ6IDIwcHg7IG1hcmdpbi1sZWZ0OiAxMHB4OyI+PC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICA8ZGl2IGlkPSJhdXRvT3B0aW1pemVkUGFyYW1zIiBjbGFzcz0iaW5mby1jYXJkIj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLWNhcmQtdGl0bGUiPkF1dG8tT3B0aW1pemVkIFBhcmFtZXRlcnMgKEJhc2VkIG9uIEJlaGF2aW9yYWwgU2NvcmU6IDxzcGFuIGlkPSJiZWhhdmlvcmFsU2NvcmUiPi0tPC9zcGFuPik8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLWNhcmQtY29udGVudCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvcm0tcm93IiBzdHlsZT0ibWFyZ2luLXRvcDogMTVweDsiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwiPkJlZHM8L2xhYmVsPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJjbWFCZWRzIiBjbGFzcz0iZm9ybS1pbnB1dCIgdmFsdWU9IjMiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iZm9ybS1sYWJlbCI+QmF0aHM8L2xhYmVsPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJjbWFCYXRocyIgY2xhc3M9ImZvcm0taW5wdXQiIHZhbHVlPSIyIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwiPlNxRnQ8L2xhYmVsPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJjbWFTcWZ0IiBjbGFzcz0iZm9ybS1pbnB1dCIgdmFsdWU9IjIwMDAiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLXJvdyIgc3R5bGU9Im1hcmdpbi10b3A6IDE1cHg7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsIj5TZWFyY2ggUmFkaXVzIChtaSkg8J+kljwvbGFiZWw+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgc3RlcD0iMC4yNSIgaWQ9ImNtYVJhZGl1cyIgY2xhc3M9ImZvcm0taW5wdXQiIHZhbHVlPSIwLjc1IiByZWFkb25seT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c21hbGwgc3R5bGU9ImNvbG9yOiAjNzE4MDk2OyI+U2NvcmUtb3B0aW1pemVkPC9zbWFsbD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwiPk1vbnRocyBCYWNrIPCfpJY8L2xhYmVsPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJjbWFNb250aHNCYWNrIiBjbGFzcz0iZm9ybS1pbnB1dCIgdmFsdWU9IjkiIHJlYWRvbmx5PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzbWFsbCBzdHlsZT0iY29sb3I6ICM3MTgwOTY7Ij5TY29yZS1vcHRpbWl6ZWQ8L3NtYWxsPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iZm9ybS1sYWJlbCI+TWluIENvbXBhcmFibGVzPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0iY21hTWluTGlzdGluZ3MiIGNsYXNzPSJmb3JtLWlucHV0IiB2YWx1ZT0iMTAiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sbGFwc2libGUgY29sbGFwc2VkIiBvbmNsaWNrPSJ0b2dnbGVDb2xsYXBzaWJsZSh0aGlzKSI+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IGNvbG9yOiAjNjY3ZWVhOyI+RWRpdCBQYXJhbWV0ZXJzIE1hbnVhbGx5PC9zcGFuPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2xsYXBzaWJsZS1jb250ZW50IGhpZGRlbiI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1yb3ciIHN0eWxlPSJtYXJnaW4tdG9wOiAxNXB4OyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwiPlByb3BlcnR5IFR5cGU8L2xhYmVsPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNlbGVjdCBpZD0iY21hUHJvcFR5cGUiIGNsYXNzPSJmb3JtLXNlbGVjdCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj5Bbnk8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJSZXNpZGVudGlhbCI+UmVzaWRlbnRpYWw8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJSZXNpZGVudGlhbCBJbmNvbWUiPlJlc2lkZW50aWFsIEluY29tZTwvb3B0aW9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IkxhbmQiPkxhbmQ8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJNYW51ZmFjdHVyZWQgSW4gUGFyayI+TWFudWZhY3R1cmVkIEluIFBhcms8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iZm9ybS1sYWJlbCI+VmFyaWFuY2UgKCUpPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJjbWFWYXJpYW5jZSIgY2xhc3M9ImZvcm0taW5wdXQiIHZhbHVlPSIxMCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cCIgc3R5bGU9Im1hcmdpbi10b3A6IDIwcHg7Ij4KICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwiPkNNQSBUaXRsZSAoT3B0aW9uYWwpPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgaWQ9ImNtYVRpdGxlIiBjbGFzcz0iZm9ybS1pbnB1dCIgcGxhY2Vob2xkZXI9IkxlYXZlIGJsYW5rIHRvIGF1dG8tZ2VuZXJhdGUiPgogICAgICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2tib3gtZ3JvdXAiPgogICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9ImNyZWF0ZUhvbWViZWF0IiBjaGVja2VkPgogICAgICAgICAgICAgICAgICAgIDxsYWJlbCBmb3I9ImNyZWF0ZUhvbWViZWF0Ij5DcmVhdGUgSG9tZWJlYXQgd2l0aCB0aGlzIENNQTwvbGFiZWw+CiAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICA8ZGl2IGlkPSJob21lYmVhdE9wdGlvbnMiIGNsYXNzPSJmb3JtLWdyb3VwIj4KICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwiPkhvbWViZWF0IEZyZXF1ZW5jeTwvbGFiZWw+CiAgICAgICAgICAgICAgICAgICAgPHNlbGVjdCBpZD0iaG9tZWJlYXRGcmVxdWVuY3kiIGNsYXNzPSJmb3JtLXNlbGVjdCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9InF1YXJ0ZXJseSI+UXVhcnRlcmx5PC9vcHRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9Im1vbnRobHkiPk1vbnRobHk8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ic2VtaS1hbm51YWxseSI+U2VtaS1Bbm51YWxseTwvb3B0aW9uPgogICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJhbm51YWxseSI+QW5udWFsbHk8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+CiAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1wcmltYXJ5IiBvbmNsaWNrPSJnZW5lcmF0ZUNNQSgpIj4KICAgICAgICAgICAgICAgICAgICAgICAg8J+agCBHRU5FUkFURSBDTUEgJiBDUkVBVEUgSE9NRUJFQVQKICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImNtYVJlc3VsdCI+PC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgoKICAgICAgICA8IS0tIFRBQiAyOiBIT01FQkVBVCBNQU5BR0VSIC0tPgogICAgICAgIDxkaXYgaWQ9ImhvbWViZWF0LW1hbmFnZXIiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24iPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi10aXRsZSI+8J+PoCBBY3RpdmUgSG9tZWJlYXRzPC9kaXY+CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+CiAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1wcmltYXJ5IiBvbmNsaWNrPSJyZWZyZXNoSG9tZWJlYXRBbmFseXRpY3MoKSI+CiAgICAgICAgICAgICAgICAgICAgICAgIPCflIQgUmVmcmVzaCBBbmFseXRpY3MKICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImhvbWViZWF0TGlzdCIgY2xhc3M9ImxvYWRpbmciIHN0eWxlPSJtYXJnaW4tdG9wOiAyMHB4OyI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3Bpbm5lciI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgTG9hZGluZyBIb21lYmVhdCBkYXRhLi4uCiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUiPvCfk4ogRW5nYWdlbWVudCBTdW1tYXJ5PC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGlkPSJlbmdhZ2VtZW50U3VtbWFyeSIgY2xhc3M9InN1bW1hcnktZ3JpZCI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VtbWFyeS1jYXJkIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VtbWFyeS1udW1iZXIiIGlkPSJoaWdoRW5nYWdlbWVudENvdW50Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbGFiZWwiPkhpZ2ggRW5nYWdlbWVudCAoMjArIHZpZXdzKTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktY2FyZCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbnVtYmVyIiBpZD0ibWVkaXVtRW5nYWdlbWVudENvdW50Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbGFiZWwiPk1lZGl1bSBFbmdhZ2VtZW50ICg1LTE5IHZpZXdzKTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktY2FyZCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbnVtYmVyIiBpZD0ibG93RW5nYWdlbWVudENvdW50Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbGFiZWwiPkxvdyBFbmdhZ2VtZW50ICgxLTQgdmlld3MpPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VtbWFyeS1jYXJkIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VtbWFyeS1udW1iZXIiIGlkPSJub3RBY2NlcHRlZENvdW50Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1bW1hcnktbGFiZWwiPk5vdCBBY2NlcHRlZCAoMCB2aWV3cyk8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KCiAgICAgICAgPCEtLSBUQUIgMzogQUNUSU9OIFBMQU5ORVIgLS0+CiAgICAgICAgPGRpdiBpZD0iYWN0aW9uLXBsYW5uZXIiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24iPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi10aXRsZSI+4pqhIFRyaWdnZXJlZCBBY3Rpb25zIChCYXNlZCBvbiBFbmdhZ2VtZW50KTwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBpZD0idHJpZ2dlcmVkQWN0aW9ucyI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibG9hZGluZyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNwaW5uZXIiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICBBbmFseXppbmcgZW5nYWdlbWVudCBkYXRhLi4uCiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUiPvCfk50gTWFudWFsIEFjdGlvbiBDcmVhdGlvbjwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1yb3ciPgogICAgICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iZm9ybS1sYWJlbCI+QWN0aW9uIFR5cGU8L2xhYmVsPgogICAgICAgICAgICAgICAgICAgICAgICA8c2VsZWN0IGlkPSJhY3Rpb25UeXBlIiBjbGFzcz0iZm9ybS1zZWxlY3QiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iVGFzayI+VGFzazwvb3B0aW9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iQ2FsbCI+Q2FsbDwvb3B0aW9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iRW1haWwiPkVtYWlsPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJOb3RlIj5Ob3RlPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iZm9ybS1sYWJlbCI+QXNzaWduIFRvPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgICAgICAgPHNlbGVjdCBpZD0iYXNzaWduVG8iIGNsYXNzPSJmb3JtLXNlbGVjdCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJHbGVubiI+R2xlbm48L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9Ikp1c3RpbiI+SnVzdGluPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJIZWF0aGVyIj5IZWF0aGVyPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJMbG95ZCI+TGxveWQ8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsIj5VcmdlbmN5PC9sYWJlbD4KICAgICAgICAgICAgICAgICAgICAgICAgPHNlbGVjdCBpZD0idXJnZW5jeSIgY2xhc3M9ImZvcm0tc2VsZWN0Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IklNTUVESUFURSI+SW1tZWRpYXRlICgyNGgpPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJTQU1FX0RBWSI+U2FtZSBEYXk8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9Ik5FWFRfREFZIj5OZXh0IERheTwvb3B0aW9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iV0VFS0xZIj5UaGlzIFdlZWs8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAiIHN0eWxlPSJtYXJnaW4tdG9wOiAxNXB4OyI+CiAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsIj5Ob3RlczwvbGFiZWw+CiAgICAgICAgICAgICAgICAgICAgPHRleHRhcmVhIGlkPSJhY3Rpb25Ob3RlcyIgY2xhc3M9ImZvcm0taW5wdXQiIHJvd3M9IjMiIHBsYWNlaG9sZGVyPSJFbnRlciBhY3Rpb24gZGV0YWlscy4uLiI+PC90ZXh0YXJlYT4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1wcmltYXJ5IiBvbmNsaWNrPSJjcmVhdGVNYW51YWxBY3Rpb24oKSI+CiAgICAgICAgICAgICAgICAgICAg4pyFIENSRUFURSBBQ1RJT04gSU4gRlVCCiAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1hbnVhbEFjdGlvblJlc3VsdCI+PC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CgogICAgPHNjcmlwdD4KICAgICAgICAvLyBHbG9iYWwgc3RhdGUKICAgICAgICBjb25zdCBBUElfQkFTRV9VUkwgPSAnaHR0cHM6Ly93aWxsb3ctdjUwLXN1cGVydmlzZWQtY21hLm5ldGxpZnkuYXBwJzsKICAgICAgICBsZXQgcGVyc29uSWQgPSBudWxsOwogICAgICAgIGxldCBwZXJzb25EYXRhID0gbnVsbDsKICAgICAgICBsZXQgaG9tZWJlYXREYXRhID0gbnVsbDsKCiAgICAgICAgLy8gQVRUT00gSW50ZWdyYXRpb24gU3RhdGUKICAgICAgICBjb25zdCBBdHRvbVN0YXRlID0gewogICAgICAgICAgbG9hZGluZzogZmFsc2UsCiAgICAgICAgICBsYXN0TG9va3VwOiBudWxsLAogICAgICAgICAgY2FjaGVFbmFibGVkOiB0cnVlCiAgICAgICAgfTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBhcHAKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ/CfmoAgQXBwIGluaXRpYWxpemluZy4uLicpOwogICAgICAgICAgICBjb25zb2xlLmxvZygn8J+MkCBDdXJyZW50IFVSTDonLCB3aW5kb3cubG9jYXRpb24uaHJlZik7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCfwn5SNIFF1ZXJ5IHBhcmFtczonLCB3aW5kb3cubG9jYXRpb24uc2VhcmNoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1ldGhvZCAxOiBUcnkgdG8gZGVjb2RlIEZVQidzIGNvbnRleHQgcXVlcnkgcGFyYW1ldGVyCiAgICAgICAgICAgIGNvbnN0IHVybFBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCk7CiAgICAgICAgICAgIGNvbnN0IGNvbnRleHRQYXJhbSA9IHVybFBhcmFtcy5nZXQoJ2NvbnRleHQnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChjb250ZXh0UGFyYW0pIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ/Cfk6YgRm91bmQgY29udGV4dCBwYXJhbWV0ZXIsIGRlY29kaW5nLi4uJyk7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ/Cfk6YgUmF3IGNvbnRleHQgcGFyYW0gKGZpcnN0IDEwMCBjaGFycyk6JywgY29udGV4dFBhcmFtLnN1YnN0cmluZygwLCAxMDApKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb250ZXh0SnNvbiA9IGF0b2IoY29udGV4dFBhcmFtKTsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygn8J+TpiBEZWNvZGVkIEpTT04gc3RyaW5nOicsIGNvbnRleHRKc29uKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb250ZXh0ID0gSlNPTi5wYXJzZShjb250ZXh0SnNvbik7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ+KchSBQYXJzZWQgRlVCIGNvbnRleHQgb2JqZWN0OicsIEpTT04uc3RyaW5naWZ5KGNvbnRleHQsIG51bGwsIDIpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoY29udGV4dCAmJiBjb250ZXh0LnBlcnNvbiAmJiBjb250ZXh0LnBlcnNvbi5pZCkgewogICAgICAgICAgICAgICAgICAgICAgICBwZXJzb25JZCA9IGNvbnRleHQucGVyc29uLmlkOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygn4pyFIEdvdCBwZXJzb25faWQgZnJvbSBjb250ZXh0IHBhcmFtOicsIHBlcnNvbklkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2Fybign4pqg77iPIEZhaWxlZCB0byBkZWNvZGUgY29udGV4dCBwYXJhbWV0ZXI6JywgZXJyb3IpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNZXRob2QgMjogVHJ5IEZVQiBTREsgZ2V0Q29udGV4dCgpCiAgICAgICAgICAgIGlmICghcGVyc29uSWQgJiYgd2luZG93LkVtYmVkZGVkQXBwcykgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygn8J+UhCBUcnlpbmcgRW1iZWRkZWRBcHBzLmluaXQoKS4uLicpOwogICAgICAgICAgICAgICAgICAgIGF3YWl0IHdpbmRvdy5FbWJlZGRlZEFwcHMuaW5pdCgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCfinIUgRlVCIFNESyBpbml0aWFsaXplZCcpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRleHQgPSBhd2FpdCB3aW5kb3cuRW1iZWRkZWRBcHBzLmdldENvbnRleHQoKTsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygn8J+TpiBGVUIgU0RLIENvbnRleHQ6JywgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQgJiYgY29udGV4dC5wZXJzb24gJiYgY29udGV4dC5wZXJzb24uaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGVyc29uSWQgPSBjb250ZXh0LnBlcnNvbi5pZDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ+KchSBHb3QgcGVyc29uX2lkIGZyb20gU0RLIGNvbnRleHQ6JywgcGVyc29uSWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCfimqDvuI8gRlVCIFNESyBlcnJvcjonLCBlcnJvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1ldGhvZCAzOiBGYWxsYmFjayB0byBwZXJzb25faWQgVVJMIHBhcmFtZXRlcgogICAgICAgICAgICBpZiAoIXBlcnNvbklkKSB7CiAgICAgICAgICAgICAgICBwZXJzb25JZCA9IHVybFBhcmFtcy5nZXQoJ3BlcnNvbl9pZCcpOwogICAgICAgICAgICAgICAgaWYgKHBlcnNvbklkKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ+KaoO+4jyBVc2luZyBVUkwgcGVyc29uX2lkIChmYWxsYmFjayk6JywgcGVyc29uSWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXBlcnNvbklkKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgTm8gcGVyc29uX2lkIGZvdW5kIHZpYSBhbnkgbWV0aG9kJyk7CiAgICAgICAgICAgICAgICBzaG93RXJyb3IoJ05vIHBlcnNvbiBJRCBwcm92aWRlZC4gVHJpZWQ6IGNvbnRleHQgcGFyYW0sIFNESyBnZXRDb250ZXh0KCksIFVSTCBwYXJhbS4nKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc29sZS5sb2coJ/Cfjq8gRmluYWwgcGVyc29uX2lkOicsIHBlcnNvbklkKTsKICAgICAgICAgICAgY29uc29sZS5sb2coJ/Cfjq8gUGVyc29uX2lkIHR5cGU6JywgdHlwZW9mIHBlcnNvbklkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghcGVyc29uSWQpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ/CfkqUgQ1JJVElDQUw6IE5vIHBlcnNvbl9pZCBhZnRlciBhbGwgMyBtZXRob2RzIScpOwogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcign8J+SpSB3aW5kb3cubG9jYXRpb24uaHJlZjonLCB3aW5kb3cubG9jYXRpb24uaHJlZik7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCfwn5KlIHdpbmRvdy5FbWJlZGRlZEFwcHMgZXhpc3RzOicsICEhd2luZG93LkVtYmVkZGVkQXBwcyk7CiAgICAgICAgICAgICAgICBzaG93RXJyb3IoJ+KdjCBVbmFibGUgdG8gZGV0ZXJtaW5lIHBlcnNvbiBJRC4gQ2hlY2sgYnJvd3NlciBjb25zb2xlIGZvciBkZXRhaWxzLicpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhd2FpdCBsb2FkUGVyc29uRGF0YSgpOwogICAgICAgICAgICBhd2FpdCBsb2FkSG9tZWJlYXREYXRhKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIFRhYiBzd2l0Y2hpbmcKICAgICAgICBmdW5jdGlvbiBzd2l0Y2hUYWIodGFiSWQpIHsKICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRhYi1jb250ZW50JykuZm9yRWFjaCh0YWIgPT4gdGFiLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpKTsKICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRhYi1idXR0b24nKS5mb3JFYWNoKGJ0biA9PiBidG4uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJykpOwogICAgICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGFiSWQpLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICBldmVudC50YXJnZXQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CgogICAgICAgICAgICAvLyBSZWZyZXNoIGRhdGEgd2hlbiBzd2l0Y2hpbmcgdG8gc3BlY2lmaWMgdGFicwogICAgICAgICAgICBpZiAodGFiSWQgPT09ICdob21lYmVhdC1tYW5hZ2VyJykgewogICAgICAgICAgICAgICAgcmVmcmVzaEhvbWViZWF0QW5hbHl0aWNzKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGFiSWQgPT09ICdhY3Rpb24tcGxhbm5lcicpIHsKICAgICAgICAgICAgICAgIGdlbmVyYXRlVHJpZ2dlcmVkQWN0aW9ucygpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBUb2dnbGUgY29sbGFwc2libGUgc2VjdGlvbnMKICAgICAgICBmdW5jdGlvbiB0b2dnbGVDb2xsYXBzaWJsZShlbGVtZW50KSB7CiAgICAgICAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LnRvZ2dsZSgnY29sbGFwc2VkJyk7CiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZzsKICAgICAgICAgICAgY29udGVudC5jbGFzc0xpc3QudG9nZ2xlKCdoaWRkZW4nKTsKICAgICAgICB9CgogICAgICAgIC8vIExvYWQgcGVyc29uIGRhdGEgZnJvbSBGVUIKICAgICAgICBhc3luYyBmdW5jdGlvbiBsb2FkUGVyc29uRGF0YSgpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ/Cfk6EgbG9hZFBlcnNvbkRhdGEoKSBjYWxsZWQgd2l0aCBwZXJzb25faWQ6JywgcGVyc29uSWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmFsaWRhdGUgcGVyc29uSWQgYmVmb3JlIG1ha2luZyBBUEkgY2FsbAogICAgICAgICAgICBpZiAoIXBlcnNvbklkIHx8IHBlcnNvbklkID09PSAnbnVsbCcgfHwgcGVyc29uSWQgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgSW52YWxpZCBwZXJzb25faWQ6JywgcGVyc29uSWQpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4aXN0aW5nQ01BJykuaW5uZXJIVE1MID0gYAogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImVycm9yIj7inYwgSW52YWxpZCBwZXJzb24gSUQuIFVuYWJsZSB0byBsb2FkIGRhdGEuPC9kaXY+CiAgICAgICAgICAgICAgICBgOwogICAgICAgICAgICAgICAgc2hvd0Vycm9yKCdJbnZhbGlkIHBlcnNvbiBJRDogJyArIHBlcnNvbklkKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCfwn4yQIEZldGNoaW5nIHBlcnNvbiBkYXRhIGZyb20gQVBJLi4uJyk7CiAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke0FQSV9CQVNFX1VSTH0vLm5ldGxpZnkvZnVuY3Rpb25zL3dpbGxvdy1jbWEtd29ya2JlbmNoP2FjdGlvbj1nZXRQZXJzb25EYXRhJnBlcnNvbklkPSR7cGVyc29uSWR9YCk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygn8J+TpSBBUEkgcmVzcG9uc2Ugc3RhdHVzOicsIHJlc3BvbnNlLnN0YXR1cyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygn8J+TpiBBUEkgcmVzcG9uc2UgZGF0YTonLCBkYXRhKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRhdGEuZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgQVBJIHJldHVybmVkIGVycm9yOicsIGRhdGEuZXJyb3IpOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleGlzdGluZ0NNQScpLmlubmVySFRNTCA9IGAKICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZXJyb3IiPkVycm9yOiAke2RhdGEuZXJyb3J9PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgYDsKICAgICAgICAgICAgICAgICAgICBzaG93RXJyb3IoZGF0YS5lcnJvcik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHBlcnNvbkRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xlYWROYW1lJykudGV4dENvbnRlbnQgPSBkYXRhLm5hbWUgfHwgJ1Vua25vd24nOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgYmVoYXZpb3JhbCBzY29yZQogICAgICAgICAgICAgICAgY29uc3Qgc2NvcmUgPSBkYXRhLmN1c3RvbVdJTExPV0JlaGF2aW9yYWxTY29yZVY0MCB8fCA1MDsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdiZWhhdmlvcmFsU2NvcmUnKS50ZXh0Q29udGVudCA9IGAke3Njb3JlfS8xMDBgOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBQcmVwb3B1bGF0ZSBhZGRyZXNzIGZpZWxkIGZyb20gY3VzdG9tV0lMTE9XX1Byb3BlcnR5QWRkcmVzcwogICAgICAgICAgICAgICAgY29uc3QgcHJvcGVydHlBZGRyZXNzID0gZGF0YS5jdXN0b21XSUxMT1dfUHJvcGVydHlBZGRyZXNzIHx8ICcnOwogICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5QWRkcmVzcykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCfwn5ONIFByZXBvcHVsYXRpbmcgYWRkcmVzcyBmcm9tIEZVQjonLCBwcm9wZXJ0eUFkZHJlc3MpOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbWFBZGRyZXNzJykudmFsdWUgPSBwcm9wZXJ0eUFkZHJlc3M7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCfimqDvuI8gTm8gY3VzdG9tV0lMTE9XX1Byb3BlcnR5QWRkcmVzcyBmb3VuZCBpbiBGVUIgZGF0YScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBdXRvLW9wdGltaXplIHBhcmFtZXRlcnMgYmFzZWQgb24gc2NvcmUKICAgICAgICAgICAgICAgIG9wdGltaXplQ01BUGFyYW1ldGVycyhzY29yZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIERpc3BsYXkgZXhpc3RpbmcgQ01BIGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgZGlzcGxheUV4aXN0aW5nQ01BKGRhdGEpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCfwn5KlIEV4Y2VwdGlvbiBpbiBsb2FkUGVyc29uRGF0YSgpOicsIGVycm9yKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleGlzdGluZ0NNQScpLmlubmVySFRNTCA9IGAKICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJlcnJvciI+RmFpbGVkIHRvIGxvYWQgcGVyc29uIGRhdGE6ICR7ZXJyb3IubWVzc2FnZX08L2Rpdj4KICAgICAgICAgICAgICAgIGA7CiAgICAgICAgICAgICAgICBzaG93RXJyb3IoJ0ZhaWxlZCB0byBsb2FkIHBlcnNvbiBkYXRhOiAnICsgZXJyb3IubWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE9wdGltaXplIENNQSBwYXJhbWV0ZXJzIGJhc2VkIG9uIGJlaGF2aW9yYWwgc2NvcmUKICAgICAgICBmdW5jdGlvbiBvcHRpbWl6ZUNNQVBhcmFtZXRlcnMoc2NvcmUpIHsKICAgICAgICAgICAgbGV0IHJhZGl1cywgbW9udGhzQmFjazsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChzY29yZSA+PSA5MCkgewogICAgICAgICAgICAgICAgcmFkaXVzID0gMC4yNTsKICAgICAgICAgICAgICAgIG1vbnRoc0JhY2sgPSAzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNjb3JlID49IDc1KSB7CiAgICAgICAgICAgICAgICByYWRpdXMgPSAwLjU7CiAgICAgICAgICAgICAgICBtb250aHNCYWNrID0gNjsKICAgICAgICAgICAgfSBlbHNlIGlmIChzY29yZSA+PSA2MCkgewogICAgICAgICAgICAgICAgcmFkaXVzID0gMC43NTsKICAgICAgICAgICAgICAgIG1vbnRoc0JhY2sgPSA5OwogICAgICAgICAgICB9IGVsc2UgaWYgKHNjb3JlID49IDQwKSB7CiAgICAgICAgICAgICAgICByYWRpdXMgPSAxLjA7CiAgICAgICAgICAgICAgICBtb250aHNCYWNrID0gMTI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByYWRpdXMgPSAxLjU7CiAgICAgICAgICAgICAgICBtb250aHNCYWNrID0gMTg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbWFSYWRpdXMnKS52YWx1ZSA9IHJhZGl1czsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NtYU1vbnRoc0JhY2snKS52YWx1ZSA9IG1vbnRoc0JhY2s7CiAgICAgICAgfQoKICAgICAgICAvLyBEaXNwbGF5IGV4aXN0aW5nIENNQQogICAgICAgIGZ1bmN0aW9uIGRpc3BsYXlFeGlzdGluZ0NNQShkYXRhKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleGlzdGluZ0NNQScpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGRhdGEuY3VzdG9tV0lMTE9XQ01BRGF0ZSAmJiBkYXRhLmN1c3RvbVdJTExPV0NNQUxpbmspIHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaW5mby1jYXJkLXRpdGxlIj5MYXN0IENNQSBHZW5lcmF0ZWQ8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLWNhcmQtY29udGVudCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+PHN0cm9uZz5EYXRlOjwvc3Ryb25nPiAke25ldyBEYXRlKGRhdGEuY3VzdG9tV0lMTE9XQ01BRGF0ZSkudG9Mb2NhbGVEYXRlU3RyaW5nKCl9PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+PHN0cm9uZz5Qcm9wZXJ0eTo8L3N0cm9uZz4gJHtkYXRhLmN1c3RvbVdJTExPV0NNQUFkZHJlc3MgfHwgJ04vQSd9PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+PHN0cm9uZz5Fc3RpbWF0ZWQgVmFsdWU6PC9zdHJvbmc+ICR7ZGF0YS5jdXN0b21XSUxMT1dDZW50ZXJWYWx1ZSA/ICckJyArIHBhcnNlSW50KGRhdGEuY3VzdG9tV0lMTE9XQ2VudGVyVmFsdWUpLnRvTG9jYWxlU3RyaW5nKCkgOiAnTi9BJ308L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYnRuLWdyb3VwIiBzdHlsZT0ibWFyZ2luLXRvcDogMTVweDsiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zZWNvbmRhcnkiIG9uY2xpY2s9IndpbmRvdy5vcGVuKCcke2RhdGEuY3VzdG9tV0lMTE9XQ01BTGlua30nLCAnX2JsYW5rJykiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIPCfk4QgVmlldyBDTUEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zZWNvbmRhcnkiIG9uY2xpY2s9InJlZ2VuZXJhdGVDTUEoKSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg8J+UhCBSZWdlbmVyYXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICBgOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9IGAKICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLWNhcmQtdGl0bGUiPk5vIENNQSBHZW5lcmF0ZWQgWWV0PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaW5mby1jYXJkLWNvbnRlbnQiPkdlbmVyYXRlIHlvdXIgZmlyc3QgQ01BIGJlbG93IHRvIGdldCBzdGFydGVkLjwvZGl2PgogICAgICAgICAgICAgICAgYDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gR2VuZXJhdGUgQ01BCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVDTUEoKSB7CiAgICAgICAgICAgIGNvbnN0IGFkZHJlc3MgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY21hQWRkcmVzcycpLnZhbHVlLnRyaW0oKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghYWRkcmVzcykgewogICAgICAgICAgICAgICAgc2hvd0Vycm9yKCdQbGVhc2UgZW50ZXIgYSBwcm9wZXJ0eSBhZGRyZXNzJyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHJlc3VsdERpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbWFSZXN1bHQnKTsKICAgICAgICAgICAgcmVzdWx0RGl2LmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPSJsb2FkaW5nIj48ZGl2IGNsYXNzPSJzcGlubmVyIj48L2Rpdj5HZW5lcmF0aW5nIENNQSBhbmQgY3JlYXRpbmcgSG9tZWJlYXQuLi48L2Rpdj4nOwoKICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgYWN0aW9uOiAnZ2VuZXJhdGVDTUEnLAogICAgICAgICAgICAgICAgcGVyc29uSWQ6IHBlcnNvbklkLAogICAgICAgICAgICAgICAgYWRkcmVzczogYWRkcmVzcywKICAgICAgICAgICAgICAgIGJlZHM6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbWFCZWRzJykudmFsdWUsCiAgICAgICAgICAgICAgICBiYXRoczogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NtYUJhdGhzJykudmFsdWUsCiAgICAgICAgICAgICAgICBzcWZ0OiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY21hU3FmdCcpLnZhbHVlLAogICAgICAgICAgICAgICAgcmFkaXVzOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY21hUmFkaXVzJykudmFsdWUsCiAgICAgICAgICAgICAgICBtb250aHNCYWNrOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY21hTW9udGhzQmFjaycpLnZhbHVlLAogICAgICAgICAgICAgICAgbWluTGlzdGluZ3M6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbWFNaW5MaXN0aW5ncycpLnZhbHVlLAogICAgICAgICAgICAgICAgcHJvcFR5cGU6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbWFQcm9wVHlwZScpLnZhbHVlLAogICAgICAgICAgICAgICAgdGl0bGU6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbWFUaXRsZScpLnZhbHVlLAogICAgICAgICAgICAgICAgY3JlYXRlSG9tZWJlYXQ6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjcmVhdGVIb21lYmVhdCcpLmNoZWNrZWQsCiAgICAgICAgICAgICAgICBob21lYmVhdEZyZXF1ZW5jeTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hvbWViZWF0RnJlcXVlbmN5JykudmFsdWUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke0FQSV9CQVNFX1VSTH0vLm5ldGxpZnkvZnVuY3Rpb25zL3dpbGxvdy1jbWEtd29ya2JlbmNoYCwgewogICAgICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LAogICAgICAgICAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHBhcmFtcykKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7CgogICAgICAgICAgICAgICAgaWYgKGRhdGEuZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHREaXYuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9ImVycm9yIj7inYwgJHtkYXRhLmVycm9yfTwvZGl2PmA7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJlc3VsdERpdi5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3VjY2VzcyI+CiAgICAgICAgICAgICAgICAgICAgICAgIOKchSA8c3Ryb25nPkNNQSBHZW5lcmF0ZWQgU3VjY2Vzc2Z1bGx5ITwvc3Ryb25nPjxicj4KICAgICAgICAgICAgICAgICAgICAgICAgJHtkYXRhLmhvbWViZWF0Q3JlYXRlZCA/ICfinIUgSG9tZWJlYXQgc3Vic2NyaXB0aW9uIGNyZWF0ZWQnIDogJyd9PGJyPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiIHN0eWxlPSJtYXJnaW4tdG9wOiAxMHB4OyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNlY29uZGFyeSIgb25jbGljaz0id2luZG93Lm9wZW4oJyR7ZGF0YS5jbWFVcmx9JywgJ19ibGFuaycpIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICDwn5OEIFZpZXcgQ01BCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICR7ZGF0YS5ob21lYmVhdFVybCA/IGA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNlY29uZGFyeSIgb25jbGljaz0id2luZG93Lm9wZW4oJyR7ZGF0YS5ob21lYmVhdFVybH0nLCAnX2JsYW5rJykiPvCfj6AgVmlldyBIb21lYmVhdDwvYnV0dG9uPmAgOiAnJ30KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICBgOwoKICAgICAgICAgICAgICAgIC8vIFJlbG9hZCBwZXJzb24gZGF0YSB0byBzaG93IHVwZGF0ZWQgQ01BCiAgICAgICAgICAgICAgICBhd2FpdCBsb2FkUGVyc29uRGF0YSgpOwogICAgICAgICAgICAgICAgYXdhaXQgbG9hZEhvbWViZWF0RGF0YSgpOwoKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIHJlc3VsdERpdi5pbm5lckhUTUwgPSBgPGRpdiBjbGFzcz0iZXJyb3IiPuKdjCBGYWlsZWQgdG8gZ2VuZXJhdGUgQ01BOiAke2Vycm9yLm1lc3NhZ2V9PC9kaXY+YDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTG9hZCBIb21lYmVhdCBkYXRhCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gbG9hZEhvbWViZWF0RGF0YSgpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7QVBJX0JBU0VfVVJMfS8ubmV0bGlmeS9mdW5jdGlvbnMvd2lsbG93LWNtYS13b3JrYmVuY2g/YWN0aW9uPWdldEhvbWViZWF0RGF0YSZwZXJzb25JZD0ke3BlcnNvbklkfWApOwogICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsKCiAgICAgICAgICAgICAgICBpZiAoZGF0YS5lcnJvcikgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdob21lYmVhdExpc3QnKS5pbm5lckhUTUwgPSBgPGRpdiBjbGFzcz0iZXJyb3IiPiR7ZGF0YS5lcnJvcn08L2Rpdj5gOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBob21lYmVhdERhdGEgPSBkYXRhLmhvbWViZWF0cyB8fCBbXTsKICAgICAgICAgICAgICAgIGRpc3BsYXlIb21lYmVhdHMoaG9tZWJlYXREYXRhKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUVuZ2FnZW1lbnRTdW1tYXJ5KGhvbWViZWF0RGF0YSk7CgogICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hvbWViZWF0TGlzdCcpLmlubmVySFRNTCA9IGA8ZGl2IGNsYXNzPSJlcnJvciI+RmFpbGVkIHRvIGxvYWQgSG9tZWJlYXQgZGF0YTogJHtlcnJvci5tZXNzYWdlfTwvZGl2PmA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIERpc3BsYXkgSG9tZWJlYXRzCiAgICAgICAgZnVuY3Rpb24gZGlzcGxheUhvbWViZWF0cyhob21lYmVhdHMpIHsKICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hvbWViZWF0TGlzdCcpOwoKICAgICAgICAgICAgaWYgKCFob21lYmVhdHMgfHwgaG9tZWJlYXRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPSJpbmZvLWNhcmQiPjxkaXYgY2xhc3M9ImluZm8tY2FyZC10aXRsZSI+Tm8gSG9tZWJlYXRzIEZvdW5kPC9kaXY+PGRpdiBjbGFzcz0iaW5mby1jYXJkLWNvbnRlbnQiPkdlbmVyYXRlIGEgQ01BIHdpdGggSG9tZWJlYXQgc3Vic2NyaXB0aW9uIHRvIGdldCBzdGFydGVkLjwvZGl2PjwvZGl2Pic7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSBob21lYmVhdHMubWFwKGhiID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZpZXdzID0gaGIudG90YWxfdmlld3MgfHwgMDsKICAgICAgICAgICAgICAgIGNvbnN0IGRheXNTaW5jZUZpcnN0U2VuZCA9IGhiLmZpcnN0X3NlbmRfZGF0ZSA/IE1hdGguZmxvb3IoKERhdGUubm93KCkgLSBuZXcgRGF0ZShoYi5maXJzdF9zZW5kX2RhdGUpLmdldFRpbWUoKSkgLyAoMTAwMCAqIDYwICogNjAgKiAyNCkpIDogMDsKICAgICAgICAgICAgICAgIGNvbnN0IG5lZWRzUmVzZW5kID0gdmlld3MgPT09IDAgJiYgZGF5c1NpbmNlRmlyc3RTZW5kID49IDYwOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgZW5nYWdlbWVudENsYXNzLCBlbmdhZ2VtZW50QmFkZ2U7CiAgICAgICAgICAgICAgICBpZiAodmlld3MgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VtZW50Q2xhc3MgPSAnbm90LWFjY2VwdGVkJzsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VtZW50QmFkZ2UgPSAnPHNwYW4gY2xhc3M9ImVuZ2FnZW1lbnQtYmFkZ2UgYmFkZ2Utbm90LWFjY2VwdGVkIj5OT1QgQUNDRVBURUQ8L3NwYW4+JzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmlld3MgPj0gMjApIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VtZW50Q2xhc3MgPSAnaGlnaC1lbmdhZ2VtZW50JzsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VtZW50QmFkZ2UgPSAnPHNwYW4gY2xhc3M9ImVuZ2FnZW1lbnQtYmFkZ2UgYmFkZ2UtY3JpdGljYWwiPvCflKUgSElHSDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2aWV3cyA+PSA1KSB7CiAgICAgICAgICAgICAgICAgICAgZW5nYWdlbWVudENsYXNzID0gJ21lZGl1bS1lbmdhZ2VtZW50JzsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VtZW50QmFkZ2UgPSAnPHNwYW4gY2xhc3M9ImVuZ2FnZW1lbnQtYmFkZ2UgYmFkZ2UtaGlnaCI+4pqg77iPIE1FRElVTTwvc3Bhbj4nOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbmdhZ2VtZW50Q2xhc3MgPSAnbG93LWVuZ2FnZW1lbnQnOwogICAgICAgICAgICAgICAgICAgIGVuZ2FnZW1lbnRCYWRnZSA9ICc8c3BhbiBjbGFzcz0iZW5nYWdlbWVudC1iYWRnZSBiYWRnZS1tZWRpdW0iPvCfk4ogTE9XPC9zcGFuPic7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGAKICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJob21lYmVhdC1pdGVtICR7ZW5nYWdlbWVudENsYXNzfSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImhvbWViZWF0LWhlYWRlciI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJob21lYmVhdC10aXRsZSI+8J+PoCAke2hiLnByb3BlcnR5X2FkZHJlc3MgfHwgJ1Vua25vd24gQWRkcmVzcyd9PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAke2VuZ2FnZW1lbnRCYWRnZX0KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICR7bmVlZHNSZXNlbmQgPyBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyZXNlbmQtd2FybmluZyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSG9tZWJlYXQgbm90IGFjY2VwdGVkIGZvciAke2RheXNTaW5jZUZpcnN0U2VuZH0gZGF5cyAtIHJlc2VuZCByZWNvbW1lbmRlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIGAgOiAnJ30KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaG9tZWJlYXQtc3RhdHMiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdC1pdGVtIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic3RhdC1sYWJlbCI+VG90YWwgVmlld3M6PC9zcGFuPiAke3ZpZXdzfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0LWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJzdGF0LWxhYmVsIj5MYXN0IFZpZXc6PC9zcGFuPiAke2hiLmxhc3RfdmlldyA/IG5ldyBEYXRlKGhiLmxhc3RfdmlldykudG9Mb2NhbGVEYXRlU3RyaW5nKCkgOiAnTmV2ZXInfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0LWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJzdGF0LWxhYmVsIj5GcmVxdWVuY3k6PC9zcGFuPiAke2hiLmZyZXF1ZW5jeSB8fCAnTi9BJ30KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdC1pdGVtIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic3RhdC1sYWJlbCI+TmV4dCBSZXBvcnQ6PC9zcGFuPiAke2hiLm5leHRfcmVwb3J0ID8gbmV3IERhdGUoaGIubmV4dF9yZXBvcnQpLnRvTG9jYWxlRGF0ZVN0cmluZygpIDogJ04vQSd9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICR7ZGF5c1NpbmNlRmlyc3RTZW5kID4gMCA/IGAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0LWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic3RhdC1sYWJlbCI+RGF5cyBTaW5jZSBGaXJzdCBTZW5kOjwvc3Bhbj4gJHtkYXlzU2luY2VGaXJzdFNlbmR9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgIDogJyd9CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zZWNvbmRhcnkiIG9uY2xpY2s9IndpbmRvdy5vcGVuKCcke2hiLmhvbWViZWF0X3VybH0nLCAnX2JsYW5rJykiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIPCfkYHvuI8gVmlldyBIb21lYmVhdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAke3ZpZXdzID09PSAwIHx8IG5lZWRzUmVzZW5kID8gYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tcHJpbWFyeSIgb25jbGljaz0icmVzZW5kSG9tZWJlYXQoJyR7aGIuaWR9JykiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICDwn5OnIFJlc2VuZCBIb21lYmVhdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYCA6ICcnfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zZWNvbmRhcnkiIG9uY2xpY2s9ImVkaXRIb21lYmVhdCgnJHtoYi5pZH0nKSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg4pyP77iPIEVkaXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1kYW5nZXIiIG9uY2xpY2s9InVuc3Vic2NyaWJlSG9tZWJlYXQoJyR7aGIuaWR9JykiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIPCfmqsgVW5zdWJzY3JpYmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIGA7CiAgICAgICAgICAgIH0pLmpvaW4oJycpOwogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIGVuZ2FnZW1lbnQgc3VtbWFyeQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUVuZ2FnZW1lbnRTdW1tYXJ5KGhvbWViZWF0cykgewogICAgICAgICAgICBsZXQgaGlnaCA9IDAsIG1lZGl1bSA9IDAsIGxvdyA9IDAsIG5vdEFjY2VwdGVkID0gMDsKCiAgICAgICAgICAgIGhvbWViZWF0cy5mb3JFYWNoKGhiID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZpZXdzID0gaGIudG90YWxfdmlld3MgfHwgMDsKICAgICAgICAgICAgICAgIGlmICh2aWV3cyA9PT0gMCkgbm90QWNjZXB0ZWQrKzsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHZpZXdzID49IDIwKSBoaWdoKys7CiAgICAgICAgICAgICAgICBlbHNlIGlmICh2aWV3cyA+PSA1KSBtZWRpdW0rKzsKICAgICAgICAgICAgICAgIGVsc2UgbG93Kys7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpZ2hFbmdhZ2VtZW50Q291bnQnKS50ZXh0Q29udGVudCA9IGhpZ2g7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZWRpdW1FbmdhZ2VtZW50Q291bnQnKS50ZXh0Q29udGVudCA9IG1lZGl1bTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvd0VuZ2FnZW1lbnRDb3VudCcpLnRleHRDb250ZW50ID0gbG93OwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbm90QWNjZXB0ZWRDb3VudCcpLnRleHRDb250ZW50ID0gbm90QWNjZXB0ZWQ7CiAgICAgICAgfQoKICAgICAgICAvLyBSZWZyZXNoIEhvbWViZWF0IGFuYWx5dGljcwogICAgICAgIGFzeW5jIGZ1bmN0aW9uIHJlZnJlc2hIb21lYmVhdEFuYWx5dGljcygpIHsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hvbWViZWF0TGlzdCcpLmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPSJsb2FkaW5nIj48ZGl2IGNsYXNzPSJzcGlubmVyIj48L2Rpdj5SZWZyZXNoaW5nIGFuYWx5dGljcy4uLjwvZGl2Pic7CiAgICAgICAgICAgIGF3YWl0IGxvYWRIb21lYmVhdERhdGEoKTsKICAgICAgICB9CgogICAgICAgIC8vIFJlc2VuZCBIb21lYmVhdAogICAgICAgIGFzeW5jIGZ1bmN0aW9uIHJlc2VuZEhvbWViZWF0KGhvbWViZWF0SWQpIHsKICAgICAgICAgICAgaWYgKCFjb25maXJtKCdSZXNlbmQgdGhpcyBIb21lYmVhdCB0byB0aGUgbGVhZD8nKSkgcmV0dXJuOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7QVBJX0JBU0VfVVJMfS8ubmV0bGlmeS9mdW5jdGlvbnMvd2lsbG93LWNtYS13b3JrYmVuY2hgLCB7CiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0sCiAgICAgICAgICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdyZXNlbmRIb21lYmVhdCcsCiAgICAgICAgICAgICAgICAgICAgICAgIGhvbWViZWF0SWQ6IGhvbWViZWF0SWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHBlcnNvbklkOiBwZXJzb25JZAogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwoKICAgICAgICAgICAgICAgIGlmIChkYXRhLmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ0ZhaWxlZCB0byByZXNlbmQgSG9tZWJlYXQ6ICcgKyBkYXRhLmVycm9yKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYWxlcnQoJ+KchSBIb21lYmVhdCByZXNlbnQgc3VjY2Vzc2Z1bGx5IScpOwogICAgICAgICAgICAgICAgYXdhaXQgbG9hZEhvbWViZWF0RGF0YSgpOwoKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGFsZXJ0KCdGYWlsZWQgdG8gcmVzZW5kIEhvbWViZWF0OiAnICsgZXJyb3IubWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEdlbmVyYXRlIHRyaWdnZXJlZCBhY3Rpb25zCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVUcmlnZ2VyZWRBY3Rpb25zKCkgewogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHJpZ2dlcmVkQWN0aW9ucycpOwogICAgICAgICAgICBjb250YWluZXIuaW5uZXJIVE1MID0gJzxkaXYgY2xhc3M9ImxvYWRpbmciPjxkaXYgY2xhc3M9InNwaW5uZXIiPjwvZGl2PkFuYWx5emluZyBlbmdhZ2VtZW50IGRhdGEuLi48L2Rpdj4nOwoKICAgICAgICAgICAgaWYgKCFob21lYmVhdERhdGEgfHwgaG9tZWJlYXREYXRhLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPSJpbmZvLWNhcmQiPjxkaXYgY2xhc3M9ImluZm8tY2FyZC10aXRsZSI+Tm8gQWN0aW9ucyBUcmlnZ2VyZWQ8L2Rpdj48ZGl2IGNsYXNzPSJpbmZvLWNhcmQtY29udGVudCI+R2VuZXJhdGUgSG9tZWJlYXRzIGFuZCB0cmFjayBlbmdhZ2VtZW50IHRvIHNlZSB0cmlnZ2VyZWQgYWN0aW9ucyBoZXJlLjwvZGl2PjwvZGl2Pic7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGFjdGlvbnMgPSBbXTsKCiAgICAgICAgICAgIGhvbWViZWF0RGF0YS5mb3JFYWNoKGhiID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZpZXdzID0gaGIudG90YWxfdmlld3MgfHwgMDsKICAgICAgICAgICAgICAgIGNvbnN0IGRheXNTaW5jZUZpcnN0U2VuZCA9IGhiLmZpcnN0X3NlbmRfZGF0ZSA/IE1hdGguZmxvb3IoKERhdGUubm93KCkgLSBuZXcgRGF0ZShoYi5maXJzdF9zZW5kX2RhdGUpLmdldFRpbWUoKSkgLyAoMTAwMCAqIDYwICogNjAgKiAyNCkpIDogMDsKCiAgICAgICAgICAgICAgICBpZiAodmlld3MgPj0gMjApIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBwcmlvcml0eTogJ2NyaXRpY2FsJywKICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHk6IGhiLnByb3BlcnR5X2FkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgIHRyaWdnZXI6IGBIb21lYmVhdCB2aWV3cyAoJHt2aWV3c30pIGV4Y2VlZCBjcml0aWNhbCB0aHJlc2hvbGRgLAogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdTY2hlZHVsZSBsaXN0aW5nIHByZXNlbnRhdGlvbicsCiAgICAgICAgICAgICAgICAgICAgICAgIHVyZ2VuY3k6ICdJTU1FRElBVEUnLAogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQ6ICJJIG5vdGljZWQgeW91J3ZlIGJlZW4gbW9uaXRvcmluZyB5b3VyIGhvbWUgdmFsdWUgY2xvc2VseSB3aXRoIHRoZSBIb21lYmVhdCByZXBvcnRzLiBXaXRoICIgKyB2aWV3cyArICIgdmlld3MsIGl0J3MgY2xlYXIgeW91J3JlIHNlcmlvdXMgYWJvdXQgdW5kZXJzdGFuZGluZyB5b3VyIHByb3BlcnR5J3Mgd29ydGguIFRoZSBtYXJrZXQgaXMgbW92aW5nIGZhc3QgcmlnaHQgbm93IC0gbGV0J3MgZGlzY3VzcyB3aGF0IHRoaXMgbWVhbnMgZm9yIHlvdSBhbmQgeW91ciB0aW1lbGluZS4iCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZpZXdzID49IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6ICdob3QnLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eTogaGIucHJvcGVydHlfYWRkcmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgdHJpZ2dlcjogYEhvbWViZWF0IHZpZXdzICgke3ZpZXdzfSkgc2hvdyBzdHJvbmcgZW5nYWdlbWVudGAsCiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ0NhbGwgdG8gZGlzY3VzcyBtYXJrZXQgY2hhbmdlcycsCiAgICAgICAgICAgICAgICAgICAgICAgIHVyZ2VuY3k6ICdTQU1FX0RBWScsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdDogIkkgc2VlIHlvdSd2ZSBiZWVuIGtlZXBpbmcgYW4gZXllIG9uIHRoZSBtYXJrZXQgdGhyb3VnaCB5b3VyIEhvbWViZWF0IHJlcG9ydHMuIEFueSBxdWVzdGlvbnMgYWJvdXQgdGhlIHJlY2VudCBjaGFuZ2VzIG9yIGNvbXBhcmFibGUgc2FsZXMgaW4geW91ciBhcmVhPyIKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmlld3MgPj0gNSkgewogICAgICAgICAgICAgICAgICAgIGFjdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW9yaXR5OiAnd2FybScsCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5OiBoYi5wcm9wZXJ0eV9hZGRyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyOiBgSG9tZWJlYXQgdmlld3MgKCR7dmlld3N9KSBzaG93IG1vZGVyYXRlIGludGVyZXN0YCwKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAnRW1haWwgY2hlY2staW4gYWJvdXQgcHJvcGVydHkgdmFsdWUnLAogICAgICAgICAgICAgICAgICAgICAgICB1cmdlbmN5OiAnV0VFS0xZJywKICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0OiAiSnVzdCB3YW50ZWQgdG8gY2hlY2sgaW4gYWJvdXQgeW91ciBIb21lYmVhdCByZXBvcnRzLiBBcmUgeW91IGZpbmRpbmcgdGhlIG1hcmtldCB1cGRhdGVzIGhlbHBmdWw/IExldCBtZSBrbm93IGlmIHlvdSdkIGxpa2UgdG8gZGlzY3VzcyBhbnkgc3BlY2lmaWMgdHJlbmRzLiIKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmlld3MgPT09IDAgJiYgZGF5c1NpbmNlRmlyc3RTZW5kID49IDYwKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6ICd3YXJtJywKICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHk6IGhiLnByb3BlcnR5X2FkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgIHRyaWdnZXI6IGBIb21lYmVhdCBub3Qgb3BlbmVkIGZvciAke2RheXNTaW5jZUZpcnN0U2VuZH0gZGF5c2AsCiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ1JlLWVuZ2FnZSB3aXRoIHVwZGF0ZWQgSG9tZWJlYXQnLAogICAgICAgICAgICAgICAgICAgICAgICB1cmdlbmN5OiAnV0VFS0xZJywKICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0OiAiSSB3YW50ZWQgdG8gbWFrZSBzdXJlIHlvdSdyZSBzdGlsbCByZWNlaXZpbmcgeW91ciBIb21lYmVhdCBtYXJrZXQgdXBkYXRlcy4gV291bGQgeW91IGxpa2UgbWUgdG8gcmVzZW5kIHRoZSBsYXRlc3QgcmVwb3J0IG9yIGFkanVzdCB0aGUgZnJlcXVlbmN5PyIKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoYWN0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAnPGRpdiBjbGFzcz0iaW5mby1jYXJkIj48ZGl2IGNsYXNzPSJpbmZvLWNhcmQtdGl0bGUiPk5vIEFjdGlvbnMgVHJpZ2dlcmVkPC9kaXY+PGRpdiBjbGFzcz0iaW5mby1jYXJkLWNvbnRlbnQiPkNvbnRpbnVlIG1vbml0b3JpbmcgSG9tZWJlYXQgZW5nYWdlbWVudC4gQWN0aW9ucyB3aWxsIGFwcGVhciBoZXJlIHdoZW4gZW5nYWdlbWVudCB0aHJlc2hvbGRzIGFyZSBtZXQuPC9kaXY+PC9kaXY+JzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9IGFjdGlvbnMubWFwKGFjdGlvbiA9PiBgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhY3Rpb24tY2FyZCAke2FjdGlvbi5wcmlvcml0eX0iPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbi1oZWFkZXIiPgogICAgICAgICAgICAgICAgICAgICAgICAke2FjdGlvbi5wcmlvcml0eSA9PT0gJ2NyaXRpY2FsJyA/ICfwn5SlIENSSVRJQ0FMIEFDVElPTiBSRUNPTU1FTkRFRCcgOiBhY3Rpb24ucHJpb3JpdHkgPT09ICdob3QnID8gJ+KaoO+4jyBIT1QgQUNUSU9OIFNVR0dFU1RFRCcgOiAn8J+TiiBXQVJNIEFDVElPTiBTVUdHRVNURUQnfQogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbi1jb250ZW50Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj48c3Ryb25nPlByb3BlcnR5Ojwvc3Ryb25nPiAke2FjdGlvbi5wcm9wZXJ0eX08L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj48c3Ryb25nPlRyaWdnZXI6PC9zdHJvbmc+ICR7YWN0aW9uLnRyaWdnZXJ9PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+PHN0cm9uZz5TdWdnZXN0ZWQgQWN0aW9uOjwvc3Ryb25nPiAke2FjdGlvbi5hY3Rpb259PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+PHN0cm9uZz5VcmdlbmN5Ojwvc3Ryb25nPiAke2FjdGlvbi51cmdlbmN5fTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNjcmlwdC1ib3giPgogICAgICAgICAgICAgICAgICAgICAgICA8c3Ryb25nPlN1Z2dlc3RlZCBTY3JpcHQ6PC9zdHJvbmc+PGJyPgogICAgICAgICAgICAgICAgICAgICAgICAiJHthY3Rpb24uc2NyaXB0fSIKICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsIj5Bc3NpZ24gUGFydG5lcjwvbGFiZWw+CiAgICAgICAgICAgICAgICAgICAgICAgIDxzZWxlY3QgY2xhc3M9ImZvcm0tc2VsZWN0IiBpZD0icGFydG5lci0ke2FjdGlvbi5wcm9wZXJ0eX0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iR2xlbm4iPkdsZW5uPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJKdXN0aW4iPkp1c3Rpbjwvb3B0aW9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iSGVhdGhlciI+SGVhdGhlcjwvb3B0aW9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iTGxveWQiPkxsb3lkPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tcHJpbWFyeSIgb25jbGljaz0iY3JlYXRlVGFzaygnJHthY3Rpb24ucHJvcGVydHl9JywgJyR7YWN0aW9uLmFjdGlvbn0nLCAnJHthY3Rpb24udXJnZW5jeX0nKSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICDinIUgQ3JlYXRlIFRhc2sgaW4gRlVCCiAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNlY29uZGFyeSIgb25jbGljaz0iY3JlYXRlQ2FsbCgnJHthY3Rpb24ucHJvcGVydHl9JykiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAg8J+TniBMb2cgQ2FsbAogICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zZWNvbmRhcnkiIG9uY2xpY2s9ImNyZWF0ZUVtYWlsKCcke2FjdGlvbi5wcm9wZXJ0eX0nLCAnJHthY3Rpb24uc2NyaXB0fScpIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIPCfk6cgU2VuZCBFbWFpbAogICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICBgKS5qb2luKCcnKTsKICAgICAgICB9CgogICAgICAgIC8vIENyZWF0ZSB0YXNrIGluIEZVQgogICAgICAgIGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRhc2socHJvcGVydHksIGFjdGlvbiwgdXJnZW5jeSkgewogICAgICAgICAgICBjb25zdCBwYXJ0bmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYHBhcnRuZXItJHtwcm9wZXJ0eX1gKT8udmFsdWUgfHwgJ0dsZW5uJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke0FQSV9CQVNFX1VSTH0vLm5ldGxpZnkvZnVuY3Rpb25zL3dpbGxvdy1jbWEtd29ya2JlbmNoYCwgewogICAgICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LAogICAgICAgICAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAnY3JlYXRlVGFzaycsCiAgICAgICAgICAgICAgICAgICAgICAgIHBlcnNvbklkOiBwZXJzb25JZCwKICAgICAgICAgICAgICAgICAgICAgICAgdGFza0Rlc2NyaXB0aW9uOiBgJHthY3Rpb259IC0gUHJvcGVydHk6ICR7cHJvcGVydHl9YCwKICAgICAgICAgICAgICAgICAgICAgICAgdXJnZW5jeTogdXJnZW5jeSwKICAgICAgICAgICAgICAgICAgICAgICAgYXNzaWduZWRUbzogcGFydG5lcgogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwoKICAgICAgICAgICAgICAgIGlmIChkYXRhLmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ0ZhaWxlZCB0byBjcmVhdGUgdGFzazogJyArIGRhdGEuZXJyb3IpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBhbGVydChg4pyFIFRhc2sgY3JlYXRlZCBhbmQgYXNzaWduZWQgdG8gJHtwYXJ0bmVyfSFgKTsKCiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICBhbGVydCgnRmFpbGVkIHRvIGNyZWF0ZSB0YXNrOiAnICsgZXJyb3IubWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIENyZWF0ZSBtYW51YWwgYWN0aW9uCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gY3JlYXRlTWFudWFsQWN0aW9uKCkgewogICAgICAgICAgICBjb25zdCBhY3Rpb25UeXBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvblR5cGUnKS52YWx1ZTsKICAgICAgICAgICAgY29uc3QgYXNzaWduVG8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXNzaWduVG8nKS52YWx1ZTsKICAgICAgICAgICAgY29uc3QgdXJnZW5jeSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1cmdlbmN5JykudmFsdWU7CiAgICAgICAgICAgIGNvbnN0IG5vdGVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbk5vdGVzJykudmFsdWUudHJpbSgpOwoKICAgICAgICAgICAgaWYgKCFub3RlcykgewogICAgICAgICAgICAgICAgYWxlcnQoJ1BsZWFzZSBlbnRlciBhY3Rpb24gbm90ZXMnKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgcmVzdWx0RGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hbnVhbEFjdGlvblJlc3VsdCcpOwogICAgICAgICAgICByZXN1bHREaXYuaW5uZXJIVE1MID0gJzxkaXYgY2xhc3M9ImxvYWRpbmciPjxkaXYgY2xhc3M9InNwaW5uZXIiPjwvZGl2PkNyZWF0aW5nIGFjdGlvbi4uLjwvZGl2Pic7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHtBUElfQkFTRV9VUkx9Ly5uZXRsaWZ5L2Z1bmN0aW9ucy93aWxsb3ctY21hLXdvcmtiZW5jaGAsIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSwKICAgICAgICAgICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ2NyZWF0ZU1hbnVhbEFjdGlvbicsCiAgICAgICAgICAgICAgICAgICAgICAgIHBlcnNvbklkOiBwZXJzb25JZCwKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uVHlwZTogYWN0aW9uVHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgYXNzaWduZWRUbzogYXNzaWduVG8sCiAgICAgICAgICAgICAgICAgICAgICAgIHVyZ2VuY3k6IHVyZ2VuY3ksCiAgICAgICAgICAgICAgICAgICAgICAgIG5vdGVzOiBub3RlcwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwoKICAgICAgICAgICAgICAgIGlmIChkYXRhLmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0RGl2LmlubmVySFRNTCA9IGA8ZGl2IGNsYXNzPSJlcnJvciI+4p2MICR7ZGF0YS5lcnJvcn08L2Rpdj5gOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXN1bHREaXYuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9InN1Y2Nlc3MiPuKchSAke2FjdGlvblR5cGV9IGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5IGFuZCBhc3NpZ25lZCB0byAke2Fzc2lnblRvfSE8L2Rpdj5gOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbk5vdGVzJykudmFsdWUgPSAnJzsKCiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICByZXN1bHREaXYuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9ImVycm9yIj7inYwgRmFpbGVkIHRvIGNyZWF0ZSBhY3Rpb246ICR7ZXJyb3IubWVzc2FnZX08L2Rpdj5gOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBIZWxwZXIgZnVuY3Rpb25zCiAgICAgICAgZnVuY3Rpb24gc2hvd0Vycm9yKG1lc3NhZ2UpIHsKICAgICAgICAgICAgYWxlcnQoJ0Vycm9yOiAnICsgbWVzc2FnZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBFZGl0IEhvbWViZWF0IChwbGFjZWhvbGRlcikKICAgICAgICBmdW5jdGlvbiBlZGl0SG9tZWJlYXQoaG9tZWJlYXRJZCkgewogICAgICAgICAgICBhbGVydCgnRWRpdCBIb21lYmVhdCBmdW5jdGlvbmFsaXR5IGNvbWluZyBzb29uLiBIb21lYmVhdCBJRDogJyArIGhvbWViZWF0SWQpOwogICAgICAgIH0KCiAgICAgICAgLy8gVW5zdWJzY3JpYmUgSG9tZWJlYXQgKHBsYWNlaG9sZGVyKQogICAgICAgIGFzeW5jIGZ1bmN0aW9uIHVuc3Vic2NyaWJlSG9tZWJlYXQoaG9tZWJlYXRJZCkgewogICAgICAgICAgICBpZiAoIWNvbmZpcm0oJ0FyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byB1bnN1YnNjcmliZSB0aGlzIEhvbWViZWF0PycpKSByZXR1cm47CiAgICAgICAgICAgIGFsZXJ0KCdVbnN1YnNjcmliZSBmdW5jdGlvbmFsaXR5IGNvbWluZyBzb29uLiBIb21lYmVhdCBJRDogJyArIGhvbWViZWF0SWQpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ3JlYXRlIGNhbGwgKHBsYWNlaG9sZGVyKQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNhbGwocHJvcGVydHkpIHsKICAgICAgICAgICAgYWxlcnQoJ0NhbGwgbG9nZ2luZyBmdW5jdGlvbmFsaXR5IGNvbWluZyBzb29uIGZvciBwcm9wZXJ0eTogJyArIHByb3BlcnR5KTsKICAgICAgICB9CgogICAgICAgIC8vIENyZWF0ZSBlbWFpbCAocGxhY2Vob2xkZXIpCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRW1haWwocHJvcGVydHksIHNjcmlwdCkgewogICAgICAgICAgICBhbGVydCgnRW1haWwgY3JlYXRpb24gZnVuY3Rpb25hbGl0eSBjb21pbmcgc29vbiBmb3IgcHJvcGVydHk6ICcgKyBwcm9wZXJ0eSk7CiAgICAgICAgfQoKICAgICAgICAvLyBSZWdlbmVyYXRlIENNQSAocGxhY2Vob2xkZXIpCiAgICAgICAgZnVuY3Rpb24gcmVnZW5lcmF0ZUNNQSgpIHsKICAgICAgICAgICAgYWxlcnQoJ1JlZ2VuZXJhdGUgQ01BIGZ1bmN0aW9uYWxpdHkgY29taW5nIHNvb24uJyk7CiAgICAgICAgfQoKICAgICAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgICAgLy8gQVRUT00gREFUQSBJTlRFR1JBVElPTgogICAgICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiAgICAgICAgLyoqCiAgICAgICAgICogQXV0by1maWxsIHByb3BlcnR5IGRhdGEgZnJvbSBBVFRPTSBBUEkKICAgICAgICAgKi8KICAgICAgICBhc3luYyBmdW5jdGlvbiBhdXRvRmlsbFByb3BlcnR5RGF0YSgpIHsKICAgICAgICAgIGNvbnN0IGFkZHJlc3NJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbWFBZGRyZXNzJyk7CiAgICAgICAgICBjb25zdCBhZGRyZXNzID0gYWRkcmVzc0lucHV0Py52YWx1ZT8udHJpbSgpOwoKICAgICAgICAgIGlmICghYWRkcmVzcykgewogICAgICAgICAgICBzaG93QXR0b21Ob3RpZmljYXRpb24oJ1BsZWFzZSBlbnRlciBhIHByb3BlcnR5IGFkZHJlc3MgZmlyc3QnLCAnd2FybmluZycpOwogICAgICAgICAgICBhZGRyZXNzSW5wdXQ/LmZvY3VzKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBTaG93IGxvYWRpbmcgc3RhdGUKICAgICAgICAgIHNldEF0dG9tTG9hZGluZ1N0YXRlKHRydWUpOwogICAgICAgICAgc2hvd0F0dG9tTm90aWZpY2F0aW9uKCdMb29raW5nIHVwIHByb3BlcnR5IGRldGFpbHMgZnJvbSBBVFRPTSBEYXRhLi4uJywgJ2luZm8nKTsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBHZXQgcGVyc29uIElEIChhbHJlYWR5IGF2YWlsYWJsZSBmcm9tIHBhZ2UgY29udGV4dCkKICAgICAgICAgICAgY29uc3QgY29udGV4dFBlcnNvbklkID0gcGVyc29uSWQ7CgogICAgICAgICAgICAvLyBDYWxsIEFUVE9NIGxvb2t1cCBmdW5jdGlvbgogICAgICAgICAgICBjb25zdCBwYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHsKICAgICAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzLAogICAgICAgICAgICAgIC4uLihjb250ZXh0UGVyc29uSWQgJiYgeyBwZXJzb25JZDogY29udGV4dFBlcnNvbklkIH0pCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHtBUElfQkFTRV9VUkx9Ly5uZXRsaWZ5L2Z1bmN0aW9ucy9hdHRvbS1wcm9wZXJ0eS1sb29rdXA/JHtwYXJhbXN9YCk7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsKCiAgICAgICAgICAgIGlmICghcmVzcG9uc2Uub2spIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVzdWx0Lm1lc3NhZ2UgfHwgJ1Byb3BlcnR5IGxvb2t1cCBmYWlsZWQnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHJlc3VsdC5zdWNjZXNzICYmIHJlc3VsdC5kYXRhKSB7CiAgICAgICAgICAgICAgLy8gRmlsbCBmb3JtIGZpZWxkcyB3aXRoIEFUVE9NIGRhdGEKICAgICAgICAgICAgICBmaWxsUHJvcGVydHlGaWVsZHNGcm9tQXR0b20ocmVzdWx0LmRhdGEsIHJlc3VsdC5zb3VyY2UpOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgIC8vIFNob3cgc3VjY2VzcyBtZXNzYWdlCiAgICAgICAgICAgICAgY29uc3Qgc291cmNlTGFiZWwgPSByZXN1bHQuY2FjaGVkID8gJ2NhY2hlZCBkYXRhJyA6ICdBVFRPTSBEYXRhIEFQSSc7CiAgICAgICAgICAgICAgc2hvd0F0dG9tTm90aWZpY2F0aW9uKGDinJMgUHJvcGVydHkgZGF0YSBsb2FkZWQgZnJvbSAke3NvdXJjZUxhYmVsfWAsICdzdWNjZXNzJyk7CiAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgLy8gU3RvcmUgZm9yIHJlZmVyZW5jZQogICAgICAgICAgICAgIEF0dG9tU3RhdGUubGFzdExvb2t1cCA9IHsKICAgICAgICAgICAgICAgIGRhdGE6IHJlc3VsdC5kYXRhLAogICAgICAgICAgICAgICAgc291cmNlOiByZXN1bHQuc291cmNlLAogICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0FUVE9NIGxvb2t1cCBlcnJvcjonLCBlcnJvcik7CiAgICAgICAgICAgIHNob3dBdHRvbU5vdGlmaWNhdGlvbihgUHJvcGVydHkgbG9va3VwIGZhaWxlZDogJHtlcnJvci5tZXNzYWdlfS4gVHJ5IG1hbnVhbCBlbnRyeS5gLCAnZXJyb3InKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZhbGwgYmFjayB0byBzbWFydCBkZWZhdWx0cwogICAgICAgICAgICBpZiAoY29uZmlybSgnUHJvcGVydHkgbm90IGZvdW5kIGluIEFUVE9NIGRhdGFiYXNlLiBXb3VsZCB5b3UgbGlrZSB0byB1c2UgSHVkc29uIFZhbGxleSBtYXJrZXQgZGVmYXVsdHM/JykpIHsKICAgICAgICAgICAgICBmaWxsUHJvcGVydHlGaWVsZHNGcm9tQXR0b20oZ2V0SHVkc29uVmFsbGV5RGVmYXVsdHMoKSwgJ01BTlVBTF9ERUZBVUxUUycpOwogICAgICAgICAgICAgIHNob3dBdHRvbU5vdGlmaWNhdGlvbignVXNpbmcgSHVkc29uIFZhbGxleSBtYXJrZXQgZGVmYXVsdHMnLCAnd2FybmluZycpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRBdHRvbUxvYWRpbmdTdGF0ZShmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBGaWxsIGZvcm0gZmllbGRzIHdpdGggcHJvcGVydHkgZGF0YSBmcm9tIEFUVE9NCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZmlsbFByb3BlcnR5RmllbGRzRnJvbUF0dG9tKGRhdGEsIHNvdXJjZSkgewogICAgICAgICAgLy8gTWFwIEFUVE9NIGRhdGEgdG8gZXhpc3RpbmcgZm9ybSBmaWVsZCBJRHMKICAgICAgICAgIGNvbnN0IGZpZWxkTWFwcGluZ3MgPSB7CiAgICAgICAgICAgICdjbWFCZWRzJzogZGF0YS5iZWRzLAogICAgICAgICAgICAnY21hQmF0aHMnOiBkYXRhLmJhdGhzLAogICAgICAgICAgICAnY21hU3FmdCc6IGRhdGEuc3FmdCwKICAgICAgICAgICAgLy8gTm90ZTogTm8gYWNyZXMgb3IgZ2FyYWdlIGZpZWxkcyBpbiBjdXJyZW50IGZvcm0KICAgICAgICAgICAgLy8gTm90ZTogTm8gbG90U2l6ZSwgcHJvcGVydHlUeXBlLCB5ZWFyQnVpbHQsIGNvbmRpdGlvbiBmaWVsZHMgaW4gY3VycmVudCBmb3JtCiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIEZpbGwgYXZhaWxhYmxlIGZpZWxkcwogICAgICAgICAgT2JqZWN0LmVudHJpZXMoZmllbGRNYXBwaW5ncykuZm9yRWFjaCgoW2ZpZWxkSWQsIHZhbHVlXSkgPT4gewogICAgICAgICAgICBzZXRBdHRvbUZpZWxkVmFsdWUoZmllbGRJZCwgdmFsdWUpOwogICAgICAgICAgfSk7CgogICAgICAgICAgLy8gQWRkIGRhdGEgc291cmNlIGluZGljYXRvciB0byBmb3JtCiAgICAgICAgICBhZGRBdHRvbURhdGFTb3VyY2VJbmRpY2F0b3Ioc291cmNlKTsKICAgICAgICAgIAogICAgICAgICAgLy8gTG9nIHRoZSBmdWxsIGRhdGEgcmVjZWl2ZWQgZm9yIGRlYnVnZ2luZwogICAgICAgICAgY29uc29sZS5sb2coJ0FUVE9NIERhdGEgUmVjZWl2ZWQ6JywgZGF0YSk7CiAgICAgICAgICBjb25zb2xlLmxvZygnRmllbGRzIG5vdCBtYXBwZWQgKG5vIGZvcm0gZmllbGQgZXhpc3RzKTonLCB7CiAgICAgICAgICAgIGFjcmVzOiBkYXRhLmFjcmVzLAogICAgICAgICAgICBnYXJhZ2U6IGRhdGEuZ2FyYWdlLAogICAgICAgICAgICBwcm9wZXJ0eVR5cGU6IGRhdGEucHJvcGVydHlUeXBlLAogICAgICAgICAgICB5ZWFyQnVpbHQ6IGRhdGEueWVhckJ1aWx0LAogICAgICAgICAgICBjb25kaXRpb246IGRhdGEuY29uZGl0aW9uCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIFNldCBmaWVsZCB2YWx1ZSB3aXRoIHZhbGlkYXRpb24KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBzZXRBdHRvbUZpZWxkVmFsdWUoZmllbGRJZCwgdmFsdWUpIHsKICAgICAgICAgIGNvbnN0IGZpZWxkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZmllbGRJZCk7CiAgICAgICAgICBpZiAoZmllbGQgJiYgdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBmaWVsZC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICBmaWVsZC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAnI2YwZmRmNCc7IC8vIExpZ2h0IGdyZWVuIGJhY2tncm91bmQKICAgICAgICAgICAgZmllbGQuc3R5bGUuYm9yZGVyQ29sb3IgPSAnIzEwYjk4MSc7IC8vIEdyZWVuIGJvcmRlcgogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBjaGFuZ2UgZXZlbnQgZm9yIGFueSBsaXN0ZW5lcnMKICAgICAgICAgICAgZmllbGQuZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoJ2NoYW5nZScsIHsgYnViYmxlczogdHJ1ZSB9KSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBBZGQgdmlzdWFsIGluZGljYXRvciBzaG93aW5nIEFUVE9NIGRhdGEgd2FzIHVzZWQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhZGRBdHRvbURhdGFTb3VyY2VJbmRpY2F0b3Ioc291cmNlKSB7CiAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXV0b09wdGltaXplZFBhcmFtcycpOwogICAgICAgICAgCiAgICAgICAgICAvLyBSZW1vdmUgZXhpc3RpbmcgaW5kaWNhdG9yCiAgICAgICAgICBjb25zdCBleGlzdGluZ0luZGljYXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdHRvbVNvdXJjZUluZGljYXRvcicpOwogICAgICAgICAgaWYgKGV4aXN0aW5nSW5kaWNhdG9yKSBleGlzdGluZ0luZGljYXRvci5yZW1vdmUoKTsKCiAgICAgICAgICBjb25zdCBzb3VyY2VMYWJlbHMgPSB7CiAgICAgICAgICAgICdBVFRPTV9BUEknOiAn4pyTIERhdGEgZnJvbSBBVFRPTSBQcm9wZXJ0eSBEYXRhYmFzZScsCiAgICAgICAgICAgICdGVUJfQ0FDSEUnOiAn4pyTIERhdGEgZnJvbSBGb2xsb3cgVXAgQm9zcyBDYWNoZScsCiAgICAgICAgICAgICdNQU5VQUxfREVGQVVMVFMnOiAn4pqgIFVzaW5nIEh1ZHNvbiBWYWxsZXkgTWFya2V0IERlZmF1bHRzJwogICAgICAgICAgfTsKCiAgICAgICAgICBjb25zdCBzb3VyY2VDb2xvcnMgPSB7CiAgICAgICAgICAgICdBVFRPTV9BUEknOiAnIzEwYjk4MScsCiAgICAgICAgICAgICdGVUJfQ0FDSEUnOiAnIzNiODJmNicsCiAgICAgICAgICAgICdNQU5VQUxfREVGQVVMVFMnOiAnI2Y1OWUwYicKICAgICAgICAgIH07CgogICAgICAgICAgY29uc3QgaW5kaWNhdG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICBpbmRpY2F0b3IuaWQgPSAnYXR0b21Tb3VyY2VJbmRpY2F0b3InOwogICAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmNzc1RleHQgPSBgCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICR7c291cmNlQ29sb3JzW3NvdXJjZV0gfHwgJyMxMGI5ODEnfTsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgICAgICBwYWRkaW5nOiAxMHB4IDE1cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgbWFyZ2luLXRvcDogMTVweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxM3B4OwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICBgOwogICAgICAgICAgaW5kaWNhdG9yLnRleHRDb250ZW50ID0gc291cmNlTGFiZWxzW3NvdXJjZV0gfHwgc291cmNlOwogICAgICAgICAgCiAgICAgICAgICBjb250YWluZXI/LmFwcGVuZENoaWxkKGluZGljYXRvcik7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBIdWRzb24gVmFsbGV5IG1hcmtldCBkZWZhdWx0cwogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGdldEh1ZHNvblZhbGxleURlZmF1bHRzKCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgYmVkczogMywKICAgICAgICAgICAgYmF0aHM6IDIsCiAgICAgICAgICAgIHNxZnQ6IDE4MDAsCiAgICAgICAgICAgIGFjcmVzOiAwLjI1LAogICAgICAgICAgICBnYXJhZ2U6IDIsCiAgICAgICAgICAgIHByb3BlcnR5VHlwZTogJ1NpbmdsZSBGYW1pbHkgUmVzaWRlbnRpYWwnLAogICAgICAgICAgICB5ZWFyQnVpbHQ6IDE5ODUsCiAgICAgICAgICAgIGNvbmRpdGlvbjogJ0F2ZXJhZ2UnCiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogU2V0IGxvYWRpbmcgc3RhdGUgZm9yIEFUVE9NIGxvb2t1cAogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHNldEF0dG9tTG9hZGluZ1N0YXRlKGxvYWRpbmcpIHsKICAgICAgICAgIEF0dG9tU3RhdGUubG9hZGluZyA9IGxvYWRpbmc7CiAgICAgICAgICAKICAgICAgICAgIGNvbnN0IGxvb2t1cEJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdXRvRmlsbEJ1dHRvbicpOwogICAgICAgICAgaWYgKGxvb2t1cEJ1dHRvbikgewogICAgICAgICAgICBsb29rdXBCdXR0b24uZGlzYWJsZWQgPSBsb2FkaW5nOwogICAgICAgICAgICBsb29rdXBCdXR0b24uaW5uZXJIVE1MID0gbG9hZGluZyAKICAgICAgICAgICAgICA/ICfwn5SNIExvb2tpbmcgdXAuLi4gPGRpdiBjbGFzcz0ic3Bpbm5lciIgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2lkdGg6IDE2cHg7IGhlaWdodDogMTZweDsgbWFyZ2luLWxlZnQ6IDVweDsgYm9yZGVyLXdpZHRoOiAycHg7Ij48L2Rpdj4nIAogICAgICAgICAgICAgIDogJ/CflI0gQXV0by1GaWxsIFByb3BlcnR5IERhdGEgKEFUVE9NKSc7CiAgICAgICAgICAgIGxvb2t1cEJ1dHRvbi5zdHlsZS5vcGFjaXR5ID0gbG9hZGluZyA/ICcwLjYnIDogJzEnOwogICAgICAgICAgICBsb29rdXBCdXR0b24uc3R5bGUuY3Vyc29yID0gbG9hZGluZyA/ICdub3QtYWxsb3dlZCcgOiAncG9pbnRlcic7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBTaG93IG5vdGlmaWNhdGlvbiBtZXNzYWdlCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gc2hvd0F0dG9tTm90aWZpY2F0aW9uKG1lc3NhZ2UsIHR5cGUgPSAnaW5mbycpIHsKICAgICAgICAgIGxldCBub3RpZmljYXRpb24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXR0b21Ob3RpZmljYXRpb24nKTsKICAgICAgICAgIAogICAgICAgICAgaWYgKCFub3RpZmljYXRpb24pIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIG5vdGlmaWNhdGlvbiBlbGVtZW50CiAgICAgICAgICAgIG5vdGlmaWNhdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBub3RpZmljYXRpb24uaWQgPSAnYXR0b21Ob3RpZmljYXRpb24nOwogICAgICAgICAgICBub3RpZmljYXRpb24uc3R5bGUuY3NzVGV4dCA9IGAKICAgICAgICAgICAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICAgICAgICAgICAgdG9wOiAyMHB4OwogICAgICAgICAgICAgIHJpZ2h0OiAyMHB4OwogICAgICAgICAgICAgIG1heC13aWR0aDogNDAwcHg7CiAgICAgICAgICAgICAgcGFkZGluZzogMTVweCAyMHB4OwogICAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgICBib3gtc2hhZG93OiAwIDRweCAxMnB4IHJnYmEoMCwwLDAsMC4xNSk7CiAgICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgICAgei1pbmRleDogMTAwMDA7CiAgICAgICAgICAgICAgZGlzcGxheTogbm9uZTsKICAgICAgICAgICAgICBhbmltYXRpb246IHNsaWRlSW4gMC4zcyBlYXNlLW91dDsKICAgICAgICAgICAgYDsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChub3RpZmljYXRpb24pOwogICAgICAgICAgfQoKICAgICAgICAgIGNvbnN0IGNvbG9ycyA9IHsKICAgICAgICAgICAgaW5mbzogeyBiZzogJyMzYjgyZjYnLCB0ZXh0OiAnd2hpdGUnIH0sCiAgICAgICAgICAgIHN1Y2Nlc3M6IHsgYmc6ICcjMTBiOTgxJywgdGV4dDogJ3doaXRlJyB9LAogICAgICAgICAgICB3YXJuaW5nOiB7IGJnOiAnI2Y1OWUwYicsIHRleHQ6ICd3aGl0ZScgfSwKICAgICAgICAgICAgZXJyb3I6IHsgYmc6ICcjZWY0NDQ0JywgdGV4dDogJ3doaXRlJyB9CiAgICAgICAgICB9OwoKICAgICAgICAgIGNvbnN0IGNvbG9yID0gY29sb3JzW3R5cGVdIHx8IGNvbG9ycy5pbmZvOwogICAgICAgICAgbm90aWZpY2F0aW9uLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yLmJnOwogICAgICAgICAgbm90aWZpY2F0aW9uLnN0eWxlLmNvbG9yID0gY29sb3IudGV4dDsKICAgICAgICAgIG5vdGlmaWNhdGlvbi50ZXh0Q29udGVudCA9IG1lc3NhZ2U7CiAgICAgICAgICBub3RpZmljYXRpb24uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CgogICAgICAgICAgLy8gQXV0by1oaWRlIGFmdGVyIDUgc2Vjb25kcwogICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIG5vdGlmaWNhdGlvbi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgfSwgNTAwMCk7CiAgICAgICAgfQoKICAgICAgICAvLyBBZGQgc2xpZGUtaW4gYW5pbWF0aW9uCiAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgICAgIHN0eWxlLnRleHRDb250ZW50ID0gYAogICAgICAgICAgQGtleWZyYW1lcyBzbGlkZUluIHsKICAgICAgICAgICAgZnJvbSB7CiAgICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDQwMHB4KTsKICAgICAgICAgICAgICBvcGFjaXR5OiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRvIHsKICAgICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCk7CiAgICAgICAgICAgICAgb3BhY2l0eTogMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLmF1dG8tZmlsbGVkIHsKICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2YwZmRmNCAhaW1wb3J0YW50OwogICAgICAgICAgICBib3JkZXItY29sb3I6ICMxMGI5ODEgIWltcG9ydGFudDsKICAgICAgICAgIH0KICAgICAgICBgOwogICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPgo=';
            const html = Buffer.from(htmlBase64, 'base64').toString('utf8');
            
            return {
                statusCode: 200,
                headers: {
                    'Content-Type': 'text/html',
                    'Access-Control-Allow-Origin': '*'
                },
                body: html
            };
        }

        // Route to appropriate API handler
        switch (action) {
            case 'getPersonData':
                return await getPersonData(params.personId, headers);
            
            case 'generateCMA':
                return await generateCMA(params, headers);
            
            case 'getHomebeatData':
                return await getHomebeatData(params.personId, headers);
            
            case 'resendHomebeat':
                return await resendHomebeat(params, headers);
            
            case 'createTask':
                return await createTask(params, headers);
            
            case 'createManualAction':
                return await createManualAction(params, headers);
            
            default:
                return {
                    statusCode: 400,
                    headers,
                    body: JSON.stringify({ error: 'Invalid action' })
                };
        }

    } catch (error) {
        console.error('Function error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: error.message })
        };
    }
};

// Get person data from FUB
async function getPersonData(personId, headers) {
    try {
        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);
        
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify(personData)
        };
    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to fetch person data: ' + error.message })
        };
    }
}

// Generate CMA with CloudCMA API
async function generateCMA(params, headers) {
    try {
        const {
            personId,
            address,
            beds,
            baths,
            sqft,
            radius,
            monthsBack,
            minListings,
            propType,
            title,
            createHomebeat,
            homebeatFrequency
        } = params;

        // Get person data for lead info
        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);

        // Build CMA URL
        const cmaParams = new URLSearchParams({
            api_key: CLOUDCMA_API_KEY,
            address: address,
            beds: beds || '',
            baths: baths || '',
            sqft: sqft || '',
            radius: radius || '0.75',
            months_back: monthsBack || '9',
            min_listings: minListings || '10',
            prop_type: propType || '',
            title: title || `${personData.name || 'Client'} - ${address}`,
            callback_url: WEBHOOK_URL
        });

        const cmaUrl = `https://cloudcma.com/cmas/new?${cmaParams.toString()}`;

        // Update FUB custom fields
        const updatePayload = {
            customWILLOWCMADate: new Date().toISOString(),
            customWILLOWCMAAddress: address,
            customWILLOWCMALink: cmaUrl
        };

        await fubAPIRequest('PUT', `/v1/people/${personId}`, updatePayload);

        // Create FUB activity
        await fubAPIRequest('POST', '/v1/events', {
            person_id: parseInt(personId),
            type: 'Note',
            body: `CMA generated for ${address}. Parameters: ${beds}bd/${baths}ba, ${sqft}sqft, ${radius}mi radius, ${monthsBack}mo back.`
        });

        let homebeatUrl = null;
        let homebeatCreated = false;

        // Create Homebeat if requested
        if (createHomebeat === true || createHomebeat === 'true') {
            try {
                const homebeatPayload = {
                    automation: {
                        api_key: CLOUDCMA_API_KEY,
                        frequency: homebeatFrequency || 'quarterly',
                        welcome_email: 'true',
                        report: {
                            prop_type: propType || null,
                            callback_url: null
                        },
                        subject_property: {
                            address: address,
                            sqft: sqft || null,
                            beds: beds || null,
                            baths: baths || null
                        },
                        lead: {
                            name: personData.name || '',
                            email_address: personData.emails?.[0]?.value || '',
                            phone: personData.phones?.[0]?.value || ''
                        }
                    }
                };

                const homebeatResponse = await cloudCMAAPIRequest('POST', '/homebeats/widget', homebeatPayload);
                homebeatCreated = true;
                homebeatUrl = homebeatResponse.homebeat_url || null;

                // Update FUB with Homebeat info
                await fubAPIRequest('PUT', `/v1/people/${personId}`, {
                    customWILLOWCloudCMAHomeBeatURL: homebeatUrl,
                    customWILLOWHomebeatFirstSendDate: new Date().toISOString()
                });

                // Create FUB activity for Homebeat
                await fubAPIRequest('POST', '/v1/events', {
                    person_id: parseInt(personId),
                    type: 'Note',
                    body: `Homebeat subscription created for ${address}. Frequency: ${homebeatFrequency}. Lead will receive automated market updates.`
                });

            } catch (homebeatError) {
                console.error('Homebeat creation failed:', homebeatError);
            }
        }

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                success: true,
                cmaUrl: cmaUrl,
                homebeatCreated: homebeatCreated,
                homebeatUrl: homebeatUrl
            })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to generate CMA: ' + error.message })
        };
    }
}

// Get Homebeat data from CloudCMA
async function getHomebeatData(personId, headers) {
    try {
        // Try to fetch homebeat data, but gracefully handle CloudCMA auth failures
        let homebeatReport = [];
        try {
            homebeatReport = await cloudCMAAPIRequest('GET', `/homebeats/report?api_key=${CLOUDCMA_API_KEY}&format=json`);
        } catch (cloudCMAError) {
            console.warn('CloudCMA API unavailable:', cloudCMAError.message);
            // Return empty homebeats array instead of failing
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({ 
                    homebeats: [],
                    warning: 'CloudCMA API unavailable. Check API key configuration.'
                })
            };
        }

        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);
        const personEmail = personData.emails?.[0]?.value?.toLowerCase();

        if (!personEmail) {
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({ homebeats: [] })
            };
        }

        const leadHomebeats = (homebeatReport || []).filter(hb => 
            hb.lead_email?.toLowerCase() === personEmail
        );

        const enrichedHomebeats = leadHomebeats.map(hb => ({
            ...hb,
            first_send_date: personData.customWILLOWHomebeatFirstSendDate || hb.created_at,
            status: (hb.total_views || 0) === 0 ? 'pending' : 'active'
        }));

        if (enrichedHomebeats.length > 0) {
            const totalViews = enrichedHomebeats.reduce((sum, hb) => sum + (hb.total_views || 0), 0);
            const latestView = enrichedHomebeats
                .map(hb => hb.last_view)
                .filter(v => v)
                .sort()
                .reverse()[0];

            await fubAPIRequest('PUT', `/v1/people/${personId}`, {
                customWILLOWHomebeatViews: totalViews,
                customWILLOWHomebeatLastView: latestView || null
            });
        }

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ homebeats: enrichedHomebeats })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to fetch Homebeat data: ' + error.message })
        };
    }
}

// Resend Homebeat
async function resendHomebeat(params, headers) {
    try {
        const { homebeatId, personId } = params;

        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);
        
        const homebeatReport = await cloudCMAAPIRequest('GET', `/homebeats/report?api_key=${CLOUDCMA_API_KEY}&format=json`);
        const homebeat = (homebeatReport || []).find(hb => hb.id === homebeatId);

        if (!homebeat) {
            throw new Error('Homebeat not found');
        }

        const homebeatPayload = {
            automation: {
                api_key: CLOUDCMA_API_KEY,
                frequency: homebeat.frequency || 'quarterly',
                welcome_email: 'true',
                subject_property: {
                    address: homebeat.property_address,
                    sqft: homebeat.sqft || null,
                    beds: homebeat.beds || null,
                    baths: homebeat.baths || null
                },
                lead: {
                    name: personData.name || '',
                    email_address: personData.emails?.[0]?.value || '',
                    phone: personData.phones?.[0]?.value || ''
                }
            }
        };

        await cloudCMAAPIRequest('POST', '/homebeats/widget', homebeatPayload);

        await fubAPIRequest('PUT', `/v1/people/${personId}`, {
            customWILLOWHomebeatLastResend: new Date().toISOString()
        });

        await fubAPIRequest('POST', '/v1/events', {
            person_id: parseInt(personId),
            type: 'Note',
            body: `Homebeat resent for ${homebeat.property_address}. Status was pending (0 views). Manual resend triggered.`
        });

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ success: true })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to resend Homebeat: ' + error.message })
        };
    }
}

// Create task in FUB
async function createTask(params, headers) {
    try {
        const { personId, taskDescription, urgency, assignedTo } = params;

        const now = new Date();
        let dueDate = new Date(now);
        
        switch (urgency) {
            case 'IMMEDIATE':
                dueDate.setHours(now.getHours() + 24);
                break;
            case 'SAME_DAY':
                dueDate.setHours(23, 59, 59);
                break;
            case 'NEXT_DAY':
                dueDate.setDate(now.getDate() + 1);
                break;
            case 'WEEKLY':
                dueDate.setDate(now.getDate() + 7);
                break;
            default:
                dueDate.setDate(now.getDate() + 1);
        }

        // FUB tasks API doesn't accept description/body field
        // Task details should be added as a note after task creation
        const taskPayload = {
            personId: parseInt(personId),
            type: 'Follow Up',
            dueDate: dueDate.toISOString()
        };

        const taskResult = await fubAPIRequest('POST', '/v1/tasks', taskPayload);
        
        // Add task details as a note
        const notePayload = {
            personId: parseInt(personId),
            subject: `Task: ${taskDescription}`,
            body: `${taskDescription}\n\nAssigned to: ${assignedTo}\nUrgency: ${urgency}\nDue: ${dueDate.toLocaleDateString()}`,
            isHtml: false
        };
        await fubAPIRequest('POST', '/v1/notes', notePayload);

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ success: true })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to create task: ' + error.message })
        };
    }
}

// Create manual action in FUB
async function createManualAction(params, headers) {
    try {
        const { personId, actionType, assignedTo, urgency, notes } = params;

        const now = new Date();
        let dueDate = new Date(now);
        
        switch (urgency) {
            case 'IMMEDIATE':
                dueDate.setHours(now.getHours() + 24);
                break;
            case 'SAME_DAY':
                dueDate.setHours(23, 59, 59);
                break;
            case 'NEXT_DAY':
                dueDate.setDate(now.getDate() + 1);
                break;
            case 'WEEKLY':
                dueDate.setDate(now.getDate() + 7);
                break;
            default:
                dueDate.setDate(now.getDate() + 1);
        }

        // Map action types to FUB task types
        const taskTypeMap = {
            'Task': 'Follow Up',
            'Call': 'Call',
            'Email': 'Email',
            'Text': 'Text',
            'Note': 'Note'
        };
        
        const fubType = taskTypeMap[actionType] || 'Follow Up';
        
        // If it's a Note, use /v1/notes endpoint, otherwise use /v1/tasks
        if (actionType === 'Note') {
            const notePayload = {
                personId: parseInt(personId),
                subject: `${urgency} Action`,
                body: `${notes}\n\nAssigned to: ${assignedTo}`,
                isHtml: false
            };
            await fubAPIRequest('POST', '/v1/notes', notePayload);
        } else {
            // FUB tasks API doesn't accept description field
            const taskPayload = {
                personId: parseInt(personId),
                type: fubType,
                dueDate: dueDate.toISOString()
            };
            await fubAPIRequest('POST', '/v1/tasks', taskPayload);
            
            // Add action details as a note
            const notePayload = {
                personId: parseInt(personId),
                subject: `${fubType} Action`,
                body: `${notes}\n\nAssigned to: ${assignedTo}\nUrgency: ${urgency}`,
                isHtml: false
            };
            await fubAPIRequest('POST', '/v1/notes', notePayload);
        }

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ success: true })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to create action: ' + error.message })
        };
    }
}

// FUB API Request Helper
function fubAPIRequest(method, path, data = null) {
    return new Promise((resolve, reject) => {
        const options = {
            hostname: 'api.followupboss.com',
            port: 443,
            path: path,
            method: method,
            headers: {
                'Authorization': `Basic ${Buffer.from(FUB_API_KEY + ':').toString('base64')}`,
                'Content-Type': 'application/json'
            }
        };

        const req = https.request(options, (res) => {
            let body = '';
            res.on('data', (chunk) => body += chunk);
            res.on('end', () => {
                try {
                    const parsed = JSON.parse(body);
                    if (res.statusCode >= 200 && res.statusCode < 300) {
                        resolve(parsed);
                    } else {
                        reject(new Error(`FUB API error: ${res.statusCode} - ${body}`));
                    }
                } catch (e) {
                    reject(new Error(`Failed to parse FUB response: ${body}`));
                }
            });
        });

        req.on('error', reject);
        
        if (data) {
            req.write(JSON.stringify(data));
        }
        
        req.end();
    });
}

// CloudCMA API Request Helper
function cloudCMAAPIRequest(method, path, data = null) {
    return new Promise((resolve, reject) => {
        const options = {
            hostname: 'cloudcma.com',
            port: 443,
            path: path,
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        };

        const req = https.request(options, (res) => {
            let body = '';
            res.on('data', (chunk) => body += chunk);
            res.on('end', () => {
                try {
                    const parsed = body ? JSON.parse(body) : {};
                    if (res.statusCode >= 200 && res.statusCode < 300) {
                        resolve(parsed);
                    } else {
                        reject(new Error(`CloudCMA API error: ${res.statusCode} - ${body}`));
                    }
                } catch (e) {
                    if (res.statusCode >= 200 && res.statusCode < 300) {
                        resolve({});
                    } else {
                        reject(new Error(`Failed to parse CloudCMA response: ${body}`));
                    }
                }
            });
        });

        req.on('error', reject);
        
        if (data) {
            req.write(JSON.stringify(data));
        }
        
        req.end();
    });
}
