// WILLOW V50 CMA Workbench - Complete Netlify Function
// Purpose: Server-side FUB/CloudCMA API integration with HTML serving

const https = require('https');

// API Credentials
const FUB_API_KEY = process.env.FUB_API_KEY || 'fka_0oHt62NxmsExO6x69p08ix82zx8ii1hzrj';
const CLOUDCMA_API_KEY = process.env.CLOUDCMA_API_KEY || '742f4a46e1780904da090d721a9bae7b';
const WEBHOOK_URL = 'https://willow-v50-supervised-cma.netlify.app/.netlify/functions/cloudcma-webhook';

exports.handler = async (event, context) => {
    // CORS headers
    const headers = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Content-Type': 'application/json'
    };

    if (event.httpMethod === 'OPTIONS') {
        return { statusCode: 200, headers, body: '' };
    }

    try {
        // Parse request
        const params = event.httpMethod === 'GET' 
            ? event.queryStringParameters || {}
            : JSON.parse(event.body || '{}');

        const action = params.action;

        // If no action parameter, serve HTML interface (Base64 decoded)
        if (!action) {
            const htmlBase64 = 'PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgICA8dGl0bGU+Q01BIFdvcmtiZW5jaDwvdGl0bGU+CiAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJodHRwczovL2VpYS5mb2xsb3d1cGJvc3MuY29tL2VtYmVkZGVkQXBwcy12MS4wLjEuanMiPjwvc2NyaXB0PgogICAgPHN0eWxlPgogICAgICAgICogewogICAgICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgICAgIHBhZGRpbmc6IDA7CiAgICAgICAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICAgICAgfQoKICAgICAgICBib2R5IHsKICAgICAgICAgICAgZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgJ1NlZ29lIFVJJywgUm9ib3RvLCBzYW5zLXNlcmlmOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjNjY3ZWVhIDAlLCAjNzY0YmEyIDEwMCUpOwogICAgICAgICAgICBjb2xvcjogIzJkMzc0ODsKICAgICAgICAgICAgbGluZS1oZWlnaHQ6IDEuNDsKICAgICAgICAgICAgZm9udC1zaXplOiAxM3B4OwogICAgICAgIH0KCiAgICAgICAgLmNvbnRhaW5lciB7CiAgICAgICAgICAgIG1heC13aWR0aDogMTYwMHB4OwogICAgICAgICAgICBtYXJnaW46IDAgYXV0bzsKICAgICAgICAgICAgcGFkZGluZzogMTVweDsKICAgICAgICB9CgogICAgICAgIC5oZWFkZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBwYWRkaW5nOiAxNXB4IDIwcHg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMnB4IDRweCByZ2JhKDAsMCwwLDAuMSk7CiAgICAgICAgfQoKICAgICAgICAuaGVhZGVyIGgxIHsKICAgICAgICAgICAgZm9udC1zaXplOiAyMHB4OwogICAgICAgICAgICBjb2xvcjogIzY2N2VlYTsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogM3B4OwogICAgICAgIH0KCiAgICAgICAgLyogUE9XRVJFRCBCWSBGT09URVIgKi8KICAgICAgICAucG93ZXJlZC1ieSB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgICAgICAgYm90dG9tOiAxMHB4OwogICAgICAgICAgICByaWdodDogMTVweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxMHB4OwogICAgICAgICAgICBjb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjcpOwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICB6LWluZGV4OiAxMDAwOwogICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAxcHggMnB4IHJnYmEoMCwwLDAsMC4zKTsKICAgICAgICB9CgogICAgICAgIC8qIFRBQlMgKi8KICAgICAgICAudGFicyB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGdhcDogOHB4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgICAgIH0KCiAgICAgICAgLnRhYi1idXR0b24gewogICAgICAgICAgICBmbGV4OiAxOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgICAgICBwYWRkaW5nOiAxMnB4IDE2cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjNzIGVhc2U7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMnB4IDRweCByZ2JhKDAsMCwwLDAuMSk7CiAgICAgICAgICAgIGNvbG9yOiAjNGE1NTY4OwogICAgICAgIH0KCiAgICAgICAgLnRhYi1idXR0b246aG92ZXIgewogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTJweCk7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDhweCByZ2JhKDAsMCwwLDAuMTUpOwogICAgICAgIH0KCiAgICAgICAgLnRhYi1idXR0b24uYWN0aXZlIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgIzY2N2VlYSAwJSwgIzc2NGJhMiAxMDAlKTsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgIH0KCiAgICAgICAgLnRhYi1jb250ZW50IHsKICAgICAgICAgICAgZGlzcGxheTogbm9uZTsKICAgICAgICB9CgogICAgICAgIC50YWItY29udGVudC5hY3RpdmUgewogICAgICAgICAgICBkaXNwbGF5OiBibG9jazsKICAgICAgICB9CgogICAgICAgIC5oZWFkZXIgLnN1YnRpdGxlIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICAgICAgICBjb2xvcjogIzcxODA5NjsKICAgICAgICB9CgogICAgICAgIC53b3JrYmVuY2ggewogICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBwYWRkaW5nOiAyMHB4OwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjEpOwogICAgICAgIH0KCiAgICAgICAgLyogREVOU0UgR1JJRCBMQVlPVVQgLSBSRVNQT05TSVZFICovCiAgICAgICAgLnByb3BlcnR5LWdyaWQgewogICAgICAgICAgICBkaXNwbGF5OiBncmlkOwogICAgICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciAxZnI7CiAgICAgICAgICAgIGdhcDogMjBweDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgICAgICB9CgogICAgICAgIC8qIE1PQklMRSBSRVNQT05TSVZFIC0gVE9VQ0ggRlJJRU5ETFkgKi8KICAgICAgICBAbWVkaWEgKG1heC13aWR0aDogNzY4cHgpIHsKICAgICAgICAgICAgYm9keSB7CiAgICAgICAgICAgICAgICBmb250LXNpemU6IDE0cHg7CiAgICAgICAgICAgICAgICAvKiBBbGxvdyB6b29tIGJ1dCBwcmV2ZW50IGRvdWJsZS10YXAgem9vbSAqLwogICAgICAgICAgICAgICAgdG91Y2gtYWN0aW9uOiBtYW5pcHVsYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC5wcm9wZXJ0eS1ncmlkIHsKICAgICAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyOwogICAgICAgICAgICAgICAgZ2FwOiAxNXB4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAuY2hhci1ncmlkIHsKICAgICAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDIsIDFmcikgIWltcG9ydGFudDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLmZvcm0tY29tcGFjdCB7CiAgICAgICAgICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciAhaW1wb3J0YW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAuY29udGFpbmVyIHsKICAgICAgICAgICAgICAgIHBhZGRpbmc6IDEwcHg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC53b3JrYmVuY2ggewogICAgICAgICAgICAgICAgcGFkZGluZzogMTVweDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLnZhbHVlLWNvbnRyb2wgewogICAgICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnIgIWltcG9ydGFudDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLnRhYi1idXR0b24gewogICAgICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICAgICAgICAgICAgcGFkZGluZzogMTBweCAxMnB4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvKiBMYXJnZXIgdG91Y2ggdGFyZ2V0cyBvbiBtb2JpbGUgKi8KICAgICAgICAgICAgLmJ0biB7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiAxMnB4IDI0cHg7CiAgICAgICAgICAgICAgICBmb250LXNpemU6IDE1cHg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC5mb3JtLWlucHV0LWNvbXBhY3QsCiAgICAgICAgICAgIC5mb3JtLXNlbGVjdC1jb21wYWN0LAogICAgICAgICAgICAudmFsdWUtaW5wdXQgewogICAgICAgICAgICAgICAgcGFkZGluZzogMTBweCAxMnB4OwogICAgICAgICAgICAgICAgZm9udC1zaXplOiAxNnB4OyAvKiBQcmV2ZW50cyBpT1Mgem9vbSBvbiBmb2N1cyAqLwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAuc2VjdGlvbi1jb21wYWN0IHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2Y3ZmFmYzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICBwYWRkaW5nOiAxMnB4OwogICAgICAgIH0KCiAgICAgICAgLnNlY3Rpb24tdGl0bGUtY29tcGFjdCB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgY29sb3I6ICMyZDM3NDg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGdhcDogOHB4OwogICAgICAgICAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgI2UyZThmMDsKICAgICAgICAgICAgcGFkZGluZy1ib3R0b206IDZweDsKICAgICAgICB9CgogICAgICAgIC8qIEFWTSBDT05GSURFTkNFIEJBREdFICovCiAgICAgICAgLmF2bS1oZWFkZXIgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEycHg7CiAgICAgICAgfQoKICAgICAgICAuY29uZmlkZW5jZS1iYWRnZSB7CiAgICAgICAgICAgIHBhZGRpbmc6IDRweCAxMnB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTFweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDAuNXB4OwogICAgICAgIH0KCiAgICAgICAgLmNvbmZpZGVuY2UtSElHSCB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICM0OGJiNzg7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICB9CgogICAgICAgIC5jb25maWRlbmNlLU1FRElVTSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNlZDg5MzY7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICB9CgogICAgICAgIC5jb25maWRlbmNlLUxPVyB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmYzgxODE7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICB9CgogICAgICAgIC5jb25maWRlbmNlLVVOS05PV04gewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjYTBhZWMwOwogICAgICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgfQoKICAgICAgICAvKiBFRElUQUJMRSBDRU5URVIgVkFMVUUgKi8KICAgICAgICAudmFsdWUtY29udHJvbCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDFmcjsKICAgICAgICAgICAgZ2FwOiAxMHB4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgICAgIH0KCiAgICAgICAgLnZhbHVlLWlucHV0LWdyb3VwIHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgZ2FwOiA0cHg7CiAgICAgICAgfQoKICAgICAgICAudmFsdWUtaW5wdXQtbGFiZWwgewogICAgICAgICAgICBmb250LXNpemU6IDExcHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGNvbG9yOiAjNzE4MDk2OwogICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgIH0KCiAgICAgICAgLnZhbHVlLWlucHV0IHsKICAgICAgICAgICAgcGFkZGluZzogOHB4IDEycHg7CiAgICAgICAgICAgIGJvcmRlcjogMnB4IHNvbGlkICNlMmU4ZjA7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICBjb2xvcjogIzJkMzc0ODsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgfQoKICAgICAgICAudmFsdWUtaW5wdXQ6Zm9jdXMgewogICAgICAgICAgICBvdXRsaW5lOiBub25lOwogICAgICAgICAgICBib3JkZXItY29sb3I6ICM2NjdlZWE7CiAgICAgICAgfQoKICAgICAgICAudmFsdWUtaW5wdXQuc3VnZ2VzdGVkIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2YwZmZmNDsKICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiAjNDhiYjc4OwogICAgICAgIH0KCiAgICAgICAgLnZhbHVlLWlucHV0LnVzZXItb3ZlcnJpZGUgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmYWYwOwogICAgICAgICAgICBib3JkZXItY29sb3I6ICNlZDg5MzY7CiAgICAgICAgfQoKICAgICAgICAvKiBERU5TRSBEQVRBIFJPV1MgKi8KICAgICAgICAuZGF0YS1yb3cgewogICAgICAgICAgICBkaXNwbGF5OiBncmlkOwogICAgICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDEyMHB4IDFmcjsKICAgICAgICAgICAgZ2FwOiA4cHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDZweCAwOwogICAgICAgICAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgI2VkZjJmNzsKICAgICAgICB9CgogICAgICAgIC5kYXRhLXJvdzpsYXN0LWNoaWxkIHsKICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogbm9uZTsKICAgICAgICB9CgogICAgICAgIC5kYXRhLWxhYmVsIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxMXB4OwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICBjb2xvcjogIzcxODA5NjsKICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICB9CgogICAgICAgIC5kYXRhLXZhbHVlIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxM3B4OwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICBjb2xvcjogIzJkMzc0ODsKICAgICAgICB9CgogICAgICAgIC5kYXRhLXZhbHVlLmhpZ2hsaWdodCB7CiAgICAgICAgICAgIGNvbG9yOiAjNjY3ZWVhOwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgIH0KCiAgICAgICAgLmRhdGEtdmFsdWUud2FybmluZyB7CiAgICAgICAgICAgIGNvbG9yOiAjZWQ4OTM2OwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgIH0KCiAgICAgICAgLmRhdGEtdmFsdWUuZGFuZ2VyIHsKICAgICAgICAgICAgY29sb3I6ICNmYzgxODE7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgfQoKICAgICAgICAuZGF0YS12YWx1ZS5zdWNjZXNzIHsKICAgICAgICAgICAgY29sb3I6ICM0OGJiNzg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgfQoKICAgICAgICAvKiBDT01QQUNUIFBST1BFUlRZIENIQVJBQ1RFUklTVElDUyAqLwogICAgICAgIC5jaGFyLWdyaWQgewogICAgICAgICAgICBkaXNwbGF5OiBncmlkOwogICAgICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCg0LCAxZnIpOwogICAgICAgICAgICBnYXA6IDhweDsKICAgICAgICAgICAgbWFyZ2luOiAxMHB4IDA7CiAgICAgICAgfQoKICAgICAgICAuY2hhci1pdGVtIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNlMmU4ZjA7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgcGFkZGluZzogOHB4OwogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgfQoKICAgICAgICAuY2hhci12YWx1ZSB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTZweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgY29sb3I6ICMyZDM3NDg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDJweDsKICAgICAgICB9CgogICAgICAgIC5jaGFyLWxhYmVsIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxMHB4OwogICAgICAgICAgICBjb2xvcjogIzcxODA5NjsKICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICB9CgogICAgICAgIC8qIFNBTEVTIEhJU1RPUlkgVEFCTEUgKi8KICAgICAgICAuc2FsZXMtdGFibGUgewogICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICAgICAgICBib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOwogICAgICAgICAgICBtYXJnaW46IDEwcHggMDsKICAgICAgICB9CgogICAgICAgIC5zYWxlcy10YWJsZSB0aCB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNlZGYyZjc7CiAgICAgICAgICAgIHBhZGRpbmc6IDZweCA4cHg7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGxlZnQ7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTBweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgY29sb3I6ICM3MTgwOTY7CiAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjY2JkNWUwOwogICAgICAgIH0KCiAgICAgICAgLnNhbGVzLXRhYmxlIHRkIHsKICAgICAgICAgICAgcGFkZGluZzogNnB4IDhweDsKICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICNlZGYyZjc7CiAgICAgICAgfQoKICAgICAgICAvKiBSSVNLIEZMQUdTICovCiAgICAgICAgLnJpc2stZmxhZ3MgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBmbGV4LXdyYXA6IHdyYXA7CiAgICAgICAgICAgIGdhcDogNnB4OwogICAgICAgICAgICBtYXJnaW46IDEwcHggMDsKICAgICAgICB9CgogICAgICAgIC5yaXNrLWZsYWcgewogICAgICAgICAgICBwYWRkaW5nOiA0cHggMTBweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgICAgICBmb250LXNpemU6IDEwcHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgfQoKICAgICAgICAuZmxhZy1kYW5nZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmNWY1OwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjZmM4MTgxOwogICAgICAgICAgICBjb2xvcjogI2M1MzAzMDsKICAgICAgICB9CgogICAgICAgIC5mbGFnLXdhcm5pbmcgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmYWYwOwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjZWQ4OTM2OwogICAgICAgICAgICBjb2xvcjogIzc0NDIxMDsKICAgICAgICB9CgogICAgICAgIC5mbGFnLWluZm8gewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZWJmOGZmOwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjNDI5OWUxOwogICAgICAgICAgICBjb2xvcjogIzJjNTI4MjsKICAgICAgICB9CgogICAgICAgIC5mbGFnLXN1Y2Nlc3MgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjBmZmY0OwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjNDhiYjc4OwogICAgICAgICAgICBjb2xvcjogIzIyNTQzZDsKICAgICAgICB9CgogICAgICAgIC8qIEZPUk0gSU5QVVRTIC0gQ09NUEFDVCAqLwogICAgICAgIC5mb3JtLWNvbXBhY3QgewogICAgICAgICAgICBkaXNwbGF5OiBncmlkOwogICAgICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgyLCAxZnIpOwogICAgICAgICAgICBnYXA6IDEwcHg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgICAgfQoKICAgICAgICAuZm9ybS1ncm91cC1jb21wYWN0IHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgZ2FwOiA0cHg7CiAgICAgICAgfQoKICAgICAgICAuZm9ybS1sYWJlbC1jb21wYWN0IHsKICAgICAgICAgICAgZm9udC1zaXplOiAxMXB4OwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICBjb2xvcjogIzcxODA5NjsKICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICB9CgogICAgICAgIC5mb3JtLWlucHV0LWNvbXBhY3QgewogICAgICAgICAgICBwYWRkaW5nOiA4cHggMTBweDsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgI2UyZThmMDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICBmb250LXNpemU6IDEzcHg7CiAgICAgICAgfQoKICAgICAgICAuZm9ybS1pbnB1dC1jb21wYWN0OmZvY3VzIHsKICAgICAgICAgICAgb3V0bGluZTogbm9uZTsKICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiAjNjY3ZWVhOwogICAgICAgIH0KCiAgICAgICAgLmZvcm0tc2VsZWN0LWNvbXBhY3QgewogICAgICAgICAgICBwYWRkaW5nOiA4cHggMTBweDsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgI2UyZThmMDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICBmb250LXNpemU6IDEzcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgfQoKICAgICAgICAuYnRuIHsKICAgICAgICAgICAgcGFkZGluZzogMTBweCAyMHB4OwogICAgICAgICAgICBib3JkZXI6IG5vbmU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjNzIGVhc2U7CiAgICAgICAgfQoKICAgICAgICAuYnRuLXByaW1hcnkgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjNjY3ZWVhIDAlLCAjNzY0YmEyIDEwMCUpOwogICAgICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgfQoKICAgICAgICAuYnRuLXByaW1hcnk6aG92ZXIgewogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTJweCk7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDhweCByZ2JhKDEwMiwgMTI2LCAyMzQsIDAuMyk7CiAgICAgICAgfQoKICAgICAgICAuYnRuLXNlY29uZGFyeSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNlMmU4ZjA7CiAgICAgICAgICAgIGNvbG9yOiAjNGE1NTY4OwogICAgICAgIH0KCiAgICAgICAgLmJ0bi1zZWNvbmRhcnk6aG92ZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjY2JkNWUwOwogICAgICAgIH0KCiAgICAgICAgLmJ0bi1ncm91cCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGdhcDogMTBweDsKICAgICAgICAgICAgbWFyZ2luLXRvcDogMTVweDsKICAgICAgICB9CgogICAgICAgIC5sb2FkaW5nIHsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBwYWRkaW5nOiAzMHB4OwogICAgICAgICAgICBjb2xvcjogIzcxODA5NjsKICAgICAgICB9CgogICAgICAgIC5zcGlubmVyIHsKICAgICAgICAgICAgYm9yZGVyOiA0cHggc29saWQgI2UyZThmMDsKICAgICAgICAgICAgYm9yZGVyLXRvcDogNHB4IHNvbGlkICM2NjdlZWE7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICAgICAgd2lkdGg6IDMwcHg7CiAgICAgICAgICAgIGhlaWdodDogMzBweDsKICAgICAgICAgICAgYW5pbWF0aW9uOiBzcGluIDFzIGxpbmVhciBpbmZpbml0ZTsKICAgICAgICAgICAgbWFyZ2luOiAwIGF1dG8gMTVweDsKICAgICAgICB9CgogICAgICAgIEBrZXlmcmFtZXMgc3BpbiB7CiAgICAgICAgICAgIDAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0KICAgICAgICAgICAgMTAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0KICAgICAgICB9CgogICAgICAgIC5lcnJvciB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmZmY1ZjU7CiAgICAgICAgICAgIGJvcmRlcjogMnB4IHNvbGlkICNmYzgxODE7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgcGFkZGluZzogMTJweDsKICAgICAgICAgICAgY29sb3I6ICNjNTMwMzA7CiAgICAgICAgICAgIG1hcmdpbjogMTVweCAwOwogICAgICAgICAgICBmb250LXNpemU6IDEycHg7CiAgICAgICAgfQoKICAgICAgICAuc3VjY2VzcyB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmMGZmZjQ7CiAgICAgICAgICAgIGJvcmRlcjogMnB4IHNvbGlkICM2OGQzOTE7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgcGFkZGluZzogMTJweDsKICAgICAgICAgICAgY29sb3I6ICMyMjU0M2Q7CiAgICAgICAgICAgIG1hcmdpbjogMTVweCAwOwogICAgICAgICAgICBmb250LXNpemU6IDEycHg7CiAgICAgICAgfQoKICAgICAgICAvKiBDT0xMQVBTSUJMRSBTRUNUSU9OUyAqLwogICAgICAgIC5jb2xsYXBzaWJsZSB7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgdXNlci1zZWxlY3Q6IG5vbmU7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGdhcDogNnB4OwogICAgICAgIH0KCiAgICAgICAgLmNvbGxhcHNpYmxlOjpiZWZvcmUgewogICAgICAgICAgICBjb250ZW50OiAn4pa8JzsKICAgICAgICAgICAgZm9udC1zaXplOiAxMHB4OwogICAgICAgICAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4zcyBlYXNlOwogICAgICAgIH0KCiAgICAgICAgLmNvbGxhcHNpYmxlLmNvbGxhcHNlZDo6YmVmb3JlIHsKICAgICAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoLTkwZGVnKTsKICAgICAgICB9CgogICAgICAgIC5jb2xsYXBzaWJsZS1jb250ZW50IHsKICAgICAgICAgICAgbWF4LWhlaWdodDogMjAwMHB4OwogICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgICAgICB0cmFuc2l0aW9uOiBtYXgtaGVpZ2h0IDAuM3MgZWFzZTsKICAgICAgICB9CgogICAgICAgIC5jb2xsYXBzaWJsZS1jb250ZW50LmhpZGRlbiB7CiAgICAgICAgICAgIG1heC1oZWlnaHQ6IDA7CiAgICAgICAgfQoKICAgICAgICAvKiBUT09MVElQICovCiAgICAgICAgLnRvb2x0aXAgewogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgICAgIGN1cnNvcjogaGVscDsKICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogMXB4IGRhc2hlZCAjY2JkNWUwOwogICAgICAgIH0KCiAgICAgICAgLnRvb2x0aXA6aG92ZXI6OmFmdGVyIHsKICAgICAgICAgICAgY29udGVudDogYXR0cihkYXRhLXRvb2x0aXApOwogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIGJvdHRvbTogMTAwJTsKICAgICAgICAgICAgbGVmdDogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMyZDM3NDg7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICAgICAgcGFkZGluZzogNnB4IDEwcHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxMXB4OwogICAgICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgICAgICB6LWluZGV4OiAxMDAwOwogICAgICAgIH0KCiAgICAgICAgLyogSU5GTyBDQVJEICovCiAgICAgICAgLmluZm8tY2FyZCB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmN2ZhZmM7CiAgICAgICAgICAgIGJvcmRlci1sZWZ0OiA0cHggc29saWQgIzY2N2VlYTsKICAgICAgICAgICAgcGFkZGluZzogMTVweCAyMHB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgfQoKICAgICAgICAuaW5mby1jYXJkLXRpdGxlIHsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgY29sb3I6ICMyZDM3NDg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDhweDsKICAgICAgICB9CgogICAgICAgIC5pbmZvLWNhcmQtY29udGVudCB7CiAgICAgICAgICAgIGNvbG9yOiAjNzE4MDk2OwogICAgICAgICAgICBmb250LXNpemU6IDEzcHg7CiAgICAgICAgfQogICAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICAgIDxkaXYgY2xhc3M9ImNvbnRhaW5lciI+CiAgICAgICAgPGRpdiBjbGFzcz0iaGVhZGVyIj4KICAgICAgICAgICAgPGgxPvCfjq8gQ01BIFdvcmtiZW5jaDwvaDE+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1YnRpdGxlIj5BVFRPTSBJbnRlbGxpZ2VuY2UgfCBMZWFkOiA8c3BhbiBpZD0ibGVhZE5hbWUiPkxvYWRpbmcuLi48L3NwYW4+PC9kaXY+CiAgICAgICAgPC9kaXY+CgogICAgICAgIDwhLS0gVEFCUyAtLT4KICAgICAgICA8ZGl2IGNsYXNzPSJ0YWJzIj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0idGFiLWJ1dHRvbiBhY3RpdmUiIG9uY2xpY2s9InN3aXRjaFRhYigncHJvcGVydHktaW50ZWwnKSI+CiAgICAgICAgICAgICAgICDwn5OKIFByb3BlcnR5IEludGVsCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIiBvbmNsaWNrPSJzd2l0Y2hUYWIoJ2NtYS1nZW5lcmF0b3InKSI+CiAgICAgICAgICAgICAgICDwn4+gIENNQSBHZW5lcmF0b3IKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InRhYi1idXR0b24iIG9uY2xpY2s9InN3aXRjaFRhYignY29tcGFyYWJsZXMnKSI+CiAgICAgICAgICAgICAgICDwn5OIIENvbXBhcmFibGVzCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgIDwvZGl2PgoKICAgICAgICA8ZGl2IGNsYXNzPSJ3b3JrYmVuY2giPgogICAgICAgICAgICA8IS0tIFRBQiAxOiBQUk9QRVJUWSBJTlRFTCAtLT4KICAgICAgICAgICAgPGRpdiBpZD0icHJvcGVydHktaW50ZWwiIGNsYXNzPSJ0YWItY29udGVudCBhY3RpdmUiPgogICAgICAgICAgICA8IS0tIFNFQ1RJT04gMTogU1VCSkVDVCBQUk9QRVJUWSBBRERSRVNTIC0tPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi10aXRsZS1jb21wYWN0Ij7wn5ONIFN1YmplY3QgUHJvcGVydHkgQWRkcmVzczwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cC1jb21wYWN0IiBzdHlsZT0iZ3JpZC1jb2x1bW46IDEgLyAtMTsiPgogICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iZm9ybS1sYWJlbC1jb21wYWN0Ij5GdWxsIEFkZHJlc3MgKENpdHksIFN0YXRlLCBaSVAgcmVxdWlyZWQpPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQgCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9InRleHQiIAogICAgICAgICAgICAgICAgICAgICAgICBpZD0ic3ViamVjdEFkZHJlc3MiIAogICAgICAgICAgICAgICAgICAgICAgICBjbGFzcz0iZm9ybS1pbnB1dC1jb21wYWN0IiAKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9IjEyMyBNYWluIFN0LCBQb3VnaGtlZXBzaWUsIE5ZIDEyNjAxIgogICAgICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1wcmltYXJ5IiBvbmNsaWNrPSJsb2FkUHJvcGVydHlEYXRhKCkiIHN0eWxlPSJtYXJnaW4tdG9wOiAxMHB4OyI+CiAgICAgICAgICAgICAgICAgICAg8J+UjSBMb2FkIEFUVE9NIEludGVsbGlnZW5jZQogICAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPGRpdiBpZD0ibG9hZGluZ0luZGljYXRvciIgY2xhc3M9ImxvYWRpbmciIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzcGlubmVyIj48L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXY+TG9hZGluZyBjb21wbGV0ZSBwcm9wZXJ0eSBpbnRlbGxpZ2VuY2UgZnJvbSBBVFRPTS4uLjwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgIDxkaXYgaWQ9ImVycm9yTWVzc2FnZSIgY2xhc3M9ImVycm9yIiBzdHlsZT0iZGlzcGxheTogbm9uZTsiPjwvZGl2PgoKICAgICAgICAgICAgPCEtLSBQUk9QRVJUWSBJTlRFTExJR0VOQ0UgR1JJRCAoSGlkZGVuIHVudGlsIGRhdGEgbG9hZGVkKSAtLT4KICAgICAgICAgICAgPGRpdiBpZD0icHJvcGVydHlJbnRlbGxpZ2VuY2UiIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcm9wZXJ0eS1ncmlkIj4KICAgICAgICAgICAgICAgICAgICA8IS0tIExFRlQgQ09MVU1OOiBBVk0gJiBWQUxVQVRJT04gLS0+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi1jb21wYWN0Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYXZtLWhlYWRlciI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLXRpdGxlLWNvbXBhY3QiPvCfkrAgQXV0b21hdGVkIFZhbHVhdGlvbiBNb2RlbCAoQVZNKTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImF2bUNvbmZpZGVuY2VCYWRnZSIgY2xhc3M9ImNvbmZpZGVuY2UtYmFkZ2UgY29uZmlkZW5jZS1VTktOT1dOIj5VTktOT1dOPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICAgICAgICAgIDwhLS0gRURJVEFCTEUgQ0VOVEVSIFZBTFVFIC0tPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ2YWx1ZS1jb250cm9sIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InZhbHVlLWlucHV0LWdyb3VwIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9InZhbHVlLWlucHV0LWxhYmVsIj5BVFRPTSBTdWdnZXN0ZWQgVmFsdWU8L2xhYmVsPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT0idGV4dCIgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkPSJhdm1TdWdnZXN0ZWRWYWx1ZSIgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzPSJ2YWx1ZS1pbnB1dCBzdWdnZXN0ZWQiIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkb25seQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj0iJDAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ2YWx1ZS1pbnB1dC1ncm91cCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJ2YWx1ZS1pbnB1dC1sYWJlbCI+WW91ciBDZW50ZXIgVmFsdWU8L2xhYmVsPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT0idGV4dCIgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkPSJjZW50ZXJWYWx1ZSIgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzPSJ2YWx1ZS1pbnB1dCB1c2VyLW92ZXJyaWRlIiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9Ik92ZXJyaWRlIGhlcmUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uY2hhbmdlPSJ1cGRhdGVDZW50ZXJWYWx1ZSgpIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5Db25maWRlbmNlIFNjb3JlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImF2bVNjb3JlIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+VmFsdWUgUmFuZ2U8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0iYXZtUmFuZ2UiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5BVk0gRGF0ZTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJhdm1EYXRlIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgICAgICA8IS0tIFJJR0hUIENPTFVNTjogU0FMRVMgSElTVE9SWSAtLT4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLXRpdGxlLWNvbXBhY3QiPvCfk4ggU2FsZXMgSGlzdG9yeSAmIE1hcmtldCBWZWxvY2l0eTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+TGFzdCBTYWxlIERhdGU8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ibGFzdFNhbGVEYXRlIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+TGFzdCBTYWxlIFByaWNlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9Imxhc3RTYWxlUHJpY2UiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5QcmljZS9TcUZ0PC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9InByaWNlUGVyU3FmdCIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPkFwcHJlY2lhdGlvbjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJhcHByZWNpYXRpb24iIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5NYXJrZXQgVmVsb2NpdHk8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ibWFya2V0VmVsb2NpdHkiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICA8IS0tIFBST1BFUlRZIENIQVJBQ1RFUklTVElDUyAtIENPTVBBQ1QgLS0+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLWNvbXBhY3QiIHN0eWxlPSJtYXJnaW4tYm90dG9tOiAyMHB4OyI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi10aXRsZS1jb21wYWN0Ij7wn4+gIFByb3BlcnR5IENoYXJhY3RlcmlzdGljczwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNoYXItZ3JpZCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNoYXItaXRlbSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJjaGFyQmVkcyIgY2xhc3M9ImNoYXItdmFsdWUiPi0tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWxhYmVsIj5CZWRzPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iY2hhckJhdGhzIiBjbGFzcz0iY2hhci12YWx1ZSI+LS08L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNoYXItbGFiZWwiPkJhdGhzPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iY2hhclNxZnQiIGNsYXNzPSJjaGFyLXZhbHVlIj4tLTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1sYWJlbCI+U3FGdDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1pdGVtIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImNoYXJBY3JlcyIgY2xhc3M9ImNoYXItdmFsdWUiPi0tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWxhYmVsIj5BY3JlczwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1pdGVtIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImNoYXJHYXJhZ2UiIGNsYXNzPSJjaGFyLXZhbHVlIj4tLTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1sYWJlbCI+R2FyYWdlPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iY2hhclR5cGUiIGNsYXNzPSJjaGFyLXZhbHVlIj4tLTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1sYWJlbCI+VHlwZTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1pdGVtIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImNoYXJZZWFyIiBjbGFzcz0iY2hhci12YWx1ZSI+LS08L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNoYXItbGFiZWwiPkJ1aWx0PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iY2hhckNvbmRpdGlvbiIgY2xhc3M9ImNoYXItdmFsdWUiPi0tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWxhYmVsIj5Db25kaXRpb248L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICA8IS0tIEVRVUlUWSAmIE9XTkVSIElOVEVMTElHRU5DRSAtLT4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb3BlcnR5LWdyaWQiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUtY29tcGFjdCI+8J+StSBFcXVpdHkgJiBNb3J0Z2FnZSBJbnRlbGxpZ2VuY2U8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPkVzdGltYXRlZCBFcXVpdHk8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0iZXF1aXR5RG9sbGFycyIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPkVxdWl0eSAlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImVxdWl0eVBlcmNlbnQiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5MVFYgUmF0aW88L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ibHR2UmF0aW8iIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5TdGF0dXM8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0iZXF1aXR5U3RhdHVzIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLXRpdGxlLWNvbXBhY3QiPvCfkaQgT3duZXIgSW50ZWxsaWdlbmNlPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5Pd25lciBOYW1lPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9Im93bmVyTmFtZSIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPk93bmVyc2hpcCBUeXBlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9Im93bmVyVHlwZSIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPlllYXJzIE93bmVkPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9Im93bmVyc2hpcExlbmd0aCIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0ib3duZXJGbGFncyIgY2xhc3M9InJpc2stZmxhZ3MiIHN0eWxlPSJtYXJnaW4tdG9wOiA4cHg7Ij48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgIDwhLS0gUklTSyAmIEVOVklST05NRU5UQUwgLS0+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcm9wZXJ0eS1ncmlkIj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLXRpdGxlLWNvbXBhY3QiPvCfjI0gRW52aXJvbm1lbnRhbCAmIFJpc2sgQXNzZXNzbWVudDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+Rmxvb2QgWm9uZTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJmbG9vZFpvbmUiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5GbG9vZCBSaXNrPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImZsb29kUmlzayIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iZW52aXJvbm1lbnRhbEZsYWdzIiBjbGFzcz0icmlzay1mbGFncyIgc3R5bGU9Im1hcmdpbi10b3A6IDhweDsiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLXRpdGxlLWNvbXBhY3QiPvCfj6sgU2Nob29sIERpc3RyaWN0IEluZm9ybWF0aW9uPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5EaXN0cmljdDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJzY2hvb2xEaXN0cmljdCIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPkVsZW1lbnRhcnk8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ic2Nob29sRWxlbWVudGFyeSIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPkhpZ2ggU2Nob29sPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9InNjaG9vbEhpZ2giIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICA8IS0tIERJU1RSRVNTIEZMQUdTIChJZiBhbnkpIC0tPgogICAgICAgICAgICAgICAgPGRpdiBpZD0iZGlzdHJlc3NTZWN0aW9uIiBjbGFzcz0ic2VjdGlvbi1jb21wYWN0IiBzdHlsZT0iZGlzcGxheTogbm9uZTsgbWFyZ2luLWJvdHRvbTogMjBweDsiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUtY29tcGFjdCI+4pqg77iPIERpc3RyZXNzIEluZGljYXRvcnM8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJkaXN0cmVzc0ZsYWdzIiBjbGFzcz0icmlzay1mbGFncyI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iZGlzdHJlc3NEZXRhaWxzIiBzdHlsZT0ibWFyZ2luLXRvcDogMTBweDsgZm9udC1zaXplOiAxMnB4OyBjb2xvcjogIzRhNTU2ODsiPjwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAgPCEtLSBDT0xMQVBTSUJMRTogQURESVRJT05BTCBERVRBSUxTIC0tPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi1jb21wYWN0Ij4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLXRpdGxlLWNvbXBhY3QgY29sbGFwc2libGUiIG9uY2xpY2s9InRvZ2dsZUNvbGxhcHNpYmxlKCdhZGRpdGlvbmFsRGV0YWlscycpIj4KICAgICAgICAgICAgICAgICAgICAgICAg8J+TiyBBZGRpdGlvbmFsIFByb3BlcnR5IERldGFpbHMKICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJhZGRpdGlvbmFsRGV0YWlscyIgY2xhc3M9ImNvbGxhcHNpYmxlLWNvbnRlbnQiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+U3Rvcmllczwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJkZXRhaWxTdG9yaWVzIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+UXVhbGl0eTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJkZXRhaWxRdWFsaXR5IiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+UG9vbDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJkZXRhaWxQb29sIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+RmlyZXBsYWNlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImRldGFpbEZpcmVwbGFjZSIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPkhlYXRpbmc8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0iZGV0YWlsSGVhdGluZyIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPkNvb2xpbmc8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0iZGV0YWlsQ29vbGluZyIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPlRheCBBbW91bnQ8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0iZGV0YWlsVGF4QW1vdW50IiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+VGF4L1NxRnQ8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0iZGV0YWlsVGF4UGVyU3FmdCIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPkFUVE9NIElEPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImRldGFpbEF0dG9tSWQiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgIDwhLS0gVEFCIDI6IENNQSBHRU5FUkFUT1IgLS0+CiAgICAgICAgICAgIDxkaXYgaWQ9ImNtYS1nZW5lcmF0b3IiIGNsYXNzPSJ0YWItY29udGVudCI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tY29tcGFjdCIgc3R5bGU9Im1hcmdpbi10b3A6IDA7Ij4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUtY29tcGFjdCI+8J+TiiBHZW5lcmF0ZSBDTUE8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvcm0tY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cC1jb21wYWN0Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsLWNvbXBhY3QiPlNlYXJjaCBSYWRpdXMgKG1pbGVzKTwvbGFiZWw+CiAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJjbWFSYWRpdXMiIGNsYXNzPSJmb3JtLWlucHV0LWNvbXBhY3QiIHZhbHVlPSIzIiBtaW49IjEiIG1heD0iMTAiPgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAtY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iZm9ybS1sYWJlbC1jb21wYWN0Ij5EYXlzIEJhY2s8L2xhYmVsPgogICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0iY21hRGF5c0JhY2siIGNsYXNzPSJmb3JtLWlucHV0LWNvbXBhY3QiIHZhbHVlPSIxODAiIG1pbj0iMzAiIG1heD0iNzMwIj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwtY29tcGFjdCI+TWF4IENvbXBhcmFibGVzPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgaWQ9ImNtYU1heENvbXBzIiBjbGFzcz0iZm9ybS1pbnB1dC1jb21wYWN0IiB2YWx1ZT0iMTAiIG1pbj0iMyIgbWF4PSIyMCI+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cC1jb21wYWN0Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsLWNvbXBhY3QiPlByaWNlIFZhcmlhbmNlICglKTwvbGFiZWw+CiAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJjbWFQcmljZVZhcmlhbmNlIiBjbGFzcz0iZm9ybS1pbnB1dC1jb21wYWN0IiB2YWx1ZT0iMjUiIG1pbj0iMTAiIG1heD0iNTAiPgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPgogICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tcHJpbWFyeSIgb25jbGljaz0iZ2VuZXJhdGVDTUEoKSI+CiAgICAgICAgICAgICAgICAgICAgICAgIPCfk4ogR2VuZXJhdGUgQ01BIFJlcG9ydAogICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc2Vjb25kYXJ5IiBvbmNsaWNrPSJleHBvcnREYXRhKCkiPgogICAgICAgICAgICAgICAgICAgICAgICDwn5K+IEV4cG9ydCB0byBGVUIKICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8IS0tIFRBQiAzOiBDT01QQVJBQkxFUyAoUExBQ0VIT0xERVIpIC0tPgogICAgICAgICAgICA8ZGl2IGlkPSJjb21wYXJhYmxlcyIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi10aXRsZS1jb21wYWN0Ij7wn5OIIENvbXBhcmFibGUgUHJvcGVydGllczwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImluZm8tY2FyZCIgc3R5bGU9Im1hcmdpbi10b3A6IDE1cHg7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaW5mby1jYXJkLXRpdGxlIj5Db21pbmcgU29vbjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLWNhcmQtY29udGVudCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIHRhYiB3aWxsIGRpc3BsYXkgY29tcGFyYWJsZSBwcm9wZXJ0aWVzIGZyb20gQ2xvdWRDTUEgYWZ0ZXIgQ01BIGdlbmVyYXRpb24uCiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CgogICAgPCEtLSBQb3dlcmVkIEJ5IEZvb3RlciAtLT4KICAgIDxkaXYgY2xhc3M9InBvd2VyZWQtYnkiPlBvd2VyZWQgYnkgV0lMTE9XPC9kaXY+CgogICAgPHNjcmlwdD4KICAgICAgICBsZXQgY3VycmVudFByb3BlcnR5RGF0YSA9IG51bGw7CiAgICAgICAgbGV0IGZ1YkNvbnRleHQgPSBudWxsOwoKICAgICAgICAvLyBJbml0aWFsaXplIEZVQiBlbWJlZGRlZCBhcHAKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGFzeW5jIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZnViQ29udGV4dCA9IGF3YWl0IEZVQi5nZXRDb250ZXh0KCk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRlVCIENvbnRleHQ6JywgZnViQ29udGV4dCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChmdWJDb250ZXh0ICYmIGZ1YkNvbnRleHQucGVyc29uKSB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xlYWROYW1lJykudGV4dENvbnRlbnQgPSAKICAgICAgICAgICAgICAgICAgICAgICAgZnViQ29udGV4dC5wZXJzb24ubmFtZSB8fCAnVW5rbm93biBMZWFkJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIEZVQiBjb250ZXh0OicsIGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBMb2FkIHByb3BlcnR5IGRhdGEgZnJvbSBBVFRPTSBBUEkKICAgICAgICBhc3luYyBmdW5jdGlvbiBsb2FkUHJvcGVydHlEYXRhKCkgewogICAgICAgICAgICBjb25zdCBhZGRyZXNzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1YmplY3RBZGRyZXNzJykudmFsdWUudHJpbSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhZGRyZXNzKSB7CiAgICAgICAgICAgICAgICBhbGVydCgnUGxlYXNlIGVudGVyIGEgcHJvcGVydHkgYWRkcmVzcycpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTaG93IGxvYWRpbmcgaW5kaWNhdG9yCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2FkaW5nSW5kaWNhdG9yJykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlcnJvck1lc3NhZ2UnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvcGVydHlJbnRlbGxpZ2VuY2UnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHBlcnNvbklkID0gZnViQ29udGV4dD8ucGVyc29uPy5pZCB8fCBudWxsOwogICAgICAgICAgICAgICAgY29uc3QgdXJsID0gYC8ubmV0bGlmeS9mdW5jdGlvbnMvYXR0b20tcHJvcGVydHktbG9va3VwP2FkZHJlc3M9JHtlbmNvZGVVUklDb21wb25lbnQoYWRkcmVzcyl9JHtwZXJzb25JZCA/ICcmcGVyc29uSWQ9JyArIHBlcnNvbklkIDogJyd9YDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwoKICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2Uub2sgfHwgIXJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlc3VsdC5tZXNzYWdlIHx8ICdGYWlsZWQgdG8gbG9hZCBwcm9wZXJ0eSBkYXRhJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY3VycmVudFByb3BlcnR5RGF0YSA9IHJlc3VsdC5kYXRhOwogICAgICAgICAgICAgICAgZGlzcGxheVByb3BlcnR5RGF0YShjdXJyZW50UHJvcGVydHlEYXRhKTsKCiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZ0luZGljYXRvcicpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvcGVydHlJbnRlbGxpZ2VuY2UnKS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKCiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBsb2FkaW5nIHByb3BlcnR5IGRhdGE6JywgZXJyb3IpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvYWRpbmdJbmRpY2F0b3InKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Vycm9yTWVzc2FnZScpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Vycm9yTWVzc2FnZScpLnRleHRDb250ZW50ID0gCiAgICAgICAgICAgICAgICAgICAgJ0Vycm9yIGxvYWRpbmcgcHJvcGVydHkgZGF0YTogJyArIGVycm9yLm1lc3NhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIERpc3BsYXkgcHJvcGVydHkgZGF0YSBpbiBVSQogICAgICAgIGZ1bmN0aW9uIGRpc3BsYXlQcm9wZXJ0eURhdGEoZGF0YSkgewogICAgICAgICAgICAvLyBBVk0gU2VjdGlvbgogICAgICAgICAgICBpZiAoZGF0YS5hdm0pIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN1Z2dlc3RlZFZhbHVlID0gZGF0YS5hdm0udmFsdWUgfHwgMDsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdm1TdWdnZXN0ZWRWYWx1ZScpLnZhbHVlID0gZm9ybWF0Q3VycmVuY3koc3VnZ2VzdGVkVmFsdWUpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NlbnRlclZhbHVlJykudmFsdWUgPSBmb3JtYXRDdXJyZW5jeShzdWdnZXN0ZWRWYWx1ZSk7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2VudGVyVmFsdWUnKS5wbGFjZWhvbGRlciA9IGZvcm1hdEN1cnJlbmN5KHN1Z2dlc3RlZFZhbHVlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F2bVNjb3JlJykudGV4dENvbnRlbnQgPSBkYXRhLmF2bS5jb25maWRlbmNlU2NvcmUgfHwgJy0tJzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdm1Db25maWRlbmNlQmFkZ2UnKS50ZXh0Q29udGVudCA9IGRhdGEuYXZtLmNvbmZpZGVuY2VMZXZlbCB8fCAnVU5LTk9XTic7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXZtQ29uZmlkZW5jZUJhZGdlJykuY2xhc3NOYW1lID0gCiAgICAgICAgICAgICAgICAgICAgJ2NvbmZpZGVuY2UtYmFkZ2UgY29uZmlkZW5jZS0nICsgKGRhdGEuYXZtLmNvbmZpZGVuY2VMZXZlbCB8fCAnVU5LTk9XTicpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXZtUmFuZ2UnKS50ZXh0Q29udGVudCA9IAogICAgICAgICAgICAgICAgICAgIGAke2Zvcm1hdEN1cnJlbmN5KGRhdGEuYXZtLnZhbHVlTG93KX0gLSAke2Zvcm1hdEN1cnJlbmN5KGRhdGEuYXZtLnZhbHVlSGlnaCl9YDsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdm1EYXRlJykudGV4dENvbnRlbnQgPSAKICAgICAgICAgICAgICAgICAgICBkYXRhLmF2bS5kYXRlID8gbmV3IERhdGUoZGF0YS5hdm0uZGF0ZSkudG9Mb2NhbGVEYXRlU3RyaW5nKCkgOiAnLS0nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTYWxlcyBIaXN0b3J5CiAgICAgICAgICAgIGlmIChkYXRhLnNhbGVIaXN0b3J5KSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGFzdFNhbGVEYXRlJykudGV4dENvbnRlbnQgPSAKICAgICAgICAgICAgICAgICAgICBkYXRhLnNhbGVIaXN0b3J5Lmxhc3RTYWxlRGF0ZSA/IG5ldyBEYXRlKGRhdGEuc2FsZUhpc3RvcnkubGFzdFNhbGVEYXRlKS50b0xvY2FsZURhdGVTdHJpbmcoKSA6ICctLSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGFzdFNhbGVQcmljZScpLnRleHRDb250ZW50ID0gCiAgICAgICAgICAgICAgICAgICAgZm9ybWF0Q3VycmVuY3koZGF0YS5zYWxlSGlzdG9yeS5sYXN0U2FsZVByaWNlKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmljZVBlclNxZnQnKS50ZXh0Q29udGVudCA9IAogICAgICAgICAgICAgICAgICAgIGRhdGEuc2FsZUhpc3RvcnkucHJpY2VQZXJTcWZ0ID8gJyQnICsgZGF0YS5zYWxlSGlzdG9yeS5wcmljZVBlclNxZnQgOiAnLS0nOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZGF0YS5zYWxlSGlzdG9yeS5hcHByZWNpYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhcHBEb2xsYXJzID0gZGF0YS5zYWxlSGlzdG9yeS5hcHByZWNpYXRpb24uZG9sbGFyczsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhcHBQZXJjZW50ID0gZGF0YS5zYWxlSGlzdG9yeS5hcHByZWNpYXRpb24ucGVyY2VudGFnZTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBwcmVjaWF0aW9uJykuaW5uZXJIVE1MID0gCiAgICAgICAgICAgICAgICAgICAgICAgIGA8c3BhbiBjbGFzcz0iJHthcHBEb2xsYXJzID49IDAgPyAnc3VjY2VzcycgOiAnZGFuZ2VyJ30iPiR7Zm9ybWF0Q3VycmVuY3koYXBwRG9sbGFycyl9ICgke2FwcFBlcmNlbnR9JSk8L3NwYW4+YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgdmVsb2NpdHkgPSBkYXRhLnNhbGVIaXN0b3J5Lm1hcmtldFZlbG9jaXR5IHx8ICdVTktOT1dOJzsKICAgICAgICAgICAgICAgIGNvbnN0IHZlbG9jaXR5Q2xhc3MgPSB2ZWxvY2l0eSA9PT0gJ0hPVCcgPyAnZGFuZ2VyJyA6IHZlbG9jaXR5ID09PSAnV0FSTScgPyAnd2FybmluZycgOiAnaGlnaGxpZ2h0JzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXJrZXRWZWxvY2l0eScpLmlubmVySFRNTCA9IAogICAgICAgICAgICAgICAgICAgIGA8c3BhbiBjbGFzcz0iJHt2ZWxvY2l0eUNsYXNzfSI+JHt2ZWxvY2l0eX08L3NwYW4+YDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUHJvcGVydHkgQ2hhcmFjdGVyaXN0aWNzCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyQmVkcycpLnRleHRDb250ZW50ID0gZGF0YS5iZWRzIHx8ICctLSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyQmF0aHMnKS50ZXh0Q29udGVudCA9IGRhdGEuYmF0aHMgfHwgJy0tJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJTcWZ0JykudGV4dENvbnRlbnQgPSBkYXRhLnNxZnQgPyBkYXRhLnNxZnQudG9Mb2NhbGVTdHJpbmcoKSA6ICctLSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyQWNyZXMnKS50ZXh0Q29udGVudCA9IGRhdGEuYWNyZXMgfHwgJy0tJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJHYXJhZ2UnKS50ZXh0Q29udGVudCA9IGRhdGEuZ2FyYWdlIHx8ICctLSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyVHlwZScpLnRleHRDb250ZW50ID0gZGF0YS5wcm9wZXJ0eVR5cGUgfHwgJy0tJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJZZWFyJykudGV4dENvbnRlbnQgPSBkYXRhLnllYXJCdWlsdCB8fCAnLS0nOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhckNvbmRpdGlvbicpLnRleHRDb250ZW50ID0gZGF0YS5jb25kaXRpb24gfHwgJy0tJzsKCiAgICAgICAgICAgIC8vIEVxdWl0eQogICAgICAgICAgICBpZiAoZGF0YS5lcXVpdHkpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlcXVpdHlEb2xsYXJzJykudGV4dENvbnRlbnQgPSBmb3JtYXRDdXJyZW5jeShkYXRhLmVxdWl0eS5lcXVpdHlEb2xsYXJzKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlcXVpdHlQZXJjZW50JykudGV4dENvbnRlbnQgPSAKICAgICAgICAgICAgICAgICAgICBkYXRhLmVxdWl0eS5lcXVpdHlQZXJjZW50YWdlID8gZGF0YS5lcXVpdHkuZXF1aXR5UGVyY2VudGFnZSArICclJyA6ICctLSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbHR2UmF0aW8nKS50ZXh0Q29udGVudCA9IAogICAgICAgICAgICAgICAgICAgIGRhdGEuZXF1aXR5Lmx0dlJhdGlvID8gZGF0YS5lcXVpdHkubHR2UmF0aW8gKyAnJScgOiAnLS0nOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXMgPSBkYXRhLmVxdWl0eS5pc1VuZGVyd2F0ZXIgPyAnVU5ERVJXQVRFUicgOiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZXF1aXR5Lmhhc0VxdWl0eSA/ICdQT1NJVElWRSBFUVVJVFknIDogJ1VOS05PV04nOwogICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzQ2xhc3MgPSBkYXRhLmVxdWl0eS5pc1VuZGVyd2F0ZXIgPyAnZGFuZ2VyJyA6IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5lcXVpdHkuaGFzRXF1aXR5ID8gJ3N1Y2Nlc3MnIDogJyc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXF1aXR5U3RhdHVzJykuaW5uZXJIVE1MID0gCiAgICAgICAgICAgICAgICAgICAgYDxzcGFuIGNsYXNzPSIke3N0YXR1c0NsYXNzfSI+JHtzdGF0dXN9PC9zcGFuPmA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE93bmVyIEludGVsbGlnZW5jZQogICAgICAgICAgICBpZiAoZGF0YS5vd25lcikgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ293bmVyTmFtZScpLnRleHRDb250ZW50ID0gZGF0YS5vd25lci5uYW1lIHx8ICctLSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnb3duZXJUeXBlJykudGV4dENvbnRlbnQgPSBkYXRhLm93bmVyLm93bmVyc2hpcFR5cGUgfHwgJy0tJzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdvd25lcnNoaXBMZW5ndGgnKS50ZXh0Q29udGVudCA9IAogICAgICAgICAgICAgICAgICAgIGRhdGEub3duZXIub3duZXJzaGlwTGVuZ3RoID8gZGF0YS5vd25lci5vd25lcnNoaXBMZW5ndGggKyAnIHllYXJzJyA6ICctLSc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IG93bmVyRmxhZ3NFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdvd25lckZsYWdzJyk7CiAgICAgICAgICAgICAgICBvd25lckZsYWdzRWwuaW5uZXJIVE1MID0gJyc7CiAgICAgICAgICAgICAgICBpZiAoZGF0YS5vd25lci5pc0Fic2VudGVlKSB7CiAgICAgICAgICAgICAgICAgICAgb3duZXJGbGFnc0VsLmlubmVySFRNTCArPSAnPHNwYW4gY2xhc3M9InJpc2stZmxhZyBmbGFnLXdhcm5pbmciPkFCU0VOVEVFIE9XTkVSPC9zcGFuPic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZGF0YS5vd25lci5pc0NvcnBvcmF0ZU93bmVkKSB7CiAgICAgICAgICAgICAgICAgICAgb3duZXJGbGFnc0VsLmlubmVySFRNTCArPSAnPHNwYW4gY2xhc3M9InJpc2stZmxhZyBmbGFnLWluZm8iPkNPUlBPUkFURSBPV05FRDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFbnZpcm9ubWVudGFsCiAgICAgICAgICAgIGlmIChkYXRhLmVudmlyb25tZW50YWwpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmbG9vZFpvbmUnKS50ZXh0Q29udGVudCA9IGRhdGEuZW52aXJvbm1lbnRhbC5mbG9vZFpvbmUgfHwgJy0tJzsKICAgICAgICAgICAgICAgIGNvbnN0IGZsb29kUmlzayA9IGRhdGEuZW52aXJvbm1lbnRhbC5mbG9vZFJpc2sgfHwgJ1VOS05PV04nOwogICAgICAgICAgICAgICAgY29uc3Qgcmlza0NsYXNzID0gZmxvb2RSaXNrID09PSAnSElHSCcgPyAnZGFuZ2VyJyA6IGZsb29kUmlzayA9PT0gJ01PREVSQVRFJyA/ICd3YXJuaW5nJyA6ICdzdWNjZXNzJzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmbG9vZFJpc2snKS5pbm5lckhUTUwgPSAKICAgICAgICAgICAgICAgICAgICBgPHNwYW4gY2xhc3M9IiR7cmlza0NsYXNzfSI+JHtmbG9vZFJpc2t9PC9zcGFuPmA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGVudkZsYWdzRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW52aXJvbm1lbnRhbEZsYWdzJyk7CiAgICAgICAgICAgICAgICBlbnZGbGFnc0VsLmlubmVySFRNTCA9ICcnOwogICAgICAgICAgICAgICAgaWYgKGZsb29kUmlzayA9PT0gJ0hJR0gnKSB7CiAgICAgICAgICAgICAgICAgICAgZW52RmxhZ3NFbC5pbm5lckhUTUwgKz0gJzxzcGFuIGNsYXNzPSJyaXNrLWZsYWcgZmxhZy1kYW5nZXIiPkhJR0ggRkxPT0QgUklTSzwvc3Bhbj4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTY2hvb2xzCiAgICAgICAgICAgIGlmIChkYXRhLnNjaG9vbHMpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY2hvb2xEaXN0cmljdCcpLnRleHRDb250ZW50ID0gZGF0YS5zY2hvb2xzLmRpc3RyaWN0IHx8ICctLSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2Nob29sRWxlbWVudGFyeScpLnRleHRDb250ZW50ID0gZGF0YS5zY2hvb2xzLmVsZW1lbnRhcnlTY2hvb2wgfHwgJy0tJzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY2hvb2xIaWdoJykudGV4dENvbnRlbnQgPSBkYXRhLnNjaG9vbHMuaGlnaFNjaG9vbCB8fCAnLS0nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEaXN0cmVzcyBJbmRpY2F0b3JzCiAgICAgICAgICAgIGlmIChkYXRhLmRpc3RyZXNzICYmIChkYXRhLmRpc3RyZXNzLmlzSW5Gb3JlY2xvc3VyZSB8fCBkYXRhLmRpc3RyZXNzLmlzUkVPKSkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Rpc3RyZXNzU2VjdGlvbicpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgY29uc3QgZGlzdHJlc3NGbGFnc0VsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Rpc3RyZXNzRmxhZ3MnKTsKICAgICAgICAgICAgICAgIGRpc3RyZXNzRmxhZ3NFbC5pbm5lckhUTUwgPSAnJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRhdGEuZGlzdHJlc3MuaXNJbkZvcmVjbG9zdXJlKSB7CiAgICAgICAgICAgICAgICAgICAgZGlzdHJlc3NGbGFnc0VsLmlubmVySFRNTCArPSAnPHNwYW4gY2xhc3M9InJpc2stZmxhZyBmbGFnLWRhbmdlciI+SU4gRk9SRUNMT1NVUkU8L3NwYW4+JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChkYXRhLmRpc3RyZXNzLmlzUkVPKSB7CiAgICAgICAgICAgICAgICAgICAgZGlzdHJlc3NGbGFnc0VsLmlubmVySFRNTCArPSAnPHNwYW4gY2xhc3M9InJpc2stZmxhZyBmbGFnLWRhbmdlciI+UkVPIFBST1BFUlRZPC9zcGFuPic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCBkZXRhaWxzID0gJyc7CiAgICAgICAgICAgICAgICBpZiAoZGF0YS5kaXN0cmVzcy5mb3JlY2xvc3VyZURhdGUpIHsKICAgICAgICAgICAgICAgICAgICBkZXRhaWxzICs9IGBGb3JlY2xvc3VyZSBEYXRlOiAke25ldyBEYXRlKGRhdGEuZGlzdHJlc3MuZm9yZWNsb3N1cmVEYXRlKS50b0xvY2FsZURhdGVTdHJpbmcoKX08YnI+YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChkYXRhLmRpc3RyZXNzLmF1Y3Rpb25EYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgZGV0YWlscyArPSBgQXVjdGlvbiBEYXRlOiAke25ldyBEYXRlKGRhdGEuZGlzdHJlc3MuYXVjdGlvbkRhdGUpLnRvTG9jYWxlRGF0ZVN0cmluZygpfTxicj5gOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Rpc3RyZXNzRGV0YWlscycpLmlubmVySFRNTCA9IGRldGFpbHM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFkZGl0aW9uYWwgRGV0YWlscwogICAgICAgICAgICBpZiAoZGF0YS5idWlsZGluZykgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbFN0b3JpZXMnKS50ZXh0Q29udGVudCA9IGRhdGEuYnVpbGRpbmcuc3RvcmllcyB8fCAnLS0nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbFF1YWxpdHknKS50ZXh0Q29udGVudCA9IGRhdGEuYnVpbGRpbmcucXVhbGl0eSB8fCAnLS0nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbFBvb2wnKS50ZXh0Q29udGVudCA9IGRhdGEuYnVpbGRpbmcucG9vbCA/ICdZZXMnIDogJ05vJzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxGaXJlcGxhY2UnKS50ZXh0Q29udGVudCA9IGRhdGEuYnVpbGRpbmcuZmlyZXBsYWNlID8gJ1llcycgOiAnTm8nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbEhlYXRpbmcnKS50ZXh0Q29udGVudCA9IGRhdGEuYnVpbGRpbmcuaGVhdGluZyB8fCAnLS0nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbENvb2xpbmcnKS50ZXh0Q29udGVudCA9IGRhdGEuYnVpbGRpbmcuY29vbGluZyB8fCAnLS0nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZGF0YS5hc3Nlc3NtZW50KSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlsVGF4QW1vdW50JykudGV4dENvbnRlbnQgPSBmb3JtYXRDdXJyZW5jeShkYXRhLmFzc2Vzc21lbnQudGF4QW1vdW50KTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxUYXhQZXJTcWZ0JykudGV4dENvbnRlbnQgPSAKICAgICAgICAgICAgICAgICAgICBkYXRhLmFzc2Vzc21lbnQudGF4UGVyU3FmdCA/ICckJyArIGRhdGEuYXNzZXNzbWVudC50YXhQZXJTcWZ0IDogJy0tJzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGRhdGEubWV0YWRhdGEpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxBdHRvbUlkJykudGV4dENvbnRlbnQgPSBkYXRhLm1ldGFkYXRhLmF0dG9tSWQgfHwgJy0tJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRm9ybWF0IGN1cnJlbmN5CiAgICAgICAgZnVuY3Rpb24gZm9ybWF0Q3VycmVuY3kodmFsdWUpIHsKICAgICAgICAgICAgaWYgKCF2YWx1ZSAmJiB2YWx1ZSAhPT0gMCkgcmV0dXJuICctLSc7CiAgICAgICAgICAgIHJldHVybiAnJCcgKyBNYXRoLnJvdW5kKHZhbHVlKS50b0xvY2FsZVN0cmluZygpOwogICAgICAgIH0KCiAgICAgICAgLy8gVXBkYXRlIGNlbnRlciB2YWx1ZSB3aGVuIHVzZXIgZWRpdHMKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDZW50ZXJWYWx1ZSgpIHsKICAgICAgICAgICAgY29uc3QgaW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2VudGVyVmFsdWUnKTsKICAgICAgICAgICAgaW5wdXQuY2xhc3NMaXN0LmFkZCgndXNlci1vdmVycmlkZScpOwogICAgICAgICAgICBjb25zb2xlLmxvZygnQ2VudGVyIHZhbHVlIHVwZGF0ZWQgYnkgdXNlcjonLCBpbnB1dC52YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBTd2l0Y2ggYmV0d2VlbiB0YWJzCiAgICAgICAgZnVuY3Rpb24gc3dpdGNoVGFiKHRhYklkKSB7CiAgICAgICAgICAgIC8vIEhpZGUgYWxsIHRhYiBjb250ZW50cwogICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiLWNvbnRlbnQnKS5mb3JFYWNoKHRhYiA9PiB7CiAgICAgICAgICAgICAgICB0YWIuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVtb3ZlIGFjdGl2ZSBmcm9tIGFsbCB0YWIgYnV0dG9ucwogICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiLWJ1dHRvbicpLmZvckVhY2goYnV0dG9uID0+IHsKICAgICAgICAgICAgICAgIGJ1dHRvbi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaG93IHNlbGVjdGVkIHRhYgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0YWJJZCkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBY3RpdmF0ZSBjb3JyZXNwb25kaW5nIGJ1dHRvbgogICAgICAgICAgICBldmVudC50YXJnZXQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQoKICAgICAgICAvLyBUb2dnbGUgY29sbGFwc2libGUgc2VjdGlvbnMKICAgICAgICBmdW5jdGlvbiB0b2dnbGVDb2xsYXBzaWJsZShpZCkgewogICAgICAgICAgICBjb25zdCBjb250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICBjb25zdCB0cmlnZ2VyID0gY29udGVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nOwogICAgICAgICAgICAKICAgICAgICAgICAgY29udGVudC5jbGFzc0xpc3QudG9nZ2xlKCdoaWRkZW4nKTsKICAgICAgICAgICAgdHJpZ2dlci5jbGFzc0xpc3QudG9nZ2xlKCdjb2xsYXBzZWQnKTsKICAgICAgICB9CgogICAgICAgIC8vIEdlbmVyYXRlIENNQSAocGxhY2Vob2xkZXIpCiAgICAgICAgZnVuY3Rpb24gZ2VuZXJhdGVDTUEoKSB7CiAgICAgICAgICAgIGlmICghY3VycmVudFByb3BlcnR5RGF0YSkgewogICAgICAgICAgICAgICAgYWxlcnQoJ1BsZWFzZSBsb2FkIHByb3BlcnR5IGRhdGEgZmlyc3QnKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgY2VudGVyVmFsdWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2VudGVyVmFsdWUnKS52YWx1ZTsKICAgICAgICAgICAgY29uc3QgcmFkaXVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NtYVJhZGl1cycpLnZhbHVlOwogICAgICAgICAgICBjb25zdCBkYXlzQmFjayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbWFEYXlzQmFjaycpLnZhbHVlOwogICAgICAgICAgICAKICAgICAgICAgICAgYWxlcnQoYENNQSBHZW5lcmF0aW9uXG5cbkNlbnRlciBWYWx1ZTogJHtjZW50ZXJWYWx1ZX1cblJhZGl1czogJHtyYWRpdXN9IG1pbGVzXG5EYXlzIEJhY2s6ICR7ZGF5c0JhY2t9XG5cblRoaXMgd2lsbCBpbnRlZ3JhdGUgd2l0aCB5b3VyIGV4aXN0aW5nIENNQSBnZW5lcmF0aW9uIHdvcmtmbG93LmApOwogICAgICAgIH0KCiAgICAgICAgLy8gRXhwb3J0IHRvIEZVQiAocGxhY2Vob2xkZXIpCiAgICAgICAgZnVuY3Rpb24gZXhwb3J0RGF0YSgpIHsKICAgICAgICAgICAgaWYgKCFjdXJyZW50UHJvcGVydHlEYXRhKSB7CiAgICAgICAgICAgICAgICBhbGVydCgnUGxlYXNlIGxvYWQgcHJvcGVydHkgZGF0YSBmaXJzdCcpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBhbGVydCgnUHJvcGVydHkgZGF0YSB3aWxsIGJlIGV4cG9ydGVkIHRvIEZVQiBjdXN0b20gZmllbGRzLicpOwogICAgICAgIH0KICAgIDwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4K';
            const html = Buffer.from(htmlBase64, 'base64').toString('utf8');
            
            return {
                statusCode: 200,
                headers: {
                    'Content-Type': 'text/html',
                    'Access-Control-Allow-Origin': '*'
                },
                body: html
            };
        }

        // Route to appropriate API handler
        switch (action) {
            case 'getPersonData':
                return await getPersonData(params.personId, headers);
            
            case 'generateCMA':
                return await generateCMA(params, headers);
            
            case 'getHomebeatData':
                return await getHomebeatData(params.personId, headers);
            
            case 'resendHomebeat':
                return await resendHomebeat(params, headers);
            
            case 'createTask':
                return await createTask(params, headers);
            
            case 'createManualAction':
                return await createManualAction(params, headers);
            
            default:
                return {
                    statusCode: 400,
                    headers,
                    body: JSON.stringify({ error: 'Invalid action' })
                };
        }

    } catch (error) {
        console.error('Function error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: error.message })
        };
    }
};

// Get person data from FUB
async function getPersonData(personId, headers) {
    try {
        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);
        
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify(personData)
        };
    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to fetch person data: ' + error.message })
        };
    }
}

// Generate CMA with CloudCMA API
async function generateCMA(params, headers) {
    try {
        const {
            personId,
            address,
            beds,
            baths,
            sqft,
            radius,
            monthsBack,
            minListings,
            propType,
            title,
            createHomebeat,
            homebeatFrequency
        } = params;

        // Get person data for lead info
        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);

        // Build CMA URL
        const cmaParams = new URLSearchParams({
            api_key: CLOUDCMA_API_KEY,
            address: address,
            beds: beds || '',
            baths: baths || '',
            sqft: sqft || '',
            radius: radius || '0.75',
            months_back: monthsBack || '9',
            min_listings: minListings || '10',
            prop_type: propType || '',
            title: title || `${personData.name || 'Client'} - ${address}`,
            callback_url: WEBHOOK_URL
        });

        const cmaUrl = `https://cloudcma.com/cmas/new?${cmaParams.toString()}`;

        // Update FUB custom fields
        const updatePayload = {
            customWILLOWCMADate: new Date().toISOString(),
            customWILLOWCMAAddress: address,
            customWILLOWCMALink: cmaUrl
        };

        await fubAPIRequest('PUT', `/v1/people/${personId}`, updatePayload);

        // Create FUB activity
        await fubAPIRequest('POST', '/v1/events', {
            person_id: parseInt(personId),
            type: 'Note',
            body: `CMA generated for ${address}. Parameters: ${beds}bd/${baths}ba, ${sqft}sqft, ${radius}mi radius, ${monthsBack}mo back.`
        });

        let homebeatUrl = null;
        let homebeatCreated = false;

        // Create Homebeat if requested
        if (createHomebeat === true || createHomebeat === 'true') {
            try {
                const homebeatPayload = {
                    automation: {
                        api_key: CLOUDCMA_API_KEY,
                        frequency: homebeatFrequency || 'quarterly',
                        welcome_email: 'true',
                        report: {
                            prop_type: propType || null,
                            callback_url: null
                        },
                        subject_property: {
                            address: address,
                            sqft: sqft || null,
                            beds: beds || null,
                            baths: baths || null
                        },
                        lead: {
                            name: personData.name || '',
                            email_address: personData.emails?.[0]?.value || '',
                            phone: personData.phones?.[0]?.value || ''
                        }
                    }
                };

                const homebeatResponse = await cloudCMAAPIRequest('POST', '/homebeats/widget', homebeatPayload);
                homebeatCreated = true;
                homebeatUrl = homebeatResponse.homebeat_url || null;

                // Update FUB with Homebeat info
                await fubAPIRequest('PUT', `/v1/people/${personId}`, {
                    customWILLOWCloudCMAHomeBeatURL: homebeatUrl,
                    customWILLOWHomebeatFirstSendDate: new Date().toISOString()
                });

                // Create FUB activity for Homebeat
                await fubAPIRequest('POST', '/v1/events', {
                    person_id: parseInt(personId),
                    type: 'Note',
                    body: `Homebeat subscription created for ${address}. Frequency: ${homebeatFrequency}. Lead will receive automated market updates.`
                });

            } catch (homebeatError) {
                console.error('Homebeat creation failed:', homebeatError);
            }
        }

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                success: true,
                cmaUrl: cmaUrl,
                homebeatCreated: homebeatCreated,
                homebeatUrl: homebeatUrl
            })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to generate CMA: ' + error.message })
        };
    }
}

// Get Homebeat data from CloudCMA
async function getHomebeatData(personId, headers) {
    try {
        // Try to fetch homebeat data, but gracefully handle CloudCMA auth failures
        let homebeatReport = [];
        try {
            homebeatReport = await cloudCMAAPIRequest('GET', `/homebeats/report?api_key=${CLOUDCMA_API_KEY}&format=json`);
        } catch (cloudCMAError) {
            console.warn('CloudCMA API unavailable:', cloudCMAError.message);
            // Return empty homebeats array instead of failing
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({ 
                    homebeats: [],
                    warning: 'CloudCMA API unavailable. Check API key configuration.'
                })
            };
        }

        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);
        const personEmail = personData.emails?.[0]?.value?.toLowerCase();

        if (!personEmail) {
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({ homebeats: [] })
            };
        }

        const leadHomebeats = (homebeatReport || []).filter(hb => 
            hb.lead_email?.toLowerCase() === personEmail
        );

        const enrichedHomebeats = leadHomebeats.map(hb => ({
            ...hb,
            first_send_date: personData.customWILLOWHomebeatFirstSendDate || hb.created_at,
            status: (hb.total_views || 0) === 0 ? 'pending' : 'active'
        }));

        if (enrichedHomebeats.length > 0) {
            const totalViews = enrichedHomebeats.reduce((sum, hb) => sum + (hb.total_views || 0), 0);
            const latestView = enrichedHomebeats
                .map(hb => hb.last_view)
                .filter(v => v)
                .sort()
                .reverse()[0];

            await fubAPIRequest('PUT', `/v1/people/${personId}`, {
                customWILLOWHomebeatViews: totalViews,
                customWILLOWHomebeatLastView: latestView || null
            });
        }

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ homebeats: enrichedHomebeats })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to fetch Homebeat data: ' + error.message })
        };
    }
}

// Resend Homebeat
async function resendHomebeat(params, headers) {
    try {
        const { homebeatId, personId } = params;

        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);
        
        const homebeatReport = await cloudCMAAPIRequest('GET', `/homebeats/report?api_key=${CLOUDCMA_API_KEY}&format=json`);
        const homebeat = (homebeatReport || []).find(hb => hb.id === homebeatId);

        if (!homebeat) {
            throw new Error('Homebeat not found');
        }

        const homebeatPayload = {
            automation: {
                api_key: CLOUDCMA_API_KEY,
                frequency: homebeat.frequency || 'quarterly',
                welcome_email: 'true',
                subject_property: {
                    address: homebeat.property_address,
                    sqft: homebeat.sqft || null,
                    beds: homebeat.beds || null,
                    baths: homebeat.baths || null
                },
                lead: {
                    name: personData.name || '',
                    email_address: personData.emails?.[0]?.value || '',
                    phone: personData.phones?.[0]?.value || ''
                }
            }
        };

        await cloudCMAAPIRequest('POST', '/homebeats/widget', homebeatPayload);

        await fubAPIRequest('PUT', `/v1/people/${personId}`, {
            customWILLOWHomebeatLastResend: new Date().toISOString()
        });

        await fubAPIRequest('POST', '/v1/events', {
            person_id: parseInt(personId),
            type: 'Note',
            body: `Homebeat resent for ${homebeat.property_address}. Status was pending (0 views). Manual resend triggered.`
        });

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ success: true })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to resend Homebeat: ' + error.message })
        };
    }
}

// Create task in FUB
async function createTask(params, headers) {
    try {
        const { personId, taskDescription, urgency, assignedTo } = params;

        const now = new Date();
        let dueDate = new Date(now);
        
        switch (urgency) {
            case 'IMMEDIATE':
                dueDate.setHours(now.getHours() + 24);
                break;
            case 'SAME_DAY':
                dueDate.setHours(23, 59, 59);
                break;
            case 'NEXT_DAY':
                dueDate.setDate(now.getDate() + 1);
                break;
            case 'WEEKLY':
                dueDate.setDate(now.getDate() + 7);
                break;
            default:
                dueDate.setDate(now.getDate() + 1);
        }

        // FUB tasks API doesn't accept description/body field
        // Task details should be added as a note after task creation
        const taskPayload = {
            personId: parseInt(personId),
            type: 'Follow Up',
            dueDate: dueDate.toISOString()
        };

        const taskResult = await fubAPIRequest('POST', '/v1/tasks', taskPayload);
        
        // Add task details as a note
        const notePayload = {
            personId: parseInt(personId),
            subject: `Task: ${taskDescription}`,
            body: `${taskDescription}\n\nAssigned to: ${assignedTo}\nUrgency: ${urgency}\nDue: ${dueDate.toLocaleDateString()}`,
            isHtml: false
        };
        await fubAPIRequest('POST', '/v1/notes', notePayload);

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ success: true })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to create task: ' + error.message })
        };
    }
}

// Create manual action in FUB
async function createManualAction(params, headers) {
    try {
        const { personId, actionType, assignedTo, urgency, notes } = params;

        const now = new Date();
        let dueDate = new Date(now);
        
        switch (urgency) {
            case 'IMMEDIATE':
                dueDate.setHours(now.getHours() + 24);
                break;
            case 'SAME_DAY':
                dueDate.setHours(23, 59, 59);
                break;
            case 'NEXT_DAY':
                dueDate.setDate(now.getDate() + 1);
                break;
            case 'WEEKLY':
                dueDate.setDate(now.getDate() + 7);
                break;
            default:
                dueDate.setDate(now.getDate() + 1);
        }

        // Map action types to FUB task types
        const taskTypeMap = {
            'Task': 'Follow Up',
            'Call': 'Call',
            'Email': 'Email',
            'Text': 'Text',
            'Note': 'Note'
        };
        
        const fubType = taskTypeMap[actionType] || 'Follow Up';
        
        // If it's a Note, use /v1/notes endpoint, otherwise use /v1/tasks
        if (actionType === 'Note') {
            const notePayload = {
                personId: parseInt(personId),
                subject: `${urgency} Action`,
                body: `${notes}\n\nAssigned to: ${assignedTo}`,
                isHtml: false
            };
            await fubAPIRequest('POST', '/v1/notes', notePayload);
        } else {
            // FUB tasks API doesn't accept description field
            const taskPayload = {
                personId: parseInt(personId),
                type: fubType,
                dueDate: dueDate.toISOString()
            };
            await fubAPIRequest('POST', '/v1/tasks', taskPayload);
            
            // Add action details as a note
            const notePayload = {
                personId: parseInt(personId),
                subject: `${fubType} Action`,
                body: `${notes}\n\nAssigned to: ${assignedTo}\nUrgency: ${urgency}`,
                isHtml: false
            };
            await fubAPIRequest('POST', '/v1/notes', notePayload);
        }

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ success: true })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to create action: ' + error.message })
        };
    }
}

// FUB API Request Helper
function fubAPIRequest(method, path, data = null) {
    return new Promise((resolve, reject) => {
        const options = {
            hostname: 'api.followupboss.com',
            port: 443,
            path: path,
            method: method,
            headers: {
                'Authorization': `Basic ${Buffer.from(FUB_API_KEY + ':').toString('base64')}`,
                'Content-Type': 'application/json'
            }
        };

        const req = https.request(options, (res) => {
            let body = '';
            res.on('data', (chunk) => body += chunk);
            res.on('end', () => {
                try {
                    const parsed = JSON.parse(body);
                    if (res.statusCode >= 200 && res.statusCode < 300) {
                        resolve(parsed);
                    } else {
                        reject(new Error(`FUB API error: ${res.statusCode} - ${body}`));
                    }
                } catch (e) {
                    reject(new Error(`Failed to parse FUB response: ${body}`));
                }
            });
        });

        req.on('error', reject);
        
        if (data) {
            req.write(JSON.stringify(data));
        }
        
        req.end();
    });
}

// CloudCMA API Request Helper
function cloudCMAAPIRequest(method, path, data = null) {
    return new Promise((resolve, reject) => {
        const options = {
            hostname: 'cloudcma.com',
            port: 443,
            path: path,
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        };

        const req = https.request(options, (res) => {
            let body = '';
            res.on('data', (chunk) => body += chunk);
            res.on('end', () => {
                try {
                    const parsed = body ? JSON.parse(body) : {};
                    if (res.statusCode >= 200 && res.statusCode < 300) {
                        resolve(parsed);
                    } else {
                        reject(new Error(`CloudCMA API error: ${res.statusCode} - ${body}`));
                    }
                } catch (e) {
                    if (res.statusCode >= 200 && res.statusCode < 300) {
                        resolve({});
                    } else {
                        reject(new Error(`Failed to parse CloudCMA response: ${body}`));
                    }
                }
            });
        });

        req.on('error', reject);
        
        if (data) {
            req.write(JSON.stringify(data));
        }
        
        req.end();
    });
}
