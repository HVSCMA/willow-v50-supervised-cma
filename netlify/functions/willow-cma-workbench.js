// WILLOW V50 CMA Workbench - Complete Netlify Function
// Purpose: Server-side FUB/CloudCMA API integration with HTML serving

const https = require('https');

// API Credentials
const FUB_API_KEY = process.env.FUB_API_KEY || 'fka_0oHt62NxmsExO6x69p08ix82zx8ii1hzrj';
const CLOUDCMA_API_KEY = process.env.CLOUDCMA_API_KEY || '742f4a46e1780904da090d721a9bae7b';
const WEBHOOK_URL = 'https://willow-v50-supervised-cma.netlify.app/.netlify/functions/cloudcma-webhook';

exports.handler = async (event, context) => {
    // CORS headers
    const headers = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Content-Type': 'application/json'
    };

    if (event.httpMethod === 'OPTIONS') {
        return { statusCode: 200, headers, body: '' };
    }

    try {
        // Parse request
        const params = event.httpMethod === 'GET' 
            ? event.queryStringParameters || {}
            : JSON.parse(event.body || '{}');

        const action = params.action;

        // If no action parameter, serve HTML interface (Base64 decoded)
        if (!action) {
            const htmlBase64 = 'PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCwgdXNlci1zY2FsYWJsZT15ZXMiPgogICAgPHRpdGxlPkNNQSBXb3JrYmVuY2g8L3RpdGxlPgogICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiIHNyYz0iaHR0cHM6Ly9laWEuZm9sbG93dXBib3NzLmNvbS9lbWJlZGRlZEFwcHMtdjEuMC4xLmpzIj48L3NjcmlwdD4KICAgIDxzdHlsZT4KICAgICAgICAqIHsKICAgICAgICAgICAgbWFyZ2luOiAwOwogICAgICAgICAgICBwYWRkaW5nOiAwOwogICAgICAgICAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgICAgIH0KCiAgICAgICAgYm9keSB7CiAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsICdTZWdvZSBVSScsIFJvYm90bywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgIzY2N2VlYSAwJSwgIzc2NGJhMiAxMDAlKTsKICAgICAgICAgICAgY29sb3I6ICMyZDM3NDg7CiAgICAgICAgICAgIGxpbmUtaGVpZ2h0OiAxLjQ7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTNweDsKICAgICAgICAgICAgbWluLWhlaWdodDogMTAwdmg7CiAgICAgICAgICAgIHBhZGRpbmctYm90dG9tOiAzMHB4OwogICAgICAgIH0KCiAgICAgICAgLmNvbnRhaW5lciB7CiAgICAgICAgICAgIG1heC13aWR0aDogMTYwMHB4OwogICAgICAgICAgICBtYXJnaW46IDAgYXV0bzsKICAgICAgICAgICAgcGFkZGluZzogMTVweDsKICAgICAgICB9CgogICAgICAgIC5oZWFkZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBwYWRkaW5nOiAxNXB4IDIwcHg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMnB4IDRweCByZ2JhKDAsMCwwLDAuMSk7CiAgICAgICAgfQoKICAgICAgICAuaGVhZGVyIGgxIHsKICAgICAgICAgICAgZm9udC1zaXplOiAyMHB4OwogICAgICAgICAgICBjb2xvcjogIzY2N2VlYTsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogM3B4OwogICAgICAgIH0KCiAgICAgICAgLmhlYWRlciAuc3VidGl0bGUgewogICAgICAgICAgICBmb250LXNpemU6IDEycHg7CiAgICAgICAgICAgIGNvbG9yOiAjNzE4MDk2OwogICAgICAgIH0KCiAgICAgICAgLyogVEFCUyAqLwogICAgICAgIC50YWJzIHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgZ2FwOiA4cHg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgICAgICAgIGZsZXgtd3JhcDogd3JhcDsKICAgICAgICB9CgogICAgICAgIC50YWItYnV0dG9uIHsKICAgICAgICAgICAgZmxleDogMTsKICAgICAgICAgICAgbWluLXdpZHRoOiAxMjBweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICAgICAgcGFkZGluZzogMTJweCAxNnB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICAgICAgICB0cmFuc2l0aW9uOiBhbGwgMC4zcyBlYXNlOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjEpOwogICAgICAgICAgICBjb2xvcjogIzRhNTU2ODsKICAgICAgICB9CgogICAgICAgIC50YWItYnV0dG9uOmhvdmVyIHsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0ycHgpOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDRweCA4cHggcmdiYSgwLDAsMCwwLjE1KTsKICAgICAgICB9CgogICAgICAgIC50YWItYnV0dG9uLmFjdGl2ZSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICM2NjdlZWEgMCUsICM3NjRiYTIgMTAwJSk7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICB9CgogICAgICAgIC50YWItY29udGVudCB7CiAgICAgICAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICAgICAgfQoKICAgICAgICAudGFiLWNvbnRlbnQuYWN0aXZlIHsKICAgICAgICAgICAgZGlzcGxheTogYmxvY2s7CiAgICAgICAgfQoKICAgICAgICAud29ya2JlbmNoIHsKICAgICAgICAgICAgaGVpZ2h0OiBhdXRvICFpbXBvcnRhbnQ7CiAgICAgICAgICAgIG1pbi1oZWlnaHQ6IDEwMHZoOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBwYWRkaW5nOiAyMHB4OwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjEpOwogICAgICAgIH0KCiAgICAgICAgLyogUE9XRVJFRCBCWSBGT09URVIgKi8KICAgICAgICAucG93ZXJlZC1ieSB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgICAgICAgYm90dG9tOiAxMHB4OwogICAgICAgICAgICByaWdodDogMTVweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxMHB4OwogICAgICAgICAgICBjb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpOwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICB6LWluZGV4OiAxMDAwOwogICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAxcHggMnB4IHJnYmEoMCwwLDAsMC4zKTsKICAgICAgICAgICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjIpOwogICAgICAgICAgICBwYWRkaW5nOiA0cHggMTBweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgIH0KCiAgICAgICAgLyogUFJPUEVSVFkgU0VMRUNUT1IgKi8KICAgICAgICAucHJvcGVydHktYmFkZ2UgewogICAgICAgICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICAgICAgICAgIHBhZGRpbmc6IDNweCA4cHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICM2NjdlZWE7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgICAgICBmb250LXNpemU6IDEwcHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIG1hcmdpbi1sZWZ0OiA4cHg7CiAgICAgICAgfQoKICAgICAgICAvKiBERU5TRSBHUklEIExBWU9VVCAtIFJFU1BPTlNJVkUgKi8KICAgICAgICAucHJvcGVydHktZ3JpZCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDFmcjsKICAgICAgICAgICAgZ2FwOiAxNXB4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgICAgIH0KCiAgICAgICAgLnNlY3Rpb24tY29tcGFjdCB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmN2ZhZmM7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgcGFkZGluZzogMTJweDsKICAgICAgICB9CgogICAgICAgIC5zZWN0aW9uLXRpdGxlLWNvbXBhY3QgewogICAgICAgICAgICBmb250LXNpemU6IDEzcHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIGNvbG9yOiAjMmQzNzQ4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxMHB4OwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDZweDsKICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkICNlMmU4ZjA7CiAgICAgICAgICAgIHBhZGRpbmctYm90dG9tOiA1cHg7CiAgICAgICAgfQoKICAgICAgICAvKiBJTkZPIENBUkQgKi8KICAgICAgICAuaW5mby1jYXJkIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2Y3ZmFmYzsKICAgICAgICAgICAgYm9yZGVyLWxlZnQ6IDRweCBzb2xpZCAjNjY3ZWVhOwogICAgICAgICAgICBwYWRkaW5nOiAxMnB4IDE1cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgbWFyZ2luOiAxMHB4IDA7CiAgICAgICAgfQoKICAgICAgICAuaW5mby1jYXJkLXRpdGxlIHsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgY29sb3I6ICMyZDM3NDg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxM3B4OwogICAgICAgIH0KCiAgICAgICAgLmluZm8tY2FyZC1jb250ZW50IHsKICAgICAgICAgICAgY29sb3I6ICM3MTgwOTY7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgICB9CgogICAgICAgIC8qIEFWTSBDT05GSURFTkNFIEJBREdFICovCiAgICAgICAgLmF2bS1oZWFkZXIgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgICAgfQoKICAgICAgICAuY29uZmlkZW5jZS1iYWRnZSB7CiAgICAgICAgICAgIHBhZGRpbmc6IDNweCAxMHB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTBweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDAuNXB4OwogICAgICAgIH0KCiAgICAgICAgLmNvbmZpZGVuY2UtSElHSCB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICM0OGJiNzg7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICB9CgogICAgICAgIC5jb25maWRlbmNlLU1FRElVTSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNlZDg5MzY7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICB9CgogICAgICAgIC5jb25maWRlbmNlLUxPVyB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmYzgxODE7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICB9CgogICAgICAgIC5jb25maWRlbmNlLVVOS05PV04gewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjYTBhZWMwOwogICAgICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgfQoKICAgICAgICAvKiBFRElUQUJMRSBDRU5URVIgVkFMVUUgKi8KICAgICAgICAudmFsdWUtY29udHJvbCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDFmcjsKICAgICAgICAgICAgZ2FwOiAxMHB4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxMnB4OwogICAgICAgIH0KCiAgICAgICAgLnZhbHVlLWlucHV0LWdyb3VwIHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgZ2FwOiA0cHg7CiAgICAgICAgfQoKICAgICAgICAudmFsdWUtaW5wdXQtbGFiZWwgewogICAgICAgICAgICBmb250LXNpemU6IDEwcHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGNvbG9yOiAjNzE4MDk2OwogICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgIH0KCiAgICAgICAgLnZhbHVlLWlucHV0IHsKICAgICAgICAgICAgcGFkZGluZzogOHB4IDEwcHg7CiAgICAgICAgICAgIGJvcmRlcjogMnB4IHNvbGlkICNlMmU4ZjA7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICBjb2xvcjogIzJkMzc0ODsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgfQoKICAgICAgICAudmFsdWUtaW5wdXQ6Zm9jdXMgewogICAgICAgICAgICBvdXRsaW5lOiBub25lOwogICAgICAgICAgICBib3JkZXItY29sb3I6ICM2NjdlZWE7CiAgICAgICAgfQoKICAgICAgICAudmFsdWUtaW5wdXQuc3VnZ2VzdGVkIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2YwZmZmNDsKICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiAjNDhiYjc4OwogICAgICAgIH0KCiAgICAgICAgLnZhbHVlLWlucHV0LnVzZXItb3ZlcnJpZGUgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmYWYwOwogICAgICAgICAgICBib3JkZXItY29sb3I6ICNlZDg5MzY7CiAgICAgICAgfQoKICAgICAgICAvKiBERU5TRSBEQVRBIFJPV1MgKi8KICAgICAgICAuZGF0YS1yb3cgewogICAgICAgICAgICBkaXNwbGF5OiBncmlkOwogICAgICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDEwMHB4IDFmcjsKICAgICAgICAgICAgZ2FwOiA4cHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDVweCAwOwogICAgICAgICAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgI2VkZjJmNzsKICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICAgIH0KCiAgICAgICAgLmRhdGEtcm93Omxhc3QtY2hpbGQgewogICAgICAgICAgICBib3JkZXItYm90dG9tOiBub25lOwogICAgICAgIH0KCiAgICAgICAgLmRhdGEtbGFiZWwgewogICAgICAgICAgICBmb250LXNpemU6IDEwcHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGNvbG9yOiAjNzE4MDk2OwogICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgIH0KCiAgICAgICAgLmRhdGEtdmFsdWUgewogICAgICAgICAgICBmb250LXNpemU6IDEycHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGNvbG9yOiAjMmQzNzQ4OwogICAgICAgIH0KCiAgICAgICAgLmRhdGEtdmFsdWUuaGlnaGxpZ2h0IHsKICAgICAgICAgICAgY29sb3I6ICM2NjdlZWE7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgfQoKICAgICAgICAuZGF0YS12YWx1ZS53YXJuaW5nIHsKICAgICAgICAgICAgY29sb3I6ICNlZDg5MzY7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgfQoKICAgICAgICAuZGF0YS12YWx1ZS5kYW5nZXIgewogICAgICAgICAgICBjb2xvcjogI2ZjODE4MTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICB9CgogICAgICAgIC5kYXRhLXZhbHVlLnN1Y2Nlc3MgewogICAgICAgICAgICBjb2xvcjogIzQ4YmI3ODsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICB9CgogICAgICAgIC8qIENPTVBBQ1QgUFJPUEVSVFkgQ0hBUkFDVEVSSVNUSUNTICovCiAgICAgICAgLmNoYXItZ3JpZCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDQsIDFmcik7CiAgICAgICAgICAgIGdhcDogOHB4OwogICAgICAgICAgICBtYXJnaW46IDhweCAwOwogICAgICAgIH0KCiAgICAgICAgLmNoYXItaXRlbSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjZTJlOGYwOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDhweDsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgIH0KCiAgICAgICAgLmNoYXItdmFsdWUgewogICAgICAgICAgICBmb250LXNpemU6IDE1cHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIGNvbG9yOiAjMmQzNzQ4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAycHg7CiAgICAgICAgfQoKICAgICAgICAuY2hhci1sYWJlbCB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogOXB4OwogICAgICAgICAgICBjb2xvcjogIzcxODA5NjsKICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICB9CgogICAgICAgIC8qIFJJU0sgRkxBR1MgKi8KICAgICAgICAucmlzay1mbGFncyB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGZsZXgtd3JhcDogd3JhcDsKICAgICAgICAgICAgZ2FwOiA2cHg7CiAgICAgICAgICAgIG1hcmdpbjogOHB4IDA7CiAgICAgICAgfQoKICAgICAgICAucmlzay1mbGFnIHsKICAgICAgICAgICAgcGFkZGluZzogM3B4IDhweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgICAgICBmb250LXNpemU6IDlweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgICAgICB9CgogICAgICAgIC5mbGFnLWRhbmdlciB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmZmY1ZjU7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNmYzgxODE7CiAgICAgICAgICAgIGNvbG9yOiAjYzUzMDMwOwogICAgICAgIH0KCiAgICAgICAgLmZsYWctd2FybmluZyB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmZmZhZjA7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNlZDg5MzY7CiAgICAgICAgICAgIGNvbG9yOiAjNzQ0MjEwOwogICAgICAgIH0KCiAgICAgICAgLmZsYWctaW5mbyB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNlYmY4ZmY7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICM0Mjk5ZTE7CiAgICAgICAgICAgIGNvbG9yOiAjMmM1MjgyOwogICAgICAgIH0KCiAgICAgICAgLmZsYWctc3VjY2VzcyB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmMGZmZjQ7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICM0OGJiNzg7CiAgICAgICAgICAgIGNvbG9yOiAjMjI1NDNkOwogICAgICAgIH0KCiAgICAgICAgLyogRk9STSBJTlBVVFMgLSBDT01QQUNUICovCiAgICAgICAgLmZvcm0tY29tcGFjdCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDIsIDFmcik7CiAgICAgICAgICAgIGdhcDogMTBweDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMTJweDsKICAgICAgICB9CgogICAgICAgIC5mb3JtLWdyb3VwLWNvbXBhY3QgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICBnYXA6IDRweDsKICAgICAgICB9CgogICAgICAgIC5mb3JtLWxhYmVsLWNvbXBhY3QgewogICAgICAgICAgICBmb250LXNpemU6IDEwcHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGNvbG9yOiAjNzE4MDk2OwogICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgIH0KCiAgICAgICAgLmZvcm0taW5wdXQtY29tcGFjdCB7CiAgICAgICAgICAgIHBhZGRpbmc6IDhweCAxMHB4OwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjZTJlOGYwOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTNweDsKICAgICAgICB9CgogICAgICAgIC5mb3JtLWlucHV0LWNvbXBhY3Q6Zm9jdXMgewogICAgICAgICAgICBvdXRsaW5lOiBub25lOwogICAgICAgICAgICBib3JkZXItY29sb3I6ICM2NjdlZWE7CiAgICAgICAgfQoKICAgICAgICAuZm9ybS1zZWxlY3QtY29tcGFjdCB7CiAgICAgICAgICAgIHBhZGRpbmc6IDhweCAxMHB4OwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjZTJlOGYwOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTNweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICB9CgogICAgICAgIC5idG4gewogICAgICAgICAgICBwYWRkaW5nOiAxMHB4IDIwcHg7CiAgICAgICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICBmb250LXNpemU6IDE0cHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuM3MgZWFzZTsKICAgICAgICB9CgogICAgICAgIC5idG4tcHJpbWFyeSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICM2NjdlZWEgMCUsICM3NjRiYTIgMTAwJSk7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICB9CgogICAgICAgIC5idG4tcHJpbWFyeTpob3ZlciB7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMnB4KTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCA0cHggOHB4IHJnYmEoMTAyLCAxMjYsIDIzNCwgMC4zKTsKICAgICAgICB9CgogICAgICAgIC5idG4tc2Vjb25kYXJ5IHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2UyZThmMDsKICAgICAgICAgICAgY29sb3I6ICM0YTU1Njg7CiAgICAgICAgfQoKICAgICAgICAuYnRuLXNlY29uZGFyeTpob3ZlciB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNjYmQ1ZTA7CiAgICAgICAgfQoKICAgICAgICAuYnRuLWdyb3VwIHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgZ2FwOiAxMHB4OwogICAgICAgICAgICBtYXJnaW4tdG9wOiAxMnB4OwogICAgICAgICAgICBmbGV4LXdyYXA6IHdyYXA7CiAgICAgICAgfQoKICAgICAgICAubG9hZGluZyB7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgcGFkZGluZzogMzBweDsKICAgICAgICAgICAgY29sb3I6ICM3MTgwOTY7CiAgICAgICAgfQoKICAgICAgICAuc3Bpbm5lciB7CiAgICAgICAgICAgIGJvcmRlcjogNHB4IHNvbGlkICNlMmU4ZjA7CiAgICAgICAgICAgIGJvcmRlci10b3A6IDRweCBzb2xpZCAjNjY3ZWVhOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIHdpZHRoOiAzMHB4OwogICAgICAgICAgICBoZWlnaHQ6IDMwcHg7CiAgICAgICAgICAgIGFuaW1hdGlvbjogc3BpbiAxcyBsaW5lYXIgaW5maW5pdGU7CiAgICAgICAgICAgIG1hcmdpbjogMCBhdXRvIDE1cHg7CiAgICAgICAgfQoKICAgICAgICBAa2V5ZnJhbWVzIHNwaW4gewogICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDBkZWcpOyB9CiAgICAgICAgICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpOyB9CiAgICAgICAgfQoKICAgICAgICAuZXJyb3IgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmNWY1OwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjZmM4MTgxOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDEycHg7CiAgICAgICAgICAgIGNvbG9yOiAjYzUzMDMwOwogICAgICAgICAgICBtYXJnaW46IDEycHggMDsKICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICAgIH0KCiAgICAgICAgLnN1Y2Nlc3MgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjBmZmY0OwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjNjhkMzkxOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDEycHg7CiAgICAgICAgICAgIGNvbG9yOiAjMjI1NDNkOwogICAgICAgICAgICBtYXJnaW46IDEycHggMDsKICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICAgIH0KCiAgICAgICAgLyogQ09MTEFQU0lCTEUgU0VDVElPTlMgKi8KICAgICAgICAuY29sbGFwc2libGUgewogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIHVzZXItc2VsZWN0OiBub25lOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDZweDsKICAgICAgICB9CgogICAgICAgIC5jb2xsYXBzaWJsZTo6YmVmb3JlIHsKICAgICAgICAgICAgY29udGVudDogJ+KWvCc7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogOXB4OwogICAgICAgICAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4zcyBlYXNlOwogICAgICAgIH0KCiAgICAgICAgLmNvbGxhcHNpYmxlLmNvbGxhcHNlZDo6YmVmb3JlIHsKICAgICAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoLTkwZGVnKTsKICAgICAgICB9CgogICAgICAgIC5jb2xsYXBzaWJsZS1jb250ZW50IHsKICAgICAgICAgICAgbWF4LWhlaWdodDogMjAwMHB4OwogICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgICAgICB0cmFuc2l0aW9uOiBtYXgtaGVpZ2h0IDAuM3MgZWFzZTsKICAgICAgICB9CgogICAgICAgIC5jb2xsYXBzaWJsZS1jb250ZW50LmhpZGRlbiB7CiAgICAgICAgICAgIG1heC1oZWlnaHQ6IDA7CiAgICAgICAgfQoKICAgICAgICAvKiBNT0JJTEUgUkVTUE9OU0lWRSAtIFRPVUNIIEZSSUVORExZICovCiAgICAgICAgQG1lZGlhIChtYXgtd2lkdGg6IDc2OHB4KSB7CiAgICAgICAgICAgIGJvZHkgewogICAgICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICAgICAgICAgICAgdG91Y2gtYWN0aW9uOiBtYW5pcHVsYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC5wcm9wZXJ0eS1ncmlkIHsKICAgICAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyOwogICAgICAgICAgICAgICAgZ2FwOiAxMnB4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAuY2hhci1ncmlkIHsKICAgICAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDIsIDFmcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC5mb3JtLWNvbXBhY3QgewogICAgICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC5jb250YWluZXIgewogICAgICAgICAgICAgICAgcGFkZGluZzogMTBweDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLndvcmtiZW5jaCB7CiAgICAgICAgICAgIGhlaWdodDogYXV0byAhaW1wb3J0YW50OwogICAgICAgICAgICBtaW4taGVpZ2h0OiAxMDB2aDsKICAgICAgICAgICAgICAgIHBhZGRpbmc6IDE1cHg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC52YWx1ZS1jb250cm9sIHsKICAgICAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAudGFiLWJ1dHRvbiB7CiAgICAgICAgICAgICAgICBmb250LXNpemU6IDEycHg7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiAxMHB4IDEycHg7CiAgICAgICAgICAgICAgICBtaW4td2lkdGg6IDkwcHg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC5idG4gewogICAgICAgICAgICAgICAgcGFkZGluZzogMTJweCAyMHB4OwogICAgICAgICAgICAgICAgZm9udC1zaXplOiAxNXB4OwogICAgICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC5idG4tZ3JvdXAgewogICAgICAgICAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLmZvcm0taW5wdXQtY29tcGFjdCwKICAgICAgICAgICAgLmZvcm0tc2VsZWN0LWNvbXBhY3QsCiAgICAgICAgICAgIC52YWx1ZS1pbnB1dCB7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiAxMHB4IDEycHg7CiAgICAgICAgICAgICAgICBmb250LXNpemU6IDE2cHg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC5kYXRhLXJvdyB7CiAgICAgICAgICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDkwcHggMWZyOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICAgIDxkaXYgY2xhc3M9ImNvbnRhaW5lciI+CiAgICAgICAgPGRpdiBjbGFzcz0iaGVhZGVyIj4KICAgICAgICAgICAgPGgxPvCfjq8gQ01BIFdvcmtiZW5jaDwvaDE+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN1YnRpdGxlIj5BVFRPTSBJbnRlbGxpZ2VuY2UgfCBMZWFkOiA8c3BhbiBpZD0ibGVhZE5hbWUiPkxvYWRpbmcuLi48L3NwYW4+PC9kaXY+CiAgICAgICAgPC9kaXY+CgogICAgICAgIDwhLS0gVEFCUyAtLT4KICAgICAgICA8ZGl2IGNsYXNzPSJ0YWJzIj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0idGFiLWJ1dHRvbiBhY3RpdmUiIG9uY2xpY2s9InN3aXRjaFRhYigncHJvcGVydHktaW50ZWwnKSI+CiAgICAgICAgICAgICAgICDwn5OKIFByb3BlcnR5IEludGVsCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJ0YWItYnV0dG9uIiBvbmNsaWNrPSJzd2l0Y2hUYWIoJ2NtYS1nZW5lcmF0b3InKSI+CiAgICAgICAgICAgICAgICDwn4+gIENNQSBHZW5lcmF0b3IKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InRhYi1idXR0b24iIG9uY2xpY2s9InN3aXRjaFRhYignY29tcGFyYWJsZXMnKSI+CiAgICAgICAgICAgICAgICDwn5OIIENvbXBhcmFibGVzCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgIDwvZGl2PgoKICAgICAgICA8ZGl2IGNsYXNzPSJ3b3JrYmVuY2giPgogICAgICAgICAgICA8IS0tIFRBQiAxOiBQUk9QRVJUWSBJTlRFTExJR0VOQ0UgLS0+CiAgICAgICAgICAgIDxkaXYgaWQ9InByb3BlcnR5LWludGVsIiBjbGFzcz0idGFiLWNvbnRlbnQgYWN0aXZlIj4KICAgICAgICAgICAgICAgIDwhLS0gUFJPUEVSVFkgU0VMRUNUT1IgKHNob3duIGlmIG11bHRpcGxlIHByb3BlcnRpZXMpIC0tPgogICAgICAgICAgICAgICAgPGRpdiBpZD0icHJvcGVydHlTZWxlY3RvciIgY2xhc3M9InNlY3Rpb24tY29tcGFjdCIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7IG1hcmdpbi1ib3R0b206IDE1cHg7Ij4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLXRpdGxlLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgICAgICAgICDwn4+Y77iPIFNlbGVjdCBQcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0icHJvcGVydHlDb3VudCIgY2xhc3M9InByb3BlcnR5LWJhZGdlIj4wIHByb3BlcnRpZXM8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPHNlbGVjdCBpZD0icHJvcGVydHlEcm9wZG93biIgY2xhc3M9ImZvcm0tc2VsZWN0LWNvbXBhY3QiIG9uY2hhbmdlPSJsb2FkU2VsZWN0ZWRQcm9wZXJ0eSgpIj4KICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj4tLSBTZWxlY3QgYSBwcm9wZXJ0eSAtLTwvb3B0aW9uPgogICAgICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tc2Vjb25kYXJ5IiBvbmNsaWNrPSJzaG93TWFudWFsRW50cnkoKSIgc3R5bGU9Im1hcmdpbi10b3A6IDEwcHg7IHdpZHRoOiAxMDAlOyI+CiAgICAgICAgICAgICAgICAgICAgICAgIOKelSBBZGQgTmV3IFByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICA8IS0tIFNFQ1RJT04gMTogU1VCSkVDVCBQUk9QRVJUWSBBRERSRVNTIC0tPgogICAgICAgICAgICAgICAgPGRpdiBpZD0ibWFudWFsQWRkcmVzc1NlY3Rpb24iIGNsYXNzPSJzZWN0aW9uLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUtY29tcGFjdCI+8J+TjSBTdWJqZWN0IFByb3BlcnR5IEFkZHJlc3M8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwLWNvbXBhY3QiIHN0eWxlPSJncmlkLWNvbHVtbjogMSAvIC0xOyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iZm9ybS1sYWJlbC1jb21wYWN0Ij5GdWxsIEFkZHJlc3MgKENpdHksIFN0YXRlLCBaSVAgcmVxdWlyZWQpPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT0idGV4dCIgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZD0ic3ViamVjdEFkZHJlc3MiIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3M9ImZvcm0taW5wdXQtY29tcGFjdCIgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj0iMTIzIE1haW4gU3QsIFBvdWdoa2VlcHNpZSwgTlkgMTI2MDEiCiAgICAgICAgICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXByaW1hcnkiIG9uY2xpY2s9ImxvYWRQcm9wZXJ0eURhdGEoKSIgc3R5bGU9Im1hcmdpbi10b3A6IDEwcHg7IHdpZHRoOiAxMDAlOyI+CiAgICAgICAgICAgICAgICAgICAgICAgIPCflI0gTG9hZCBBVFRPTSBJbnRlbGxpZ2VuY2UKICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImxvYWRpbmdJbmRpY2F0b3IiIGNsYXNzPSJsb2FkaW5nIiBzdHlsZT0iZGlzcGxheTogbm9uZTsiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNwaW5uZXIiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXY+TG9hZGluZyBwcm9wZXJ0eSBpbnRlbGxpZ2VuY2UuLi48L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImVycm9yTWVzc2FnZSIgY2xhc3M9ImVycm9yIiBzdHlsZT0iZGlzcGxheTogbm9uZTsiPjwvZGl2PgoKICAgICAgICAgICAgICAgIDwhLS0gUFJPUEVSVFkgSU5URUxMSUdFTkNFIEdSSUQgKEhpZGRlbiB1bnRpbCBkYXRhIGxvYWRlZCkgLS0+CiAgICAgICAgICAgICAgICA8ZGl2IGlkPSJwcm9wZXJ0eUludGVsbGlnZW5jZSIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7IG1pbi1oZWlnaHQ6IDYwMHB4OyBvdmVyZmxvdy15OiBhdXRvOyBtYXgtaGVpZ2h0OiBjYWxjKDEwMHZoIC0gMzAwcHgpOyI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvcGVydHktZ3JpZCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDwhLS0gTEVGVCBDT0xVTU46IEFWTSAmIFZBTFVBVElPTiAtLT4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi1jb21wYWN0Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImF2bS1oZWFkZXIiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUtY29tcGFjdCI+8J+SsCBBVk08L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0iYXZtQ29uZmlkZW5jZUJhZGdlIiBjbGFzcz0iY29uZmlkZW5jZS1iYWRnZSBjb25maWRlbmNlLVVOS05PV04iPlVOS05PV048L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8IS0tIEVESVRBQkxFIENFTlRFUiBWQUxVRSAtLT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InZhbHVlLWNvbnRyb2wiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InZhbHVlLWlucHV0LWdyb3VwIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJ2YWx1ZS1pbnB1dC1sYWJlbCI+QVRUT00gU3VnZ2VzdGVkPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT0idGV4dCIgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZD0iYXZtU3VnZ2VzdGVkVmFsdWUiIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3M9InZhbHVlLWlucHV0IHN1Z2dlc3RlZCIgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkb25seQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9IiQwIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idmFsdWUtaW5wdXQtZ3JvdXAiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9InZhbHVlLWlucHV0LWxhYmVsIj5Zb3VyIENlbnRlciBWYWx1ZTwvbGFiZWw+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU9InRleHQiIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ9ImNlbnRlclZhbHVlIiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzPSJ2YWx1ZS1pbnB1dCB1c2VyLW92ZXJyaWRlIiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyPSJPdmVycmlkZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uY2hhbmdlPSJ1cGRhdGVDZW50ZXJWYWx1ZSgpIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPkNvbmZpZGVuY2U8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImF2bVNjb3JlIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+UmFuZ2U8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImF2bVJhbmdlIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+QVZNIERhdGU8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImF2bURhdGUiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICAgICAgICAgIDwhLS0gUklHSFQgQ09MVU1OOiBTQUxFUyBISVNUT1JZIC0tPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi10aXRsZS1jb21wYWN0Ij7wn5OIIFNhbGVzICYgVmVsb2NpdHk8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+TGFzdCBTYWxlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJsYXN0U2FsZURhdGUiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5TYWxlIFByaWNlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJsYXN0U2FsZVByaWNlIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+UHJpY2UvU3FGdDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0icHJpY2VQZXJTcWZ0IiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+QXBwcmVjaWF0aW9uPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJhcHByZWNpYXRpb24iIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5WZWxvY2l0eTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ibWFya2V0VmVsb2NpdHkiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICAgICAgPCEtLSBQUk9QRVJUWSBDSEFSQUNURVJJU1RJQ1MgLSBDT01QQUNUIC0tPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tY29tcGFjdCIgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE1cHg7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi10aXRsZS1jb21wYWN0Ij7wn4+gIFByb3BlcnR5IENoYXJhY3RlcmlzdGljczwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWdyaWQiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1pdGVtIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJjaGFyQmVkcyIgY2xhc3M9ImNoYXItdmFsdWUiPi0tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1sYWJlbCI+QmVkczwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImNoYXJCYXRocyIgY2xhc3M9ImNoYXItdmFsdWUiPi0tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1sYWJlbCI+QmF0aHM8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1pdGVtIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJjaGFyU3FmdCIgY2xhc3M9ImNoYXItdmFsdWUiPi0tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1sYWJlbCI+U3FGdDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImNoYXJBY3JlcyIgY2xhc3M9ImNoYXItdmFsdWUiPi0tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1sYWJlbCI+QWNyZXM8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1pdGVtIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJjaGFyR2FyYWdlIiBjbGFzcz0iY2hhci12YWx1ZSI+LS08L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWxhYmVsIj5HYXJhZ2U8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1pdGVtIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJjaGFyVHlwZSIgY2xhc3M9ImNoYXItdmFsdWUiPi0tPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hhci1sYWJlbCI+VHlwZTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImNoYXJZZWFyIiBjbGFzcz0iY2hhci12YWx1ZSI+LS08L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWxhYmVsIj5CdWlsdDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGFyLWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImNoYXJDb25kaXRpb24iIGNsYXNzPSJjaGFyLXZhbHVlIj4tLTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNoYXItbGFiZWwiPkNvbmRpdGlvbjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgICAgICA8IS0tIEVRVUlUWSAmIE9XTkVSIElOVEVMTElHRU5DRSAtLT4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcm9wZXJ0eS1ncmlkIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi1jb21wYWN0Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUtY29tcGFjdCI+8J+StSBFcXVpdHkgSW50ZWxsaWdlbmNlPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPkVxdWl0eSAkPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJlcXVpdHlEb2xsYXJzIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+RXF1aXR5ICU8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImVxdWl0eVBlcmNlbnQiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5MVFYgUmF0aW88L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9Imx0dlJhdGlvIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+U3RhdHVzPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJlcXVpdHlTdGF0dXMiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLXRpdGxlLWNvbXBhY3QiPvCfkaQgT3duZXIgSW50ZWw8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+T3duZXI8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9Im93bmVyTmFtZSIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPlR5cGU8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9Im93bmVyVHlwZSIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPlllYXJzIE93bmVkPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJvd25lcnNoaXBMZW5ndGgiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0ib3duZXJGbGFncyIgY2xhc3M9InJpc2stZmxhZ3MiIHN0eWxlPSJtYXJnaW4tdG9wOiA2cHg7Ij48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAgICAgIDwhLS0gUklTSyAmIEVOVklST05NRU5UQUwgLS0+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvcGVydHktZ3JpZCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLXRpdGxlLWNvbXBhY3QiPvCfjI0gRW52aXJvbm1lbnRhbDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5GbG9vZCBab25lPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJmbG9vZFpvbmUiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5GbG9vZCBSaXNrPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJmbG9vZFJpc2siIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iZW52aXJvbm1lbnRhbEZsYWdzIiBjbGFzcz0icmlzay1mbGFncyIgc3R5bGU9Im1hcmdpbi10b3A6IDZweDsiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLXRpdGxlLWNvbXBhY3QiPvCfj6sgU2Nob29sczwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5EaXN0cmljdDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ic2Nob29sRGlzdHJpY3QiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5FbGVtZW50YXJ5PC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJzY2hvb2xFbGVtZW50YXJ5IiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+SGlnaCBTY2hvb2w8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9InNjaG9vbEhpZ2giIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICAgICAgPCEtLSBESVNUUkVTUyBGTEFHUyAoSWYgYW55KSAtLT4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJkaXN0cmVzc1NlY3Rpb24iIGNsYXNzPSJzZWN0aW9uLWNvbXBhY3QiIHN0eWxlPSJkaXNwbGF5OiBub25lOyBtYXJnaW4tYm90dG9tOiAxNXB4OyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUtY29tcGFjdCI+4pqg77iPIERpc3RyZXNzIEluZGljYXRvcnM8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iZGlzdHJlc3NGbGFncyIgY2xhc3M9InJpc2stZmxhZ3MiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJkaXN0cmVzc0RldGFpbHMiIHN0eWxlPSJtYXJnaW4tdG9wOiA4cHg7IGZvbnQtc2l6ZTogMTFweDsgY29sb3I6ICM0YTU1Njg7Ij48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICAgICAgPCEtLSBDT0xMQVBTSUJMRTogQURESVRJT05BTCBERVRBSUxTIC0tPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tdGl0bGUtY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICDwn5OLIEFkZGl0aW9uYWwgRGV0YWlscwogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iYWRkaXRpb25hbERldGFpbHMiIHN0eWxlPSJkaXNwbGF5OiBibG9jazsgbWFyZ2luLXRvcDogMTBweDsiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5TdG9yaWVzPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJkZXRhaWxTdG9yaWVzIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+UXVhbGl0eTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0iZGV0YWlsUXVhbGl0eSIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPlBvb2w8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImRldGFpbFBvb2wiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5GaXJlcGxhY2U8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImRldGFpbEZpcmVwbGFjZSIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJkYXRhLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImRhdGEtbGFiZWwiPkhlYXRpbmc8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImRldGFpbEhlYXRpbmciIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5Db29saW5nPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJkZXRhaWxDb29saW5nIiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+VGF4IEFtb3VudDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0iZGV0YWlsVGF4QW1vdW50IiBjbGFzcz0iZGF0YS12YWx1ZSI+LS08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRhdGEtcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZGF0YS1sYWJlbCI+VGF4L1NxRnQ8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImRldGFpbFRheFBlclNxZnQiIGNsYXNzPSJkYXRhLXZhbHVlIj4tLTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGF0YS1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJkYXRhLWxhYmVsIj5BVFRPTSBJRDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0iZGV0YWlsQXR0b21JZCIgY2xhc3M9ImRhdGEtdmFsdWUiPi0tPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPCEtLSBUQUIgMjogQ01BIEdFTkVSQVRPUiAtLT4KICAgICAgICAgICAgPGRpdiBpZD0iY21hLWdlbmVyYXRvciIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi10aXRsZS1jb21wYWN0Ij7wn5OKIEdlbmVyYXRlIENNQSBSZXBvcnQ8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsLWNvbXBhY3QiPlNlYXJjaCBSYWRpdXMgKG1pbGVzKTwvbGFiZWw+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0iY21hUmFkaXVzIiBjbGFzcz0iZm9ybS1pbnB1dC1jb21wYWN0IiB2YWx1ZT0iMyIgbWluPSIxIiBtYXg9IjEwIj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAtY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwtY29tcGFjdCI+RGF5cyBCYWNrPC9sYWJlbD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJjbWFEYXlzQmFjayIgY2xhc3M9ImZvcm0taW5wdXQtY29tcGFjdCIgdmFsdWU9IjE4MCIgbWluPSIzMCIgbWF4PSI3MzAiPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cC1jb21wYWN0Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iZm9ybS1sYWJlbC1jb21wYWN0Ij5NYXggQ29tcGFyYWJsZXM8L2xhYmVsPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgaWQ9ImNtYU1heENvbXBzIiBjbGFzcz0iZm9ybS1pbnB1dC1jb21wYWN0IiB2YWx1ZT0iMTAiIG1pbj0iMyIgbWF4PSIyMCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwLWNvbXBhY3QiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsLWNvbXBhY3QiPlByaWNlIFZhcmlhbmNlICglKTwvbGFiZWw+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0iY21hUHJpY2VWYXJpYW5jZSIgY2xhc3M9ImZvcm0taW5wdXQtY29tcGFjdCIgdmFsdWU9IjI1IiBtaW49IjEwIiBtYXg9IjUwIj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYnRuLWdyb3VwIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1wcmltYXJ5IiBvbmNsaWNrPSJnZW5lcmF0ZUNNQSgpIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIPCfk4ogR2VuZXJhdGUgQ01BIFJlcG9ydAogICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1zZWNvbmRhcnkiIG9uY2xpY2s9ImV4cG9ydERhdGEoKSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICDwn5K+IEV4cG9ydCB0byBGVUIKICAgICAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8IS0tIFRBQiAzOiBDT01QQVJBQkxFUyAoUExBQ0VIT0xERVIpIC0tPgogICAgICAgICAgICA8ZGl2IGlkPSJjb21wYXJhYmxlcyIgY2xhc3M9InRhYi1jb250ZW50Ij4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tY29tcGFjdCI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi10aXRsZS1jb21wYWN0Ij7wn5OIIENvbXBhcmFibGUgUHJvcGVydGllczwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImluZm8tY2FyZCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImluZm8tY2FyZC10aXRsZSI+Q29taW5nIFNvb248L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaW5mby1jYXJkLWNvbnRlbnQiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyB0YWIgd2lsbCBkaXNwbGF5IGNvbXBhcmFibGUgcHJvcGVydGllcyBmcm9tIENsb3VkQ01BIGFmdGVyIENNQSBnZW5lcmF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgIDwvZGl2PgoKICAgIDwhLS0gUG93ZXJlZCBCeSBGb290ZXIgLS0+CiAgICA8ZGl2IGNsYXNzPSJwb3dlcmVkLWJ5Ij5Qb3dlcmVkIGJ5IFdJTExPVzwvZGl2PgoKICAgIDxzY3JpcHQ+CiAgICAgICAgbGV0IGN1cnJlbnRQcm9wZXJ0eURhdGEgPSBudWxsOwogICAgICAgIGxldCBmdWJDb250ZXh0ID0gbnVsbDsKICAgICAgICBsZXQgZGV0ZWN0ZWRQcm9wZXJ0aWVzID0gW107CiAgICAgICAgbGV0IGNtYUhpc3RvcnkgPSBbXTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSBGVUIgZW1iZWRkZWQgYXBwCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBhc3luYyBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZ1YkNvbnRleHQgPSBhd2FpdCBGVUIuZ2V0Q29udGV4dCgpOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0ZVQiBDb250ZXh0OicsIGZ1YkNvbnRleHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoZnViQ29udGV4dCAmJiBmdWJDb250ZXh0LnBlcnNvbikgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsZWFkTmFtZScpLnRleHRDb250ZW50ID0gCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1YkNvbnRleHQucGVyc29uLm5hbWUgfHwgJ1Vua25vd24gTGVhZCc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gRGV0ZWN0IG11bHRpcGxlIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgICAgICBhd2FpdCBkZXRlY3RQcm9wZXJ0aWVzKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBGVUIgY29udGV4dDonLCBlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gRGV0ZWN0IHByb3BlcnRpZXMgZnJvbSBGVUIgcmVjb3JkCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gZGV0ZWN0UHJvcGVydGllcygpIHsKICAgICAgICAgICAgaWYgKCFmdWJDb250ZXh0IHx8ICFmdWJDb250ZXh0LnBlcnNvbikgcmV0dXJuOwoKICAgICAgICAgICAgY29uc3QgcGVyc29uID0gZnViQ29udGV4dC5wZXJzb247CiAgICAgICAgICAgIGNvbnN0IGFkZHJlc3NlcyA9IFtdOwoKICAgICAgICAgICAgLy8gMS4gU2NhbiBzdGFuZGFyZCBGVUIgYWRkcmVzcyBmaWVsZHMKICAgICAgICAgICAgaWYgKHBlcnNvbi5hZGRyZXNzZXMgJiYgQXJyYXkuaXNBcnJheShwZXJzb24uYWRkcmVzc2VzKSkgewogICAgICAgICAgICAgICAgcGVyc29uLmFkZHJlc3Nlcy5mb3JFYWNoKGFkZHIgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChhZGRyLnN0cmVldCAmJiBhZGRyLmNpdHkgJiYgYWRkci5zdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmdWxsQWRkciA9IGAke2FkZHIuc3RyZWV0fSwgJHthZGRyLmNpdHl9LCAke2FkZHIuc3RhdGV9ICR7YWRkci56aXAgfHwgJyd9YC50cmltKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3Nlcy5wdXNoKGZ1bGxBZGRyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMi4gU2NhbiBXSUxMT1cgQ01BIGhpc3RvcnkgYWRkcmVzcwogICAgICAgICAgICBpZiAocGVyc29uLmN1c3RvbVdJTExPV0NNQUFkZHJlc3MpIHsKICAgICAgICAgICAgICAgIGFkZHJlc3Nlcy5wdXNoKHBlcnNvbi5jdXN0b21XSUxMT1dDTUFBZGRyZXNzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gMy4gU2NhbiBGZWxsbyBwcm9wZXJ0eSBhZGRyZXNzZXMgKGlmIGF2YWlsYWJsZSkKICAgICAgICAgICAgaWYgKHBlcnNvbi5jdXN0b21GZWxsb1Byb3BlcnR5QWRkcmVzcykgewogICAgICAgICAgICAgICAgYWRkcmVzc2VzLnB1c2gocGVyc29uLmN1c3RvbUZlbGxvUHJvcGVydHlBZGRyZXNzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gNC4gUGFyc2UgQ01BIGhpc3RvcnkgZnJvbSBub3RlcyAoaWYgYXZhaWxhYmxlKQogICAgICAgICAgICBhd2FpdCBwYXJzZUNNQUhpc3RvcnlGcm9tTm90ZXMoKTsKCiAgICAgICAgICAgIC8vIERlZHVwbGljYXRlIGFkZHJlc3NlcwogICAgICAgICAgICBkZXRlY3RlZFByb3BlcnRpZXMgPSBbLi4ubmV3IFNldChhZGRyZXNzZXMpXS5maWx0ZXIoYWRkciA9PiBhZGRyICYmIGFkZHIubGVuZ3RoID4gMTApOwoKICAgICAgICAgICAgY29uc29sZS5sb2coJ0RldGVjdGVkIHByb3BlcnRpZXM6JywgZGV0ZWN0ZWRQcm9wZXJ0aWVzKTsKCiAgICAgICAgICAgIC8vIFNob3cgcHJvcGVydHkgc2VsZWN0b3IgaWYgbXVsdGlwbGUgcHJvcGVydGllcwogICAgICAgICAgICBpZiAoZGV0ZWN0ZWRQcm9wZXJ0aWVzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIHNob3dQcm9wZXJ0eVNlbGVjdG9yKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGV0ZWN0ZWRQcm9wZXJ0aWVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgLy8gQXV0by1maWxsIHNpbmdsZSBwcm9wZXJ0eQogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1YmplY3RBZGRyZXNzJykudmFsdWUgPSBkZXRlY3RlZFByb3BlcnRpZXNbMF07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFBhcnNlIENNQSBoaXN0b3J5IGZyb20gRlVCIG5vdGVzCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gcGFyc2VDTUFIaXN0b3J5RnJvbU5vdGVzKCkgewogICAgICAgICAgICAvLyBUT0RPOiBJbXBsZW1lbnQgbm90ZSBwYXJzaW5nIHdoZW4gYXZhaWxhYmxlCiAgICAgICAgICAgIC8vIFdpbGwgbG9vayBmb3Igc3RydWN0dXJlZCBDTUEgaGlzdG9yeSBpbiBub3RlcwogICAgICAgIH0KCiAgICAgICAgLy8gU2hvdyBwcm9wZXJ0eSBzZWxlY3RvciBkcm9wZG93bgogICAgICAgIGZ1bmN0aW9uIHNob3dQcm9wZXJ0eVNlbGVjdG9yKCkgewogICAgICAgICAgICBjb25zdCBzZWxlY3RvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9wZXJ0eVNlbGVjdG9yJyk7CiAgICAgICAgICAgIGNvbnN0IGRyb3Bkb3duID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb3BlcnR5RHJvcGRvd24nKTsKICAgICAgICAgICAgY29uc3QgY291bnRCYWRnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9wZXJ0eUNvdW50Jyk7CgogICAgICAgICAgICAvLyBDbGVhciBleGlzdGluZyBvcHRpb25zCiAgICAgICAgICAgIGRyb3Bkb3duLmlubmVySFRNTCA9ICc8b3B0aW9uIHZhbHVlPSIiPi0tIFNlbGVjdCBhIHByb3BlcnR5IC0tPC9vcHRpb24+JzsKCiAgICAgICAgICAgIC8vIEFkZCBkZXRlY3RlZCBwcm9wZXJ0aWVzCiAgICAgICAgICAgIGRldGVjdGVkUHJvcGVydGllcy5mb3JFYWNoKChhZGRyLCBpbmRleCkgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7CiAgICAgICAgICAgICAgICBvcHRpb24udmFsdWUgPSBhZGRyOwogICAgICAgICAgICAgICAgb3B0aW9uLnRleHRDb250ZW50ID0gYWRkcjsKICAgICAgICAgICAgICAgIGRyb3Bkb3duLmFwcGVuZENoaWxkKG9wdGlvbik7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gVXBkYXRlIGNvdW50IGJhZGdlCiAgICAgICAgICAgIGNvdW50QmFkZ2UudGV4dENvbnRlbnQgPSBgJHtkZXRlY3RlZFByb3BlcnRpZXMubGVuZ3RofSBwcm9wZXJ0aWVzYDsKCiAgICAgICAgICAgIC8vIFNob3cgc2VsZWN0b3IKICAgICAgICAgICAgc2VsZWN0b3Iuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgfQoKICAgICAgICAvLyBMb2FkIHNlbGVjdGVkIHByb3BlcnR5IGZyb20gZHJvcGRvd24KICAgICAgICBmdW5jdGlvbiBsb2FkU2VsZWN0ZWRQcm9wZXJ0eSgpIHsKICAgICAgICAgICAgY29uc3QgZHJvcGRvd24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJvcGVydHlEcm9wZG93bicpOwogICAgICAgICAgICBjb25zdCBzZWxlY3RlZEFkZHJlc3MgPSBkcm9wZG93bi52YWx1ZTsKCiAgICAgICAgICAgIGlmIChzZWxlY3RlZEFkZHJlc3MpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdWJqZWN0QWRkcmVzcycpLnZhbHVlID0gc2VsZWN0ZWRBZGRyZXNzOwogICAgICAgICAgICAgICAgbG9hZFByb3BlcnR5RGF0YSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBTaG93IG1hbnVhbCBhZGRyZXNzIGVudHJ5CiAgICAgICAgZnVuY3Rpb24gc2hvd01hbnVhbEVudHJ5KCkgewogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3ViamVjdEFkZHJlc3MnKS52YWx1ZSA9ICcnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3ViamVjdEFkZHJlc3MnKS5mb2N1cygpOwogICAgICAgIH0KCiAgICAgICAgLy8gU3dpdGNoIGJldHdlZW4gdGFicwogICAgICAgIGZ1bmN0aW9uIHN3aXRjaFRhYih0YWJJZCkgewogICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiLWNvbnRlbnQnKS5mb3JFYWNoKHRhYiA9PiB7CiAgICAgICAgICAgICAgICB0YWIuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRhYi1idXR0b24nKS5mb3JFYWNoKGJ1dHRvbiA9PiB7CiAgICAgICAgICAgICAgICBidXR0b24uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGFiSWQpLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICBldmVudC50YXJnZXQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQoKICAgICAgICAvLyBMb2FkIHByb3BlcnR5IGRhdGEgZnJvbSBBVFRPTSBBUEkKICAgICAgICBhc3luYyBmdW5jdGlvbiBsb2FkUHJvcGVydHlEYXRhKCkgewogICAgICAgICAgICBjb25zdCBhZGRyZXNzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1YmplY3RBZGRyZXNzJykudmFsdWUudHJpbSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFhZGRyZXNzKSB7CiAgICAgICAgICAgICAgICBhbGVydCgnUGxlYXNlIGVudGVyIGEgcHJvcGVydHkgYWRkcmVzcycpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZ0luZGljYXRvcicpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXJyb3JNZXNzYWdlJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb3BlcnR5SW50ZWxsaWdlbmNlJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb25zdCBwZXJzb25JZCA9IGZ1YkNvbnRleHQ/LnBlcnNvbj8uaWQgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9IGAvLm5ldGxpZnkvZnVuY3Rpb25zL2F0dG9tLXByb3BlcnR5LWxvb2t1cD9hZGRyZXNzPSR7ZW5jb2RlVVJJQ29tcG9uZW50KGFkZHJlc3MpfSR7cGVyc29uSWQgPyAnJnBlcnNvbklkPScgKyBwZXJzb25JZCA6ICcnfWA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsKCiAgICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlLm9rIHx8ICFyZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihyZXN1bHQubWVzc2FnZSB8fCAnRmFpbGVkIHRvIGxvYWQgcHJvcGVydHkgZGF0YScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGN1cnJlbnRQcm9wZXJ0eURhdGEgPSByZXN1bHQuZGF0YTsKICAgICAgICAgICAgICAgIGN1cnJlbnRQcm9wZXJ0eURhdGEuYWRkcmVzc19xdWVyaWVkID0gYWRkcmVzczsgLy8gU3RvcmUgcXVlcmllZCBhZGRyZXNzCiAgICAgICAgICAgICAgICBkaXNwbGF5UHJvcGVydHlEYXRhKGN1cnJlbnRQcm9wZXJ0eURhdGEpOwoKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2FkaW5nSW5kaWNhdG9yJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9wZXJ0eUludGVsbGlnZW5jZScpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwoKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGxvYWRpbmcgcHJvcGVydHkgZGF0YTonLCBlcnJvcik7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZ0luZGljYXRvcicpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXJyb3JNZXNzYWdlJykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXJyb3JNZXNzYWdlJykudGV4dENvbnRlbnQgPSAKICAgICAgICAgICAgICAgICAgICAnRXJyb3I6ICcgKyBlcnJvci5tZXNzYWdlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBEaXNwbGF5IHByb3BlcnR5IGRhdGEgaW4gVUkKICAgICAgICBmdW5jdGlvbiBkaXNwbGF5UHJvcGVydHlEYXRhKGRhdGEpIHsKICAgICAgICAgICAgLy8gQVZNIFNlY3Rpb24KICAgICAgICAgICAgaWYgKGRhdGEuYXZtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzdWdnZXN0ZWRWYWx1ZSA9IGRhdGEuYXZtLnZhbHVlIHx8IDA7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXZtU3VnZ2VzdGVkVmFsdWUnKS52YWx1ZSA9IGZvcm1hdEN1cnJlbmN5KHN1Z2dlc3RlZFZhbHVlKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjZW50ZXJWYWx1ZScpLnZhbHVlID0gZm9ybWF0Q3VycmVuY3koc3VnZ2VzdGVkVmFsdWUpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NlbnRlclZhbHVlJykucGxhY2Vob2xkZXIgPSBmb3JtYXRDdXJyZW5jeShzdWdnZXN0ZWRWYWx1ZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdm1TY29yZScpLnRleHRDb250ZW50ID0gZGF0YS5hdm0uY29uZmlkZW5jZVNjb3JlIHx8ICctLSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXZtQ29uZmlkZW5jZUJhZGdlJykudGV4dENvbnRlbnQgPSBkYXRhLmF2bS5jb25maWRlbmNlTGV2ZWwgfHwgJ1VOS05PV04nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F2bUNvbmZpZGVuY2VCYWRnZScpLmNsYXNzTmFtZSA9IAogICAgICAgICAgICAgICAgICAgICdjb25maWRlbmNlLWJhZGdlIGNvbmZpZGVuY2UtJyArIChkYXRhLmF2bS5jb25maWRlbmNlTGV2ZWwgfHwgJ1VOS05PV04nKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F2bVJhbmdlJykudGV4dENvbnRlbnQgPSAKICAgICAgICAgICAgICAgICAgICBgJHtmb3JtYXRDdXJyZW5jeShkYXRhLmF2bS52YWx1ZUxvdyl9IC0gJHtmb3JtYXRDdXJyZW5jeShkYXRhLmF2bS52YWx1ZUhpZ2gpfWA7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXZtRGF0ZScpLnRleHRDb250ZW50ID0gCiAgICAgICAgICAgICAgICAgICAgZGF0YS5hdm0uZGF0ZSA/IG5ldyBEYXRlKGRhdGEuYXZtLmRhdGUpLnRvTG9jYWxlRGF0ZVN0cmluZygpIDogJy0tJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2FsZXMgSGlzdG9yeQogICAgICAgICAgICBpZiAoZGF0YS5zYWxlSGlzdG9yeSkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xhc3RTYWxlRGF0ZScpLnRleHRDb250ZW50ID0gCiAgICAgICAgICAgICAgICAgICAgZGF0YS5zYWxlSGlzdG9yeS5sYXN0U2FsZURhdGUgPyBuZXcgRGF0ZShkYXRhLnNhbGVIaXN0b3J5Lmxhc3RTYWxlRGF0ZSkudG9Mb2NhbGVEYXRlU3RyaW5nKCkgOiAnLS0nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xhc3RTYWxlUHJpY2UnKS50ZXh0Q29udGVudCA9IAogICAgICAgICAgICAgICAgICAgIGZvcm1hdEN1cnJlbmN5KGRhdGEuc2FsZUhpc3RvcnkubGFzdFNhbGVQcmljZSk7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJpY2VQZXJTcWZ0JykudGV4dENvbnRlbnQgPSAKICAgICAgICAgICAgICAgICAgICBkYXRhLnNhbGVIaXN0b3J5LnByaWNlUGVyU3FmdCA/ICckJyArIGRhdGEuc2FsZUhpc3RvcnkucHJpY2VQZXJTcWZ0IDogJy0tJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRhdGEuc2FsZUhpc3RvcnkuYXBwcmVjaWF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXBwRG9sbGFycyA9IGRhdGEuc2FsZUhpc3RvcnkuYXBwcmVjaWF0aW9uLmRvbGxhcnM7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXBwUGVyY2VudCA9IGRhdGEuc2FsZUhpc3RvcnkuYXBwcmVjaWF0aW9uLnBlcmNlbnRhZ2U7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FwcHJlY2lhdGlvbicpLmlubmVySFRNTCA9IAogICAgICAgICAgICAgICAgICAgICAgICBgPHNwYW4gY2xhc3M9IiR7YXBwRG9sbGFycyA+PSAwID8gJ3N1Y2Nlc3MnIDogJ2Rhbmdlcid9Ij4ke2Zvcm1hdEN1cnJlbmN5KGFwcERvbGxhcnMpfSAoJHthcHBQZXJjZW50fSUpPC9zcGFuPmA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHZlbG9jaXR5ID0gZGF0YS5zYWxlSGlzdG9yeS5tYXJrZXRWZWxvY2l0eSB8fCAnVU5LTk9XTic7CiAgICAgICAgICAgICAgICBjb25zdCB2ZWxvY2l0eUNsYXNzID0gdmVsb2NpdHkgPT09ICdIT1QnID8gJ2RhbmdlcicgOiB2ZWxvY2l0eSA9PT0gJ1dBUk0nID8gJ3dhcm5pbmcnIDogJ2hpZ2hsaWdodCc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFya2V0VmVsb2NpdHknKS5pbm5lckhUTUwgPSAKICAgICAgICAgICAgICAgICAgICBgPHNwYW4gY2xhc3M9IiR7dmVsb2NpdHlDbGFzc30iPiR7dmVsb2NpdHl9PC9zcGFuPmA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFByb3BlcnR5IENoYXJhY3RlcmlzdGljcwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhckJlZHMnKS50ZXh0Q29udGVudCA9IGRhdGEuYmVkcyB8fCAnLS0nOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhckJhdGhzJykudGV4dENvbnRlbnQgPSBkYXRhLmJhdGhzIHx8ICctLSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyU3FmdCcpLnRleHRDb250ZW50ID0gZGF0YS5zcWZ0ID8gZGF0YS5zcWZ0LnRvTG9jYWxlU3RyaW5nKCkgOiAnLS0nOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhckFjcmVzJykudGV4dENvbnRlbnQgPSBkYXRhLmFjcmVzIHx8ICctLSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyR2FyYWdlJykudGV4dENvbnRlbnQgPSBkYXRhLmdhcmFnZSB8fCAnLS0nOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hhclR5cGUnKS50ZXh0Q29udGVudCA9IGRhdGEucHJvcGVydHlUeXBlIHx8ICctLSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFyWWVhcicpLnRleHRDb250ZW50ID0gZGF0YS55ZWFyQnVpbHQgfHwgJy0tJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJDb25kaXRpb24nKS50ZXh0Q29udGVudCA9IGRhdGEuY29uZGl0aW9uIHx8ICctLSc7CgogICAgICAgICAgICAvLyBFcXVpdHkKICAgICAgICAgICAgaWYgKGRhdGEuZXF1aXR5KSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXF1aXR5RG9sbGFycycpLnRleHRDb250ZW50ID0gZm9ybWF0Q3VycmVuY3koZGF0YS5lcXVpdHkuZXF1aXR5RG9sbGFycyk7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXF1aXR5UGVyY2VudCcpLnRleHRDb250ZW50ID0gCiAgICAgICAgICAgICAgICAgICAgZGF0YS5lcXVpdHkuZXF1aXR5UGVyY2VudGFnZSA/IGRhdGEuZXF1aXR5LmVxdWl0eVBlcmNlbnRhZ2UgKyAnJScgOiAnLS0nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2x0dlJhdGlvJykudGV4dENvbnRlbnQgPSAKICAgICAgICAgICAgICAgICAgICBkYXRhLmVxdWl0eS5sdHZSYXRpbyA/IGRhdGEuZXF1aXR5Lmx0dlJhdGlvICsgJyUnIDogJy0tJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzID0gZGF0YS5lcXVpdHkuaXNVbmRlcndhdGVyID8gJ1VOREVSV0FURVInIDogCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmVxdWl0eS5oYXNFcXVpdHkgPyAnUE9TSVRJVkUgRVFVSVRZJyA6ICdVTktOT1dOJzsKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c0NsYXNzID0gZGF0YS5lcXVpdHkuaXNVbmRlcndhdGVyID8gJ2RhbmdlcicgOiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZXF1aXR5Lmhhc0VxdWl0eSA/ICdzdWNjZXNzJyA6ICcnOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VxdWl0eVN0YXR1cycpLmlubmVySFRNTCA9IAogICAgICAgICAgICAgICAgICAgIGA8c3BhbiBjbGFzcz0iJHtzdGF0dXNDbGFzc30iPiR7c3RhdHVzfTwvc3Bhbj5gOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPd25lciBJbnRlbGxpZ2VuY2UKICAgICAgICAgICAgaWYgKGRhdGEub3duZXIpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdvd25lck5hbWUnKS50ZXh0Q29udGVudCA9IGRhdGEub3duZXIubmFtZSB8fCAnLS0nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ293bmVyVHlwZScpLnRleHRDb250ZW50ID0gZGF0YS5vd25lci5vd25lcnNoaXBUeXBlIHx8ICctLSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnb3duZXJzaGlwTGVuZ3RoJykudGV4dENvbnRlbnQgPSAKICAgICAgICAgICAgICAgICAgICBkYXRhLm93bmVyLm93bmVyc2hpcExlbmd0aCA/IGRhdGEub3duZXIub3duZXJzaGlwTGVuZ3RoICsgJyB5ZWFycycgOiAnLS0nOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBvd25lckZsYWdzRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnb3duZXJGbGFncycpOwogICAgICAgICAgICAgICAgb3duZXJGbGFnc0VsLmlubmVySFRNTCA9ICcnOwogICAgICAgICAgICAgICAgaWYgKGRhdGEub3duZXIuaXNBYnNlbnRlZSkgewogICAgICAgICAgICAgICAgICAgIG93bmVyRmxhZ3NFbC5pbm5lckhUTUwgKz0gJzxzcGFuIGNsYXNzPSJyaXNrLWZsYWcgZmxhZy13YXJuaW5nIj5BQlNFTlRFRTwvc3Bhbj4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRhdGEub3duZXIuaXNDb3Jwb3JhdGVPd25lZCkgewogICAgICAgICAgICAgICAgICAgIG93bmVyRmxhZ3NFbC5pbm5lckhUTUwgKz0gJzxzcGFuIGNsYXNzPSJyaXNrLWZsYWcgZmxhZy1pbmZvIj5DT1JQT1JBVEU8L3NwYW4+JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRW52aXJvbm1lbnRhbAogICAgICAgICAgICBpZiAoZGF0YS5lbnZpcm9ubWVudGFsKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmxvb2Rab25lJykudGV4dENvbnRlbnQgPSBkYXRhLmVudmlyb25tZW50YWwuZmxvb2Rab25lIHx8ICctLSc7CiAgICAgICAgICAgICAgICBjb25zdCBmbG9vZFJpc2sgPSBkYXRhLmVudmlyb25tZW50YWwuZmxvb2RSaXNrIHx8ICdVTktOT1dOJzsKICAgICAgICAgICAgICAgIGNvbnN0IHJpc2tDbGFzcyA9IGZsb29kUmlzayA9PT0gJ0hJR0gnID8gJ2RhbmdlcicgOiBmbG9vZFJpc2sgPT09ICdNT0RFUkFURScgPyAnd2FybmluZycgOiAnc3VjY2Vzcyc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmxvb2RSaXNrJykuaW5uZXJIVE1MID0gCiAgICAgICAgICAgICAgICAgICAgYDxzcGFuIGNsYXNzPSIke3Jpc2tDbGFzc30iPiR7Zmxvb2RSaXNrfTwvc3Bhbj5gOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBlbnZGbGFnc0VsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Vudmlyb25tZW50YWxGbGFncycpOwogICAgICAgICAgICAgICAgZW52RmxhZ3NFbC5pbm5lckhUTUwgPSAnJzsKICAgICAgICAgICAgICAgIGlmIChmbG9vZFJpc2sgPT09ICdISUdIJykgewogICAgICAgICAgICAgICAgICAgIGVudkZsYWdzRWwuaW5uZXJIVE1MICs9ICc8c3BhbiBjbGFzcz0icmlzay1mbGFnIGZsYWctZGFuZ2VyIj5ISUdIIEZMT09EIFJJU0s8L3NwYW4+JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2Nob29scwogICAgICAgICAgICBpZiAoZGF0YS5zY2hvb2xzKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2Nob29sRGlzdHJpY3QnKS50ZXh0Q29udGVudCA9IGRhdGEuc2Nob29scy5kaXN0cmljdCB8fCAnLS0nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjaG9vbEVsZW1lbnRhcnknKS50ZXh0Q29udGVudCA9IGRhdGEuc2Nob29scy5lbGVtZW50YXJ5U2Nob29sIHx8ICctLSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2Nob29sSGlnaCcpLnRleHRDb250ZW50ID0gZGF0YS5zY2hvb2xzLmhpZ2hTY2hvb2wgfHwgJy0tJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGlzdHJlc3MgSW5kaWNhdG9ycwogICAgICAgICAgICBpZiAoZGF0YS5kaXN0cmVzcyAmJiAoZGF0YS5kaXN0cmVzcy5pc0luRm9yZWNsb3N1cmUgfHwgZGF0YS5kaXN0cmVzcy5pc1JFTykpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaXN0cmVzc1NlY3Rpb24nKS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RyZXNzRmxhZ3NFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaXN0cmVzc0ZsYWdzJyk7CiAgICAgICAgICAgICAgICBkaXN0cmVzc0ZsYWdzRWwuaW5uZXJIVE1MID0gJyc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChkYXRhLmRpc3RyZXNzLmlzSW5Gb3JlY2xvc3VyZSkgewogICAgICAgICAgICAgICAgICAgIGRpc3RyZXNzRmxhZ3NFbC5pbm5lckhUTUwgKz0gJzxzcGFuIGNsYXNzPSJyaXNrLWZsYWcgZmxhZy1kYW5nZXIiPkZPUkVDTE9TVVJFPC9zcGFuPic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZGF0YS5kaXN0cmVzcy5pc1JFTykgewogICAgICAgICAgICAgICAgICAgIGRpc3RyZXNzRmxhZ3NFbC5pbm5lckhUTUwgKz0gJzxzcGFuIGNsYXNzPSJyaXNrLWZsYWcgZmxhZy1kYW5nZXIiPlJFTzwvc3Bhbj4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZXQgZGV0YWlscyA9ICcnOwogICAgICAgICAgICAgICAgaWYgKGRhdGEuZGlzdHJlc3MuZm9yZWNsb3N1cmVEYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgZGV0YWlscyArPSBgRm9yZWNsb3N1cmU6ICR7bmV3IERhdGUoZGF0YS5kaXN0cmVzcy5mb3JlY2xvc3VyZURhdGUpLnRvTG9jYWxlRGF0ZVN0cmluZygpfTxicj5gOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRhdGEuZGlzdHJlc3MuYXVjdGlvbkRhdGUpIHsKICAgICAgICAgICAgICAgICAgICBkZXRhaWxzICs9IGBBdWN0aW9uOiAke25ldyBEYXRlKGRhdGEuZGlzdHJlc3MuYXVjdGlvbkRhdGUpLnRvTG9jYWxlRGF0ZVN0cmluZygpfWA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGlzdHJlc3NEZXRhaWxzJykuaW5uZXJIVE1MID0gZGV0YWlsczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQWRkaXRpb25hbCBEZXRhaWxzCiAgICAgICAgICAgIGlmIChkYXRhLmJ1aWxkaW5nKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlsU3RvcmllcycpLnRleHRDb250ZW50ID0gZGF0YS5idWlsZGluZy5zdG9yaWVzIHx8ICctLSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlsUXVhbGl0eScpLnRleHRDb250ZW50ID0gZGF0YS5idWlsZGluZy5xdWFsaXR5IHx8ICctLSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlsUG9vbCcpLnRleHRDb250ZW50ID0gZGF0YS5idWlsZGluZy5wb29sID8gJ1llcycgOiAnTm8nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbEZpcmVwbGFjZScpLnRleHRDb250ZW50ID0gZGF0YS5idWlsZGluZy5maXJlcGxhY2UgPyAnWWVzJyA6ICdObyc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlsSGVhdGluZycpLnRleHRDb250ZW50ID0gZGF0YS5idWlsZGluZy5oZWF0aW5nIHx8ICctLSc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlsQ29vbGluZycpLnRleHRDb250ZW50ID0gZGF0YS5idWlsZGluZy5jb29saW5nIHx8ICctLSc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChkYXRhLmFzc2Vzc21lbnQpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxUYXhBbW91bnQnKS50ZXh0Q29udGVudCA9IGZvcm1hdEN1cnJlbmN5KGRhdGEuYXNzZXNzbWVudC50YXhBbW91bnQpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbFRheFBlclNxZnQnKS50ZXh0Q29udGVudCA9IAogICAgICAgICAgICAgICAgICAgIGRhdGEuYXNzZXNzbWVudC50YXhQZXJTcWZ0ID8gJyQnICsgZGF0YS5hc3Nlc3NtZW50LnRheFBlclNxZnQgOiAnLS0nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZGF0YS5tZXRhZGF0YSkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbEF0dG9tSWQnKS50ZXh0Q29udGVudCA9IGRhdGEubWV0YWRhdGEuYXR0b21JZCB8fCAnLS0nOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBGb3JtYXQgY3VycmVuY3kKICAgICAgICBmdW5jdGlvbiBmb3JtYXRDdXJyZW5jeSh2YWx1ZSkgewogICAgICAgICAgICBpZiAoIXZhbHVlICYmIHZhbHVlICE9PSAwKSByZXR1cm4gJy0tJzsKICAgICAgICAgICAgcmV0dXJuICckJyArIE1hdGgucm91bmQodmFsdWUpLnRvTG9jYWxlU3RyaW5nKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgY2VudGVyIHZhbHVlIHdoZW4gdXNlciBlZGl0cwogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNlbnRlclZhbHVlKCkgewogICAgICAgICAgICBjb25zdCBpbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjZW50ZXJWYWx1ZScpOwogICAgICAgICAgICBpbnB1dC5jbGFzc0xpc3QuYWRkKCd1c2VyLW92ZXJyaWRlJyk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdDZW50ZXIgdmFsdWUgdXBkYXRlZDonLCBpbnB1dC52YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBUb2dnbGUgY29sbGFwc2libGUgc2VjdGlvbnMKICAgICAgICBmdW5jdGlvbiB0b2dnbGVDb2xsYXBzaWJsZShpZCkgewogICAgICAgICAgICBjb25zdCBjb250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICBjb25zdCB0cmlnZ2VyID0gY29udGVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nOwogICAgICAgICAgICAKICAgICAgICAgICAgY29udGVudC5jbGFzc0xpc3QudG9nZ2xlKCdoaWRkZW4nKTsKICAgICAgICAgICAgdHJpZ2dlci5jbGFzc0xpc3QudG9nZ2xlKCdjb2xsYXBzZWQnKTsKICAgICAgICB9CgogICAgICAgIC8vIEdlbmVyYXRlIENNQSAoZW5oYW5jZWQgd2l0aCBtdWx0aS1wcm9wZXJ0eSBzdXBwb3J0KQogICAgICAgIGFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlQ01BKCkgewogICAgICAgICAgICBpZiAoIWN1cnJlbnRQcm9wZXJ0eURhdGEpIHsKICAgICAgICAgICAgICAgIGFsZXJ0KCdQbGVhc2UgbG9hZCBwcm9wZXJ0eSBkYXRhIGZpcnN0Jyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGNlbnRlclZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NlbnRlclZhbHVlJykudmFsdWU7CiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbWFSYWRpdXMnKS52YWx1ZTsKICAgICAgICAgICAgY29uc3QgZGF5c0JhY2sgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY21hRGF5c0JhY2snKS52YWx1ZTsKICAgICAgICAgICAgY29uc3QgYWRkcmVzcyA9IGN1cnJlbnRQcm9wZXJ0eURhdGEuYWRkcmVzc19xdWVyaWVkIHx8IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdWJqZWN0QWRkcmVzcycpLnZhbHVlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXJjaGl2ZSBwcmV2aW91cyBDTUEgdG8gbm90ZXMgaWYgdGhpcyBpcyAybmQrIENNQQogICAgICAgICAgICBpZiAoZnViQ29udGV4dD8ucGVyc29uPy5jdXN0b21XSUxMT1dDTUFMaW5rKSB7CiAgICAgICAgICAgICAgICBhd2FpdCBhcmNoaXZlQ01BVG9Ob3RlcygKICAgICAgICAgICAgICAgICAgICBmdWJDb250ZXh0LnBlcnNvbi5jdXN0b21XSUxMT1dDTUFBZGRyZXNzLAogICAgICAgICAgICAgICAgICAgIGZ1YkNvbnRleHQucGVyc29uLmN1c3RvbVdJTExPV0NNQUxpbmssCiAgICAgICAgICAgICAgICAgICAgZnViQ29udGV4dC5wZXJzb24uY3VzdG9tV0lMTE9XQ01BRGF0ZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgYWxlcnQoYENNQSBHZW5lcmF0aW9uXG5cblByb3BlcnR5OiAke2FkZHJlc3N9XG5DZW50ZXIgVmFsdWU6ICR7Y2VudGVyVmFsdWV9XG5SYWRpdXM6ICR7cmFkaXVzfSBtaWxlc1xuRGF5cyBCYWNrOiAke2RheXNCYWNrfVxuXG5JbnRlZ3JhdGluZyB3aXRoIENsb3VkQ01BLi4uYCk7CiAgICAgICAgfQoKICAgICAgICAvLyBBcmNoaXZlIENNQSB0byBGVUIgbm90ZXMKICAgICAgICBhc3luYyBmdW5jdGlvbiBhcmNoaXZlQ01BVG9Ob3RlcyhhZGRyZXNzLCBsaW5rLCBkYXRlKSB7CiAgICAgICAgICAgIGlmICghZnViQ29udGV4dCB8fCAhZnViQ29udGV4dC5wZXJzb24pIHJldHVybjsKCiAgICAgICAgICAgIGNvbnN0IG5vdGVDb250ZW50ID0gYENNQSBIaXN0b3J5IEVudHJ5Ci0tLQpEYXRlOiAke2RhdGV9ClByb3BlcnR5OiAke2FkZHJlc3N9CkNNQSBMaW5rOiAke2xpbmt9ClN0YXR1czogQXJjaGl2ZWQKYDsKCiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdBcmNoaXZpbmcgQ01BIHRvIG5vdGVzOicsIG5vdGVDb250ZW50KTsKICAgICAgICAgICAgLy8gVE9ETzogSW1wbGVtZW50IEZVQiBub3RlcyBBUEkgY2FsbCB3aGVuIHJlYWR5CiAgICAgICAgfQoKICAgICAgICAvLyBFeHBvcnQgdG8gRlVCCiAgICAgICAgZnVuY3Rpb24gZXhwb3J0RGF0YSgpIHsKICAgICAgICAgICAgaWYgKCFjdXJyZW50UHJvcGVydHlEYXRhKSB7CiAgICAgICAgICAgICAgICBhbGVydCgnUGxlYXNlIGxvYWQgcHJvcGVydHkgZGF0YSBmaXJzdCcpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBhbGVydCgnRXhwb3J0aW5nIHByb3BlcnR5IGludGVsbGlnZW5jZSB0byBGVUIgY3VzdG9tIGZpZWxkcy4uLicpOwogICAgICAgIH0KICAgIDwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4K';
            const html = Buffer.from(htmlBase64, 'base64').toString('utf8');
            
            return {
                statusCode: 200,
                headers: {
                    'Content-Type': 'text/html',
                    'Access-Control-Allow-Origin': '*'
                },
                body: html
            };
        }

        // Route to appropriate API handler
        switch (action) {
            case 'getPersonData':
                return await getPersonData(params.personId, headers);
            
            case 'generateCMA':
                return await generateCMA(params, headers);
            
            case 'getHomebeatData':
                return await getHomebeatData(params.personId, headers);
            
            case 'resendHomebeat':
                return await resendHomebeat(params, headers);
            
            case 'createTask':
                return await createTask(params, headers);
            
            case 'createManualAction':
                return await createManualAction(params, headers);
            
            default:
                return {
                    statusCode: 400,
                    headers,
                    body: JSON.stringify({ error: 'Invalid action' })
                };
        }

    } catch (error) {
        console.error('Function error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: error.message })
        };
    }
};

// Get person data from FUB
async function getPersonData(personId, headers) {
    try {
        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);
        
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify(personData)
        };
    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to fetch person data: ' + error.message })
        };
    }
}

// Generate CMA with CloudCMA API
async function generateCMA(params, headers) {
    try {
        const {
            personId,
            address,
            beds,
            baths,
            sqft,
            radius,
            monthsBack,
            minListings,
            propType,
            title,
            createHomebeat,
            homebeatFrequency
        } = params;

        // Get person data for lead info
        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);

        // Build CMA URL
        const cmaParams = new URLSearchParams({
            api_key: CLOUDCMA_API_KEY,
            address: address,
            beds: beds || '',
            baths: baths || '',
            sqft: sqft || '',
            radius: radius || '0.75',
            months_back: monthsBack || '9',
            min_listings: minListings || '10',
            prop_type: propType || '',
            title: title || `${personData.name || 'Client'} - ${address}`,
            callback_url: WEBHOOK_URL
        });

        const cmaUrl = `https://cloudcma.com/cmas/new?${cmaParams.toString()}`;

        // Update FUB custom fields
        const updatePayload = {
            customWILLOWCMADate: new Date().toISOString(),
            customWILLOWCMAAddress: address,
            customWILLOWCMALink: cmaUrl
        };

        await fubAPIRequest('PUT', `/v1/people/${personId}`, updatePayload);

        // Create FUB activity
        await fubAPIRequest('POST', '/v1/events', {
            person_id: parseInt(personId),
            type: 'Note',
            body: `CMA generated for ${address}. Parameters: ${beds}bd/${baths}ba, ${sqft}sqft, ${radius}mi radius, ${monthsBack}mo back.`
        });

        let homebeatUrl = null;
        let homebeatCreated = false;

        // Create Homebeat if requested
        if (createHomebeat === true || createHomebeat === 'true') {
            try {
                const homebeatPayload = {
                    automation: {
                        api_key: CLOUDCMA_API_KEY,
                        frequency: homebeatFrequency || 'quarterly',
                        welcome_email: 'true',
                        report: {
                            prop_type: propType || null,
                            callback_url: null
                        },
                        subject_property: {
                            address: address,
                            sqft: sqft || null,
                            beds: beds || null,
                            baths: baths || null
                        },
                        lead: {
                            name: personData.name || '',
                            email_address: personData.emails?.[0]?.value || '',
                            phone: personData.phones?.[0]?.value || ''
                        }
                    }
                };

                const homebeatResponse = await cloudCMAAPIRequest('POST', '/homebeats/widget', homebeatPayload);
                homebeatCreated = true;
                homebeatUrl = homebeatResponse.homebeat_url || null;

                // Update FUB with Homebeat info
                await fubAPIRequest('PUT', `/v1/people/${personId}`, {
                    customWILLOWCloudCMAHomeBeatURL: homebeatUrl,
                    customWILLOWHomebeatFirstSendDate: new Date().toISOString()
                });

                // Create FUB activity for Homebeat
                await fubAPIRequest('POST', '/v1/events', {
                    person_id: parseInt(personId),
                    type: 'Note',
                    body: `Homebeat subscription created for ${address}. Frequency: ${homebeatFrequency}. Lead will receive automated market updates.`
                });

            } catch (homebeatError) {
                console.error('Homebeat creation failed:', homebeatError);
            }
        }

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                success: true,
                cmaUrl: cmaUrl,
                homebeatCreated: homebeatCreated,
                homebeatUrl: homebeatUrl
            })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to generate CMA: ' + error.message })
        };
    }
}

// Get Homebeat data from CloudCMA
async function getHomebeatData(personId, headers) {
    try {
        // Try to fetch homebeat data, but gracefully handle CloudCMA auth failures
        let homebeatReport = [];
        try {
            homebeatReport = await cloudCMAAPIRequest('GET', `/homebeats/report?api_key=${CLOUDCMA_API_KEY}&format=json`);
        } catch (cloudCMAError) {
            console.warn('CloudCMA API unavailable:', cloudCMAError.message);
            // Return empty homebeats array instead of failing
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({ 
                    homebeats: [],
                    warning: 'CloudCMA API unavailable. Check API key configuration.'
                })
            };
        }

        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);
        const personEmail = personData.emails?.[0]?.value?.toLowerCase();

        if (!personEmail) {
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({ homebeats: [] })
            };
        }

        const leadHomebeats = (homebeatReport || []).filter(hb => 
            hb.lead_email?.toLowerCase() === personEmail
        );

        const enrichedHomebeats = leadHomebeats.map(hb => ({
            ...hb,
            first_send_date: personData.customWILLOWHomebeatFirstSendDate || hb.created_at,
            status: (hb.total_views || 0) === 0 ? 'pending' : 'active'
        }));

        if (enrichedHomebeats.length > 0) {
            const totalViews = enrichedHomebeats.reduce((sum, hb) => sum + (hb.total_views || 0), 0);
            const latestView = enrichedHomebeats
                .map(hb => hb.last_view)
                .filter(v => v)
                .sort()
                .reverse()[0];

            await fubAPIRequest('PUT', `/v1/people/${personId}`, {
                customWILLOWHomebeatViews: totalViews,
                customWILLOWHomebeatLastView: latestView || null
            });
        }

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ homebeats: enrichedHomebeats })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to fetch Homebeat data: ' + error.message })
        };
    }
}

// Resend Homebeat
async function resendHomebeat(params, headers) {
    try {
        const { homebeatId, personId } = params;

        const personData = await fubAPIRequest('GET', `/v1/people/${personId}`);
        
        const homebeatReport = await cloudCMAAPIRequest('GET', `/homebeats/report?api_key=${CLOUDCMA_API_KEY}&format=json`);
        const homebeat = (homebeatReport || []).find(hb => hb.id === homebeatId);

        if (!homebeat) {
            throw new Error('Homebeat not found');
        }

        const homebeatPayload = {
            automation: {
                api_key: CLOUDCMA_API_KEY,
                frequency: homebeat.frequency || 'quarterly',
                welcome_email: 'true',
                subject_property: {
                    address: homebeat.property_address,
                    sqft: homebeat.sqft || null,
                    beds: homebeat.beds || null,
                    baths: homebeat.baths || null
                },
                lead: {
                    name: personData.name || '',
                    email_address: personData.emails?.[0]?.value || '',
                    phone: personData.phones?.[0]?.value || ''
                }
            }
        };

        await cloudCMAAPIRequest('POST', '/homebeats/widget', homebeatPayload);

        await fubAPIRequest('PUT', `/v1/people/${personId}`, {
            customWILLOWHomebeatLastResend: new Date().toISOString()
        });

        await fubAPIRequest('POST', '/v1/events', {
            person_id: parseInt(personId),
            type: 'Note',
            body: `Homebeat resent for ${homebeat.property_address}. Status was pending (0 views). Manual resend triggered.`
        });

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ success: true })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to resend Homebeat: ' + error.message })
        };
    }
}

// Create task in FUB
async function createTask(params, headers) {
    try {
        const { personId, taskDescription, urgency, assignedTo } = params;

        const now = new Date();
        let dueDate = new Date(now);
        
        switch (urgency) {
            case 'IMMEDIATE':
                dueDate.setHours(now.getHours() + 24);
                break;
            case 'SAME_DAY':
                dueDate.setHours(23, 59, 59);
                break;
            case 'NEXT_DAY':
                dueDate.setDate(now.getDate() + 1);
                break;
            case 'WEEKLY':
                dueDate.setDate(now.getDate() + 7);
                break;
            default:
                dueDate.setDate(now.getDate() + 1);
        }

        // FUB tasks API doesn't accept description/body field
        // Task details should be added as a note after task creation
        const taskPayload = {
            personId: parseInt(personId),
            type: 'Follow Up',
            dueDate: dueDate.toISOString()
        };

        const taskResult = await fubAPIRequest('POST', '/v1/tasks', taskPayload);
        
        // Add task details as a note
        const notePayload = {
            personId: parseInt(personId),
            subject: `Task: ${taskDescription}`,
            body: `${taskDescription}\n\nAssigned to: ${assignedTo}\nUrgency: ${urgency}\nDue: ${dueDate.toLocaleDateString()}`,
            isHtml: false
        };
        await fubAPIRequest('POST', '/v1/notes', notePayload);

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ success: true })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to create task: ' + error.message })
        };
    }
}

// Create manual action in FUB
async function createManualAction(params, headers) {
    try {
        const { personId, actionType, assignedTo, urgency, notes } = params;

        const now = new Date();
        let dueDate = new Date(now);
        
        switch (urgency) {
            case 'IMMEDIATE':
                dueDate.setHours(now.getHours() + 24);
                break;
            case 'SAME_DAY':
                dueDate.setHours(23, 59, 59);
                break;
            case 'NEXT_DAY':
                dueDate.setDate(now.getDate() + 1);
                break;
            case 'WEEKLY':
                dueDate.setDate(now.getDate() + 7);
                break;
            default:
                dueDate.setDate(now.getDate() + 1);
        }

        // Map action types to FUB task types
        const taskTypeMap = {
            'Task': 'Follow Up',
            'Call': 'Call',
            'Email': 'Email',
            'Text': 'Text',
            'Note': 'Note'
        };
        
        const fubType = taskTypeMap[actionType] || 'Follow Up';
        
        // If it's a Note, use /v1/notes endpoint, otherwise use /v1/tasks
        if (actionType === 'Note') {
            const notePayload = {
                personId: parseInt(personId),
                subject: `${urgency} Action`,
                body: `${notes}\n\nAssigned to: ${assignedTo}`,
                isHtml: false
            };
            await fubAPIRequest('POST', '/v1/notes', notePayload);
        } else {
            // FUB tasks API doesn't accept description field
            const taskPayload = {
                personId: parseInt(personId),
                type: fubType,
                dueDate: dueDate.toISOString()
            };
            await fubAPIRequest('POST', '/v1/tasks', taskPayload);
            
            // Add action details as a note
            const notePayload = {
                personId: parseInt(personId),
                subject: `${fubType} Action`,
                body: `${notes}\n\nAssigned to: ${assignedTo}\nUrgency: ${urgency}`,
                isHtml: false
            };
            await fubAPIRequest('POST', '/v1/notes', notePayload);
        }

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ success: true })
        };

    } catch (error) {
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to create action: ' + error.message })
        };
    }
}

// FUB API Request Helper
function fubAPIRequest(method, path, data = null) {
    return new Promise((resolve, reject) => {
        const options = {
            hostname: 'api.followupboss.com',
            port: 443,
            path: path,
            method: method,
            headers: {
                'Authorization': `Basic ${Buffer.from(FUB_API_KEY + ':').toString('base64')}`,
                'Content-Type': 'application/json'
            }
        };

        const req = https.request(options, (res) => {
            let body = '';
            res.on('data', (chunk) => body += chunk);
            res.on('end', () => {
                try {
                    const parsed = JSON.parse(body);
                    if (res.statusCode >= 200 && res.statusCode < 300) {
                        resolve(parsed);
                    } else {
                        reject(new Error(`FUB API error: ${res.statusCode} - ${body}`));
                    }
                } catch (e) {
                    reject(new Error(`Failed to parse FUB response: ${body}`));
                }
            });
        });

        req.on('error', reject);
        
        if (data) {
            req.write(JSON.stringify(data));
        }
        
        req.end();
    });
}

// CloudCMA API Request Helper
function cloudCMAAPIRequest(method, path, data = null) {
    return new Promise((resolve, reject) => {
        const options = {
            hostname: 'cloudcma.com',
            port: 443,
            path: path,
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        };

        const req = https.request(options, (res) => {
            let body = '';
            res.on('data', (chunk) => body += chunk);
            res.on('end', () => {
                try {
                    const parsed = body ? JSON.parse(body) : {};
                    if (res.statusCode >= 200 && res.statusCode < 300) {
                        resolve(parsed);
                    } else {
                        reject(new Error(`CloudCMA API error: ${res.statusCode} - ${body}`));
                    }
                } catch (e) {
                    if (res.statusCode >= 200 && res.statusCode < 300) {
                        resolve({});
                    } else {
                        reject(new Error(`Failed to parse CloudCMA response: ${body}`));
                    }
                }
            });
        });

        req.on('error', reject);
        
        if (data) {
            req.write(JSON.stringify(data));
        }
        
        req.end();
    });
}
